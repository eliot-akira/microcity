var Hf=Object.defineProperty;var d=(R,f)=>Hf(R,"name",{value:f,configurable:!0});(function(){"use strict";(function(){const t={env:{NODE_ENV:"production"}};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,t);return}}catch(i){}globalThis.process={env:t}})();const R=0,f=2,b=3,W=4,Rr=5,Mr=20,we=f,ve=Mr,Gi=21,Ws=Gi,Us=37,$r=39,Gs=$r,Pr=40,Ar=43,Yi=44,Lr=47,se=48,Ir=51,ii=52,Ys=56,ro=Ys,at=64,V=at,rt=65,wt=66,si=67,kr=68,xr=69,Nr=70,Vr=71,Fr=72,Br=73,Hr=74,Wr=75,ni=76,Rt=77,tt=78,Se=79,zs=80,ye=95,Xs=144,zi=206,Mt=208,Vt=209,Ft=210,oi=211,Ur=212,Gr=213,Yr=214,zr=215,Xr=216,jr=217,Zr=218,qr=219,lo=220,q=221,dt=222,vt=Mt,lt=224,Bt=225,$t=226,ai=227,Kr=228,Qr=229,Jr=230,tl=231,el=232,il=233,sl=234,nl=235,ho=236,st=237,j=238,Ht=lt,co=238,Wt=240,De=244,uo=249,Xi=uo,po=260,js=265,ol=405,Zs=409,qs=423,Ks=427,fo=436,ji=612,Qs=616,al=620,ri=625,Ut=693,ne=698,rl=708,ll=709,go=711,F=716,Js=745,Gt=750,tn=760,hl=761,mo=765,cl=770,en=774,_o=779,Yt=784,Eo=800,dl=811,Pt=816,sn=826,ul=827,nn=828,To=829,wo=830,vo=831,So=832,yo=840,pl=844,li=860,Zi=867,fl=916,on=924,an=932,gl=940,rn=948,Do=949,bo=950,Oo=951,ml=956,_l=1018,qi=1024,zt=-1;var El=Object.defineProperty,Co=d((t,i)=>El(t,"name",{value:i,configurable:!0}),"s$l");const Tl=16,Ro=Math.sqrt(qi);class ln{constructor(i,s,n){if(s===void 0||n===void 0)throw s===void 0&&n===void 0?new Error("Tileset constructor called with no callback or errorCallback"):new Error("Tileset constructor called with no "+(s===void 0?"callback":"errorCallback"));this.isValid=!1,i.width,i.height;const o=this.tileWidth=Tl,a=document.createElement("canvas");a.width=o,a.height=o;const r=a.getContext("2d"),l=qi;let h=0;const c=this,g=Co(function(){h++,h===l&&(c.isValid=!0,window.setTimeout(s,0))},"imageLoad");for(let _=0;_<l;_++){r.clearRect(0,0,o,o);const v=_%Ro*o,S=Math.floor(_/Ro)*o;r.drawImage(i,v,S,o,o,0,0,o,o),this[_]=new Image,this[_].onload=g,this[_].src=a.toDataURL()}}}d(ln,"E$h"),Co(ln,"TileSet");var wl=Object.defineProperty,hi=d((t,i)=>wl(t,"name",{value:i,configurable:!0}),"t$8");function Mo(t,i=Qi){return(i()&t)===0}d(Mo,"d$g"),hi(Mo,"getChance");function $o(t,i=Ki){const s=i(t),n=i(t);return Math.min(s,n)}d($o,"i$j"),hi($o,"getERandom");function Ki(t,i=Math){return i.floor(i.random()*(t+1))}d(Ki,"r$k"),hi(Ki,"getRandom");function Qi(t=Ki){return t(65535)}d(Qi,"o$h"),hi(Qi,"getRandom16");function Po(t=Qi){const i=t();return i<32768?i:-(2**16)+i}d(Po,"b$8"),hi(Po,"getRandom16Signed");const u={getChance:Mo,getERandom:$o,getRandom:Ki,getRandom16:Qi,getRandom16Signed:Po};var vl=Object.defineProperty,be=d((t,i)=>vl(t,"name",{value:i,configurable:!0}),"r$j");class St{constructor(i){this.name=i}oppositeDirection(){return this.transform(4)}rotateClockwise(){return this.transform(1)}rotateCounterClockwise(){return this.transform(ci.length-1)}toString(){return this.name}transform(i){const s=xo(this)+i;return ci[s%ci.length]}}d(St,"t$7"),be(St,"DirectionValue");const Ji=Object.freeze(new St("NORTH")),Ao=Object.freeze(new St("NORTHEAST")),ts=Object.freeze(new St("EAST")),Lo=Object.freeze(new St("SOUTHEAST")),es=Object.freeze(new St("SOUTH")),Io=Object.freeze(new St("SOUTHWEST")),is=Object.freeze(new St("WEST")),ko=Object.freeze(new St("NORTHWEST")),ci=[Ji,Ao,ts,Lo,es,Io,is,ko];function xo(t){return ci.indexOf(t)}d(xo,"p$l"),be(xo,"directionIndex");const No=[Ji,ts,es,is];function Oe(t){No.forEach(i=>t(i))}d(Oe,"forEachCardinalDirection"),be(Oe,"forEachCardinalDirection");function hn(){return cn(No)}d(hn,"getRandomCardinalDirection"),be(hn,"getRandomCardinalDirection");function Vo(){return cn(ci)}d(Vo,"getRandomDirection"),be(Vo,"getRandomDirection");function cn(t){const i=t.length-1,s=u.getRandom(i);return t[s]}d(cn,"s$k"),be(cn,"getRandomDirectionFrom");var Sl=Object.defineProperty,yl=d((t,i)=>Sl(t,"name",{value:i,configurable:!0}),"i$i");function dn(t,i){t||alert(`Assertion failed: ${i}`)}d(dn,"assert"),yl(dn,"assert");var Dl=Object.defineProperty,un=d((t,i)=>Dl(t,"name",{value:i,configurable:!0}),"o$e");class yt{constructor(i,s){this.xDelta=i,this.yDelta=s}}d(yt,"e$d"),un(yt,"DirectionDelta");function Fo(t){switch(t){case Ji:return new yt(0,-1);case Ao:return new yt(1,-1);case ts:return new yt(1,0);case Lo:return new yt(1,1);case es:return new yt(0,1);case Io:return new yt(-1,1);case is:return new yt(-1,0);case ko:return new yt(-1,-1);default:throw new Error("Unexpected direction!")}}d(Fo,"w$6"),un(Fo,"getDeltaFor");class O{constructor(i,s){this.x=i,this.y=s}static move(i,s){const{x:n,y:o}=i,{xDelta:a,yDelta:r}=Fo(s);return new O(n+a,o+r)}static origin(){return new O(0,0)}toString(){return`(${this.x}, ${this.y})`}}d(O,"Position"),un(O,"Position");var bl=Object.defineProperty,Ol=d((t,i)=>bl(t,"name",{value:i,configurable:!0}),"i$h");class di{constructor(i,s,n,o){this.inclusiveStartX=i,this.inclusiveStartY=s,dn(n>0,"bounded region must have a width"),dn(o>0,"bounded region must have a width"),this.exclusiveEndX=i+n,this.exclusiveEndY=s+o}static fromOrigin(i,s){return new di(0,0,i,s)}contains(i){const{x:s,y:n}=i;return this.xInBounds(s)&&this.yInBounds(n)}toString(){const i=new O(this.inclusiveStartX,this.inclusiveStartY),s=new O(this.exclusiveEndX-1,this.exclusiveEndY-1);return`Bounds Rectangle: ${i} - ${s}`}xInBounds(i){return i>=this.inclusiveStartX&&i<this.exclusiveEndX}yInBounds(i){return i>=this.inclusiveStartY&&i<this.exclusiveEndY}}d(di,"Bounds"),Ol(di,"Bounds");const Bo=0,At=32768,k=16384,M=8192,m=4096,Z=2048,Ce=1024,Ho=m|M,ui=m|M|k,ss=M|k,Cl=Z|k|M,pn=At|k|M|m|Z|Ce,Wo=1024,ns=Wo-1;var Rl=Object.defineProperty,Ml=d((t,i)=>Rl(t,"name",{value:i,configurable:!0}),"n$k");class G{constructor(i=R,s=0){this.validateArguments(i,s,"Tile constructor"),this.value=i|s}getValue(){return this.valueFromCombinedValue(this.value)}getFlags(){return this.flagsFromCombinedValue(this.value)}getRawValue(){return this.value}addFlags(i){this.validateFlags(i,"addFlags"),i!==Bo&&(this.value|=i)}setValue(i){if(i<zt)throw new Error(`setValue called with out-of-range value ${i}`);const s=this.valueFromCombinedValue(i),n=this.flagsToSetFromCombinedValue(i);this.set(s,n)}setFlags(i){this.validateFlags(i,"setFlags");const s=this.value&~pn;this.value=s|i}removeFlags(i){this.validateFlags(i,"removeFlags"),i!==Bo&&(this.value&=~i)}setFrom(i){if(!i){console.log("Tile is undefined");return}this.value=i.value}set(i,s){this.validateArguments(i,s,"set"),this.value=i|s}isAnimated(){return this.checkBits(Z)}isBulldozable(){return this.checkBits(m)}isConductive(){return this.checkBits(k)}isCombustible(){return this.checkBits(M)}isPowered(){return this.checkBits(At)}isZone(){return this.checkBits(Ce)}toString(){const i=["animated","bulldozable","combustible","conductive","powered","zone"].map(s=>this.getQualityText(s)).join(", ");return`Tile# ${this.getValue()}: ${i}`}getQualityText(i){const s=this.predicateForQuality(i),n=this[s]();return`${i}: ${this.summariseBoolean(n)}`}predicateForQuality(i){return`is${i[0].toUpperCase()}${i.slice(1)}`}summariseBoolean(i){return i?"\u2714":"\u2718"}valueFromCombinedValue(i){return i&ns}flagsFromCombinedValue(i){return i&pn}flagsToSetFromCombinedValue(i){const s=this.flagsFromCombinedValue(i);return s>0?s:this.getFlags()}checkBits(i){return(this.value&i)>0}validateArguments(i,s,n){this.validateValue(i,n),this.validateFlags(s,n)}validateValue(i,s){if(this.valueIsInvalid(i))throw new Error(`${s} called with out-of-range value ${i}`)}validateFlags(i,s){if(this.flagsAreInvalid(i))throw new Error(`${s} called with out-of-range flags 0x${i.toString(16)}`)}valueIsInvalid(i){return i<zt||i>=qi}flagsAreInvalid(i){return i!==0&&(i<Wo||(i&~pn)!==0)}}d(G,"Tile"),Ml(G,"Tile");var $l=Object.defineProperty,Pl=d((t,i)=>$l(t,"name",{value:i,configurable:!0}),"m$k");function x(t,i,s){if(arguments.length>1&&typeof t=="number"&&(t<1||i<1))throw new Error("GameMap constructor called with invalid width or height "+t+" "+i);const n=120,o=100;arguments.length===0?(t=n,i=o,s=new G().getValue()):arguments.length===1?(typeof t=="number"?s=t:s=t.getValue(),t=n,i=o):arguments.length===2?s=new G().getValue():arguments.length===3&&typeof s=="object"&&(s=s.getValue()),this.width=t,this.height=i,this.bounds=di.fromOrigin(t,i);const a=[];for(let r=0,l=t*i;r<l;r++)a[r]=new G(s);this._data=a,this.cityCentreX=Math.floor(this.width/2),this.cityCentreY=Math.floor(this.height/2),this.pollutionMaxX=this.cityCentreX,this.pollutionMaxY=this.cityCentreY}d(x,"a$l"),Pl(x,"GameMap");const Re=["cityCentreX","cityCentreY","pollutionMaxX","pollutionMaxY","width","height"];x.prototype.save=function(t){for(let i=0,s=Re.length;i<s;i++)t[Re[i]]=this[Re[i]];t.map=this._data.map(function(i){return{value:i.getRawValue()}})},x.prototype.load=function(t){for(var i=0,s=Re.length;i<s;i++)this[Re[i]]=t[Re[i]];const n=t.map;for(i=0,s=n.length;i<s;i++)this.setTileValue(i%this.width,Math.floor(i/this.width),n[i].value)},x.prototype._calculateIndex=function(t,i){return t+i*this.width},x.prototype.isPositionInBounds=function(t){return this.bounds.contains(t)},x.prototype.testBounds=function(t,i){return this.isPositionInBounds(new O(t,i))},x.prototype.getTile=function(t,i,s){typeof t=="object"&&(i=t.y,t=t.x);const n=this.width,o=this.height;if(t<0||i<0||t>=n||i>=o)return console.warn("getTile called with bad bounds",t,i),new G(zt);const a=t+i*n,r=this._data[a];return s&&s.setFrom(r),r},x.prototype.getTileValue=function(t,i){if(arguments.length<1)throw new Error("GameMap getTileValue called with too few arguments"+[].toString.apply(arguments));if(typeof t=="object"&&(i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap getTileValue called with invalid bounds "+t+", "+i);const s=this._calculateIndex(t,i);if(this._data[s])return this._data[s].getValue()},x.prototype.getTileFlags=function(t,i){if(arguments.length<1)throw new Error("GameMap getTileFlags called with too few arguments"+[].toString.apply(arguments));if(typeof t=="object"&&(i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap getTileFlags called with invalid bounds "+t+", "+i);const s=this._calculateIndex(t,i);return this._data[s].getFlags()},x.prototype.getTiles=function(t,i,s,n){if(arguments.length<3)throw new Error("GameMap getTiles called with too few arguments"+[].toString.apply(arguments));if(arguments.length===3&&(n=s,s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap getTiles called with invalid bounds "+t+", "+i);const o=[];for(let a=i,r=i+n;a<r;a++){o[a-i]=[];for(let l=t,h=t+s;l<h;l++){const c=this._calculateIndex(l,a);o[a-i].push(this._data[c])}}return o},x.prototype.getTileValuesForPainting=function(t,i,s,n,o){if(o=o||[],arguments.length<3)throw new Error("GameMap getTileValuesForPainting called with too few arguments"+[].toString.apply(arguments));arguments.length===3&&(n=s,s=i,i=t.y,t=t.x);const a=this.width,r=this.height;for(let l=i,h=i+n;l<h;l++)for(let c=t,g=t+s;c<g;c++){if(l<0||c<0||l>=r||c>=a){o[(l-i)*s+(c-t)]=zt;continue}const _=c+l*a;o[(l-i)*s+(c-t)]=this._data[_].getRawValue()}return o},x.prototype.getTileFromMapOrDefault=function(t,i,s){switch(i){case Ji:return t.y>0?this.getTileValue(t.x,t.y-1):s;case ts:return t.x<this.width-1?this.getTileValue(t.x+1,t.y):s;case es:return t.y<this.height-1?this.getTileValue(t.x,t.y+1):s;case is:return t.x>0?this.getTileValue(t.x-1,t.y):s;default:return s}},x.prototype.setTile=function(t,i,s,n){if(arguments.length<3)throw new Error("GameMap setTile called with too few arguments"+[].toString.apply(arguments));if(arguments.length===3&&(n=s,s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap setTile called with invalid bounds "+t+", "+i);const o=this._calculateIndex(t,i);this._data[o].set(s,n)},x.prototype.setTo=function(t,i,s){if(arguments.length<2)throw new Error("GameMap setTo called with too few arguments"+[].toString.apply(arguments));if(s===void 0&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap setTo called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n]=s},x.prototype.setTileValue=function(t,i,s){if(arguments.length<2)throw new Error("GameMap setTileValue called with too few arguments"+[].toString.apply(arguments));arguments.length===2&&(s=i,i=t.y,t=t.x),this.testBounds(t,i)||(console.log("GameMap setTileValue called with invalid bounds "+t+", "+i),ReadableStreamDefaultController);const n=this._calculateIndex(t,i);!this._data[n]||this._data[n].setValue(s)},x.prototype.setTileFlags=function(t,i,s){if(arguments.length<2)throw new Error("GameMap setTileFlags called with too few arguments"+[].toString.apply(arguments));if(arguments.length===2&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap setTileFlags called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n].setFlags(s)},x.prototype.addTileFlags=function(t,i,s){if(arguments.length<2)throw new Error("GameMap addTileFlags called with too few arguments"+[].toString.apply(arguments));if(arguments.length===2&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap addTileFlags called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n].addFlags(s)},x.prototype.removeTileFlags=function(t,i,s){if(arguments.length<2)throw new Error("GameMap removeTileFlags called with too few arguments"+[].toString.apply(arguments));if(arguments.length===2&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap removeTileFlags called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n].removeFlags(s)},x.prototype.putZone=function(t,i,s,n){let o,a;if(!this.testBounds(t,i)||!this.testBounds(t-1+n-1,i-1+n-1))throw new Error("GameMap putZone called with invalid bounds "+o+", "+a);let r=s-1-n;const l=t-1,h=i-1;for(a=h;a<h+n;a++)for(o=l;o<l+n;o++)o===t&&a===i?this.setTo(o,a,new G(r,ss|Ce)):this.setTo(o,a,new G(r,ss)),r+=1};var Al=Object.defineProperty,B=d((t,i)=>Al(t,"name",{value:i,configurable:!0}),"u$i");let fn;const Ll=-1,Il=18,kl=B(function(t,i){t=t||120,i=i||100,fn=u.getRandom(2)-1;const s=new x(t,i);if(fn<0&&u.getRandom(100)<10)return Nl(s),s;if(fn===1?Uo(s):xl(s),Ll!==0){const n=40+u.getRandom(s.width-80),o=33+u.getRandom(s.height-67),a=new O(n,o);Gl(s,a)}return Vl(s),Yo(s),Go(s),s},"MapGenerator");var xl=B(function(t){for(let i=0;i<t.width;i++)for(let s=0;s<t.height;s++)t.setTile(i,s,R,0)},"clearMap");B(function(t){for(let i=0;i<t.width;i++)for(let s=0;s<t.height;s++)t.getTileValue(i,s)>Us&&t.setTile(i,s,R,0)},"clearUnnatural");var Uo=B(function(t){const i=Il;let s,n;for(s=0;s<t.width;s++)for(n=0;n<t.height;n++)s<5||s>=t.width-5||n<5||n>=t.height-5?t.setTile(s,n,f,0):t.setTile(s,n,R,0);for(s=0;s<t.width-5;s+=2){let o=u.getERandom(i);Me(t,new O(s,o)),o=t.height-10-u.getERandom(i),Me(t,new O(s,o)),$e(t,new O(s,0)),$e(t,new O(s,t.height-6))}for(n=0;n<t.height-5;n+=2){let o=u.getERandom(i);Me(t,new O(o,n)),o=t.width-10-u.getERandom(i),Me(t,new O(o,n)),$e(t,new O(0,n)),$e(t,new O(t.width-6,n))}},"makeNakedIsland"),Nl=B(function(t){Uo(t),Yo(t),Go(t)},"makeIsland"),Vl=B(function(t){let i;for(i=u.getRandom(10);i>0;){const s=u.getRandom(t.width-21)+10,n=u.getRandom(t.height-20)+10;Fl(t,new O(s,n)),i--}},"makeLakes"),Fl=B(function(t,i){let s=u.getRandom(12)+2;for(;s>0;){const n=new O(i,u.getRandom(12)-6,u.getRandom(12)-6);u.getRandom(4)?$e(t,n):Me(t,n),s--}},"makeSingleLake");const Bl=B(function(t,i,s){let n;n=u.getRandom(150)+50;let o=new O(i,s);for(;n>0;){const a=Vo();if(o=O.move(o,a),!t.isPositionInBounds(o))return;t.getTileValue(o)===R&&t.setTile(o,Us,Ho),n--}},"treeSplash");var Go=B(function(t){let i;i=u.getRandom(100)+50;for(let s=0;s<i;s++){const n=u.getRandom(t.width-1),o=u.getRandom(t.height-1);Bl(t,n,o)}zo(t),zo(t)},"doTrees");const Hl=[13|m,13|m,17|m,15|m,5|m,f,19|m,17|m,9|m,11|m,f,13|m,7|m,9|m,5|m,f];var Yo=B(function(t){const i=[-1,0,1,0],s=[0,1,0,-1];for(let n=0;n<t.width;n++)for(let o=0;o<t.height;o++)if(t.getTileValue(n,o)===b){let a=0;for(let l=0;l<4;l++){a=a<<1;const h=n+i[l],c=o+s[l];t.testBounds(h,c)&&t.getTileValue(h,c)!==R&&(t.getTileValue(h,c)<Ws||t.getTileValue(h,c)>Gs)&&a++}let r=Hl[a&15];r!==f&&u.getRandom(1)&&r++,t.setTileValue(n,o,r,0)}},"smoothRiver");const gn=B(function(t){return t>=Ws&&t<=Gs},"isTree");var zo=B(function(t){for(let i=0;i<t.width;i++)for(let s=0;s<t.height;s++)gn(t.getTileValue(i,s))&&Ul(t,i,s,!1)},"smoothTrees");const Wl=[0,0,0,34,0,0,36,35,0,32,0,33,30,31,29,37];var Ul=B(function(t,i,s,n){const o=[-1,0,1,0],a=[0,1,0,-1];if(!gn(t.getTileValue(i,s)))return;let r=0;for(let h=0;h<4;h++){r=r<<1;const c=i+o[h],g=s+a[h];t.testBounds(c,g)&&gn(t.getTileValue(c,g))&&r++}let l=Wl[r&15];l?(l!==Us&&i+s&1&&(l=l-8),t.setTile(i,s,l,Ho)):n||t.setTileValue(i,s,l,0)},"smoothTreesAt"),Gl=B(function(t,i){let s=hn();Xo(t,i,s,s),s=s.oppositeDirection();const n=Xo(t,i,s,s);s=hn(),Yl(t,i,s,n)},"doRivers"),Xo=B(function(t,i,s,n){let o,a;for(o=100,a=200;t.testBounds(i.x+4,i.y+4);)Me(t,i),u.getRandom(o)<10?n=s:(u.getRandom(a)>90&&(n=n.rotateClockwise()),u.getRandom(a)>90&&(n=n.rotateCounterClockwise())),i=O.move(i,n);return n},"doBRiver"),Yl=B(function(t,i,s,n){let o,a;for(o=100,a=200;t.testBounds(i.x+3,i.y+3);)$e(t,i),u.getRandom(o)<10?n=s:(u.getRandom(a)>90&&(n=n.rotateClockwise()),u.getRandom(a)>90&&(n=n.rotateCounterClockwise())),i=O.move(i,n);return n},"doSRiver");const jo=B(function(t,i,s,n){if(i===0||!t.testBounds(s,n))return;const o=t.getTileValue(s,n);o!==R&&(o===f&&i!==W||o===W)||t.setTile(s,n,i,0)},"putOnMap");var Me=B(function(t,i){const s=[[0,0,0,b,b,b,0,0,0],[0,0,b,f,f,f,b,0,0],[0,b,f,f,f,f,f,b,0],[b,f,f,f,f,f,f,f,b],[b,f,f,f,W,f,f,f,b],[b,f,f,f,f,f,f,f,b],[0,b,f,f,f,f,f,b,0],[0,0,b,f,f,f,b,0,0],[0,0,0,b,b,b,0,0,0]];for(let n=0;n<9;n++)for(let o=0;o<9;o++)jo(t,s[o][n],i.x+n,i.y+o)},"plopBRiver"),$e=B(function(t,i){const s=[[0,0,b,b,0,0],[0,b,f,f,b,0],[b,f,f,f,f,b],[b,f,f,f,f,b],[0,b,f,f,b,0],[0,0,b,b,0,0]];for(let n=0;n<6;n++)for(let o=0;o<6;o++)jo(t,s[o][n],i.x+n,i.y+o)},"plopSRiver");B(function(t){let i,s,n,o;for(i=0;i<t.width;i++)for(s=0;s<t.height;s++)if(n=t.getTileValue(i,s),n>=we&&n<=ve){o=new O(i,s);let r=!1;Oe(l=>{r||(n=t.getTileFromMap(o,l,we),(n<we||n>ve)&&(t.setTileValue(i,s,b,0),r=!0))})}for(i=0;i<t.width;i++)for(s=0;s<t.height;s++)if(n=t.getTileValue(i,s),n!==W&&n>=we&&n<=ve){var a=!0;o=new O(i,s),Oe(r=>{!a||(n=t.getTileFromMapOrDefault(o,r,we),(n<we||n>ve)&&(a=!1))}),a&&t.setTileValue(i,s,f,0)}for(i=0;i<t.width;i++)for(s=0;s<t.height;s++)if(n=t.getTileValue(i,s),n>=Ws&&n<=Gs){o=new O(i,s);let r=!1;Oe(l=>{r||(n=t.getTileFromMapOrDefault(o,l,TILE_INVALID),(n===f||n===W)&&(t.setTileValue(i,s,b,0),r=!0))})}},"smoothWater");var zl=Object.defineProperty,Zo=d((t,i)=>zl(t,"name",{value:i,configurable:!0}),"h$e");const Xl=Zo(t=>t,"ID");class Y{constructor(i,s,n){this.gameMapWidth=i,this.gameMapHeight=s,this.blockSize=n,this.data=[],this._width=this.convertToBlockCount(this.gameMapWidth),this._height=this.convertToBlockCount(this.gameMapHeight),this.clear()}get width(){return this._width}get height(){return this._height}get(i,s){const n=this.toIndex(i,s);return this.data[n]}set(i,s,n){const o=this.toIndex(i,s);this.data[o]=n}worldGet(i,s){const{x:n,y:o}=this.toBlockCoordinate(i,s);return this.get(n,o)}worldSet(i,s,n){const{x:o,y:a}=this.toBlockCoordinate(i,s);this.set(o,a,n)}clear(){this.forEach((i,s)=>this.set(i,s,0))}copyFrom(i,s=Xl){this.hasIncompatibleDimensions(i)&&console.warn("Copying from incompatible blockMap!"),this.forEach((n,o)=>this.set(n,o,s(i.get(n,o))))}forEach(i){const s=this.width,n=this.height;for(let o=0;o<s;o++)for(let a=0;a<n;a++)i(o,a)}convertToBlockCount(i){return Math.floor((i+this.blockSize-1)/this.blockSize)}hasIncompatibleDimensions(i){return i.gameMapHeight!==this.gameMapHeight||i.gameMapWidth!==this.gameMapWidth||i.blockSize!==this.blockSize}toBlockCoordinate(i,s){const n=this.toBlockIndex(i),o=this.toBlockIndex(s);return{x:n,y:o}}toBlockIndex(i){return Math.floor(i/this.blockSize)}toIndex(i,s){return this.width*s+i}}d(Y,"BlockMap"),Zo(Y,"BlockMap");var jl=Object.defineProperty,Pe=d((t,i)=>jl(t,"name",{value:i,configurable:!0}),"t$6");const ut=Pe(function(t){return function(i){return i instanceof G&&(i=i.getValue()),t.call(null,i)}},"unwrapTile"),Zl=ut(function(t){return t>=Rr&&t<=Lr||t>=vt+2&&t<=vt+12||t>=li&&t<=Zi+2}),qo=ut(function(t){return t>=qs&&t<ji}),ql=Pe(function(t){return t.isZone()&&qo(t)},"isCommercialZone"),Kl=ut(function(t){return t>=V&&t<=zi||t>=q&&t<=co}),Ql=ut(function(t){return t>=ro&&t<V}),Jl=ut(function(t){return t>=se&&t<Ir}),Ko=ut(function(t){return t>=ji&&t<Ut}),th=Pe(function(t){return t.isZone()&&Ko(t)},"isIndustrialZone"),eh=ut(function(t){return t>=li&&t<=Zi}),ih=ut(function(t){return t>=Ht&&t<Wt}),Qo=ut(function(t){return t>=Wt&&t<ol}),sh=Pe(function(t){return t.isZone()&&Qo(t)},"isResidentialZone"),nh=ut(function(t){return t>=V&&t<vt}),oh=ut(function(t){return t>=V&&t<=zi+1?(t&15)+64:t}),ah=Pe(function(){return new G(Ys+(u.getRandom16()&3),Z)},"randomFire"),rh=Pe(function(){return new G(Yi+(u.getRandom16()&3),m)},"randomRubble"),T={canBulldoze:Zl,isCommercial:qo,isCommercialZone:ql,isDriveable:Kl,isFire:Ql,isFlood:Jl,isIndustrial:Ko,isIndustrialZone:th,isManualExplosion:eh,isRail:ih,isResidential:Qo,isResidentialZone:sh,isRoad:nh,normalizeRoad:oh,randomFire:ah,randomRubble:rh};var lh=Object.defineProperty,os=d((t,i)=>lh(t,"name",{value:i,configurable:!0}),"e$b");const hh=os(function(t,i,s){return t<i?i:t>s?s:t},"clamp"),ch=os(function(t){return{configurable:!1,enumerable:!1,writeable:!1,value:t}},"makeConstantDescriptor"),dh=os(function(t){return(t[0]!=="#"?"#":"")+t},"normaliseDOMid"),uh=os(function(t,i){this._emitEvent(t,i)},"reflectEvent"),p={clamp:hh,makeConstantDescriptor:ch,normaliseDOMid:dh,reflectEvent:uh},Ae=1,Lt=2,It=3,oe=4,Le=5,pi=6,as=7,fi={SPRITE_TRAIN:Ae,SPRITE_HELICOPTER:Lt,SPRITE_AIRPLANE:It,SPRITE_SHIP:oe,SPRITE_MONSTER:Le,SPRITE_TORNADO:pi,SPRITE_EXPLOSION:as};var ph=Object.defineProperty,Ie=d((t,i)=>ph(t,"name",{value:i,configurable:!0}),"d$d");const fh=Ie(function(t){let i;switch(t){case Gt:case ne:case Pt:case Yt:i={zoneSize:4,deltaX:0,deltaY:0};break;case Gt+1:case on:case on+1:case on+2:case ne+1:case Pt+1:case Yt+1:i={zoneSize:4,deltaX:-1,deltaY:0};break;case Gt+4:case ne+4:case Pt+4:case Yt+4:i={zoneSize:4,deltaX:0,deltaY:-1};break;case Gt+5:case ne+5:case Pt+5:case Yt+5:i={zoneSize:4,deltaX:-1,deltaY:-1};break;case F:i={zoneSize:6,deltaX:0,deltaY:0};break;case F+1:i={zoneSize:6,deltaX:-1,deltaY:0};break;case F+2:i={zoneSize:6,deltaX:-2,deltaY:0};break;case F+3:i={zoneSize:6,deltaX:-3,deltaY:0};break;case F+6:i={zoneSize:6,deltaX:0,deltaY:-1};break;case F+7:i={zoneSize:6,deltaX:-1,deltaY:-1};break;case F+8:i={zoneSize:6,deltaX:-2,deltaY:-1};break;case F+9:i={zoneSize:6,deltaX:-3,deltaY:-1};break;case F+12:i={zoneSize:6,deltaX:0,deltaY:-2};break;case F+13:i={zoneSize:6,deltaX:-1,deltaY:-2};break;case F+14:i={zoneSize:6,deltaX:-2,deltaY:-2};break;case F+15:i={zoneSize:6,deltaX:-3,deltaY:-2};break;case F+18:i={zoneSize:6,deltaX:0,deltaY:-3};break;case F+19:i={zoneSize:6,deltaX:-1,deltaY:-3};break;case F+20:i={zoneSize:6,deltaX:-2,deltaY:-3};break;case F+21:i={zoneSize:6,deltaX:-3,deltaY:-3};break;default:i={zoneSize:0,deltaX:0,deltaY:0};break}return i},"checkBigZone"),gh=Ie(function(t){return t>=Wt-1&&t<=Ut-1||t>=tn+1&&t<=en+4||t>=ml&&t<=_l?3:t>=Ut&&t<=rl||t>=Js&&t<=tn||t>=_o&&t<=sn?4:0},"checkZoneSize"),mh=Ie(function(t,i,s,n){const o=t.getTileValue(i,s);let a=2,r=n.rateOfGrowthMap.worldGet(i,s);r=p.clamp(r-20,-200,200),n.rateOfGrowthMap.worldSet(i,s,r),o===F?a=5:o>=Ut?a=3:o<Ut&&(a=2);for(let l=-1;l<a;l++)for(let h=-1;h<a;h++){const c=i+l,g=s+h;!t.testBounds(c,g)||t.getTileValue(c,g>=V)&&t.addTileFlags(c,g,m)}},"fireZone"),_h=Ie(function(t,i,s){let n=t.landValueMap.worldGet(i,s);return n-=t.pollutionDensityMap.worldGet(i,s),n<30?0:n<80?1:n<150?2:3},"getLandPollutionValue"),Eh=Ie(function(t,i,s,n){const o=t.rateOfGrowthMap.worldGet(i,s),a=p.clamp(o+n*4,-200,200);t.rateOfGrowthMap.worldSet(i,s,a)},"incRateOfGrowth"),Th=Ie(function(t,i,s,n,o){for(let a=-1;a<2;a++)for(let r=-1;r<2;r++){const l=t.getTileValue(i+r,s+a);if(l>=se&&l<V)return}t.putZone(i,s,n,3),t.addTileFlags(i,s,m),o&&t.addTileFlags(i,s,At)},"putZone"),P={checkBigZone:fh,checkZoneSize:gh,fireZone:mh,getLandPollutionValue:_h,incRateOfGrowth:Eh,putZone:Th};var wh=Object.defineProperty,Dt=d((t,i)=>wh(t,"name",{value:i,configurable:!0}),"s$i");const gi=Dt(function(t){return t>>4},"pixToWorld"),vh=Dt(function(t){return t<<4},"worldToPix"),Sh=Dt(function(t,i){return t===i||(t<i?i-t<4?t++:t--:t-i<4?t--:t++,t>8&&(t=1),t<1&&(t=8)),t},"turnTo"),yh=Dt(function(t,i,s){const n=gi(i),o=gi(s);return n<0||n>=t.width||o<0||o>=t.height?-1:t.getTileValue(n,o)},"getTileValue"),Dh=[0,3,2,1,3,4,5,7,6,5,7,8,1],bh=Dt(function(t,i,s,n){let o=s-t,a=n-i,r;return o<0?a<0?r=11:r=8:a<0?r=2:r=5,o=Math.abs(o),a=Math.abs(a),o*2<a?r++:a*2<o&&r--,(r<0||r>12)&&(r=0),Dh[r]},"getDir"),Oh=Dt(function(t,i,s,n){const o=s-t,a=n-i;return Math.abs(o)+Math.abs(a)},"absoluteDistance"),Ch=Dt(function(t){return t===Mt||t===Vt||t===lt||t===Bt||t===Se||t===ye},"checkWet"),Rh=Dt(function(t,i,s,n,o){const a=gi(n),r=gi(o);if(!i.testBounds(a,r))return;const l=i.getTile(a,r),h=l.getValue();if(!(h<Gi)){if(!l.isCombustible()){h>=V&&h<=zi&&i.setTile(a,r,f,0);return}l.isZone()&&(P.fireZone(i,a,r,s),h>js&&t.makeExplosionAt(n,o)),Ch(h)?i.setTile(a,r,f,0):i.setTile(a,r,li,m|Z)}},"destroyMapTile"),Mh=Dt(function(t,i,s,n){return Math.abs(t-s)+Math.abs(i-n)},"getDistance"),$h=Dt(function(t,i){return t.frame!==0&&i.frame!==0&&Mh(t.x,t.y,i.x,i.y)<30},"checkSpriteCollision"),E={absoluteDistance:Oh,checkSpriteCollision:$h,destroyMapTile:Rh,getDir:bh,getTileValue:yh,turnTo:Sh,pixToWorld:gi,worldToPix:vh};var Ph=Object.defineProperty,Ah=d((t,i)=>Ph(t,"name",{value:i,configurable:!0}),"p$i");function N(t,i){this._map=t,this._stack=[],this._spriteManager=i}d(N,"s$h"),Ah(N,"Traffic"),N.prototype.makeTraffic=function(t,i,s,n){this._stack=[];const o=new O(t,i);return this.findPerimeterRoad(o)?this.tryDrive(o,n)?(this.addToTrafficDensityMap(s),N.ROUTE_FOUND):N.NO_ROUTE_FOUND:N.NO_ROAD_FOUND},N.prototype.addToTrafficDensityMap=function(t){const i=t.trafficDensityMap;for(;this._stack.length>0;){const s=this._stack.pop();if(!this._map.testBounds(s.x,s.y))continue;const n=this._map.getTileValue(s.x,s.y);if(n>=V&&n<vt){let o=i.worldGet(s.x,s.y);if(o+=50,o=Math.min(o,240),i.worldSet(s.x,s.y,o),o>=240&&u.getRandom(5)===0){const a=this._spriteManager.getSprite(Lt);a!==null&&(a.destX=E.worldToPix(s.x),a.destY=E.worldToPix(s.y))}}}};const Lh=[-1,0,1,2,2,2,1,0,-1,-2,-2,-2],Ih=[-2,-2,-2,-1,0,1,2,2,2,1,0,-1];N.prototype.findPerimeterRoad=function(t){for(let i=0;i<12;i++){const s=t.x+Lh[i],n=t.y+Ih[i];if(this._map.testBounds(s,n)&&T.isDriveable(this._map.getTileValue(s,n)))return t.x=s,t.y=n,!0}return!1};const kh=30;N.prototype.tryDrive=function(t,i){let s,n=new O(t);for(let o=0;o<kh;o++){const a=this.tryGo(n,s);if(a){if(n=O.move(pos,a),s=a.oppositeDirection(),o&1&&this._stack.push(new O(n)),this.driveDone(n,i))return!0}else if(this._stack.length>0)this._stack.pop(),o+=3;else return!1}return!1},N.prototype.tryGo=function(t,i){const s=[];let n=0;if(Oe(a=>{a!=i&&T.isDriveable(this._map.getTileFromMapOrDefault(t,a,R))&&(s.push(a),n++)}),n===0)return;if(n===1)return s[0];const o=u.getRandom(s.length-1);return s[o]},N.prototype.driveDone=function(t,i){return!!(t.y>0&&i(this._map.getTileValue(t.x,t.y-1))||t.x<this._map.width-1&&i(this._map.getTileValue(t.x+1,t.y))||t.y<this._map.height-1&&i(this._map.getTileValue(t.x,t.y+1))||t.x>0&&i(this._map.getTileValue(t.x-1,t.y)))},Object.defineProperties(N,{ROUTE_FOUND:p.makeConstantDescriptor(1),NO_ROUTE_FOUND:p.makeConstantDescriptor(0),NO_ROAD_FOUND:p.makeConstantDescriptor(-1)});var xh=Object.defineProperty,mi=d((t,i)=>xh(t,"name",{value:i,configurable:!0}),"u$f");const Jo=mi(function(t,i,s,n){return n===Ks?0:Math.floor((n-fo)/9)%5+1},"getZonePopulation"),ta=mi(function(t,i,s,n,o,a){const r=(o*5+n)*9+fo;P.putZone(t,i,s,r,a)},"placeCommercial"),Nh=mi(function(t,i,s,n,o,a,r){let l=n.landValueMap.worldGet(i,s);l=l>>5,!(o>l)&&o<5&&(ta(t,i,s,o,a,r),P.incRateOfGrowth(n,i,s,8))},"growZone"),ea=mi(function(t,i,s,n,o,a,r){o>1?ta(t,i,s,o-2,a,r):P.putZone(t,i,s,Ks,r),P.incRateOfGrowth(n,i,s,-8)},"degradeZone"),Vh=mi(function(t,i,s,n){let o;n.census.comZonePop+=1;const a=t.getTileValue(i,s),r=Jo(t,i,s,a);n.census.comPop+=r;const l=t.getTile(i,s).isPowered();let h=N.ROUTE_FOUND;if(r>u.getRandom(5)&&(h=n.trafficManager.makeTraffic(i,s,n.blockMaps,T.isIndustrial),h===N.NO_ROAD_FOUND)){o=P.getLandPollutionValue(n.blockMaps,i,s),ea(t,i,s,n.blockMaps,r,o,l);return}if(u.getChance(7)){const c=h===N.NO_ROAD_FOUND?-3e3:n.blockMaps.cityCentreDistScoreMap.worldGet(i,s);let g=n.valves.comValve+c;if(l||(g=-500),l&&g>-350&&g-26380>u.getRandom16Signed()){o=P.getLandPollutionValue(n.blockMaps,i,s),Nh(t,i,s,n.blockMaps,r,o,l);return}g<350&&g+26380<u.getRandom16Signed()&&(o=P.getLandPollutionValue(n.blockMaps,i,s),ea(t,i,s,n.blockMaps,r,o,l))}},"commercialFound"),ia={registerHandlers:function(t,i){t.addAction(T.isCommercialZone,Vh)},getZonePopulation:Jo};var Fh=Object.defineProperty,ke=d((t,i)=>Fh(t,"name",{value:i,configurable:!0}),"f$a"),sa=ke(function(t,i,s,n){return n===Qs?0:Math.floor((n-ri)/9)%4+1},"getZonePopulation"),na=ke(function(t,i,s,n,o,a){var r=(o*4+n)*9+ri;P.putZone(t,i,s,r,a)},"placeIndustrial"),Bh=ke(function(t,i,s,n,o,a,r){o<4&&(na(t,i,s,o,a,r),P.incRateOfGrowth(n,i,s,8))},"growZone"),oa=ke(function(t,i,s,n,o,a,r){o>1?na(t,i,s,o-2,a,r):P.putZone(t,i,s,Qs,r),P.incRateOfGrowth(n,i,s,-8)},"degradeZone"),Hh=[!0,!1,!0,!0,!1,!1,!0,!0],mn=[-1,0,1,0,0,0,0,1],_n=[-1,0,-1,-1,0,0,-1,-1],Wh=ke(function(t,i,s,n,o){if(!(n<ri)){var a=n-ri>>3;Hh[a]&&o?t.addTileFlags(i+mn[a],s+_n[a],Cl):(t.addTileFlags(i+mn[a],s+_n[a],ss),t.removeTileFlags(i+mn[a],s+_n[a],Z))}},"setAnimation"),Uh=ke(function(t,i,s,n){n.census.indZonePop+=1;var o=t.getTileValue(i,s),a=sa(t,i,s,o);n.census.indPop+=a;var r=t.getTile(i,s).isPowered();Wh(t,i,s,o,r);var l=N.ROUTE_FOUND;if(a>u.getRandom(5)&&(l=n.trafficManager.makeTraffic(i,s,n.blockMaps,T.isResidential),l===N.NO_ROAD_FOUND)){var h=u.getRandom16()&1;oa(t,i,s,n.blockMaps,a,h,r);return}if(u.getChance(7)){var c=n.valves.indValve+(l===N.NO_ROAD_FOUND?-1e3:0);if(r||(c=-500),c>-350&&c-26380>u.getRandom16Signed()){Bh(t,i,s,n.blockMaps,a,u.getRandom16()&1,r);return}c<350&&c+26380<u.getRandom16Signed()&&oa(t,i,s,n.blockMaps,a,u.getRandom16()&1,r)}},"industrialFound"),aa={registerHandlers:function(t,i){t.addAction(T.isIndustrialZone,Uh)},getZonePopulation:sa},Gh=Object.defineProperty,pt=d((t,i)=>Gh(t,"name",{value:i,configurable:!0}),"u$e");const En=pt(function(t,i,s,n,o,a){const r=(o*4+n)*9+js;P.putZone(t,i,s,r,a)},"placeResidential"),Yh=pt(function(t,i,s,n){let o=0;for(let a=i-1;a<=i+1;a++)for(let r=s-1;r<=s+1;r++)a===i&&r===s||(n=t.getTileValue(a,r),n>=Xi&&n<=po&&(o+=1));return o},"getFreeZonePopulation"),ra=pt(function(t,i,s,n){return n instanceof G&&(n=tile.getValue()),n===De?Yh(t,i,s,n):(Math.floor((n-js)/9)%4+1)*8+16},"getZonePopulation"),zh=pt(function(t,i,s){const n=[0,1,0,-1],o=[-1,0,1,0];if(!t.testBounds(i,s))return-1;let a=t.getTileValue(i,s);if(a<Wt||a>Wt+8)return-1;let r=1;for(let l=0;l<4;l++){const h=i+n[l],c=s+o[l];h<0||h>=t.width||c<0||c>=t.height||(a=t.getTileValue(h,c),a!==R&&a<=zi&&(r+=1))}return r},"evalLot"),Xh=pt(function(t,i,s,n){let o=0,a=0;const r=[0,-1,0,1,-1,1,-1,0,1],l=[0,-1,-1,-1,0,0,1,1,1];for(let h=0;h<9;h++){const c=i+r[h],g=s+l[h],_=zh(t,c,g);_>a?(a=_,o=h):_===a&&u.getChance(7)&&(o=h)}o>0&&t.testBounds(i+r[o],s+l[o])&&t.setTile(i+r[o],s+l[o],uo+u.getRandom(2)+n*3,ui)},"buildHouse"),jh=pt(function(t,i,s,n,o,a,r){if(!(n.pollutionDensityMap.worldGet(i,s)>128)){if(t.getTileValue(i,s)===De){o<8?(Xh(t,i,s,a),P.incRateOfGrowth(n,i,s,1)):n.populationDensityMap.worldGet(i,s)>64&&(En(t,i,s,0,a,r),P.incRateOfGrowth(n,i,s,8));return}o<40&&(En(t,i,s,Math.floor(o/8)-1,a,r),P.incRateOfGrowth(n,i,s,8))}},"growZone"),Zh=[0,3,6,1,4,7,2,5,8],la=pt(function(t,i,s,n,o,a,r){let l,h;if(o===0)return;if(o>16){En(t,i,s,Math.floor((o-24)/8),a,r),P.incRateOfGrowth(n,i,s,-8);return}if(o===16){for(t.setTile(i,s,De,ui|Ce),h=s-1;h<=s+1;h++)for(l=i-1;l<=i+1;l++)l===i&&h===s||t.setTile(i,s,Xi+a+u.getRandom(2),ui);P.incRateOfGrowth(n,i,s,-8);return}let c=0;for(P.incRateOfGrowth(n,i,s,-1),l=i-1;l<=i+1;l++)for(h=s-1;h<=s+1;h++,c++){const g=t.getTileValue(l,h);if(g>=Xi&&g<=po){t.setTile(l,h,Zh[c]+Wt,ui);return}}},"degradeZone"),qh=pt(function(t,i,s,n){if(n===N.NO_ROAD_FOUND)return-3e3;let o=t.landValueMap.worldGet(i,s);return o-=t.pollutionDensityMap.worldGet(i,s),o<0?o=0:o=Math.min(o*32,6e3),o-3e3},"evalResidential"),Kh=pt(function(t,i,s,n){let o;n.census.resZonePop+=1;const a=t.getTileValue(i,s),r=ra(t,i,s,a);n.census.resPop+=r;const l=t.getTile(i,s).isPowered();let h=N.ROUTE_FOUND;if(r>u.getRandom(35)&&(h=n.trafficManager.makeTraffic(i,s,n.blockMaps,T.isCommercial),h===N.NO_ROAD_FOUND)){o=P.getLandPollutionValue(n.blockMaps,i,s),la(t,i,s,n.blockMaps,r,o,l);return}if(a===De||u.getChance(7)){const c=qh(n.blockMaps,i,s,h);let g=n.valves.resValve+c;if(l||(g=-500),g>-350&&g-26380>u.getRandom16Signed()){if(r===0&&u.getChance(3)){ha(t,i,s,n,l);return}o=P.getLandPollutionValue(n.blockMaps,i,s),jh(t,i,s,n.blockMaps,r,o,l);return}g<350&&g+26380<u.getRandom16Signed()&&(o=P.getLandPollutionValue(n.blockMaps,i,s),la(t,i,s,n.blockMaps,r,o,l))}},"residentialFound");function ha(t,i,s,n,o){n.census.needHospital>0&&(P.putZone(t,i,s,Zs,o),n.census.needHospital=0)}d(ha,"I$9"),pt(ha,"makeHospital");const Qh=pt(function(t,i,s,n){n.census.hospitalPop+=1,n.census.needHospital===-1&&u.getRandom(20)===0&&P.putZone(t,i,s,De,t.getTile(i,s).isPowered())},"hospitalFound"),ca={registerHandlers:function(t,i){t.addAction(T.isResidentialZone,Kh),t.addAction(Zs,Qh),i.addAction(Zs,15,3)},getZonePopulation:ra};var Jh=Object.defineProperty,ft=d((t,i)=>Jh(t,"name",{value:i,configurable:!0}),"d$c");const Xt=0,_i=1,ht=ft(function(t,i,s){for(let n=0,o=t.width;n<o;n++)for(let a=0,r=t.height;a<r;a++){let l=0;n>0&&(l+=t.get(n-1,a)),n<t.width-1&&(l+=t.get(n+1,a)),a>0&&(l+=t.get(n,a-1)),a<t.height-1&&(l+=t.get(n,a+1)),s===Xt?(l=t.get(n,a)+Math.floor(l/4),i.set(n,a,Math.floor(l/2))):(l=l+t.get(n,a)>>2,l>255&&(l=255),i.set(n,a,l))}},"smoothMap"),tc=ft(function(t){const i=t.rateOfGrowthMap;for(let s=0,n=i.width;s<n;s++)for(let o=0,a=i.height;o<a;o++){let r=i.get(s,o);r!==0&&(r>0?r--:r++,r=p.clamp(r,-200,200),i.set(s,o,r))}},"neutraliseRateOfGrowthMap"),ec=ft(function(t){const i=t.trafficDensityMap;for(let s=0,n=i.width;s<n;s++)for(let o=0,a=i.height;o<a;o++){let r=i.get(s,o);r!==0&&(r<=24?r=0:r>200?r=r-34:r=r-24,i.set(s,o,r))}},"neutraliseTrafficMap"),ic=ft(function(t){if(t<vt){if(t>=Xs)return 75;if(t>=zs)return 50;if(t<V){if(t>ro)return 90;if(t>=ii)return 255}return 0}return t<=al?0:t<Ut?50:t<=tn?100:0},"getPollutionValue"),da=ft(function(t,i,s){let n,o;return i>t.cityCentreX?n=i-t.cityCentreX:n=t.cityCentreX-i,s>t.cityCentreY?o=s-t.cityCentreY:o=t.cityCentreY-s,Math.min(n+o,64)},"getCityCentreDistance"),sc=ft(function(t,i,s){const n=s.tempMap1,o=s.tempMap2,a=s.tempMap3;a.clear();const r=s.landValueMap,l=s.terrainDensityMap,h=s.pollutionDensityMap,c=s.crimeRateMap;let g,_,v,S,C=0,A=0;for(g=0,v=r.width;g<v;g++)for(_=0,S=r.height;_<S;_++){let Q=0,Cr=!1;const oo=g*2,ao=_*2;for(let J=oo;J<=oo+1;J++)for(let Ui=ao;Ui<=ao+1;Ui++){const Hs=t.getTileValue(J,Ui);if(Hs!==R){if(Hs<Yi){const Bf=a.worldGet(J,Ui);a.worldSet(J,Ui,Bf+15);continue}Q+=ic(Hs),Hs>=V&&(Cr=!0)}}if(Q=Math.min(Q,255),n.set(g,_,Q),Cr){let J=34-Math.floor(da(t,oo,ao)/2);J=J<<2,J+=l.get(g>>1,_>>1),J-=h.get(g,_),c.get(g,_)>190&&(J-=20),J=p.clamp(J,1,250),r.set(g,_,J),C+=J,A++}else r.set(g,_,0)}A>0?i.landValueAverage=Math.floor(C/A):i.landValueAverage=0,ht(n,o,_i),ht(o,n,_i);let ot=0,Et=0,Tt=0;for(g=0,v=t.width;g<v;g+=h.blockSize)for(_=0,S=t.height;_<S;_+=h.blockSize){const Q=n.worldGet(g,_);h.worldSet(g,_,Q),Q!==0&&(Et++,Tt+=Q,(Q>ot||Q===ot&&u.getChance(3))&&(ot=Q,t.pollutionMaxX=g,t.pollutionMaxY=_))}Et?i.pollutionAverage=Math.floor(Tt/Et):i.pollutionAverage=0,ht(a,l,Xt)},"pollutionTerrainLandValueScan"),nc=ft(function(t,i){const s=i.policeStationMap,n=i.policeStationEffectMap,o=i.crimeRateMap,a=i.landValueMap,r=i.populationDensityMap;ht(s,n,Xt),ht(n,s,Xt),ht(s,n,Xt);let l=0,h=0;for(let v=0,S=o.mapWidth,C=o.blockSize;v<S;v+=C)for(var c=0,g=o.mapHeight,_;c<g;c+=C){let A=a.worldGet(v,c);A>0?(h+=1,A=128-A,A+=r.worldGet(v,c),A=Math.min(A,300),A-=s.worldGet(v,c),A=p.clamp(A,0,250),o.worldSet(v,c,A),l+=A):o.worldSet(v,c,0)}h>0?t.crimeAverage=Math.floor(l/h):t.crimeAverage=0},"crimeScan"),oc=ft(function(t,i){const s=i.cityCentreDistScoreMap;for(let n=0,o=s.width;n<o;n++)for(let a=0,r=s.height;a<r;a++){let l=Math.floor(da(t,n*8,a*8)/2);l=l*4,l=64-l,s.set(n,a,l)}},"fillCityCentreDistScoreMap"),ac=ft(function(t,i,s,n){return n<qs?ca.getZonePopulation(t,i,s,n):n<ji?ia.getZonePopulation(t,i,s,n)*8:n<Ut?aa.getZonePopulation(t,i,s,n)*8:0},"getPopulationDensity"),rc=ft(function(t,i){const s=i.tempMap1,n=i.tempMap2;i.populationDensityMap;let o=0,a=0,r=0;s.clear();for(let l=0,h=t.width;l<h;l++)for(let c=0,g=t.height;c<g;c++){const _=t.getTile(l,c);if(_.isZone()){const v=_.getValue();let S=ac(t,l,c,v)*8;S=Math.min(S,254),s.worldSet(l,c,S),o+=l,a+=c,r++}}ht(s,n,_i),ht(n,s,_i),ht(s,n,_i),i.populationDensityMap.copyFrom(n,function(l){return l*2}),oc(t,i),r>0?(t.cityCentreX=Math.floor(o/r),t.cityCentreY=Math.floor(a/r)):(t.cityCentreX=Math.floor(t.width/2),t.cityCentreY=Math.floor(t.height/2))},"populationDensityScan"),lc=ft(function(t){const i=t.fireStationMap,s=t.fireStationEffectMap;ht(i,s,Xt),ht(s,i,Xt),ht(i,s,Xt)},"fireAnalysis"),bt={crimeScan:nc,fireAnalysis:lc,neutraliseRateOfGrowthMap:tc,neutraliseTrafficMap:ec,pollutionTerrainLandValueScan:sc,populationDensityScan:rc},hc={debug:!1,gameDebug:!1,queryDebug:!1};var cc=Object.defineProperty,Ei=d((t,i)=>cc(t,"name",{value:i,configurable:!0}),"s$g");const nt=Ei(function(t){const i={},s=Ei(function(r,l){r in i||(i[r]=[]);const h=i[r];h.indexOf(l)===-1&&h.push(l)},"addListener"),n=Ei(function(r,l){r in i||(i[r]=[]);const h=i[r],c=h.indexOf(l);c!==-1&&h.splice(c,1)},"removeListener"),o=Ei(function(r,l){r===void 0&&console.warn("Sending undefined event!"),r in i||(i[r]=[]);const h=i[r];for(let c=0,g=h.length;c<g;c++)h[c](l)},"emitEvent"),a=Ei(function(r,l){if(["addEventListener","removeEventListener","_emitEvent"].some(function(h){return r[h]!==void 0}))throw new Error("Cannot decorate "+l+": existing properties would be overwritten!");r.addEventListener=s,r.removeEventListener=n,r._emitEvent=o},"addProps");return typeof t=="object"?a(t,"object"):a(t.prototype,"constructor"),t},"EventEmitter"),Tn="Autobudget changed",xe="User needs to budget",ua="Budget window requested",wn="Budget window closed",rs="Blackouts reported",vn="Classification updated",dc="Congratulations showing",uc="Congratulations window closed",Sn="Date changed",pa="Debug Window Requested",yn="Debug Window Closed",fa="Disaster Requested",Dn="Disaster window closed",Ti="Earthquake",ga="Evaluation Requested",pc="Evaluation Updated",bn="Eval window closed",wi="Explosion Reported",vi="Fire!",ls="Fire station needs funding",Si="Flooding reported",L="Front-end Message",Ne="Total funds has changed",jt="Total funds has changed",yi="Helicopter crashed",hs="High crime",cs="High pollution",Di="Monster sighted",fc="Nag window closed",ds="Airport needed",us="More power needed",ps="Fire station needed",fs="More commercial zones needed",gs="More industrial zones needed",ms="More railways needed",_s="More residential needed",Es="More roads needed",Ts="Police station needed",ws="Seaport needed",vs="Stadium needed",ae="No money",Ve="Not enough power",bi="Nuclear Meltdown",Oi="Plane crashed",Ss="Police need funding",On="Population updated",Cn="Query window closed",re="Query window needed",Ci="Now a capital",Ri="Now a city",Mi="Now a metropolis",$i="Now a megalopolis",Pi="Now a town",ma="Now a village",ys="Roads need funding",_a="Save requested",Rn="Save window closed",Mn="Scoe updated",$n="Screenshot link closed",Pn="Screenshot window closed",Ea="Screenshot window requested",An="Settings window closed",Ta="Settings window requested",Ai="Shipwrecked",Ds="Explosion! Bang!",Ln="Explosion! Bang!",wa="Heavy Traffic sound",va="HonkHonk sound",Sa="Monster sound",In="Speed change",le="Sprite dying",Fe="Sprite move",bs="Tax too high",Li="Tool clicked",Be="Tornado sighted",kn="Touch Window closed",Os="Traffic jams reported",Ii="Train crashed",He="Valves updated",xn="Welcome",he=[Ti,wi,vi,Si,Di,bi,Be],ce=[yi,Oi,Ai,Ii];var ya=Object.freeze({__proto__:null,AUTOBUDGET_CHANGED:Tn,BUDGET_NEEDED:xe,BUDGET_REQUESTED:ua,BUDGET_WINDOW_CLOSED:wn,BLACKOUTS_REPORTED:rs,CLASSIFICATION_UPDATED:vn,CONGRATS_SHOWING:dc,CONGRATS_WINDOW_CLOSED:uc,DATE_UPDATED:Sn,DEBUG_WINDOW_REQUESTED:pa,DEBUG_WINDOW_CLOSED:yn,DISASTER_REQUESTED:fa,DISASTER_WINDOW_CLOSED:Dn,EARTHQUAKE:Ti,EVAL_REQUESTED:ga,EVAL_UPDATED:pc,EVAL_WINDOW_CLOSED:bn,EXPLOSION_REPORTED:wi,FIRE_REPORTED:vi,FIRE_STATION_NEEDS_FUNDING:ls,FLOODING_REPORTED:Si,FRONT_END_MESSAGE:L,FUNDS_CHANGED:Ne,HEAVY_TRAFFIC:jt,HELICOPTER_CRASHED:yi,HIGH_CRIME:hs,HIGH_POLLUTION:cs,MONSTER_SIGHTED:Di,NAG_WINDOW_CLOSED:fc,NEED_AIRPORT:ds,NEED_ELECTRICITY:us,NEED_FIRE_STATION:ps,NEED_MORE_COMMERCIAL:fs,NEED_MORE_INDUSTRIAL:gs,NEED_MORE_RAILS:ms,NEED_MORE_RESIDENTIAL:_s,NEED_MORE_ROADS:Es,NEED_POLICE_STATION:Ts,NEED_SEAPORT:ws,NEED_STADIUM:vs,NO_MONEY:ae,NOT_ENOUGH_POWER:Ve,NUCLEAR_MELTDOWN:bi,PLANE_CRASHED:Oi,POLICE_NEEDS_FUNDING:Ss,POPULATION_UPDATED:On,QUERY_WINDOW_CLOSED:Cn,QUERY_WINDOW_NEEDED:re,REACHED_CAPITAL:Ci,REACHED_CITY:Ri,REACHED_METROPOLIS:Mi,REACHED_MEGALOPOLIS:$i,REACHED_TOWN:Pi,REACHED_VILLAGE:ma,ROAD_NEEDS_FUNDING:ys,SAVE_REQUESTED:_a,SAVE_WINDOW_CLOSED:Rn,SCORE_UPDATED:Mn,SCREENSHOT_LINK_CLOSED:$n,SCREENSHOT_WINDOW_CLOSED:Pn,SCREENSHOT_WINDOW_REQUESTED:Ea,SETTINGS_WINDOW_CLOSED:An,SETTINGS_WINDOW_REQUESTED:Ta,SHIP_CRASHED:Ai,SOUND_EXPLOSIONHIGH:Ds,SOUND_EXPLOSIONLOW:Ln,SOUND_HEAVY_TRAFFIC:wa,SOUND_HONKHONK:va,SOUND_MONSTER:Sa,SPEED_CHANGE:In,SPRITE_DYING:le,SPRITE_MOVED:Fe,TAX_TOO_HIGH:bs,TOOL_CLICKED:Li,TORNADO_SIGHTED:Be,TOUCH_WINDOW_CLOSED:kn,TRAFFIC_JAMS:Os,TRAIN_CRASHED:Ii,VALVES_UPDATED:He,WELCOME:xn,DISASTER_MESSAGES:he,CRASHES:ce});const gc=100,mc=100,_c=1,Ec=2,et=nt(function(){Object.defineProperties(this,{MAX_ROAD_EFFECT:p.makeConstantDescriptor(32),MAX_POLICESTATION_EFFECT:p.makeConstantDescriptor(1e3),MAX_FIRESTATION_EFFECT:p.makeConstantDescriptor(1e3)}),this.roadEffect=this.MAX_ROAD_EFFECT,this.policeEffect=this.MAX_POLICESTATION_EFFECT,this.fireEffect=this.MAX_FIRESTATION_EFFECT,this.totalFunds=0,this.cityTax=7,this.cashFlow=0,this.taxFund=0,this.roadMaintenanceBudget=0,this.fireMaintenanceBudget=0,this.policeMaintenanceBudget=0,this.roadPercent=1,this.firePercent=1,this.policePercent=1,this.roadSpend=0,this.fireSpend=0,this.policeSpend=0,this.awaitingValues=!1,this.autoBudget=!0}),We=["autoBudget","totalFunds","policePercent","roadPercent","firePercent","roadSpend","policeSpend","fireSpend","roadMaintenanceBudget","policeMaintenanceBudget","fireMaintenanceBudget","cityTax","roadEffect","policeEffect","fireEffect"];et.prototype.save=function(t){for(let i=0,s=We.length;i<s;i++)t[We[i]]=this[We[i]]},et.prototype.load=function(t){for(let i=0,s=We.length;i<s;i++)this[We[i]]=t[We[i]];this._emitEvent(Tn,this.autoBudget),this._emitEvent(Ne,this.totalFunds)},et.prototype.setAutoBudget=function(t){this.autoBudget=t,this._emitEvent(Tn,this.autoBudget)};const Tc=[.7,.9,1.2],wc=[1.4,1.2,.8];et.prototype._calculateBestPercentages=function(){if(this.roadSpend=Math.round(this.roadMaintenanceBudget*this.roadPercent),this.fireSpend=Math.round(this.fireMaintenanceBudget*this.firePercent),this.policeSpend=Math.round(this.policeMaintenanceBudget*this.policePercent),this.roadSpend+this.fireSpend+this.policeSpend===0)return this.roadPercent=1,this.firePercent=1,this.policePercent=1,{road:1,fire:1,police:1};let t=0,i=0,s=0,n=this.totalFunds+this.taxFund;return n>=this.roadSpend?t=this.roadSpend:t=n,n-=t,n>=this.fireSpend?i=this.fireSpend:i=n,n-=i,n>=this.policeSpend?s=this.policeSpend:s=n,n-=s,this.roadMaintenanceBudget>0?this.roadPercent=(t/this.roadMaintenanceBudget).toPrecision(2)-0:this.roadPercent=1,this.fireMaintenanceBudget>0?this.firePercent=(i/this.fireMaintenanceBudget).toPrecision(2)-0:this.firePercent=1,this.policeMaintenanceBudget>0?this.policePercent=(s/this.policeMaintenanceBudget).toPrecision(2)-0:this.policePercent=1,{road:t,police:s,fire:i}},et.prototype.doBudgetWindow=function(){return this.doBudgetNow(!0)},et.prototype.doBudgetNow=function(t){const i=this._calculateBestPercentages();if(!this.autoBudget&&!t){this.autoBudget=!1,this.awaitingValues=!0,this._emitEvent(xe);return}const s=i.road,n=i.police,o=i.fire,a=s+n+o;if(this.totalFunds+this.taxFund-a>0&&this.autoBudget||t){this.awaitingValues=!1,this.doBudgetSpend(s,o,n);return}this.setAutoBudget(!1),this.awaitingValues=!0,this._emitEvent(xe),this._emitEvent(ae)},et.prototype.doBudgetSpend=function(t,i,s){this.roadSpend=t,this.fireSpend=i,this.policeSpend=s;const n=this.roadSpend+this.fireSpend+this.policeSpend;this.spend(-(this.taxFund-n)),this.updateFundEffects()},et.prototype.updateFundEffects=function(){this.roadSpend=Math.round(this.roadMaintenanceBudget*this.roadPercent),this.fireSpend=Math.round(this.fireMaintenanceBudget*this.firePercent),this.policeSpend=Math.round(this.policeMaintenanceBudget*this.policePercent),this.roadEffect=this.MAX_ROAD_EFFECT,this.policeEffect=this.MAX_POLICESTATION_EFFECT,this.fireEffect=this.MAX_FIRESTATION_EFFECT,this.roadMaintenanceBudget>0&&(this.roadEffect=Math.floor(this.roadEffect*this.roadSpend/this.roadMaintenanceBudget)),this.fireMaintenanceBudget>0&&(this.fireEffect=Math.floor(this.fireEffect*this.fireSpend/this.fireMaintenanceBudget)),this.policeMaintenanceBudget>0&&(this.policeEffect=Math.floor(this.policeEffect*this.policeSpend/this.policeMaintenanceBudget))},et.prototype.collectTax=function(t,i){this.cashFlow=0,this.policeMaintenanceBudget=i.policeStationPop*gc,this.fireMaintenanceBudget=i.fireStationPop*mc;const s=i.roadTotal*_c,n=i.railTotal*Ec;this.roadMaintenanceBudget=Math.floor((s+n)*Tc[t]),this.taxFund=Math.floor(Math.floor(i.totalPop*i.landValueAverage/120)*this.cityTax*wc[t]),i.totalPop>0?(this.cashFlow=this.taxFund-(this.policeMaintenanceBudget+this.fireMaintenanceBudget+this.roadMaintenanceBudget),this.doBudgetNow(!1)):(this.roadEffect=this.MAX_ROAD_EFFECT,this.policeEffect=this.MAX_POLICESTATION_EFFECT,this.fireEffect=this.MAX_FIRESTATION_EFFECT)},et.prototype.setTax=function(t){t!==this.cityTax&&(this.cityTax=t)},et.prototype.setFunds=function(t){t!==this.totalFunds&&(this.totalFunds=Math.max(0,t),this._emitEvent(Ne,this.totalFunds),this.totalFunds===0&&this._emitEvent(ae))},et.prototype.spend=function(t){this.setFunds(this.totalFunds-t)},et.prototype.shouldDegradeRoad=function(){return this.roadEffect<Math.floor(15*this.MAX_ROAD_EFFECT/16)};var vc=Object.defineProperty,Cs=d((t,i)=>vc(t,"name",{value:i,configurable:!0}),"n$i");const de=["res","com","ind","crime","money","pollution"];function ue(){this.clearCensus(),this.changed=!1,this.crimeRamp=0,this.pollutionRamp=0,this.landValueAverage=0,this.pollutionAverage=0,this.crimeAverage=0,this.totalPop=0;const t=Cs(function(i){this[i]=[];for(let s=0;s<120;s++)this[i][s]=0},"createArray");for(let i=0;i<de.length;i++){const s=de[i]+"Hist10",n=de[i]+"Hist120";t.call(this,s),t.call(this,n)}}d(ue,"e$9"),Cs(ue,"Census");const Sc=Cs(function(){for(let t=0;t<de.length;t++){const i=de[t]+"Hist10";this[i].pop(),this[i].unshift(0)}},"rotate10Arrays"),yc=Cs(function(){for(let t=0;t<de.length;t++){const i=de[t]+"Hist120";this[i].pop(),this[i].unshift(0)}},"rotate120Arrays");ue.prototype.clearCensus=function(){this.poweredZoneCount=0,this.unpoweredZoneCount=0,this.firePop=0,this.roadTotal=0,this.railTotal=0,this.resPop=0,this.comPop=0,this.indPop=0,this.resZonePop=0,this.comZonePop=0,this.indZonePop=0,this.hospitalPop=0,this.churchPop=0,this.policeStationPop=0,this.fireStationPop=0,this.stadiumPop=0,this.coalPowerPop=0,this.nuclearPowerPop=0,this.seaportPop=0,this.airportPop=0};const Ue=["resPop","comPop","indPop","crimeRamp","pollutionRamp","landValueAverage","pollutionAverage","crimeAverage","totalPop","resHist10","resHist120","comHist10","comHist120","indHist10","indHist120","crimeHist10","crimeHist120","moneyHist10","moneyHist120","pollutionHist10","pollutionHist120"];ue.prototype.save=function(t){for(let i=0,s=Ue.length;i<s;i++)t[Ue[i]]=this[Ue[i]]},ue.prototype.load=function(t){for(let i=0,s=Ue.length;i<s;i++)this[Ue[i]]=t[Ue[i]]},ue.prototype.take10Census=function(t){Sc.call(this),this.resHist10[0]=Math.floor(this.resPop/8),this.comHist10[0]=this.comPop,this.indHist10[0]=this.indPop,this.crimeRamp+=Math.floor((this.crimeAverage-this.crimeRamp)/4),this.crimeHist10[0]=Math.min(this.crimeRamp,255),this.pollutionRamp+=Math.floor((this.pollutionAverage-this.pollutionRamp)/4),this.pollutionHist10[0]=Math.min(this.pollutionRamp,255);const i=Math.floor(t.cashFlow/20)+128;this.moneyHist10[0]=p.clamp(i,0,255),this.resPop>>8,this.hospitalPop<this.resPopScaled?this.needHospital=1:this.hospitalPop>this.resPopScaled?this.needHospital=-1:this.hospitalPop===this.resPopScaled&&(this.needHospital=0),this.changed=!0},ue.prototype.take120Census=function(){yc.call(this);const t=8;this.resHist120[0]=Math.floor(this.resPop/t),this.comHist120[0]=this.comPop,this.indHist120[0]=this.indPop,this.crimeHist120[0]=this.crimeHist10[0],this.pollutionHist120[0]=this.pollutionHist10[0],this.moneyHist120[0]=this.moneyHist10[0],this.changed=!0};var Dc=Object.defineProperty,bc=d((t,i)=>Dc(t,"name",{value:i,configurable:!0}),"u$c");const gt=nt(function(t,i,s){this._map=t,this._spriteManager=i,this._gameLevel=s,this._floodCount=0,this.disastersEnabled=!1}),Oc=[479,239,59];gt.prototype.doDisasters=function(t){if(this._floodCount&&this._floodCount--,!!this.disastersEnabled&&!u.getRandom(Oc[this._gameLevel]))switch(u.getRandom(8)){case 0:case 1:this.setFire();break;case 2:case 3:this.makeFlood();break;case 4:break;case 5:this._spriteManager.makeTornado();break;case 6:break;case 7:case 8:t.pollutionAverage>60&&this._spriteManager.makeMonster();break}},gt.prototype.scenarioDisaster=function(){},gt.prototype.makeMeltdown=function(){for(let t=0;t<this._map.width-1;t++)for(let i=0;i<this._map.height-1;i++)if(this._map.getTileValue(t,i)===Pt){this.doMeltdown(t,i);return}};const Cc=bc(function(t){const i=t.getValue();return!(i<Wt||i>sn||t.isZone())},"vulnerable");gt.prototype.makeEarthquake=function(){const t=u.getRandom(700)+300;this.doEarthquake(t),this._emitEvent(Ti,{x:this._map.cityCenterX,y:this._map.cityCenterY});for(let i=0;i<t;i++){const s=u.getRandom(this._map.width-1),n=u.getRandom(this._map.height-1);!this._map.testBounds(s,n)||Cc(this._map.getTile(s,n))&&((i&3)!==0?this._map.setTo(s,n,T.randomRubble()):this._map.setTo(s,n,T.randomFire()))}},gt.prototype.setFire=function(t,i){t=t||1,i=i||!1;for(let s=0;s<t;s++){const n=u.getRandom(this._map.width-1),o=u.getRandom(this._map.height-1);if(!this._map.testBounds(n,o))continue;let a=this._map.getTile(n,o);if(!a.isZone()&&(a=a.getValue(),a>(i?Xi:Gi)&&a<sn)){this._map.setTo(n,o,T.randomFire()),this._emitEvent(vi,{showable:!0,x:n,y:o});return}}},gt.prototype.makeCrash=function(){let t=this._spriteManager.getSprite(It);if(t!==null){t.explodeSprite();return}const i=u.getRandom(this._map.width-1),s=u.getRandom(this._map.height-1);this._spriteManager.generatePlane(i,s),t=this._spriteManager.getSprite(It),t.explodeSprite()},gt.prototype.makeFire=function(){this.setFire(40,!1)};const Da=[0,1,0,-1],ba=[-1,0,1,0];gt.prototype.makeFlood=function(){for(let t=0;t<300;t++){const i=u.getRandom(this._map.width-1),s=u.getRandom(this._map.height-1);if(!this._map.testBounds(i,s))continue;let n=this._map.getTileValue(i,s);if(n>W&&n<=ve)for(let o=0;o<4;o++){const a=i+Da[o],r=s+ba[o];if(!this._map.testBounds(a,r))continue;const l=this._map.getTile(a,r);if(n=l.getValue(),l===R||l.isBulldozable()&&l.isCombustible){this._map.setTile(a,r,se,0),this._floodCount=30,this._emitEvent(Si,{showable:!0,x:a,y:r});return}}}},gt.prototype.doFlood=function(t,i,s){if(this._floodCount>0){for(let n=0;n<4;n++)if(u.getChance(7)){const o=t+Da[n],a=i+ba[n];if(this._map.testBounds(o,a)){const r=this._map.getTile(o,a),l=r.getValue();(r.isCombustible()||l===R||l>=Ar&&l<se)&&(r.isZone()&&P.fireZone(this._map,o,a,s),this._map.setTile(o,a,se+u.getRandom(2),0))}}}else u.getChance(15)&&this._map.setTile(t,i,R,0)},gt.prototype.doMeltdown=function(t,i){this._spriteManager.makeExplosion(t-1,i-1),this._spriteManager.makeExplosion(t-1,i+2),this._spriteManager.makeExplosion(t+2,i-1),this._spriteManager.makeExplosion(t+2,i+2);let s,n;for(n=t-1;n<t+3;n++)for(s=i-1;s<i+3;s++)this._map.setTo(n,s,T.randomFire());for(let o=0;o<200;o++){if(n=t-20+u.getRandom(40),s=i-15+u.getRandom(30),!this._map.testBounds(n,s))continue;const a=this._map.getTile(n,s);a.isZone()||(a.isCombustible()||a.getValue()===R)&&this._map.setTile(n,s,ii,0)}this._emitEvent(bi,{showable:!0,x:t,y:i})};var Rc=Object.defineProperty,Mc=d((t,i)=>Rc(t,"name",{value:i,configurable:!0}),"d$a");const Oa=Mc(function(t,i,s){return function(n,o,a,r){r.census[t]+=1;let l=r.budget[i];n.getTile(o,a).isPowered()||(l=Math.floor(l/2));const h=new O(o,a);r.trafficManager.findPerimeterRoad(h)||(l=Math.floor(l/2));let c=r.blockMaps[s].worldGet(o,a);c+=l,r.blockMaps[s].worldSet(o,a,c)}},"handleService"),$c=Oa("policeStationPop","policeEffect","policeStationMap"),Pc=Oa("fireStationPop","fireEffect","fireStationMap"),Ac={registerHandlers:function(t,i){t.addAction(en,$c),t.addAction(mo,Pc)}};var Lc=Object.defineProperty,Nn=d((t,i)=>Lc(t,"name",{value:i,configurable:!0}),"P$3"),Ic=["CVP_CRIME","CVP_POLLUTION","CVP_HOUSING","CVP_TAXES","CVP_TRAFFIC","CVP_UNEMPLOYMENT","CVP_FIRE"],Ge=Ic.length,Vn=4,Ot=[],w=nt(function(t){this.problemVotes=[],this.problemOrder=[],this.evalInit(),this.gameLevel=""+t});w.prototype.cityEvaluation=function(t){var i=t.census;if(i.totalPop>0){for(var s=0;s<Ge;s++)Ot.push(0);this.getAssessedValue(i),this.getPopulation(i),this.doProblems(t.census,t.budget,t.blockMaps),this.getScore(t),this.doVotes()}else this.evalInit(),this.cityYes=50},w.prototype.evalInit=function(){this.cityYes=0,this.cityPop=0,this.cityPopDelta=0,this.cityAssessedValue=0,this.cityClass=w.CC_VILLAGE,this.cityClassLast=w.CC_VILLAGE,this.cityScore=500,this.cityScoreDelta=0;for(var t=0;t<Ge;t++)this.problemVotes[t]={index:t,voteCount:0};for(t=0;t<Vn;t++)this.problemOrder[t]=Ge};var Ye=["cityClass","cityScore"];w.prototype.save=function(t){for(var i=0,s=Ye.length;i<s;i++)t[Ye[i]]=this[Ye[i]]},w.prototype.load=function(t){for(var i=0,s=Ye.length;i<s;i++)this[Ye[i]]=t[Ye[i]]},w.prototype.getAssessedValue=function(t){var i;i=t.roadTotal*5,i+=t.railTotal*10,i+=t.policeStationPop*1e3,i+=t.fireStationPop*1e3,i+=t.hospitalPop*400,i+=t.stadiumPop*3e3,i+=t.seaportPop*5e3,i+=t.airportPop*1e4,i+=t.coalPowerPop*3e3,i+=t.nuclearPowerPop*6e3,this.cityAssessedValue=i*1e3},w.prototype.getPopulation=function(t){var i=this.cityPop;return this.cityPop=(t.resPop+(t.comPop+t.indPop)*8)*20,this.cityPopDelta=this.cityPop-i,this.cityPopDelta!==0&&this._emitEvent(On,this.cityPop),this.cityPop},w.prototype.getCityClass=function(t){return this.cityClass=w.CC_VILLAGE,t>2e3&&(this.cityClass=w.CC_TOWN),t>1e4&&(this.cityClass=w.CC_CITY),t>5e4&&(this.cityClass=w.CC_CAPITAL),t>1e5&&(this.cityClass=w.CC_METROPOLIS),t>5e5&&(this.cityClass=w.CC_MEGALOPOLIS),this.cityClass!==this.cityClassLast&&(this.cityClassLast=this.cityClass,this._emitEvent(vn,this.cityClass)),this.cityClass},w.prototype.voteProblems=function(){for(var t=0;t<Ge;t++)this.problemVotes[t].index=t,this.problemVotes[t].voteCount=0;for(var i=0,s=0,n=0;s<100&&n<600;){var o=u.getRandom(300);Ot[i]>o&&(this.problemVotes[i].voteCount+=1,s++),i=(i+1)%Ge,n++}};var kc=Nn(function(t,i){for(var s=t.trafficDensityMap,n=t.landValueMap,o=0,a=1,r=0;r<n.gameMapWidth;r+=n.blockSize)for(var l=0;l<n.gameMapHeight;l+=n.blockSize)n.worldGet(r,l)>0&&(o+=s.worldGet(r,l),a++);var h=i.trafficAverage=Math.floor(o/a)*2.4;return h},"getTrafficAverage"),xc=Nn(function(t){var i=(t.comPop+t.indPop)*8;if(i===0)return 0;var s=t.resPop/i;return i=Math.round((s-1)*255),Math.min(i,255)},"getUnemployment"),Ca=Nn(function(t){return Math.min(t.firePop*5,255)},"getFireSeverity");w.prototype.doProblems=function(t,i,s){Ot[w.CRIME]=t.crimeAverage,Ot[w.POLLUTION]=t.pollutionAverage,Ot[w.HOUSING]=t.landValueAverage*7/10,Ot[w.TAXES]=i.cityTax*10,Ot[w.TRAFFIC]=kc(s,t),Ot[w.UNEMPLOYMENT]=xc(t),Ot[w.FIRE]=Ca(t),this.voteProblems(),this.problemVotes.sort(function(n,o){return o.voteCount-n.voteCount}),this.problemOrder=this.problemVotes.map(function(n,o){return o>=Vn||n.voteCount===0?null:n.index})},w.prototype.getScore=function(t){for(var i=t.census,s=t.budget,n=t.valves,o=this.cityScore,a=0,r=0;r<Ge;r++)a+=Ot[r];a=Math.floor(a/3),a=(250-Math.min(a,250))*4;var l=.85;n.resCap&&(a=Math.round(a*l)),n.comCap&&(a=Math.round(a*l)),n.indCap&&(a=Math.round(a*l)),s.roadEffect<s.MAX_ROAD_EFFECT&&(a-=s.MAX_ROAD_EFFECT-s.roadEffect),s.policeEffect<s.MAX_POLICE_STATION_EFFECT&&(a=Math.round(a*(.9+s.policeEffect/(10*s.MAX_POLICE_STATION_EFFECT)))),s.fireEffect<s.MAX_FIRE_STATION_EFFECT&&(a=Math.round(a*(.9+s.fireEffect/(10*s.MAX_FIRE_STATION_EFFECT)))),n.resValve<-1e3&&(a=Math.round(a*.85)),n.comValve<-1e3&&(a=Math.round(a*.85)),n.indValve<-1e3&&(a=Math.round(a*.85));var h=1;this.cityPop===0||this.cityPopDelta===0||this.cityPopDelta===this.cityPop?h=1:this.cityPopDelta>0?h=this.cityPopDelta/this.cityPop+1:this.cityPopDelta<0&&(h=.95+Math.floor(this.cityPopDelta/(this.cityPop-this.cityPopDelta))),a=Math.round(a*h),a=a-Ca(i)-s.cityTax,h=i.unpoweredZoneCount+i.poweredZoneCount,h>0&&(a=Math.round(a*(i.poweredZoneCount/h))),a=p.clamp(a,0,1e3),this.cityScore=Math.round((this.cityScore+a)/2),this.cityScoreDelta=this.cityScore-o,this.cityScoreDelta!==0&&this._emitEvent(Mn,this.cityScore)},w.prototype.doVotes=function(){this.cityYes=0;for(var t=0;t<100;t++){var i=u.getRandom(1e3);this.cityScore>i&&this.cityYes++}},w.prototype.getProblemNumber=function(t){return t<0||t>=Vn?null:this.problemOrder[t]},Object.defineProperties(w,{CC_VILLAGE:p.makeConstantDescriptor("VILLAGE"),CC_TOWN:p.makeConstantDescriptor("TOWN"),CC_CITY:p.makeConstantDescriptor("CITY"),CC_CAPITAL:p.makeConstantDescriptor("CAPITAL"),CC_METROPOLIS:p.makeConstantDescriptor("METROPOLIS"),CC_MEGALOPOLIS:p.makeConstantDescriptor("MEGALOPOLIS"),CRIME:p.makeConstantDescriptor(0),POLLUTION:p.makeConstantDescriptor(1),HOUSING:p.makeConstantDescriptor(2),TAXES:p.makeConstantDescriptor(3),TRAFFIC:p.makeConstantDescriptor(4),UNEMPLOYMENT:p.makeConstantDescriptor(5),FIRE:p.makeConstantDescriptor(6)});var Nc=Object.defineProperty,Ra=d((t,i)=>Nc(t,"name",{value:i,configurable:!0}),"s$e");const ze=new G;function Rs(t){this._map=t,this._actions=[]}d(Rs,"p$c"),Ra(Rs,"MapScanner");const Vc=Ra(function(t){return typeof t=="function"},"isCallable");Rs.prototype.addAction=function(t,i){this._actions.push({criterion:t,action:i})},Rs.prototype.mapScan=function(t,i,s){for(let n=0;n<this._map.height;n++)for(let o=t;o<i;o++){this._map.getTile(o,n,ze);const a=ze.getValue();if(!(a<se)){ze.isConductive()&&s.powerManager.setTilePower(o,n),ze.isZone()&&(s.repairManager.checkTile(o,n,s.cityTime),ze.isPowered()?s.census.poweredZoneCount+=1:s.census.unpoweredZoneCount+=1);for(let r=0,l=this._actions.length;r<l;r++){const h=this._actions[r],c=Vc(h.criterion);if(c&&h.criterion.call(null,ze)){h.action.call(null,this._map,o,n,s);break}else if(!c&&h.criterion===a){h.action.call(null,this._map,o,n,s);break}}}}};var Fc=Object.defineProperty,Fn=d((t,i)=>Fc(t,"name",{value:i,configurable:!0}),"s$d");const Bc=[-1,0,1,0],Hc=[0,-1,0,1],Wc=Fn(function(t,i,s,n){if(n.census.firePop+=1,(u.getRandom16()&3)!==0)return;for(let r=0;r<4;r++)if(u.getChance(7)){const l=i+Bc[r],h=s+Hc[r];if(t.testBounds(l,h)){const c=t.getTile(i,s);if(!c.isCombustible())continue;c.isZone()&&(P.fireZone(t,i,s,n.blockMaps),c.getValue()>ri&&n.spriteManager.makeExplosionAt(i,s)),t.setTo(T.randomFire())}}let o=10,a=n.blockMaps.fireStationEffectMap.worldGet(i,s);a>100?o=1:a>20?o=2:a>0&&(o=3),u.getRandom(o)===0&&t.setTo(i,s,T.randomRubble())},"fireFound"),Uc=Fn(function(t,i,s,n){u.getChance(4095)&&t.setTile(i,s,R,0)},"radiationFound"),Gc=Fn(function(t,i,s,n){n.disasterManager.doFlood(i,s,n.blockMaps)},"floodFound"),Yc={registerHandlers:function(t,i){t.addAction(T.isFire,Wc,!0),t.addAction(ii,Uc,!0),t.addAction(T.isFlood,Gc,!0)}},zc=700,Xc=2e3,Zt=nt(function(t){this._map=t,this._powerStack=[],this.powerGridMap=new Y(this._map.width,this._map.height,1)});Zt.prototype.setTilePower=function(t,i){const s=this._map.getTile(t,i),n=s.getValue();if(n===Pt||n===Gt||this.powerGridMap.worldGet(t,i)>0){s.addFlags(At);return}s.removeFlags(At)},Zt.prototype.clearPowerStack=function(){this._powerStackPointer=0,this._powerStack=[]},Zt.prototype.testForConductive=function(t,i){const s=O.move(t,i);return!!(this._map.isPositionInBounds(s)&&this._map.getTile(s.x,s.y).isConductive()&&this.powerGridMap.worldGet(s.x,s.y)===0)},Zt.prototype.doPowerScan=function(t){this.powerGridMap.clear();const i=t.coalPowerPop*zc+t.nuclearPowerPop*Xc;let s=0;for(;this._powerStack.length>0;){var n=this._powerStack.pop(),o=void 0,a;do{if(s++,s>i){this._emitEvent(Ve);return}o&&(n=O.move(n,o)),this.powerGridMap.worldSet(n.x,n.y,1),a=0,Oe(r=>{a>=2||this.testForConductive(n,r)&&(a++,o=r)}),a>1&&this._powerStack.push(new O(n.x,n.y))}while(a)}},Zt.prototype.coalPowerFound=function(t,i,s,n){n.census.coalPowerPop+=1,this._powerStack.push(new O(i,s));const o=[-1,2,1,2],a=[-1,-1,0,0];for(let r=0;r<4;r++)t.addTileFlags(i+o[r],s+a[r],Z)};const jc=[3e4,2e4,1e4];Zt.prototype.nuclearPowerFound=function(t,i,s,n){if(n.disasterManager.disastersEnabled&&u.getRandom(jc[n.gameLevel])===0){n.disasterManager.doMeltdown(i,s);return}n.census.nuclearPowerPop+=1,this._powerStack.push(new O(i,s));for(let o=0;o<4;o++)t.addTileFlags(i,s,Z|k|At|M)},Zt.prototype.registerHandlers=function(t,i){t.addAction(Gt,this.coalPowerFound.bind(this)),t.addAction(Pt,this.nuclearPowerFound.bind(this)),i.addAction(Gt,7,4),i.addAction(Pt,7,4)};var Zc=Object.defineProperty,Ma=d((t,i)=>Zc(t,"name",{value:i,configurable:!0}),"p$b");function ki(t){this._map=t,this._actions=[]}d(ki,"a$f"),Ma(ki,"RepairManager");const qc=Ma(function(t){return typeof t=="function"},"isCallable");ki.prototype.addAction=function(t,i,s){this._actions.push({criterion:t,period:i,zoneSize:s})},ki.prototype.repairZone=function(t,i,s){let n=this._map.getTileValue(t,i)-s-2;for(let o=-1;o<s-1;o++)for(let a=-1;a<s-1;a++){n++;const r=this._map.getTile(t+a,i+o);if(r.isZone()||r.isAnimated())continue;const l=r.getValue();(l<Yi||l>=V)&&this._map.setTile(t+a,i+o,n,k|M)}},ki.prototype.checkTile=function(t,i,s){for(let n=0,o=this._actions.length;n<o;n++){const a=this._actions[n],r=a.period;if((s&r)!==0)continue;const l=this._map.getTile(t,i),h=l.getValue(),c=qc(a.criterion);c&&a.criterion.call(null,l)?this.repairZone(t,i,a.zoneSize):!c&&a.criterion===h&&this.repairZone(t,i,a.zoneSize)}};var Kc=Object.defineProperty,Ms=d((t,i)=>Kc(t,"name",{value:i,configurable:!0}),"a$e");const $a=Ms(function(t,i,s,n,o,a,r){for(let l=0;l<7;l++){const h=i+n[l],c=s+o[l];t.testBounds(h,c)&&t.getTileValue(h,c)===(a[l]&ns)&&t.setTileValue(h,c,r[l])}},"openBridge"),Pa=Ms(function(t,i,s,n,o,a,r){for(let l=0;l<7;l++){const h=i+n[l],c=s+o[l];if(t.testBounds(h,c)){const g=t.getTileValue(h,c);(g===W||(g&15)===(a[l]&15))&&t.setTileValue(h,c,r[l])}}},"closeBridge"),Aa=[0,1,0,0,0,0,1],La=[-2,-2,-1,0,1,2,2],Ia=[rn|m,Do|m,f,ye|m,f,bo|m,Oo|m],ka=[rt|m,f,rt|m,rt|m,rt|m,rt|m,f],xa=[-2,2,-2,-1,0,1,2],Na=[-1,-1,0,0,0,0,0],Va=[To|m,vo|m,nn|m,f,Se|m,f,wo|m],Fa=[f,f,at|m,at|m,at|m,at|m,at|m],Qc=Ms(function(t,i,s,n,o){if(n===ye)return u.getChance(3)&&o.spriteManager.getBoatDistance(i,s)>340&&Pa(t,i,s,Aa,La,Ia,ka),!0;if(n==Se)return u.getChance(3)&&o.spriteManager.getBoatDistance(i,s)>340&&Pa(t,i,s,xa,Na,Va,Fa),!0;if(o.spriteManager.getBoatDistance(i,s)<300||u.getChance(7)){if(n&1)return i<t.width-1&&t.getTileValue(i+1,s)===W?($a(t,i,s,Aa,La,ka,Ia),!0):!1;if(s>0&&t.getTileValue(i,s-1)===W)return $a(t,i,s,xa,Na,Fa,Va),!0}return!1},"doBridge"),Jc=[V,zs,Xs],td=Ms(function(t,i,s,n){n.census.roadTotal+=1;let o=t.getTile(i,s);const a=o.getValue();if(n.budget.shouldDegradeRoad()&&u.getChance(511)&&(o=t.getTile(i,s),!o.isConductive()&&n.budget.roadEffect<(u.getRandom16()&31))){o.getValue(),(a&15)<2||(a&15)===15?t.setTile(i,s,f,0):t.setTo(i,s,T.randomRubble());return}if(!o.isCombustible()&&(n.census.roadTotal+=4,Qc(t,i,s,a,n)))return;let r=0;a<zs?r=0:a<Xs?r=1:(n.census.roadTotal+=1,r=2);let l=n.blockMaps.trafficDensityMap.worldGet(i,s)>>6;if(l>1&&(l-=1),l===r)return;const h=(a-V&15)+Jc[l];let c=o.getFlags()&~Z;l>0&&(c|=Z),t.setTo(i,s,new G(h,c))},"roadFound"),ed={registerHandlers:function(t,i){t.addAction(T.isRoad,td)}};var id=Object.defineProperty,$s=d((t,i)=>id(t,"name",{value:i,configurable:!0}),"n$g");const sd=$s(function(t,i,s,n,o){this.type=t,this.map=i,this.spriteManager=s;let a=n,r=o,l=n>>4,h=o>>4;Object.defineProperty(this,"x",{configurable:!1,enumerable:!0,set:function(c){a=c,l=c>>4},get:function(){return a}}),Object.defineProperty(this,"y",{configurable:!1,enumerable:!0,set:function(c){r=c,h=c>>4},get:function(){return r}}),Object.defineProperty(this,"worldX",{configurable:!1,enumerable:!0,set:function(c){l=c,a=c<<4},get:function(){return l}}),Object.defineProperty(this,"worldY",{configurable:!1,enumerable:!0,set:function(c){h=c,r=c<<4},get:function(){return h}}),this.origX=0,this.origY=0,this.destX=0,this.destY=0,this.count=0,this.soundCount=0,this.dir=0,this.newDir=0,this.step=0,this.flag=0,this.turn=0,this.accel=0,this.speed=100},"init"),nd=$s(function(){return["obj",this.type,"-",this.frame-1].join("")},"getFileName"),od=$s(function(){const t=this.worldX,i=this.worldY;return t<0||i<0||t>=this.map.width||i>=this.map.height},"spriteNotInBounds"),ad={init:sd,getFileName:nd,spriteNotInBounds:od},pe=$s(function(t){t.prototype=Object.create(ad),nt(t)},"BaseSprite");var rd=Object.defineProperty,ld=d((t,i)=>rd(t,"name",{value:i,configurable:!0}),"m$c");function Xe(t,i,s,n){this.init(It,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,s>E.worldToPix(t.width-20)?(this.destX=this.x-200,this.frame=7):(this.destX=this.x+200,this.frame=11),this.destY=this.y}d(Xe,"r$f"),ld(Xe,"AirplaneSprite"),pe(Xe);const hd=[0,0,6,8,6,0,-6,-8,-6,8,8,8],cd=[0,-8,-6,0,6,8,6,0,-6,0,0,0];Xe.prototype.move=function(t,i,s){let n=this.frame;if(t%5===0)if(n>8)n--,n<9&&(n=3),this.frame=n;else{const o=E.getDir(this.x,this.y,this.destX,this.destY);n=E.turnTo(n,o),this.frame=n}if(E.absoluteDistance(this.x,this.y,this.destX,this.destY)<50&&(this.destX=u.getRandom(E.worldToPix(this.map.width))+8,this.destY=u.getRandom(E.worldToPix(this.map.height))+8),i.enableDisasters){let o=!1;const a=this.spriteManager.getSpriteList();for(let r=0;r<a.length;r++){const l=a[r];l.frame===0||l===this||(l.type===Lt||l.type===It)&&E.checkSpriteCollision(this,l)&&(l.explodeSprite(),o=!0)}o&&this.explodeSprite()}this.x+=hd[n],this.y+=cd[n],this.spriteNotInBounds()&&(this.frame=0)},Xe.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(Oi,{showable:!0,x:this.worldX,y:this.worldY})},Object.defineProperties(Xe,{ID:p.makeConstantDescriptor(3),width:p.makeConstantDescriptor(48),frames:p.makeConstantDescriptor(11)});var dd=Object.defineProperty,Ba=d((t,i)=>dd(t,"name",{value:i,configurable:!0}),"p$a");function je(t,i,s,n){this.init(oe,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,s<E.worldToPix(4)?this.frame=3:s>=E.worldToPix(t.width-4)?this.frame=7:n<E.worldToPix(4)?this.frame=5:n>=E.worldToPix(t.height-4)?this.frame=1:this.frame=3,this.newDir=this.frame,this.dir=10,this.count=1}d(je,"f$6"),Ba(je,"BoatSprite"),pe(je);const ud=Ba(function(t,i,s){let n=i+4;return n>8&&(n-=8),s!==n?!1:t===vt||t===vt+1||t===Ht||t===Ht+1},"oppositeAndUnderwater"),pd=[0,0,1,1,1,0,-1,-1,-1],fd=[0,-1,-1,0,1,1,1,0,-1],gd=[0,0,2,2,2,0,-2,-2,-2],md=[0,-2,-2,0,2,2,2,0,-2],_d=[f,W,vt,vt+1,Ht,Ht+1,Se,ye],Ed=10;je.prototype.move=function(t,i,s){let n=f,o,a,r;if(this.soundCount>0&&this.soundCount--,this.soundCount===0&&((u.getRandom16()&3)===1&&this._emitEvent(va),this.soundCount=200),this.count>0&&this.count--,this.count===0){if(this.count=9,this.frame!==this.newDir){this.frame=E.turnTo(this.frame,this.newDir);return}const l=u.getRandom16()&7;let h=l;for(;h<l+8;h++)if(o=(h&7)+1,o!==this.dir&&(a=this.worldX+pd[o],r=this.worldY+fd[o],this.map.testBounds(a,r)&&(n=this.map.getTileValue(a,r),n===W||n===Se||n===ye||ud(n,this.dir,o)))){this.newDir=o,this.frame=E.turnTo(this.frame,this.newDir),this.dir=o+4,this.dir>8&&(this.dir-=8);break}h===l+8&&(this.dir=Ed,this.newDir=(u.getRandom16()&7)+1)}else o=this.frame,o===this.newDir&&(this.x+=gd[o],this.y+=md[o]);if(this.spriteNotInBounds()){this.frame=0;return}for(let l=0;l<8&&n!==_d[l];l++)l===7&&(this.explodeSprite(),E.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y))},je.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(Ai,{showable:!0,x:this.worldX,y:this.worldY})},Object.defineProperties(je,{ID:p.makeConstantDescriptor(4),width:p.makeConstantDescriptor(48),frames:p.makeConstantDescriptor(8)});var Td=Object.defineProperty,wd=d((t,i)=>Td(t,"name",{value:i,configurable:!0}),"f$5");function Ze(t,i,s,n){this.init(Lt,t,i,s,n),this.width=32,this.height=32,this.xOffset=-16,this.yOffset=-16,this.frame=5,this.count=1500,this.destX=u.getRandom(E.worldToPix(t.width))+8,this.destY=u.getRandom(E.worldToPix(t.height))+8,this.origX=s,this.origY=n}d(Ze,"r$e"),wd(Ze,"CopterSprite"),pe(Ze);const vd=[0,0,3,5,3,0,-3,-5,-3],Sd=[0,-5,-3,0,3,5,3,0,-3];Ze.prototype.move=function(t,i,s){if(this.soundCount>0&&this.soundCount--,this.count>0&&this.count--,this.count===0){let o=this.spriteManager.getSprite(Le);if(o!==null?(this.destX=o.x,this.destY=o.y):(o=this.spriteManager.getSprite(pi),o!==null?(this.destX=o.x,this.destY=o.y):(this.destX=this.origX,this.destY=this.origY)),E.absoluteDistance(this.x,this.y,this.origX,this.origY)<30){this.frame=0;return}}if(this.soundCount===0){const o=this.worldX,a=this.worldY;o>=0&&o<this.map.width&&a>=0&&a<this.map.height&&s.trafficDensityMap.worldGet(o,a)>170&&(u.getRandom16()&7)===0&&(this._emitEvent(jt,{x:o,y:a}),this._emitEvent(wa),this.soundCount=200)}let n=this.frame;if((t&3)===0){const o=E.getDir(this.x,this.y,this.destX,this.destY);n=E.turnTo(n,o),this.frame=n}this.x+=vd[n],this.y+=Sd[n]},Ze.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(yi,{x:this.worldX,y:this.worldY})},Object.defineProperties(Ze,{ID:p.makeConstantDescriptor(2),width:p.makeConstantDescriptor(32),frames:p.makeConstantDescriptor(8)});var yd=Object.defineProperty,Dd=d((t,i)=>yd(t,"name",{value:i,configurable:!0}),"h$8");function qe(t,i,s,n){this.init(as,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,this.frame=1}d(qe,"e$8"),Dd(qe,"ExplosionSprite"),pe(qe),qe.prototype.startFire=function(t,i){if(t=this.worldX,i=this.worldY,!!this.map.testBounds(t,i)){var s=this.map.getTile(t,i),n=s.getValue();!s.isCombustible()&&n!==R||s.isZone()||this.map.setTo(t,i,T.randomFire())}},qe.prototype.move=function(t,i,s){if((t&1)===0){if(this.frame===1){var n=this.worldX,o=this.worldY;this._emitEvent(Ds),this._emitEvent(wi,{x:n,y:o})}this.frame++}this.frame>6&&(this.frame=0,this.startFire(this.x,this.y),this.startFire(this.x-16,this.y-16),this.startFire(this.x+16,this.y+16),this.startFire(this.x-16,this.y+16),this.startFire(this.x+16,this.y+16))},Object.defineProperties(qe,{ID:p.makeConstantDescriptor(7),width:p.makeConstantDescriptor(48),frames:p.makeConstantDescriptor(6)});var bd=Object.defineProperty,Od=d((t,i)=>bd(t,"name",{value:i,configurable:!0}),"g$5");function xi(t,i,s,n){this.init(Le,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,s>E.worldToPix(t.width)/2?n>E.worldToPix(t.height)/2?this.frame=10:this.frame=7:n>E.worldToPix(t.height)/2?this.frame=1:this.frame=4,this.flag=0,this.count=1e3,this.destX=E.worldToPix(t.pollutionMaxX),this.destY=E.worldToPix(t.pollutionMaxY),this.origX=this.x,this.origY=this.y,this._seenLand=!1}d(xi,"d$8"),Od(xi,"MonsterSprite"),pe(xi);const Cd=[2,2,-2,-2,0],Rd=[-2,2,2,-2,0],Md=[0,1,2,3],$d=[1,2,3,0],Pd=[2,5,8,11],Ad=[11,2,5,8];xi.prototype.move=function(t,i,s){this.soundCount>0&&this.soundCount--;let n=Math.floor((this.frame-1)/3),o,a;if(n<4){if(o=(this.frame-1)%3,o===2&&(this.step=0),o===0&&(this.step=1),this.step?o++:o--,E.absoluteDistance(this.x,this.y,this.destX,this.destY)<60)if(this.flag===0)this.flag=1,this.destX=this.origX,this.destY=this.origY;else{this.frame=0,this._emitEvent(le);return}a=E.getDir(this.x,this.y,this.destX,this.destY),a=Math.floor((a-1)/2),a!==n&&u.getChance(10)&&(u.getRandom16()&1?o=Md[n]:o=$d[n],n=4,this.soundCount||(this._emitEvent(Sa),this.soundCount=50+u.getRandom(100)))}else n=4,a=this.frame,o=a-13&3,u.getRandom16()&3||(u.getRandom16()&1?o=Pd[o]:o=Ad[o],n=Math.floor((o-1)/3),o=(o-1)%3);o=n*3+o+1,o>16&&(o=16),this.frame=o,this.x+=Cd[n],this.y+=Rd[n],this.count>0&&this.count--;const r=E.getTileValue(this.map,this.x,this.y);(r===-1||r===f&&this.count<500)&&(this.frame=0),(r===R||r>ve)&&(this._seenLand=!0);const l=this.spriteManager.getSpriteList();for(let h=0;h<l.length;h++){const c=l[h];c.frame!==0&&(c.type===It||c.type===Lt||c.type===oe||c.type===Ae)&&E.checkSpriteCollision(this,c)&&c.explodeSprite()}this.frame===0&&this._emitEvent(le),E.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y),this._emitEvent(Fe,{x:this.worldX,y:this.worldY})},Object.defineProperties(xi,{ID:p.makeConstantDescriptor(5),width:p.makeConstantDescriptor(48),frames:p.makeConstantDescriptor(16)});var Ld=Object.defineProperty,Id=d((t,i)=>Ld(t,"name",{value:i,configurable:!0}),"p$9");function Ni(t,i,s,n){this.init(fi.SPRITE_TORNADO,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-40,this.frame=1,this.count=200}d(Ni,"o$b"),Id(Ni,"TornadoSprite"),pe(Ni);const kd=[2,3,2,0,-2,-3],xd=[-2,0,2,3,2,0];Ni.prototype.move=function(t,i,s){let n=this.frame;n===2?this.flag?n=3:n=1:(n===1?this.flag=1:this.flag=0,n=2),this.count>0&&this.count--,this.frame=n;const o=this.spriteManager.getSpriteList();for(let a=0;a<o.length;a++){const r=o[a];r.frame!==0&&(r.type===fi.SPRITE_AIRPLANE||r.type===fi.SPRITE_HELICOPTER||r.type===fi.SPRITE_SHIP||r.type===fi.SPRITE_TRAIN)&&E.checkSpriteCollision(this,r)&&r.explodeSprite()}n=u.getRandom(5),this.x+=kd[n],this.y+=xd[n],this.spriteNotInBounds()&&(this.frame=0),this.count!==0&&u.getRandom(500)===0&&(this.frame=0),this.frame===0&&this._emitEvent(le),E.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y),this._emitEvent(Fe,{x:this.worldX,y:this.worldY})},Object.defineProperties(Ni,{ID:p.makeConstantDescriptor(6),width:p.makeConstantDescriptor(48),frames:p.makeConstantDescriptor(3)});var Nd=Object.defineProperty,Vd=d((t,i)=>Nd(t,"name",{value:i,configurable:!0}),"c$9");function Ke(t,i,s,n){this.init(Ae,t,i,s,n),this.width=32,this.height=32,this.xOffset=-16,this.yOffset=-16,this.frame=1,this.dir=4}d(Ke,"e$7"),Vd(Ke,"TrainSprite"),pe(Ke);const Fd=[0,16,0,-16],Bd=[-16,0,16,0],Hd=[0,4,0,-4,0],Wd=[-4,0,4,0,0],Ha=[1,2,1,2,5],Wa=3,Ua=4,Ud=5,Gd=3,Ps=4;Ke.prototype.move=function(t,i,s){if((this.frame===Wa||this.frame===Ua)&&(this.frame=Ha[this.dir]),this.x+=Hd[this.dir],this.y+=Wd[this.dir],(t&3)===0){const n=u.getRandom16()&3;for(let o=n;o<n+4;o++){const a=o&3;if(this.dir!==Ps&&a===(this.dir+2&3))continue;const r=E.getTileValue(this.map,this.x+Fd[a],this.y+Bd[a]);if(r>=Ht&&r<=co||r===dt||r===q){this.dir!==a&&this.dir!==Ps?this.dir+a===Gd?this.frame=Wa:this.frame=Ua:this.frame=Ha[a],(r===lt||r===Bt)&&(this.frame=Ud),this.dir=a;return}}if(this.dir===Ps){this.frame=0;return}this.dir=Ps}},Ke.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(Ii,{showable:!0,x:this.worldX,y:this.worldY})},Object.defineProperties(Ke,{ID:p.makeConstantDescriptor(1),width:p.makeConstantDescriptor(32),frames:p.makeConstantDescriptor(5)});const z=nt(function(t){this.spriteList=[],this.map=t,this.spriteCycle=0});z.prototype.getSprite=function(t){const i=this.spriteList.filter(function(s){return s.frame!==0&&s.type===t});return i.length===0?null:i[0]},z.prototype.getSpriteList=function(){return this.spriteList.slice()},z.prototype.getSpritesInView=function(t,i,s,n){t=E.worldToPix(t),i=E.worldToPix(i);const o=t+s,a=i+n;return this.spriteList.filter(function(r){const l=r.x+r.xOffset,h=r.y+r.yOffset,c=r.x+r.xOffset+r.width,g=r.y+r.yOffset+r.width,_=l>=t&&l<o,v=c>=t&&c<o,S=h>=i&&h<a,C=g>=i&&g<a;return(_||v)&&(S||C)})},z.prototype.moveObjects=function(t){const i=t.disasterManager,s=t.blockMaps;this.spriteCycle+=1;const n=this.spriteList.slice();for(let o=0,a=n.length;o<a;o++){const r=n[o];r.frame!==0&&r.move(this.spriteCycle,i,s)}this.pruneDeadSprites()},z.prototype.makeSprite=function(t,i,s){const n=new qt[t](this.map,this,i,s);for(let o=0,a=ce.length;o<a;o++)n.addEventListener(ce[o],p.reflectEvent.bind(this,ce[o]));return t==Lt&&n.addEventListener(jt,p.reflectEvent.bind(this,jt)),this.spriteList.push(n),n},z.prototype.makeTornado=function(){let t=this.getSprite(pi);if(t!==null){t.count=200,this._emitEvent(Be,{trackable:!0,x:t.worldX,y:t.worldY,sprite:t});return}const i=u.getRandom(E.worldToPix(this.map.width)-800)+400,s=u.getRandom(E.worldToPix(this.map.height)-200)+100;t=this.makeSprite(pi,i,s),this._emitEvent(Be,{trackable:!0,x:t.worldX,y:t.worldY,sprite:t})},z.prototype.makeExplosion=function(t,i){this.map.testBounds(t,i)&&this.makeExplosionAt(E.worldToPix(t),E.worldToPix(i))},z.prototype.makeExplosionAt=function(t,i){this.makeSprite(as,t,i)},z.prototype.generatePlane=function(t,i){this.getSprite(It)===null&&this.makeSprite(It,E.worldToPix(t),E.worldToPix(i))},z.prototype.generateTrain=function(t,i,s){t.totalPop>10&&this.getSprite(Ae)===null&&u.getRandom(25)===0&&this.makeSprite(Ae,E.worldToPix(i)+8,E.worldToPix(s)+8)},z.prototype.generateShip=function(){let t,i;if(u.getChance(3)){for(t=4;t<this.map.width-2;t++)if(this.map.getTileValue(t,0)===W){this.makeShipHere(t,0);return}}if(u.getChance(3)){for(i=1;i<this.map.height-2;i++)if(this.map.getTileValue(0,i)===W){this.makeShipHere(0,i);return}}if(u.getChance(3)){for(t=4;t<this.map.width-2;t++)if(this.map.getTileValue(t,this.map.height-1)===W){this.makeShipHere(t,this.map.height-1);return}}if(u.getChance(3)){for(i=1;i<this.map.height-2;i++)if(this.map.getTileValue(this.map.width-1,i)===W){this.makeShipHere(this.map.width-1,i);return}}},z.prototype.getBoatDistance=function(t,i){let s=99999;const n=E.worldToPix(t)+8,o=E.worldToPix(i)+8;for(let a=0,r=this.spriteList.length;a<r;a++){const l=this.spriteList[a];if(l.type===oe&&l.frame!==0){const h=Math.abs(l.x-n)+Math.abs(l.y-o);s=Math.min(s,h)}}return s},z.prototype.makeShipHere=function(t,i){this.makeSprite(oe,E.worldToPix(t),E.worldToPix(i))},z.prototype.generateCopter=function(t,i){this.getSprite(Lt)===null&&this.makeSprite(Lt,E.worldToPix(t),E.worldToPix(i))},z.prototype.makeMonsterAt=function(t,i){const s=this.makeSprite(Le,E.worldToPix(t),E.worldToPix(i));this._emitEvent(Di,{trackable:!0,x:t,y:i,sprite:s})},z.prototype.makeMonster=function(){const t=this.getSprite(Le);t!==null&&(t.soundCount=1,t.count=1e3,t.destX=E.worldToPix(this.map.pollutionMaxX),t.destY=E.worldToPix(this.map.pollutionMaxY));let i=0;for(let s=0;s<300;s++){const n=u.getRandom(this.map.width-20)+10,o=u.getRandom(this.map.height-10)+5;if(this.map.getTile(n,o).getValue()===f){this.makeMonsterAt(n,o),i=1;break}}i===0&&this.makeMonsterAt(60,50)},z.prototype.pruneDeadSprites=function(t){this.spriteList=this.spriteList.filter(function(i){return i.frame!==0})};var qt={};qt[Ae]=Ke,qt[oe]=je,qt[Le]=xi,qt[Lt]=Ze,qt[It]=Xe,qt[pi]=Ni,qt[as]=qe;var Yd=Object.defineProperty,Ga=d((t,i)=>Yd(t,"name",{value:i,configurable:!0}),"d$5");const zd=Ga(function(t,i,s,n){n.census.stadiumPop+=1,t.getTile(i,s).isPowered()&&(n.cityTime+i+s&31)===0&&(t.putZone(i,s,Eo,4),t.addTileFlags(i,s,At),t.setTile(i+1,s,an,Z),t.setTile(i+1,s+1,gl,Z))},"emptyStadiumFound"),Xd=Ga(function(t,i,s,n){n.census.stadiumPop+=1;const o=t.getTile(i,s).isPowered();(n.cityTime+i+s&7)===0&&(t.putZone(i,s,Yt,4),o&&t.addTileFlags(i,s,At))},"fullStadiumFound"),jd={registerHandlers:function(t,i){t.addAction(Yt,zd),t.addAction(Eo,Xd),i.addAction(Yt,15,4)}};var Zd=Object.defineProperty,Bn=d((t,i)=>Zd(t,"name",{value:i,configurable:!0}),"l$9");const qd=Bn(function(t,i,s,n){if(n.census.railTotal+=1,n.spriteManager.generateTrain(n.census,i,s),n.budget.shouldDegradeRoad()&&u.getChance(511)){const o=t.getTile(i,s);if(o.isConductive())return;n.budget.roadEffect<(u.getRandom16()&31)&&(o.getValue()<Ht+2?t.setTile(i,s,f,0):t.setTo(i,s,T.randomRubble()))}},"railFound"),Kd=Bn(function(t,i,s,n){if(n.census.airportPop+=1,t.getTile(i,s).isPowered()){if(t.getTileValue(i+1,s-1)===go&&t.setTile(i+1,s-1,So,k|Z|M),u.getRandom(5)===0){n.spriteManager.generatePlane(i,s);return}u.getRandom(12)===0&&n.spriteManager.generateCopter(i,s)}else t.setTile(i+1,s-1,go,k|M)},"airportFound"),Qd=Bn(function(t,i,s,n){n.census.seaportPop+=1,t.getTile(i,s).isPowered()&&n.spriteManager.getSprite(oe)===null&&n.spriteManager.generateShip()},"portFound"),Jd={registerHandlers:function(t,i){t.addAction(T.isRail,qd),t.addAction(ne,Qd),t.addAction(F,Kd),i.addAction(ne,15,4),i.addAction(F,7,6)}},As=nt(function(){this.resValve=0,this.comValve=0,this.indValve=0,this.resCap=!1,this.comCap=!1,this.indCap=!1}),Ya=2e3,za=1500,Xa=1500,Hn=[200,150,120,100,80,50,30,0,-10,-40,-100,-150,-200,-250,-300,-350,-400,-450,-500,-550,-600],tu=[1.2,1.1,.98];As.prototype.save=function(t){t.resValve=this.resValve,t.comValve=this.comValve,t.indValve=this.indValve},As.prototype.load=function(t){this.resValve=t.resValve,this.comValve=t.comValve,this.indValve=t.indValve,this._emitEvent(He)},As.prototype.setValves=function(t,i,s){let n,o;const a=i.resPop/8;i.totalPop=Math.round(a+i.comPop+i.indPop),i.resPop>0?n=(i.comHist10[1]+i.indHist10[1])/a:n=1;const r=a*(n-1),l=a*.02,h=a+r+l;o=i.comHist10[1]+i.indHist10[1],o>0?o=i.resHist10[1]/o:o=1,o=p.clamp(o,0,1.3);const c=(a+i.comPop+i.indPop)/3.7*o;let g=i.indPop*o*tu[t];g=Math.max(g,5);let _;a>0?_=h/a:_=1.3;let v;i.comPop>0?v=c/i.comPop:v=c;let S;i.indPop>0?S=g/i.indPop:S=g,_=Math.min(_,2),v=Math.min(v,2),S=Math.min(S,2);const C=Math.min(s.cityTax+t,20);_=(_-1)*600+Hn[C],v=(v-1)*600+Hn[C],S=(S-1)*600+Hn[C],this.resValve=p.clamp(this.resValve+Math.round(_),-Ya,Ya),this.comValve=p.clamp(this.comValve+Math.round(v),-za,za),this.indValve=p.clamp(this.indValve+Math.round(S),-Xa,Xa),this.resCap&&this.resValve>0&&(this.resValve=0),this.comCap&&this.comValve>0&&(this.comValve=0),this.indCap&&this.indValve>0&&(this.indValve=0),this._emitEvent(He)};var eu=Object.defineProperty,iu=d((t,i)=>eu(t,"name",{value:i,configurable:!0}),"l$8");const y=nt(function(t,i,s,n){this._map=t,this.setLevel(i),this.setSpeed(s),this._phaseCycle=0,this._simCycle=0,this._cityTime=0,this._cityPopLast=0,this._messageLast=ma,this._startingYear=1,this._cityYearLast=-1,this._cityMonthLast=-1,this._lastPowerMessage=null,this.evaluation=new w(this._gameLevel),this._valves=new As,this.budget=new et,this._census=new ue,this._powerManager=new Zt(this._map),this.spriteManager=new z(this._map),this._mapScanner=new Rs(this._map),this._repairManager=new ki(this._map),this._traffic=new N(this._map,this.spriteManager),this.disasterManager=new gt(this._map,this.spriteManager,this._gameLevel),this.blockMaps={cityCentreDistScoreMap:new Y(this._map.width,this._map.height,8),crimeRateMap:new Y(this._map.width,this._map.height,2),fireStationMap:new Y(this._map.width,this._map.height,8),fireStationEffectMap:new Y(this._map.width,this._map.height,8),landValueMap:new Y(this._map.width,this._map.height,2),policeStationMap:new Y(this._map.width,this._map.height,8),policeStationEffectMap:new Y(this._map.width,this._map.height,8),pollutionDensityMap:new Y(this._map.width,this._map.height,2),populationDensityMap:new Y(this._map.width,this._map.height,2),rateOfGrowthMap:new Y(this._map.width,this._map.height,8),terrainDensityMap:new Y(this._map.width,this._map.height,4),trafficDensityMap:new Y(this._map.width,this._map.height,2),tempMap1:new Y(this._map.width,this._map.height,2),tempMap2:new Y(this._map.width,this._map.height,2),tempMap3:new Y(this._map.width,this._map.height,4)},this._clearCensus(),n?this.load(n):(this.budget.setFunds(1e6),this._census.totalPop=1),this.init()});y.prototype.setLevel=function(t){if(t!==y.LEVEL_EASY&&t!==y.LEVEL_MED&&t!==y.LEVEL_HARD)throw new Error("Invalid level!");this._gameLevel=t},y.prototype.setSpeed=function(t){if(t!==y.SPEED_PAUSED&&t!==y.SPEED_SLOW&&t!==y.SPEED_MED&&t!==y.SPEED_FAST)throw new Error("Invalid speed!");this._speed=t},y.prototype.isPaused=function(){return this._speed===y.SPEED_PAUSED};const Qe=["_cityTime","_speed","_gameLevel"];y.prototype.save=function(t){for(let i=0,s=Qe.length;i<s;i++)t[Qe[i]]=this[Qe[i]];this._map.save(t),this.evaluation.save(t),this._valves.save(t),this.budget.save(t),this._census.save(t)},y.prototype.load=function(t){for(let i=0,s=Qe.length;i<s;i++)this[Qe[i]]=t[Qe[i]];this._map.load(t),this.evaluation.load(t),this._valves.load(t),this.budget.load(t),this._census.load(t)},y.prototype.simTick=function(){this._simFrame(),this._updateTime()},y.prototype._simFrame=function(){if(this.budget.awaitingValues)return;let t=100;switch(this._speed){case y.SPEED_PAUSED:return;case y.SPEED_SLOW:break;case y.SPEED_MED:t=50;break;case y.SPEED_FAST:t=10;break;default:console.warn("Unexpected speed ("+this._speed+"): defaulting to slow")}if(new Date-this._lastTickTime<t)return;const i=this._constructSimData();this._simulate(i),this._lastTickTime=new Date},y.prototype._clearCensus=function(){this._census.clearCensus(),this._powerManager.clearPowerStack(),this.blockMaps.fireStationMap.clear(),this.blockMaps.policeStationMap.clear()},y.prototype._constructSimData=function(){return{blockMaps:this.blockMaps,budget:this.budget,census:this._census,cityTime:this._cityTime,disasterManager:this.disasterManager,gameLevel:this._gameLevel,repairManager:this._repairManager,powerManager:this._powerManager,simulator:this,spriteManager:this.spriteManager,trafficManager:this._traffic,valves:this._valves}},y.prototype.init=function(){this._lastTickTime=-1;const t=["CLASSIFICATION_UPDATED","POPULATION_UPDATED","SCORE_UPDATED"].map(function(o){return ya[o]});for(var i=0,s=t.length;i<s;i++)this.evaluation.addEventListener(t[i],p.reflectEvent.bind(this,t[i]));for(this._powerManager.addEventListener(Ve,function(o){const a=new Date;(this._lastPowerMessage===null||a-this._lastPowerMessage>1e3*60*2)&&(this._emitEvent(L,{subject:Ve}),this._lastPowerMessage=a)}.bind(this)),this.budget.addEventListener(Ne,p.reflectEvent.bind(this,Ne)),this.budget.addEventListener(xe,p.reflectEvent.bind(this,xe)),this.budget.addEventListener(ae,this._wrapMessage.bind(this,ae)),this._valves.addEventListener(He,this._onValveChange.bind(this)),i=0,s=he.length;i<s;i++)this.spriteManager.addEventListener(he[i],this._wrapMessage.bind(this,he[i])),this.disasterManager.addEventListener(he[i],this._wrapMessage.bind(this,he[i]));for(i=0,s=ce.length;i<s;i++)this.spriteManager.addEventListener(ce[i],this._wrapMessage.bind(this,ce[i]));this.spriteManager.addEventListener(jt,this._wrapMessage.bind(this,jt)),ia.registerHandlers(this._mapScanner,this._repairManager),Ac.registerHandlers(this._mapScanner,this._repairManager),aa.registerHandlers(this._mapScanner,this._repairManager),Yc.registerHandlers(this._mapScanner,this._repairManager),this._powerManager.registerHandlers(this._mapScanner,this._repairManager),ed.registerHandlers(this._mapScanner,this._repairManager),ca.registerHandlers(this._mapScanner,this._repairManager),jd.registerHandlers(this._mapScanner,this._repairManager),Jd.registerHandlers(this._mapScanner,this._repairManager);const n=this._constructSimData();this._mapScanner.mapScan(0,this._map.width,n),this._powerManager.doPowerScan(this._census),bt.pollutionTerrainLandValueScan(this._map,this._census,this.blockMaps),bt.crimeScan(this._census,this.blockMaps),bt.populationDensityScan(this._map,this.blockMaps),bt.fireAnalysis(this.blockMaps)};const su=[2,4,5],nu=[2,7,17],ou=[1,8,18],au=[1,9,19],ru=[1,10,20],ja=4,lu=ja*10,hu=48,cu=iu(function(t){this._phaseCycle&=15;const i=this._speed-1;switch(this._phaseCycle){case 0:++this._simCycle>1023&&(this._simCycle=0),this._cityTime++,(this._simCycle&1)===0&&this._valves.setValves(this._gameLevel,this._census,this.budget),this._clearCensus();break;case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:this._mapScanner.mapScan((this._phaseCycle-1)*this._map.width/8,this._phaseCycle*this._map.width/8,t);break;case 9:this._cityTime%ja===0&&this._census.take10Census(budget),this._cityTime%lu===0&&this._census.take120Census(budget),this._cityTime%hu===0&&(this.budget.collectTax(this._gameLevel,this._census),this.evaluation.cityEvaluation(t));break;case 10:this._simCycle%5===0&&bt.neutraliseRateOfGrowthMap(t.blockMaps),bt.neutraliseTrafficMap(this.blockMaps),this._sendMessages();break;case 11:this._simCycle%su[i]===0&&this._powerManager.doPowerScan(this._census);break;case 12:this._simCycle%nu[i]===0&&bt.pollutionTerrainLandValueScan(this._map,this._census,this.blockMaps);break;case 13:this._simCycle%ou[i]===0&&bt.crimeScan(this._census,this.blockMaps);break;case 14:this._simCycle%au[i]===0&&bt.populationDensityScan(this._map,this.blockMaps);break;case 15:this._simCycle%ru[i]===0&&bt.fireAnalysis(this.blockMaps),this.disasterManager.doDisasters(this._census);break}this._phaseCycle=this._phaseCycle+1&15},"simulate");y.prototype._simulate=function(t){this.evaluation.cityEvaluation(t),this._simulate=cu,this._simulate(t)},y.prototype._wrapMessage=function(t,i){this._emitEvent(L,{subject:t,data:i})},y.prototype._sendMessages=function(){this._checkGrowth();const t=this._census.resZonePop+this._census.comZonePop+this._census.indZonePop,i=this._census.nuclearPowerPop+this._census.coalPowerPop;switch(this._cityTime&63){case 1:Math.floor(t/4)>=this._census.resZonePop&&this._emitEvent(L,{subject:_s});break;case 5:Math.floor(t/8)>=this._census.comZonePop&&this._emitEvent(L,{subject:fs});break;case 10:Math.floor(t/8)>=this._census.indZonePop&&this._emitEvent(L,{subject:gs});break;case 14:t>10&&t*2>this._census.roadTotal&&this._emitEvent(L,{subject:Es});break;case 18:t>50&&t>this._census.railTotal&&this._emitEvent(L,{subject:ms});break;case 22:t>10&&i===0&&this._emitEvent(L,{subject:us});break;case 26:this._census.resPop>500&&this._census.stadiumPop===0?(this._emitEvent(L,{subject:vs}),this._valves.resCap=!0):this._valves.resCap=!1;break;case 28:this._census.indPop>70&&this._census.seaportPop===0?(this._emitEvent(L,{subject:ws}),this._valves.indCap=!0):this._valves.indCap=!1;break;case 30:this._census.comPop>100&&this._census.airportPop===0?(this._emitEvent(L,{subject:ds}),this._valves.comCap=!0):this._valves.comCap=!1;break;case 32:var s=this._census.unpoweredZoneCount+this._census.poweredZoneCount;if(s>0&&this._census.poweredZoneCount/s<.7&&i>0){const n=new Date;(this._lastPowerMessage===null||n-this._lastPowerMessage>1e3*60*2)&&(this._emitEvent(L,{subject:rs}),this._lastPowerMessage=n)}break;case 35:this._census.pollutionAverage>60&&this._emitEvent(L,{subject:cs,data:{x:this._map.pollutionMaxX,y:this._map.pollutionMaxY}});break;case 42:this._census.crimeAverage>100&&this._emitEvent(L,{subject:hs});break;case 45:this._census.totalPop>60&&this._census.fireStationPop===0&&this._emitEvent(L,{subject:ps});break;case 48:this._census.totalPop>60&&this._census.policeStationPop===0&&this._emitEvent(L,{subject:Ts});break;case 51:this.budget.cityTax>12&&this._emitEvent(L,{subject:bs});break;case 54:this.budget.roadEffect<Math.floor(5*this.budget.MAX_ROAD_EFFECT/8)&&this._census.roadTotal>30&&this._emitEvent(L,{subject:ys});break;case 57:this.budget.fireEffect<Math.floor(7*this.budget.MAX_FIRE_STATION_EFFECT/10)&&this._census.totalPop>20&&this._emitEvent(L,{subject:ls});break;case 60:this.budget.policeEffect<Math.floor(7*this.budget.MAX_POLICE_STATION_EFFECT/10)&&this._census.totalPop>20&&this._emitEvent(L,{subject:Ss});break;case 63:this._census.trafficAverage>60&&this._emitEvent(L,{subject:Os});break}},y.prototype._checkGrowth=function(){if((this._cityTime&3)!==0)return;let t="";const i=this.evaluation.getPopulation(this._census);if(i!==this._cityPopLast){const s=this.evaluation.getCityClass(this._cityPopLast),n=this.evaluation.getCityClass(i);if(s!==n)switch(n){case w.CC_VILLAGE:break;case w.CC_TOWN:t=Pi;break;case w.CC_CITY:t=Ri;break;case w.CC_CAPITAL:t=Ci;break;case w.CC_METROPOLIS:t=Mi;break;case w.CC_MEGALOPOLIS:t=$i;break}}t!==""&&t!==this._messageLast&&(this._emitEvent(L,{subject:t}),this._messageLast=t),this._cityPopLast=i},y.prototype._onValveChange=function(){this._resLast=this._valves.resValve,this._comLast=this._valves.comValve,this._indLast=this._valves.indValve,this._emitEvent(He,{residential:this._valves.resValve,commercial:this._valves.comValve,industrial:this._valves.indValve})},y.prototype.getDate=function(){const t=Math.floor(this._cityTime/48)+this._startingYear;return{month:Math.floor(this._cityTime%48)>>2,year:t}},y.prototype._setYear=function(t){t<this._startingYear&&(t=this._startingYear),t=t-this._startingYear-this._cityTime/48,this._cityTime+=t*48,this._updateTime()},y.prototype._updateTime=function(){const t=Math.floor(this._cityTime/48)+this._startingYear,i=Math.floor(this._cityTime%48)>>2;if(t>=1e6){this.setYear(startingYear);return}(this._cityYearLast!==t||this._cityMonthLast!==i)&&(this._cityYearLast=t,this._cityMonthLast=i,this._emitEvent(Sn,{month:i,year:t}))},Object.defineProperties(y,{LEVEL_EASY:p.makeConstantDescriptor(0),LEVEL_MED:p.makeConstantDescriptor(1),LEVEL_HARD:p.makeConstantDescriptor(2),SPEED_PAUSED:p.makeConstantDescriptor(0),SPEED_SLOW:p.makeConstantDescriptor(1),SPEED_MED:p.makeConstantDescriptor(2),SPEED_FAST:p.makeConstantDescriptor(3)});var du=Object.defineProperty,Wn=d((t,i)=>du(t,"name",{value:i,configurable:!0}),"o$a");const uu=Wn(function(){let t=window.localStorage.getItem(this.KEY);return t!==null&&(t=JSON.parse(t),t.version!==this.CURRENT_VERSION&&this.transitionOldSave(t),t.isSavedGame=!0),t},"getSavedGame"),pu=Wn(function(t){t.version=this.CURRENT_VERSION,t=JSON.stringify(t),window.localStorage.setItem(this.KEY,t)},"saveGame"),fu=Wn(function(t){switch(t.version){case 1:t.everClicked=!1;case 2:t.pollutionMaxX=Math.floor(t.width/2),t.pollutionMaxY=Math.floor(t.height/2),t.cityCentreX=Math.floor(t.width/2),t.cityCentreY=Math.floor(t.height/2);break;default:throw new Error("Unknown save version!")}},"transitionOldSave"),fe={getSavedGame:uu,saveGame:pu,transitionOldSave:fu};Object.defineProperty(fe,"CURRENT_VERSION",p.makeConstantDescriptor(3)),Object.defineProperty(fe,"KEY",p.makeConstantDescriptor("micropolisJSGame")),Object.defineProperty(fe,"canStore",p.makeConstantDescriptor(window.localStorage!==void 0));var gu=Object.defineProperty,Un=d((t,i)=>gu(t,"name",{value:i,configurable:!0}),"r$d");function ge(t){this._map=t,this._data={}}d(ge,"o$9"),Un(ge,"WorldEffects");const Za=Un(function(t,i){return[t,i].join(",")},"toKey"),mu=Un(function(t){return t=t.split(","),{x:t[0]-0,y:t[1]-0,toString:function(){return"World effect coord: ("+t[0]+", "+t[1]+")"}}},"fromKey");ge.prototype.clear=function(){this._data=[]},ge.prototype.getTile=function(t,i){const s=Za(t,i);let n=this._data[s];return n===void 0&&(n=this._map.getTile(t,i)),n},ge.prototype.getTileValue=function(t,i){return this.getTile(t,i).getValue()},ge.prototype.setTile=function(t,i,s,n){if(n!==void 0&&s instanceof G)throw new Error("Flags supplied with already defined tile");if(!this._map.testBounds(t,i))throw new Error("WorldEffects setTile called with invalid bounds "+t+", "+i);n===void 0&&!(s instanceof G)?s=new G(s):n!==void 0&&(s=new G(s,n));const o=Za(t,i);this._data[o]=s},ge.prototype.apply=function(){const t=Object.keys(this._data);for(let i=0,s=t.length;i<s;i++){const n=mu(t[i]);this._map.setTo(n,this._data[t[i]])}};var _u=Object.defineProperty,kt=d((t,i)=>_u(t,"name",{value:i,configurable:!0}),"o$8");const Eu=kt(function(t,i,s,n){n=n||!1,Object.defineProperty(this,"toolCost",p.makeConstantDescriptor(t)),this.result=null,this.isDraggable=n,this._shouldAutoBulldoze=s,this._map=i,this._worldEffects=new ge(i),this._applicationCost=0},"init"),Tu=kt(function(){this._applicationCost=0,this._worldEffects.clear()},"clear"),wu=kt(function(t){this._applicationCost+=t},"addCost"),vu=kt(function(t,i){let s=this._worldEffects.getTile(t,i);s.isBulldozable()&&(s=T.normalizeRoad(s.getValue()),(s>=li&&s<=Zi||s<at&&s!==R)&&(this.addCost(1),this._worldEffects.setTile(t,i,R)))},"doAutoBulldoze"),Su=kt(function(t){this._worldEffects.apply(),t.spend(this._applicationCost),this.clear()},"apply"),yu=kt(function(t){return this.result!==this.TOOLRESULT_OK?(this.clear(),!1):t.totalFunds<this._applicationCost?(this.result=this.TOOLRESULT_NO_MONEY,this.clear(),!1):(Su.call(this,t),this.clear(),!0)},"modifyIfEnoughFunding"),Du=0,bu=1,Ou=2,Cu=3,Ls={addCost:wu,autoBulldoze:!0,bulldozerCost:1,clear:Tu,doAutoBulldoze:vu,init:Eu,modifyIfEnoughFunding:yu,TOOLRESULT_OK:Du,TOOLRESULT_FAILED:bu,TOOLRESULT_NO_MONEY:Ou,TOOLRESULT_NEEDS_BULLDOZE:Cu},Kt={makeTool:Qa,setAutoBulldoze:function(t){Ls.autoBulldoze=t},getAutoBulldoze:function(){return Ls.autoBulldoze},save:qa,load:Ka};function qa(t){t.autoBulldoze=Ls.autoBulldoze}d(qa,"U"),kt(qa,"save");function Ka(t){Kt.autoBulldoze=t.autoBulldoze}d(Ka,"S$3"),kt(Ka,"load");function Qa(t){return t.prototype=Object.create(Ls),t}d(Qa,"N$2"),kt(Qa,"makeTool");var Ru=Object.defineProperty,Ja=d((t,i)=>Ru(t,"name",{value:i,configurable:!0}),"l$6");const Ct=Ja(function(t,i){i=i?p.normaliseDOMid(i):null;const s=Ja(function(n,o){this._opacityLayer=p.normaliseDOMid(n),this._windowID=p.normaliseDOMid(o),t.call(this)},"newConstructor");return s.prototype._toggleDisplay=function(){let n=$(this._opacityLayer);if(n=n.length===0?null:n,n===null)throw new Error("Node "+this._opacityLayer+" not found");let o=$(this._windowID);if(o=o.length===0?null:o,o===null)throw new Error("Node "+this._windowID+" not found");n.toggle(),o.toggle(),i!==null?$(i).focus():$(this._windowID+" input[type=submit]").focus()},nt(s)},"ModalWindow");var Mu=Object.defineProperty,Je=d((t,i)=>Mu(t,"name",{value:i,configurable:!0}),"s$a"),Gn=Ct(function(){$(Pu).on("click",ku.bind(this)),$($u).on("click",Iu.bind(this)),$(Au).on("submit",xu.bind(this))}),me=["roadMaintenanceBudget","fireMaintenanceBudget","policeMaintenanceBudget"],mt=["roadRate","fireRate","policeRate"],$u="#budgetReset",Pu="#budgetCancel",Au="#budgetForm",Yn=Je(function(t,i,s){var n=t+"Label",o=Math.floor(s*(i/100)),a=[i,"% of $",s," = $",o].join("");$(p.normaliseDOMid(n)).text(a)},"setSpendRangeText"),Lu=Je(function(t,i){var s=$(p.normaliseDOMid(t))[0],n=s.value-0,o=s.getAttribute("data-source");Yn(t,n,this[o])},"onFundingUpdate"),zn=Je(function(t){var i=$("#taxRateLabel")[0],s=$("#taxRate")[0];$(i).text(["Tax rate: ",s.value,"%"].join(""))},"onTaxUpdate"),Iu=Je(function(t){for(var i=0;i<mt.length;i++){var s=this["original"+mt[i]];$(p.normaliseDOMid(mt[i]))[0].value=s,Yn(mt[i],s,this[me[i]])}$("#taxRate")[0].value=this.originaltaxRate,zn(),t.preventDefault()},"resetItems");Gn.prototype.close=function(t){t=t||{cancelled:!0},this._emitEvent(wn,t),this._toggleDisplay()};var ku=Je(function(t){t.preventDefault(),this.close({cancelled:!0})},"cancel"),xu=Je(function(t){t.preventDefault();var i=$("#roadRate")[0].value,s=$("#fireRate")[0].value,n=$("#policeRate")[0].value,o=$("#taxRate")[0].value,a={cancelled:!1,roadPercent:i,firePercent:s,policePercent:n,taxPercent:o,e:t,original:t.type};this.close(a)},"submit");Gn.prototype.open=function(t){var i,s;for(i=0;i<me.length;i++){if(t[me[i]]===void 0)throw new Error("Missing budget data ("+me[i]+")");this[me[i]]=t[me[i]]}for(i=0;i<mt.length;i++){if(t[mt[i]]===void 0)throw new Error("Missing budget data ("+mt[i]+")");s=mt[i],this["original"+s]=t[s],Yn(s,t[mt[i]],this[me[i]]),s=$(p.normaliseDOMid(s)),s.on("change",Lu.bind(this,mt[i])),s=s[0],s.value=t[mt[i]]}if(t.taxRate===void 0)throw new Error("Missing budget data (taxRate)");this.originalTaxRate=t.taxRate,s=$("#taxRate"),s.on("change",zn),s=s[0],s.value=t.taxRate,zn();var n=t.totalFunds;if(n===void 0)throw new Error("Missing budget data (previousFunds)");var o=t.taxesCollected;if(o===void 0)throw new Error("Missing budget data (taxesCollected)");var a=o-this.roadMaintenanceBudget-this.fireMaintenanceBudget-this.policeMaintenanceBudget,r=n+a;$("#taxesCollected").text("$"+o),$("#cashFlow").text((a<0?"-$":"$")+a),$("#previousFunds").text((n<0?"-$":"$")+n),$("#currentFunds").text("$"+r),this._toggleDisplay()};var Nu=Object.defineProperty,tr=d((t,i)=>Nu(t,"name",{value:i,configurable:!0}),"n$c");const ti=Ct(function(){$(Vu).on("click",Bu.bind(this)),$(Fu).on("submit",Hu.bind(this))});var Vu="#debugCancel",Fu="#debugForm";ti.prototype.close=function(t){t=t||[],this._emitEvent(yn,t),this._toggleDisplay()};var Bu=tr(function(t){t.preventDefault(),this.close([])},"cancel"),Hu=tr(function(t){t.preventDefault();const i=[];$(".debugAdd:checked").val()==="true"&&i.push({action:ti.ADD_FUNDS,data:{}}),this.close(i)},"submit");ti.prototype.open=function(){this._toggleDisplay()},function(){let t=0;return function(i){Object.defineProperty(ti,i,p.makeConstantDescriptor(t)),t+=1}}()("ADD_FUNDS");var Wu=Object.defineProperty,er=d((t,i)=>Wu(t,"name",{value:i,configurable:!0}),"a$9"),ir="#disasterSelect",Uu="#disasterCancel",Gu="#disasterForm",U=Ct(function(){$(Gu).on("submit",zu.bind(this)),$(Uu).on("click",Yu.bind(this))},ir);U.prototype.close=function(t){t=t||U.DISASTER_NONE,this._toggleDisplay(),this._emitEvent(Dn,t)};var Yu=er(function(t){t.preventDefault(),this.close()},"cancel"),zu=er(function(t){t.preventDefault();var i=$(ir)[0].value;this.close(i)},"submit");U.prototype.open=function(){$("#disasterNone").attr("value",U.DISASTER_NONE),$("#disasterMonster").attr("value",U.DISASTER_MONSTER),$("#disasterFire").attr("value",U.DISASTER_FIRE),$("#disasterFlood").attr("value",U.DISASTER_FLOOD),$("#disasterCrash").attr("value",U.DISASTER_CRASH),$("#disasterMeltdown").attr("value",U.DISASTER_MELTDOWN),$("#disasterTornado").attr("value",U.DISASTER_TORNADO),this._toggleDisplay()},Object.defineProperties(U,{DISASTER_NONE:p.makeConstantDescriptor("None"),DISASTER_MONSTER:p.makeConstantDescriptor("Monster"),DISASTER_FIRE:p.makeConstantDescriptor("Fire"),DISASTER_FLOOD:p.makeConstantDescriptor("Flood"),DISASTER_CRASH:p.makeConstantDescriptor("Crash"),DISASTER_MELTDOWN:p.makeConstantDescriptor("Meltdown"),DISASTER_TORNADO:p.makeConstantDescriptor("Tornado")});const Xu=["Low","Medium","High","Very High"],ju=["Slum","Lower Class","Middle Class","High"],Zu=["Safe","Light","Moderate","Dangerous"],qu=["None","Moderate","Heavy","Very Heavy"],Ku=["Declining","Stable","Slow Growth","Fast Growth"],Qu=["Clear","Water","Trees","Rubble","Flood","Radioactive Waste","Fire","Road","Power","Rail","Residential","Commercial","Industrial","Seaport","Airport","Coal Power","Fire Department","Police Department","Stadium","Nuclear Power","Draw Bridge","Radar Dish","Fountain","Industrial","Steelers 38  Bears 3","Draw Bridge","Ur 238"],Is={};Is[""+y.LEVEL_EASY]="Easy",Is[""+y.LEVEL_MED]="Medium",Is[""+y.LEVEL_HARD]="Hard";const _e={};_e[w.CC_VILLAGE]="VILLAGE",_e[w.CC_TOWN]="TOWN",_e[w.CC_CITY]="CITY",_e[w.CC_CAPITAL]="CAPITAL",_e[w.CC_METROPOLIS]="METROPOLIS",_e[w.CC_MEGALOPOLIS]="MEGALOPOLIS";const Qt={};Qt[w.CRIME]="Crime",Qt[w.POLLUTION]="Pollution",Qt[w.HOUSING]="Housing",Qt[w.TAXES]="Taxes",Qt[w.TRAFFIC]="Traffic",Qt[w.UNEMPLOYMENT]="Unemployment",Qt[w.FIRE]="Fire";const Ju=["January","February","March","April","May","June","July","August","September","October","November","December"],tp={noMoney:"Insufficient funds to build that",needsDoze:"Area must be bulldozed first"},K={};K[ls]=!0,K[ds]=!0,K[ps]=!0,K[us]=!0,K[gs]=!0,K[fs]=!0,K[_s]=!0,K[ms]=!0,K[Es]=!0,K[Ts]=!0,K[ws]=!0,K[vs]=!0,K[ys]=!0,K[Ss]=!0,K[xn]=!0;const H={};H[rs]=!0,H[Ti]=!0,H[wi]=!0,H[Si]=!0,H[vi]=!0,H[jt]=!0,H[yi]=!0,H[hs]=!0,H[cs]=!0,H[Di]=!0,H[ae]=!0,H[Ve]=!0,H[bi]=!0,H[Oi]=!0,H[Ai]=!0,H[bs]=!0,H[Be]=!0,H[Os]=!0,H[Ii]=!0;const ei={};ei[Ci]=!0,ei[Ri]=!0,ei[$i]=!0,ei[Mi]=!0,ei[Pi]=!0;const D={};D[ls]="Fire departments need funding",D[ds]="Commerce requires an Airport",D[ps]="Citizens demand a Fire Department",D[us]="Build a Power Plant",D[gs]="More industrial zones needed",D[fs]="More commercial zones needed",D[_s]="More residential zones needed",D[ms]="Inadequate rail system",D[Es]="More roads required",D[Ts]="Citizens demand a Police Department",D[ws]="Industry requires a Sea Port",D[vs]="Residents demand a Stadium",D[ys]="Roads deteriorating, due to lack of funds",D[Ss]="Police departments need funding",D[xn]="Welcome to micropolisJS",D[rs]="Brownouts, build another Power Plant",D[Ti]="Major earthquake reported !!",D[wi]="Explosion detected ",D[Si]="Flooding reported !",D[vi]="Fire reported ",D[jt]="Heavy Traffic reported",D[yi]="A helicopter crashed ",D[hs]="Crime very high",D[cs]="Pollution very high",D[Di]="A Monster has been sighted !",D[ae]="YOUR CITY HAS GONE BROKE",D[Ve]="Blackouts reported: insufficient power capacity",D[bi]="A Nuclear Meltdown has occurred !!",D[Oi]="A plane has crashed ",D[Ai]="Shipwreck reported ",D[bs]="Citizens upset. The tax rate is too high",D[Be]="Tornado reported !",D[Os]="Frequent traffic jams reported",D[Ii]="A train crashed ",D[Ci]="Population has reached 50,000",D[Ri]="Population has reached 10,000",D[$i]="Population has reached 500,000",D[Mi]="Population has reached 100,000",D[Pi]="Population has reached 2,000";const X={badMessages:H,cityClass:_e,crimeStrings:Zu,densityStrings:Xu,gameLevel:Is,goodMessages:ei,landValueStrings:ju,messageText:D,months:Ju,neutralMessages:K,problems:Qt,pollutionStrings:qu,rateStrings:Ku,toolMessages:tp,zoneTypes:Qu};var ep=Object.defineProperty,ip=d((t,i)=>ep(t,"name",{value:i,configurable:!0}),"s$7"),ks=Ct(function(){$(sp).on("submit",np.bind(this))}),sp="#evalButtons";ks.prototype.close=function(){this._emitEvent(bn),this._toggleDisplay()};var np=ip(function(t){t.preventDefault(),this.close()},"submit");ks.prototype._populateWindow=function(t){$("#evalYes").text(t.cityYes),$("#evalNo").text(100-t.cityYes);for(var i=0;i<4;i++){var s=t.getProblemNumber(i);if(s!==null){var n=X.problems[s];$("#evalProb"+(i+1)).text(n),$("#evalProb"+(i+1)).show()}else $("#evalProb"+(i+1)).hide()}$("#evalPopulation").text(t.cityPop),$("#evalMigration").text(t.cityPopDelta),$("#evalValue").text(t.cityAssessedValue),$("#evalLevel").text(X.gameLevel[t.gameLevel]),$("#evalClass").text(X.cityClass[t.cityClass]),$("#evalScore").text(t.cityScore),$("#evalScoreDelta").text(t.cityScoreDelta)},ks.prototype.open=function(t){this._populateWindow(t),this._toggleDisplay()};var op=Object.defineProperty,sr=d((t,i)=>op(t,"name",{value:i,configurable:!0}),"i$6");function Vi(){this.clear()}d(Vi,"e$5"),sr(Vi,"TileHistory");const nr=sr(function(t,i){return[t,i].join(",")},"toKey");Vi.prototype.clear=function(){this.data={}},Vi.prototype.getTile=function(t,i){const s=nr(t,i);return this.data[s]},Vi.prototype.setTile=function(t,i,s){const n=nr(t,i);this.data[n]=s};var ap=Object.defineProperty,rp=d((t,i)=>ap(t,"name",{value:i,configurable:!0}),"B$1");function Jt(t,i,s){i=i||240,s=s||600,this._map=t,this.animationPeriod=i,this.lastAnimation=new Date(1970,1,1),this.lastBlink=new Date(1970,1,1),this.blinkPeriod=s,this.shouldBlink=!1,this._lastPainted=null,this._currentPainted=null,this._data=[],this.initArray(),this.registerAnimations()}d(Jt,"o$5"),rp(Jt,"AnimationManager"),Jt.prototype.initArray=function(){for(var t=0;t<qi;t++)this._data[t]=t},Jt.prototype.inSequence=function(t,i){for(var s=[t],n=this._data[t];s.indexOf(n)===-1;){if(n===i)return!0;s.push(n),n=this._data[n]}return!1},Jt.prototype.getTiles=function(t,i,s,n,o,a){a=a||!1;var r=!1,l=new Date,h=this.shouldBlink;l-this.lastBlink>this.blinkPeriod&&(h=this.shouldBlink=!this.shouldBlink,this.lastBlink=l),a||l-this.lastAnimation>this.animationPeriod&&(r=!0,this.lastAnimation=l);for(var c=this._currentPainted===null?new Vi:this._currentPainted,g=0;g<o;g++)for(var _=0;_<n;_++){var v=_+i,S=g+s,C=g*n+_;if(!(v<0||v>=this._map.width||S<0||S>=this._map.height)){var A=t[C];if(A!==zt){if(h&&A&Ce&&!(A&At)){t[C]=ul;continue}if(!(A&Z)){t[C]=A&ns;continue}var ot=A&ns,Et=zt,Tt;if(this._lastPainted&&(Tt=this._lastPainted.getTile(_,g)),r?Tt&&this.inSequence(ot,Tt)?Tt===Zi?(this._map.setTo(v,S,T.randomRubble()),Et=this._map.getTileValue(v,S)):Et=this._data[Tt]:Et=this._data[ot]:Tt&&this.inSequence(ot,Tt)&&(Et=Tt),Et===zt){t[C]=ot;continue}t[C]=Et,c.setTile(_,g,Et)}}}var Q=this._lastPainted;this._lastPainted=c,Q!==null&&Q.clear(),this._currentPainted=Q},Jt.prototype.registerSingleAnimation=function(t){for(var i=1;i<t.length;i++)this._data[t[i-1]]=t[i]},Jt.prototype.registerAnimations=function(){this.registerSingleAnimation([56,57,58,59,60,61,62,63,56]),this.registerSingleAnimation([80,128,112,96,80]),this.registerSingleAnimation([81,129,113,97,81]),this.registerSingleAnimation([82,130,114,98,82]),this.registerSingleAnimation([83,131,115,99,83]),this.registerSingleAnimation([84,132,116,100,84]),this.registerSingleAnimation([85,133,117,101,85]),this.registerSingleAnimation([86,134,118,102,86]),this.registerSingleAnimation([87,135,119,103,87]),this.registerSingleAnimation([88,136,120,104,88]),this.registerSingleAnimation([89,137,121,105,89]),this.registerSingleAnimation([90,138,122,106,90]),this.registerSingleAnimation([91,139,123,107,91]),this.registerSingleAnimation([92,140,124,108,92]),this.registerSingleAnimation([93,141,125,109,93]),this.registerSingleAnimation([94,142,126,110,94]),this.registerSingleAnimation([95,143,127,111,95]),this.registerSingleAnimation([144,192,176,160,144]),this.registerSingleAnimation([145,193,177,161,145]),this.registerSingleAnimation([146,194,178,162,146]),this.registerSingleAnimation([147,195,179,163,147]),this.registerSingleAnimation([148,196,180,164,148]),this.registerSingleAnimation([149,197,181,165,149]),this.registerSingleAnimation([150,198,182,166,150]),this.registerSingleAnimation([151,199,183,167,151]),this.registerSingleAnimation([152,200,184,168,152]),this.registerSingleAnimation([153,201,185,169,153]),this.registerSingleAnimation([154,202,186,170,154]),this.registerSingleAnimation([155,203,187,171,155]),this.registerSingleAnimation([156,204,188,172,156]),this.registerSingleAnimation([157,205,189,173,157]),this.registerSingleAnimation([158,206,190,174,158]),this.registerSingleAnimation([159,207,191,175,159]),this.registerSingleAnimation([621,852,853,854,855,856,857,858,859,852]),this.registerSingleAnimation([641,884,885,886,887,884]),this.registerSingleAnimation([644,888,889,890,891,888]),this.registerSingleAnimation([649,892,893,894,895,892]),this.registerSingleAnimation([650,896,897,898,899,896]),this.registerSingleAnimation([676,900,901,902,903,900]),this.registerSingleAnimation([677,904,905,906,907,904]),this.registerSingleAnimation([686,908,909,910,911,908]),this.registerSingleAnimation([689,912,913,914,915,912]),this.registerSingleAnimation([747,916,917,918,919,916]),this.registerSingleAnimation([748,920,921,922,923,920]),this.registerSingleAnimation([751,924,925,926,927,924]),this.registerSingleAnimation([752,928,929,930,931,928]),this.registerSingleAnimation([820,952,953,954,955,952]),this.registerSingleAnimation([832,833,834,835,836,837,838,839,832]),this.registerSingleAnimation([840,841,842,843,840]),this.registerSingleAnimation([844,845,846,847,848,849,850,851,844]),this.registerSingleAnimation([860,861,862,863,864,865,866,867]),this.registerSingleAnimation([932,933,934,935,936,937,938,939,932]),this.registerSingleAnimation([940,941,942,943,944,945,946,947,940])};const lp={draw:function(t,i,s,n,o){const a=o.lineWidth||3,r=o.colour||"yellow",l="outline"in o&&o.outline===!0||!1;let h=-1,c=1;l||(h=1,c=-1);const g=i.x+h*a/2;s=s+c*a;const _=i.y+h*a/2;n=n+c*a;const v=t.getContext("2d");v.lineWidth=a,v.strokeStyle=r,v.strokeRect(g,_,s,n)}};var hp=Object.defineProperty,cp=d((t,i)=>hp(t,"name",{value:i,configurable:!0}),"y$1");const or=d(class{constructor(t,i,s=1.22){if(arguments.length<1)throw new Error("Attempt to construct a GameCanvas with no parameters");if(i===void 0&&(i=t,t=or.DEFAULT_ID),typeof i=="string"){const a=i;if(i=$(p.normaliseDOMid(i)),i=i.length===0?null:i[0],i===null)throw new Error("Node "+a+" not found")}this.zoomRatio=s,this._canvas=document.createElement("canvas"),this._canvas.id=t;const n=i.getBoundingClientRect();this._canvas.width=n.width,this._canvas.height=n.height,this._canvas.style.margin="0",this._canvas.style.padding="0",this._canvas.style.transform=`scale(${s})`,this._canvas.style.imageRendering="pixelated",this._pendingTileSet=null;const o=document.getElementById(t);if(o!==null)if(o.parentNode===i)i.replaceChild(this._canvas,o);else throw new Error("ID "+t+" already exists in document!");else i.appendChild(this._canvas);this.ready=!1}init(t,i,s,n){if(n=n||new Jt(t),arguments.length<3)throw new Error("GameCanvas constructor called with too few arguments "+[].toString.apply(arguments));if(!i.isValid)throw new Error("TileSet not ready!");this._spriteSheet=s,this._tileSet=i;const o=this._tileSet.tileWidth;if(this._map=t,this.animationManager=new Jt(t),this._canvas.width<o||this._canvas.height<o)throw new Error("Canvas too small!");this._allowScrolling=!0,this._lastPaintedTiles=null,this._currentPaintedTiles=[],this._lastPaintedWidth=-1,this._lastPaintedHeight=-1,this._lastCanvasWidth=-1,this._lastCanvasHeight=-1,this._lastCanvasData=null,this._calculateDimensions(),this._pendingDimensionChange=!1;const a=function(r){this._pendingDimensionChange=!0}.bind(this);window.addEventListener("resize",a,!1),this.ready=!0,this.centreOn(Math.floor(this._map.width/2),Math.floor(this._map.height/2)),this.paint(null,null)}_calculateDimensions(t){t=t||!1;const i=this.canvasWidth=this._canvas.parentNode.clientWidth,s=this.canvasHeight=this._canvas.parentNode.clientHeight;if(s===this._lastCanvasHeight&&i===this._lastCanvasWidth&&!t)return;this._canvas.width=i,this._canvas.height=s;const n=this._tileSet.tileWidth;this._wholeTilesInViewX=Math.floor(i/n),this._wholeTilesInViewY=Math.floor(s/n),this._totalTilesInViewX=Math.ceil(i/n),this._totalTilesInViewY=Math.ceil(s/n),this._allowScrolling?(this.minX=0,this.maxX=this._map.width-1-Math.ceil(Math.floor(i/n)),this.minY=0,this.maxY=this._map.height-1-Math.ceil(Math.floor(s/n)),this._totalTilesInViewY=Math.ceil(s/n)):(this.minX=0,this.minY=0,this.maxX=this._map.width-this._totalTilesInViewX,this.maxY=this._map.height-this._totalTilesInViewY),this._pendingDimensionChange=!0}disallowOffMap(){this._allowScrolling=!1,this._lastPaintedTiles=null,this._calculateDimensions(!0)}moveNorth(){if(!this.ready)throw new Error("Not ready!");this._originY>this.minY&&this._originY--}moveEast(){if(!this.ready)throw new Error("Not ready!");this._originX<this.maxX&&this._originX++}moveSouth(){if(!this.ready)throw new Error("Not ready!");this._originY<this.maxY&&this._originY++}moveWest(){if(!this.ready)throw new Error("Not ready!");this._originX>this.minX&&this._originX--}moveTo(t,i){if(arguments.length<1)throw new Error("GameCanvas moveTo called with no arguments");if(!this.ready)throw new Error("Not ready!");if(t<this.minX||t>this.maxX||i<this.minY||i>this.maxY)throw new Error("Coordinates out of bounds");this._originX=t,this._originY=i}centreOn(t,i){if(arguments.length<1)throw new Error("GameCanvas centreOn called with no arguments");if(!this.ready)throw new Error("Not ready!");i===void 0&&(i=t.y,t=t.x);let s=Math.floor(t)-Math.ceil(this._wholeTilesInViewX/2),n=Math.floor(i)-Math.ceil(this._wholeTilesInViewY/2);s>this.maxX&&(s=this.maxX),s<this.minX&&(s=this.minX),n>this.maxY&&(n=this.maxY),n<this.minY&&(n=this.minY),this._originX=s,this._originY=n}getTileOrigin(){const t=new Error("Not ready!");if(!this.ready)throw t;return{x:this._originX,y:this._originY}}getMaxTile(){const t=new Error("Not ready!");if(!this.ready)throw t;return{x:this._originX+this._totalTilesInViewX-1,y:this._originY+this._totalTilesInViewY-1}}canvasCoordinateToTileOffset(t,i){if(arguments.length<2)throw new Error("GameCanvas canvasCoordinateToTileOffset called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");return{x:Math.floor(t/this._tileSet.tileWidth/this.zoomRatio),y:Math.floor(i/this._tileSet.tileWidth/this.zoomRatio)}}canvasCoordinateToTileCoordinate(t,i){if(arguments.length<2)throw new Error("GameCanvas canvasCoordinateToTileCoordinate called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");return t>=this.canvasWidth||i>=this.canvasHeight?null:{x:this._originX+Math.floor(t/this._tileSet.tileWidth/this.zoomRatio),y:this._originY+Math.floor(i/this._tileSet.tileWidth/this.zoomRatio)}}canvasCoordinateToPosition(t,i){if(arguments.length<2)throw new Error("GameCanvas canvasCoordinateToPosition called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");return t>=this.canvasWidth||i>=this.canvasHeight||(t=this._originX+Math.floor(t/this._tileSet.tileWidth/this.zoomRatio),i=this._originY+Math.floor(i/this._tileSet.tileWidth/this.zoomRatio),t<0||t>=this._map.width||i<0||i>=this._map.height)?null:new O(t,i)}positionToCanvasCoordinate(t){if(arguments.length<1)throw new Error("GameCanvas positionToCanvasCoordinate called with too few arguments "+[].toString.apply(arguments));return this.tileToCanvasCoordinate(t)}tileToCanvasCoordinate(t,i){if(arguments.length<1)throw new Error("GameCanvas tileToCanvasCoordinate  called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");if(i===void 0&&(i=t.y,t=t.x),t===void 0||i===void 0||t<this.minX||i<this.minY||t>this.maxX+this._totalTilesInViewX-1||i>this.maxY+this._totalTilesInViewY-1)throw e;return t<this._originX||t>=this._originX+this._totalTilesInViewX||i<this._originY||i>=this._originY+this._totalTilesInViewY?null:{x:(t-this._originX)*this._tileSet.tileWidth*this.zoomRatio,y:(i-this._originY)*this._tileSet.tileWidth*this.zoomRatio}}changeTileSet(t){if(!this.ready)throw new Error("Not ready!");if(!t.isValid)throw new Error("new tileset not loaded");this._pendingTileSet=t}_screenshot(t){if(t)return this._canvas.toDataURL();const i=document.createElement("canvas");i.width=this._map.width*this._tileSet.tileWidth*this.zoomRatio,i.height=this._map.height*this._tileSet.tileWidth*this.zoomRatio;const s=i.getContext("2d");for(let n=0;n<this._map.width;n++)for(let o=0;o<this._map.height;o++)this._paintOne(s,this._map.getTileValue(n,o),n,o);return i.toDataURL()}screenshotMap(){return this._screenshot(!1)}screenshotVisible(){return this._screenshot(!0)}shoogle(){}_processSprites(t,i){const s=[],n=this._tileSet.tileWidth;for(let o=0,a=i.length;o<a;o++){const r=i[o];try{t.drawImage(this._spriteSheet,(r.frame-1)*48,(r.type-1)*48,r.width,r.width,r.x+r.xOffset-this._originX*16,r.y+r.yOffset-this._originY*16,r.width,r.width)}catch(l){console.warn("Failed to draw sprite "+r.type+" frame "+r.frame+" at "+r.x+", "+r.y);continue}s.push({x:Math.floor((r.x+r.xOffset-this._originX*16)/n),xBound:Math.ceil((r.x+r.xOffset+r.width-this._originX*16)/n),y:Math.floor((r.y+r.yOffset-this._originY*16)/n),yBound:Math.ceil((r.y+r.yOffset+r.height-this._originY*16)/n)})}return s}_processMouse(t){const i={x:0,xBound:0,y:0,yBound:0};if(t.width===0||t.height===0)return;let s=t.x,n=t.y;const o=t.width,a=t.height,r={colour:t.colour,outline:!0};if(o>2&&(s-=1),a>2&&(n-=1),this._originX+s<0&&this._originX+s+o<=0||this._originY+n<0&&this._originY+n+a<=0||this._originX+s>=this._map.width||this._originY+n>=this._map.height)return i.x=i.xBound=s,i.y=i.yBound=n,i;const l={x:s*this._tileSet.tileWidth,y:n*this._tileSet.tileWidth},h=o*this._tileSet.tileWidth,c=a*this._tileSet.tileWidth;return lp.draw(this._canvas,l,h,c,r),i.x=s-1,i.xBound=s+o+2,i.y=n-1,i.yBound=n+o+2,i}_paintVoid(t,i,s){const n=this._tileSet.tileWidth;t.fillStyle="black",t.fillRect(i*n,s*n,n,n)}_paintOne(t,i,s,n){if(i===zt){this._paintVoid(t,s,n);return}const o=this._tileSet[i];try{t.drawImage(o,s*this._tileSet.tileWidth,n*this._tileSet.tileWidth)}catch(a){const r=this._originX+s,l=this._originY+n;throw new Error("Failed to draw tile "+i+" at "+s+", "+n+" (map "+r+", "+l+" tile "+(this._map.testBounds(r,l)?this._map.getTileValue(r,l):"?? (Out of bounds)")+")")}}_paintTiles(t,i){let s,n,o;const a=this._lastPaintedTiles,r=this._totalTilesInViewX,l=this._totalTilesInViewY;if(a!==null){const c=Math.min(this._lastPaintedWidth,r),g=Math.min(this._lastPaintedHeight,l);for(n=0;n<g;n++)for(s=0;s<c;s++)o=n*c+s,a[o]!==i[o]&&this._paintOne(t,i[o],s,n);if(r>this._lastPaintedWidth)for(n=0;n<l;n++)for(s=this._lastPaintedWidth;s<r;s++)o=n*r+s,this._paintOne(t,i[o],s,n);if(l>this._lastPaintedHeight)for(n=this._lastPaintedHeight;n<l;n++)for(s=0;s<r;s++)o=n*r+s,this._paintOne(t,i[o],s,n)}else for(n=0;n<l;n++)for(s=0;s<r;s++)o=n*r+s,this._paintOne(t,i[o],s,n);this._lastPaintedWidth=r,this._lastPaintedHeight=l;const h=this._lastPaintedTiles;this._lastPaintedTiles=i,this._currentPaintedTiles=h}paint(t,i,s){let n,o,a,r,l,h,c,g;if(!this.ready)return;const _=this._canvas.getContext("2d");let v=this._lastPaintedTiles;if(this._pendingDimensionChange||this._pendingTileSet){for(this._calculateDimensions(),this._pendingDimensionChange=!1,this._pendingTileSet!==null&&(this._tileSet=this._pendingTileSet),_.clearRect(0,0,this.canvasWidth,this.canvasHeight),r=0,o=v!==null?v.length:0;r<o;r++)v[r]=-2;this._pendingTileSet=null}const S=this._totalTilesInViewX,C=this._totalTilesInViewY,A=this._map.getTileValuesForPainting(this._originX,this._originY,S,C,this._currentPaintedTiles);if(this.animationManager.getTiles(A,this._originX,this._originY,S,C,s),this._paintTiles(_,A),v=this._lastPaintedTiles,this._lastCanvasWidth=this.canvasWidth,this._lastCanvasHeight=this.canvasHeight,!(!t&&!i)){if(t)for(l=this._processMouse(t),r=Math.max(0,l.y),c=Math.min(C,l.yBound);r<c;r++)for(a=Math.max(0,l.x),h=Math.min(S,l.xBound);a<h;a++)g=[r*S+a],v[g]=-2;if(i)for(l=this._processSprites(_,i),n=0,o=l.length;n<o;n++){const ot=l[n];for(r=Math.max(0,ot.y),c=Math.min(ot.yBound,C);r<c;r++)for(a=Math.max(0,ot.x),h=Math.min(ot.xBound,S);a<h;a++)g=[r*S+a],this._lastPaintedTiles[g]=-2}}}},"T$2");let Fi=or;cp(Fi,"GameCanvas"),Fi.DEFAULT_ID="microcity-canvas";var dp=Object.defineProperty,up=d((t,i)=>dp(t,"name",{value:i,configurable:!0}),"x$1");const pp=up(function(t,i,s,n,o,a){const r=p.normaliseDOMid(t),l=p.normaliseDOMid(i),h=p.normaliseDOMid(s),c=p.normaliseDOMid(n),g=p.normaliseDOMid(o),_=p.normaliseDOMid(a);return function(v,S){$(r).text(S.classification),$(l).text(S.population),$(h).text(S.score),$(c).text(S.funds),$(g).text([X.months[S.date.month],S.date.year].join(" ")),$(_).text(S.name),v.addEventListener(vn,function(C){$(r).text(C)}),v.addEventListener(On,function(C){$(l).text(C)}),v.addEventListener(Mn,function(C){$(h).text(C)}),v.addEventListener(Ne,function(C){$(c).text(C)}),v.addEventListener(Sn,function(C){$(g).text(`Year ${C.year} ${X.months[C.month]}`)})}},"InfoBar");var fp=Object.defineProperty,xs=d((t,i)=>fp(t,"name",{value:i,configurable:!0}),"f$2");const gp=[wt,si,wt,kr,si,si,xr,Br,wt,Vr,wt,Fr,Nr,Wr,Hr,ni],mp=[$t,ai,$t,Kr,ai,ai,Qr,il,$t,tl,$t,el,Jr,nl,sl,ho],_p=[Ft,oi,Ft,Ur,oi,oi,Gr,jr,Ft,zr,Ft,Xr,Yr,qr,Zr,lo],Ep=xs(function(t,i){let s=0,n=this._worldEffects.getTile(t,i);if(n=T.normalizeRoad(n),n>=wt&&n<=ni){i>0&&(n=this._worldEffects.getTileValue(t,i-1),n=T.normalizeRoad(n),(n===st||n>=V&&n<=tt)&&n!==Rt&&n!==j&&n!==V&&(s|=1)),t<this._map.width-1&&(n=this._worldEffects.getTileValue(t+1,i),n=T.normalizeRoad(n),(n===j||n>=V&&n<=tt)&&n!==tt&&n!==st&&n!==rt&&(s|=2)),i<this._map.height-1&&(n=this._worldEffects.getTileValue(t,i+1),n=T.normalizeRoad(n),(n===st||n>=V&&n<=tt)&&n!==Rt&&n!==j&&n!==V&&(s|=4)),t>0&&(n=this._worldEffects.getTileValue(t-1,i),n=T.normalizeRoad(n),(n===j||n>=V&&n<=tt)&&n!==tt&&n!==st&&n!==rt&&(s|=8)),this._worldEffects.setTile(t,i,gp[s],m|M);return}if(n>=$t&&n<=ho){i>0&&(n=this._worldEffects.getTileValue(t,i-1),n=T.normalizeRoad(n),n>=q&&n<=j&&n!==q&&n!==st&&n!==lt&&(s|=1)),t<this._map.width-1&&(n=this._worldEffects.getTileValue(t+1,i),n=T.normalizeRoad(n),n>=q&&n<=j&&n!==dt&&n!==j&&n!==Bt&&(s|=2)),i<this._map.height-1&&(n=this._worldEffects.getTileValue(t,i+1),n=T.normalizeRoad(n),n>=q&&n<=j&&n!==q&&n!==st&&n!==lt&&(s|=4)),t>0&&(n=this._worldEffects.getTileValue(t-1,i),n=T.normalizeRoad(n),n>=q&&n<=j&&n!==dt&&n!==j&&n!==Bt&&(s|=8)),this._worldEffects.setTile(t,i,mp[s],m|M);return}n>=Ft&&n<=lo&&(i>0&&(n=this._worldEffects.getTile(t,i-1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Vt&&n!==tt&&n!==dt&&(s|=1))),t<this._map.width-1&&(n=this._worldEffects.getTile(t+1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Mt&&n!==Rt&&n!==q&&(s|=2))),i<this._map.height-1&&(n=this._worldEffects.getTile(t,i+1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Vt&&n!==tt&&n!==dt&&(s|=4))),t>0&&(n=this._worldEffects.getTile(t-1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Mt&&n!==Rt&&n!==q&&(s|=8))),this._worldEffects.setTile(t,i,_p[s],ui))},"fixSingle"),Tp=xs(function(t,i){this.fixSingle(t,i),i>0&&this.fixSingle(t,i-1),t<this._map.width-1&&this.fixSingle(t+1,i),i<this._map.height-1&&this.fixSingle(t,i+1),t>0&&this.fixSingle(t-1,i)},"checkZoneConnections"),wp=xs(function(t,i,s){t=t-1,i=i-1;let n;for(n=0;n<s;n++)this.fixZone(t+n,i-1);for(n=0;n<s;n++)this.fixZone(t-1,i+n);for(n=0;n<s;n++)this.fixZone(t+n,i+s);for(n=0;n<s;n++)this.fixZone(t+s,i+n)},"checkBorder"),vp=xs(function(t){return t.prototype.checkZoneConnections=Tp,t.prototype.fixSingle=Ep,t.prototype.checkBorder=wp,t},"Connector");var Sp=Object.defineProperty,yp=d((t,i)=>Sp(t,"name",{value:i,configurable:!0}),"n$8");const Dp=Kt.makeTool,Bi=yp(function(t){return vp(Dp(t))},"ConnectingTool"),it=Bi(function(t,i,s,n,o){this.init(t,s,!1),this.centreTile=i,this.size=n,this.animated=o});it.prototype.putBuilding=function(t,i){let s,n,o,a,r=this.centreTile-this.size-1;for(let l=0;l<this.size;l++){n=i+l;for(let h=0;h<this.size;h++)s=t+h,o=r,a=ss,h===1&&(l===1?a|=Ce:l===2&&this.animated&&(a|=Z)),this._worldEffects.setTile(s,n,o,a),r++}},it.prototype.prepareBuildingSite=function(t,i){if(t<0||t+this.size>this._map.width)return this.TOOLRESULT_FAILED;if(i<0||i+this.size>this._map.height)return this.TOOLRESULT_FAILED;let s,n,o;for(let a=0;a<this.size;a++){n=i+a;for(let r=0;r<this.size;r++)if(s=t+r,o=this._worldEffects.getTileValue(s,n),o!==R){if(!this.autoBulldoze)return this.TOOLRESULT_NEEDS_BULLDOZE;if(!T.canBulldoze(o))return this.TOOLRESULT_NEEDS_BULLDOZE;this._worldEffects.setTile(s,n,R),this.addCost(this.bulldozerCost)}}return this.TOOLRESULT_OK},it.prototype.buildBuilding=function(t,i){t--,i--;const s=this.prepareBuildingSite(t,i);return s!==this.TOOLRESULT_OK?s:(this.addCost(this.toolCost),this.putBuilding(t,i),this.checkBorder(t,i),this.TOOLRESULT_OK)},it.prototype.doTool=function(t,i,s){this.result=this.buildBuilding(t,i)};const Ns=nt(Bi(function(t){this.init(10,t,!0)}));Ns.prototype.putRubble=function(t,i,s){for(let n=t;n<t+s;n++)for(let o=i;o<i+s;o++)if(this._map.testBounds(n,o)){const a=this._worldEffects.getTileValue(n,o);a!=ii&&a!=R&&this._worldEffects.setTile(n,o,li+u.getRandom(2),Z|m)}},Ns.prototype.layDoze=function(t,i){let s=this._worldEffects.getTile(t,i);if(!s.isBulldozable())return this.TOOLRESULT_FAILED;switch(s=s.getValue(),s=T.normalizeRoad(s),s){case at:case rt:case ye:case Se:case nn:case To:case wo:case vo:case rn:case Do:case bo:case Oo:case Mt:case Vt:case lt:case Bt:this._worldEffects.setTile(t,i,f);break;default:this._worldEffects.setTile(t,i,R);break}return this.addCost(1),this.TOOLRESULT_OK},Ns.prototype.doTool=function(t,i,s){this._map.testBounds(t,i)||(this.result=this.TOOLRESULT_FAILED);const n=this._worldEffects.getTile(t,i),o=n.getValue();let a=0,r,l;if(n.isZone())a=P.checkZoneSize(o),r=0,l=0;else{const h=P.checkBigZone(o);a=h.zoneSize,r=h.deltaX,l=h.deltaY}if(a>0){this.addCost(this.bulldozerCost);const h=t+r,c=i+l;switch(a){case 3:this._emitEvent(Ds),this.putRubble(h-1,c-1,3);break;case 4:this._emitEvent(Ln),this.putRubble(h-1,c-1,4);break;case 6:this._emitEvent(Ds),this._emitEvent(Ln),this.putRubble(h-1,c-1,6);break}this.result=this.TOOLRESULT_OK}else{let h;o===f||o===b||o===W?(h=this.layDoze(t,i),o!==this._worldEffects.getTileValue(t,i)&&this.addCost(5)):(h=this.layDoze(t,i),this.checkZoneConnections(t,i)),this.result=h}};const bp=Kt.makeTool,ar=bp(function(t){this.init(10,t,!0,!0)});ar.prototype.doTool=function(t,i,s){if(this._worldEffects.getTileValue(t,i)!==R){this.result=this.TOOLRESULT_NEEDS_BULLDOZE;return}const n=u.getRandom(4);let o=M|m,a;n===4?(a=yo,o|=Z):a=n+Pr,this._worldEffects.setTile(t,i,a,o),this.addCost(10),this.result=this.TOOLRESULT_OK};const Xn=Bi(function(t){this.init(20,t,!0,!0)});Xn.prototype.layRail=function(t,i){this.doAutoBulldoze(t,i);let s=this._worldEffects.getTileValue(t,i);s=T.normalizeRoad(s);let n=this.toolCost;switch(s){case R:this._worldEffects.setTile(t,i,$t,m|M);break;case f:case b:case W:if(n=100,t<this._map.width-1&&(s=this._worldEffects.getTileValue(t+1,i),s=T.normalizeRoad(s),s==q||s==lt||s>=$t&&s<=st)){this._worldEffects.setTile(t,i,lt,m);break}if(t>0&&(s=this._worldEffects.getTileValue(t-1,i),s=T.normalizeRoad(s),s==q||s==lt||s>Bt&&s<j)){this._worldEffects.setTile(t,i,lt,m);break}if(i<this._map.height-1&&(s=this._worldEffects.getTileValue(t,i+1),s=T.normalizeRoad(s),s==dt||s==j||s>lt&&s<st)){this._worldEffects.setTile(t,i,Bt,m);break}if(i>0&&(s=this._worldEffects.getTileValue(t,i-1),s=T.normalizeRoad(s),s==dt||s==j||s>lt&&s<st)){this._worldEffects.setTile(t,i,Bt,m);break}return this.TOOLRESULT_FAILED;case Ft:this._worldEffects.setTile(t,i,dt,k|M|m);break;case oi:this._worldEffects.setTile(t,i,q,k|M|m);break;case wt:this._worldEffects.setTile(t,i,j,M|m);break;case si:this._worldEffects.setTile(t,i,st,M|m);break;default:return this.TOOLRESULT_FAILED}return this.addCost(n),this.checkZoneConnections(t,i),this.TOOLRESULT_OK},Xn.prototype.doTool=function(t,i,s){this.result=this.layRail(t,i)};const jn=Bi(function(t){this.init(10,t,!0,!0)});jn.prototype.layRoad=function(t,i){this.doAutoBulldoze(t,i);let s=this._worldEffects.getTileValue(t,i),n=this.toolCost;switch(s){case R:this._worldEffects.setTile(t,i,wt,m|M);break;case f:case b:case W:if(n=50,t<this._map.width-1&&(s=this._worldEffects.getTileValue(t+1,i),s=T.normalizeRoad(s),s===j||s===at||s>=wt&&s<=Rt)){this._worldEffects.setTile(t,i,at,m);break}if(t>0&&(s=this._worldEffects.getTileValue(t-1,i),s=T.normalizeRoad(s),s===j||s===at||s>=wt&&s<=ni)){this._worldEffects.setTile(t,i,at,m);break}if(i<this._map.height-1&&(s=this._worldEffects.getTileValue(t,i+1),s=T.normalizeRoad(s),s===st||s===tt||s>=rt&&s<=ni)){this._worldEffects.setTile(t,i,rt,m);break}if(i>0&&(s=this._worldEffects.getTileValue(t,i-1),s=T.normalizeRoad(s),s===st||s===tt||s>=rt&&s<=ni)){this._worldEffects.setTile(t,i,rt,m);break}return this.TOOLRESULT_FAILED;case Ft:this._worldEffects.setTile(t,i,tt,k|M|m);break;case oi:this._worldEffects.setTile(t,i,Rt,k|M|m);break;case $t:this._worldEffects.setTile(t,i,st,M|m);break;case ai:this._worldEffects.setTile(t,i,j,M|m);break;default:return this.TOOLRESULT_FAILED}return this.addCost(n),this.checkZoneConnections(t,i),this.TOOLRESULT_OK},jn.prototype.doTool=function(t,i,s){this.result=this.layRoad(t,i)};const Op=Kt.makeTool,xt=nt(Op(function(t){this.init(0,t,!1,!1)}));xt.prototype.classifyPopulationDensity=function(t,i,s){let n=s.populationDensityMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryDensity").text(X.densityStrings[n])},xt.prototype.classifyLandValue=function(t,i,s){const n=s.landValueMap.worldGet(t,i);let o=0;n>=150?o=3:n>=80?o=2:n>=30&&(o=1);const a=X.landValueStrings[o];$("#queryLandValue").text(a)},xt.prototype.classifyCrime=function(t,i,s){let n=s.crimeRateMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryCrime").text(X.crimeStrings[n])},xt.prototype.classifyPollution=function(t,i,s){let n=s.pollutionDensityMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryPollution").text(X.pollutionStrings[n])},xt.prototype.classifyRateOfGrowth=function(t,i,s){let n=s.rateOfGrowthMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryRate").text(X.rateStrings[n])},xt.prototype.classifyDebug=function(t,i,s){},xt.prototype.classifyZone=function(t,i){const s=[R,f,Gi,Yi,se,ii,Ys,V,vt,Ht,Wt,qs,ji,Ut,ll,Js,hl,cl,_o,dl,nn,So,yo,pl,an,rn,952];let n=this._map.getTileValue(t,i);n>=fl&&n<an&&(n=Js);let o,a;for(o=0,a=s.length-1;o<a&&!(n<s[o+1]);o++);$("#queryZoneType").text(X.zoneTypes[o])},xt.prototype.doTool=function(t,i,s){let n="Position ("+t+", "+i+")";n+=" TileValue: "+this._map.getTileValue(t,i),hc.queryDebug,this.classifyZone(t,i),this.classifyPopulationDensity(t,i,s),this.classifyLandValue(t,i,s),this.classifyCrime(t,i,s),this.classifyPollution(t,i,s),this.classifyRateOfGrowth(t,i,s),this.classifyDebug(t,i,s),this._emitEvent(re),this.result=this.TOOLRESULT_OK};const Zn=Bi(function(t){this.init(5,t,!0,!0)});Zn.prototype.layWire=function(t,i){this.doAutoBulldoze(t,i);let s=this.toolCost,n=this._worldEffects.getTileValue(t,i);switch(n=T.normalizeRoad(n),n){case R:this._worldEffects.setTile(t,i,Ft,k|M|m);break;case f:case b:case W:if(s=25,t<this._map.width-1&&(n=this._worldEffects.getTile(t+1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=Rt&&n!=q&&n!=Mt))){this._worldEffects.setTile(t,i,Vt,k|m);break}if(t>0&&(n=this._worldEffects.getTile(t-1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=Rt&&n!=q&&n!=Mt))){this._worldEffects.setTile(t,i,Vt,k|m);break}if(i<this._map.height-1&&(n=this._worldEffects.getTile(t,i+1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=tt&&n!=dt&&n!=Vt))){this._worldEffects.setTile(t,i,Mt,k|m);break}if(i>0&&(n=this._worldEffects.getTile(t,i-1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=tt&&n!=dt&&n!=Vt))){this._worldEffects.setTile(t,i,Mt,k|m);break}return this.TOOLRESULT_FAILED;case wt:this._worldEffects.setTile(t,i,Rt,k|M|m);break;case si:this._worldEffects.setTile(t,i,tt,k|M|m);break;case $t:this._worldEffects.setTile(t,i,q,k|M|m);break;case ai:this._worldEffects.setTile(t,i,dt,k|M|m);break;default:return this.TOOLRESULT_FAILED}return this.addCost(s),this.checkZoneConnections(t,i),this.TOOLRESULT_OK},Zn.prototype.doTool=function(t,i,s){this.result=this.layWire(t,i)};var Cp=Object.defineProperty,Rp=d((t,i)=>Cp(t,"name",{value:i,configurable:!0}),"i$4");function rr(t){const i=nt({airport:new it(1e4,F,t,6,!1),bulldozer:new Ns(t),coal:new it(3e3,Gt,t,4,!1),commercial:new it(100,Ks,t,3,!1),fire:new it(500,mo,t,3,!1),industrial:new it(100,Qs,t,3,!1),nuclear:new it(5e3,Pt,t,4,!0),park:new ar(t),police:new it(500,en,t,3,!1),port:new it(3e3,ne,t,4,!1),rail:new Xn(t),residential:new it(100,De,t,3,!1),road:new jn(t),query:new xt(t),stadium:new it(5e3,Yt,t,4,!1),wire:new Zn(t)});return i.query.addEventListener(re,p.reflectEvent.bind(i,re)),i}d(rr,"a$4"),Rp(rr,"GameTools");var Mp=Object.defineProperty,_t=d((t,i)=>Mp(t,"name",{value:i,configurable:!0}),"s$4");const $p="#"+Fi.DEFAULT_ID,qn=nt(function(t,i){this.gameTools=rr(t),this.gameTools.addEventListener(re,p.reflectEvent.bind(this,re)),this.canvasID=p.normaliseDOMid($p),this._tileWidth=i,this.up=!1,this.down=!1,this.left=!1,this.right=!1,this.escape=!1,this.mouseX=-1,this.mouseY=-1,this._dragging=!1,this._lastdragX=-1,this._lastdragY=-1,this.toolName=null,this.currentTool=null,this.toolWidth=0,this.toolColour="",$(document).keydown(lr.bind(this)),$(document).keyup(hr.bind(this)),this.getRelativeCoordinates=cr.bind(this),$(this.canvasID).on("mouseenter",dr.bind(this)),$(this.canvasID).on("mouseleave",fr.bind(this)),this.mouseDownHandler=ur.bind(this),this.mouseMoveHandler=gr.bind(this),this.mouseUpHandler=pr.bind(this),this.canvasClickHandler=mr.bind(this),$(".toolButton").click(_r.bind(this)),$("#budgetRequest").click(Pp.bind(this)),$("#evalRequest").click(Ip.bind(this)),$("#disasterRequest").click(Lp.bind(this)),$("#pauseRequest").click(this.speedChangeHandler.bind(this)),$("#screenshotRequest").click(kp.bind(this)),$("#settingsRequest").click(xp.bind(this)),$("#saveRequest").click(Np.bind(this)),$("#debugRequest").click(Ap.bind(this))});function lr(t){let i=!1;switch(t.keyCode){case 38:case 87:this.up=!0,i=!0;break;case 40:case 83:this.down=!0,i=!0;break;case 39:case 68:this.right=!0,i=!0;break;case 37:case 65:this.left=!0,i=!0;break;case 27:this.escape=!0,i=!0}i&&t.preventDefault()}d(lr,"v$1"),_t(lr,"keyDownHandler");function hr(t){switch(t.keyCode){case 38:case 87:this.up=!1;break;case 40:case 83:this.down=!1;break;case 39:case 68:this.right=!1;break;case 37:case 65:this.left=!1;break;case 27:this.escape=!1}}d(hr,"g$4"),_t(hr,"keyUpHandler");function cr(t){const i=document.querySelector(this.canvasID).getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top}}d(cr,"E$1"),_t(cr,"getRelativeCoordinates");function dr(t){this.currentTool!==null&&($(this.canvasID).on("mousemove",this.mouseMoveHandler),this.currentTool.isDraggable?$(this.canvasID).on("mousedown",this.mouseDownHandler):$(this.canvasID).on("click",this.canvasClickHandler))}d(dr,"_$3"),_t(dr,"mouseEnterHandler");function ur(t){if(t.which!==1||t.shiftKey||t.altKey||t.ctrlKey||t.metaKey)return;const i=this.getRelativeCoordinates(t);this.mouseX=i.x,this.mouseY=i.y,this._dragging=!0,this._emitEvent(Li,{x:this.mouseX,y:this.mouseY}),this._lastDragX=Math.floor(this.mouseX/this._tileWidth),this._lastDragY=Math.floor(this.mouseY/this._tileWidth),$(this.canvasID).on("mouseup",this.mouseUpHandler),t.preventDefault()}d(ur,"p$5"),_t(ur,"mouseDownHandler");function pr(t){this._dragging=!1,this._lastDragX=-1,this._lastDragY=-1,$(this.canvasID).off("mouseup"),t.preventDefault()}d(pr,"C$1"),_t(pr,"mouseUpHandler");function fr(t){$(this.canvasID).off("mousedown"),$(this.canvasID).off("mousemove"),$(this.canvasID).off("mouseup"),this._dragging&&(this._dragging=!1,this._lastDragX=-1,this._lastDragY=-1),$(this.canvasID).off("click"),this.mouseX=-1,this.mouseY=-1}d(fr,"I$1"),_t(fr,"mouseLeaveHandler");function gr(t){const i=this.getRelativeCoordinates(t);if(this.mouseX=i.x,this.mouseY=i.y,this._dragging){const s=Math.floor(this.mouseX/this._tileWidth),n=Math.floor(this.mouseY/this._tileWidth),o=this._lastDragX,a=this._lastDragY;(s!==o||n!==a)&&(this._emitEvent(Li,{x:this.mouseX,y:this.mouseY}),this._lastDragX=s,this._lastDragY=n)}}d(gr,"b"),_t(gr,"mouseMoveHandler");function mr(t){t.which!==1||t.shiftKey||t.altKey||t.ctrlKey||t.metaKey||this.mouseX===-1||this._mouseY===-1||this._dragging||(this._emitEvent(Li,{x:this.mouseX,y:this.mouseY}),t.preventDefault())}d(mr,"k$1"),_t(mr,"canvasClickHandler");function _r(t){$(".selected").each(function(){$(this).removeClass("selected"),$(this).addClass("unselected")}),$(t.target).removeClass("unselected"),$(t.target).addClass("selected"),this.toolName=$(t.target).attr("data-tool"),this.toolWidth=$(t.target).attr("data-size"),this.currentTool=this.gameTools[this.toolName],this.toolColour="",this.toolName!=="query"?($(this.canvasID).removeClass("helpPointer"),$(this.canvasID).addClass("pointer")):($(this.canvasID).removeClass("pointer"),$(this.canvasID).addClass("helpPointer")),t.preventDefault()}d(_r,"H"),_t(_r,"toolButtonHandler"),qn.prototype.speedChangeHandler=function(t){const i=$("#pauseRequest").text(),s=i==="Pause"?"Play":"Pause";$("#pauseRequest").text(s),this._emitEvent(In,i)},qn.prototype.clearTool=function(){this.toolName==="query"&&($(this.canvasID).removeClass("helpPointer"),$(this.canvasID).addClass("pointer")),this.currentTool=null,this.toolWidth=0,this.toolColour="",$(".selected").removeClass("selected")};const Ee=_t(function(t){const i=ya[t];return function(s){this._emitEvent(i)}},"makeHandler");var Pp=Ee("BUDGET_REQUESTED"),Ap=Ee("DEBUG_WINDOW_REQUESTED"),Lp=Ee("DISASTER_REQUESTED"),Ip=Ee("EVAL_REQUESTED"),kp=Ee("SCREENSHOT_WINDOW_REQUESTED"),xp=Ee("SETTINGS_WINDOW_REQUESTED"),Np=Ee("SAVE_REQUESTED"),Vp=Object.defineProperty,Vs=d((t,i)=>Vp(t,"name",{value:i,configurable:!0}),"e$4");const Fp=10,Hi=Vs(function(t,i,s,n){this.isOpen=!1,this._tracking=null,$(Fs).toggle(),this.canvas=new Fi(Wp,Hp),this.canvas.init(t,i,s,n),this.canvas.disallowOffMap(),this._onMove=Gp.bind(this),this._onDie=Yp.bind(this),this._timeout=null,$(Fs).toggle(),this.close=Up.bind(this),$(Bp).on("submit",this.close)},"MonsterTV");var Bp="#monsterTVForm",Hp="#tvContainer",Wp="#tvCanvas",Fs="#monstertv",Up=Vs(function(t){t&&t.preventDefault(),this.isOpen=!1,$(Fs).toggle()},"close");Hi.prototype.paint=function(t,i){!this.isOpen||this.canvas.paint(null,t,i)};var Gp=Vs(function(t){const i=this.canvas.getTileOrigin(),s=this.canvas.getMaxTile();(t.x<i.x||t.y<i.y||t.x>=s.x||t.y>=s.y)&&this.canvas.centreOn(t.x,t.y)},"onMove"),Yp=Vs(function(t){this._tracking.removeEventListener(Fe,this._onMove),this._tracking.removeEventListener(le,this._onDie),this._tracking=null,this._timeout=window.setTimeout(function(){this._timeout=null,this.close()}.bind(this),Fp*1e3)},"onDie");Hi.prototype.track=function(t,i,s){this._tracking!==null&&(this._tracking.removeEventListener(Fe,this._onMove),this._tracking.removeEventListener(le,this._onDie)),this._tracking=s,s.addEventListener(Fe,this._onMove),s.addEventListener(le,this._onDie),this.canvas.centreOn(t,i),this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),!this.isOpen&&this.open()},Hi.prototype.show=function(t,i){this.canvas.centreOn(t,i),this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),!this.isOpen&&this.open()},Hi.prototype.open=function(t){this.isOpen=!0,$(Fs).toggle()};var zp=Object.defineProperty,Kn=d((t,i)=>zp(t,"name",{value:i,configurable:!0}),"s$2");const Er=30,Xp=Kn(function(t){t&&t.preventDefault(),this._element.is(":visible")&&this._element.toggle()},"close"),jp=Kn(function(t){t.preventDefault(),!(this._x===-1||this._y===-1)&&this._map.centreOn(this._x,this._y)},"handleClick");function te(t,i,s){t=p.normaliseDOMid(t),this._map=i,this._element=$(t),this._timeout=null,this._handleClick=jp.bind(this),this._x=-1,this._y=-1,this._element.click(this._handleClick),this.close=Xp.bind(this),this._element.is(":visible")&&this._element.toggle()}d(te,"e$3"),Kn(te,"Notification"),te.prototype._displayLink=function(t,i,s){this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),this._element.text(t),this._x=i,this._y=s,this._element.addClass("pointer"),this._element.is(":visible")||this._element.toggle(),this._timeout=window.setTimeout(function(){this._timeout=null,this.close()}.bind(this),Er*1e3)},te.prototype._displayText=function(t,i,s){this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),this._element.removeClass("pointer"),this._element.text(t),this._x=-1,this._y=-1,this._element.is(":visible")||this._element.toggle(),this._timeout=window.setTimeout(function(){this._timeout=null,this.close()}.bind(this),Er*1e3)},te.prototype.createMessage=function(t){if(t.hasOwnProperty("data")&&t.data!==void 0&&t.data.hasOwnProperty("x")&&t.data.hasOwnProperty("y")){this._displayLink(X.messageText[t.subject],t.data.x,t.data.y);return}this._displayText(X.messageText[t.subject])},te.prototype.badNews=function(t){this._element.removeClass("neutral"),this._element.removeClass("good"),this._element.addClass("bad"),this.createMessage(t)},te.prototype.goodNews=function(t){this._element.removeClass("neutral"),this._element.removeClass("bad"),this._element.addClass("good"),this.createMessage(t)},te.prototype.news=function(t){this._element.removeClass("good"),this._element.removeClass("bad"),this._element.addClass("neutral"),this.createMessage(t)};var Zp=Object.defineProperty,qp=d((t,i)=>Zp(t,"name",{value:i,configurable:!0}),"t$3");const Qn=Ct(function(){this._debugToggled=!1,$(Kp).on("submit",Jp.bind(this))});var Kp="#queryForm";const Qp="#queryOK";var Jp=qp(function(t){t.preventDefault(),this.close()},"submit");Qn.prototype.close=function(){this._toggleDisplay(),this._emitEvent(Cn)},Qn.prototype.open=function(){this._toggleDisplay(),$(Qp).focus()};var tf=Object.defineProperty,ef=d((t,i)=>tf(t,"name",{value:i,configurable:!0}),"o$3");function Nt(t,i,s){if(arguments.length<2)throw new Error("RCI constructor called with too few arguments "+[].toString.apply(arguments));if(s===void 0&&(s=Nt.DEFAULT_ID),typeof t=="string"){const a=t;if(t=$(p.normaliseDOMid(t)),t=t.length===0?null:t[0],t===null)throw new Error("Node "+a+" not found")}this._padding=3,this._buckets=10,this._rectSize=5,this._scale=Math.floor(2e3/this._buckets),this._canvas=$("<canvas></canvas>",{id:s})[0];const n=$(p.normaliseDOMid(s)),o=n.length>0?n[0]:null;if(o!==null)if(o.parentNode===t)t.replaceChild(this._canvas,o);else throw new Error("ID "+s+" already exists in document!");else t.appendChild(this._canvas);this._initialisedBounds=!1,i.addEventListener(He,this.update.bind(this))}d(Nt,"a$2"),ef(Nt,"RCI"),Nt.prototype._clear=function(t){t.clearRect(0,0,this._canvas.width,this._canvas.height)},Nt.prototype._drawRect=function(t){const i=this._padding*this._rectSize,s=(this._buckets+this._padding)*this._rectSize,n=7*this._padding*this._rectSize,o=this._padding*this._rectSize;t.fillStyle="rgb(192, 192, 192)",t.fillRect(i,s,n,o)},Nt.prototype._drawValue=function(t,i,s){i>1&&(s=Math.floor(2e3/1500*s));const n=["rgb(0,255,0)","rgb(0, 0, 139)","rgb(255, 255, 0)"],o=Math.floor(Math.abs(s)/this._scale),a=s>=0?this._buckets+this._padding-o:this._buckets+2*this._padding,r=2*this._padding+i*2*this._padding;t.fillStyle=n[i],t.fillRect(r*this._rectSize,a*this._rectSize,this._padding*this._rectSize,o*this._rectSize)},Nt.prototype._drawLabel=function(t,i){const s=["R","C","I"],n=2*this._padding+i*2*this._padding+Math.floor(this._padding/2);t.font="normal xx-small sans-serif",t.fillStyle="rgb(0, 0, 0)",t.textBaseline="bottom",t.fillText(s[i],n*this._rectSize,(this._buckets+2*this._padding)*this._rectSize)},Nt.prototype.update=function(t){if(!this._initialised){const n=this._canvas.parentNode.getBoundingClientRect();this._canvas.width=n.width,this._canvas.height=n.height,this._canvas.style.margin="0",this._canvas.style.padding="0",this._intialised=!0}const i=this._canvas.getContext("2d");this._clear(i),this._drawRect(i);const s=[t.residential,t.commercial,t.industrial];for(let n=0;n<3;n++)this._drawValue(i,n,s[n]),this._drawLabel(i,n)},Object.defineProperty(Nt,"DEFAULT_ID",p.makeConstantDescriptor("RCICanvas"));var sf=Object.defineProperty,nf=d((t,i)=>sf(t,"name",{value:i,configurable:!0}),"i$3");const of="#saveForm",af="#saveOK",rf=nf(function(t){t.preventDefault(),this.close()},"submit"),Jn=Ct(function(){$(of).on("submit",rf.bind(this))});Jn.prototype.close=function(){this._toggleDisplay(),this._emitEvent(Rn)},Jn.prototype.open=function(){this._toggleDisplay(),$(af).focus()};var lf=Object.defineProperty,Tr=d((t,i)=>lf(t,"name",{value:i,configurable:!0}),"o$2");const hf="#screenshotLinkForm",cf="#screenshotLink";Tr(function(t){t.preventDefault(),this.close()},"cancel");const df=Tr(function(t){t.preventDefault(),this.close()},"submit"),to=Ct(function(){$(hf).on("submit",df.bind(this))});to.prototype.close=function(){this._toggleDisplay(),this._emitEvent($n)},to.prototype.open=function(t){$(cf).attr("href",t),this._toggleDisplay()};var uf=Object.defineProperty,wr=d((t,i)=>uf(t,"name",{value:i,configurable:!0}),"o$1");const ee=Ct(function(){$(pf).on("click",gf.bind(this)),$(ff).on("submit",mf.bind(this))});var pf="#screenshotCancel",ff="#screenshotForm";ee.prototype.close=function(t){t=t||null,this._toggleDisplay(),this._emitEvent(Pn,t)};var gf=wr(function(t){t.preventDefault(),this.close(null)},"cancel"),mf=wr(function(t){t.preventDefault();let i=null;$(".screenshotType:checked").val()==="visible"?i=ee.SCREENSHOT_VISIBLE:i=ee.SCREENSHOT_ALL,this.close(i)},"submit");ee.prototype.open=function(t){this._toggleDisplay()};const vr=function(){let t=1;return function(i){Object.defineProperty(ee,i,p.makeConstantDescriptor(t)),t+=1}}();vr("SCREENSHOT_VISIBLE"),vr("SCREENSHOT_ALL");var _f=Object.defineProperty,Sr=d((t,i)=>_f(t,"name",{value:i,configurable:!0}),"i$1");const Ef="#settingsCancel",Tf="#settingsForm",wf="#autoBudgetYes",vf="#autoBudgetNo",Sf="#autoBulldozeYes",yf="#autoBulldozeNo",Df="#speedSlow",bf="#speedMed",Of="#speedFast",Cf="#disastersYes",Rf="#disastersNo",Mf=Sr(function(t){t.preventDefault(),this.close([])},"cancel"),$f=Sr(function(t){t.preventDefault();const i=[];let s=$(".autoBudgetSetting:checked").val();s==="true"?s=!0:s=!1,i.push({action:ct.AUTOBUDGET,data:s});let n=$(".autoBulldozeSetting:checked").val();n==="true"?n=!0:n=!1,i.push({action:ct.AUTOBULLDOZE,data:n});const o=$(".speedSetting:checked").val()-0;i.push({action:ct.SPEED,data:o});let a=$(".enableDisastersSetting:checked").val();a==="true"?a=!0:a=!1,i.push({action:ct.DISASTERS_CHANGED,data:a}),this.close(i)},"submit"),ct=Ct(function(){$(Ef).on("click",Mf.bind(this)),$(Tf).on("submit",$f.bind(this))});ct.prototype.close=function(t){t=t||[],this._emitEvent(An,t),this._toggleDisplay()},ct.prototype.open=function(t){t.autoBudget?$(wf).prop("checked",!0):$(vf).prop("checked",!0),t.autoBulldoze?$(Sf).prop("checked",!0):$(yf).prop("checked",!0),t.speed===y.SPEED_SLOW?$(Df).prop("checked",!0):t.speed===y.SPEED_MED?$(bf).prop("checked",!0):$(Of).prop("checked",!0),t.disasters?$(Cf).prop("checked",!0):$(Rf).prop("checked",!0),this._toggleDisplay()};const Bs=function(){let t=0;return function(i){Object.defineProperty(ct,i,p.makeConstantDescriptor(t)),t+=1}}();Bs("AUTOBUDGET"),Bs("AUTOBULLDOZE"),Bs("SPEED"),Bs("DISASTERS_CHANGED");var Pf=Object.defineProperty,Af=d((t,i)=>Pf(t,"name",{value:i,configurable:!0}),"i");const Lf="#touchForm",If="#touchOK",kf=Af(function(t){t.preventDefault(),this.close()},"submit"),eo=Ct(function(){$(Lf).on("submit",kf.bind(this))});eo.prototype.close=function(){this._toggleDisplay(),this._emitEvent(kn)},eo.prototype.open=function(){this._toggleDisplay(),$(If).focus()};var xf=Object.defineProperty,Te=d((t,i)=>xf(t,"name",{value:i,configurable:!0}),"h");const yr=20*1e3;function I(t,i,s,n,o,a){o=o||0;let r;t.isSavedGame?(this.gameMap=new x(t.width||120,t.height||100),r=t):(this.gameMap=t,r=null),this.tileSet=i,this.snowTileSet=s,this.defaultSpeed=y.SPEED_MED,this.simulation=new y(this.gameMap,o,this.defaultSpeed,r),this.tickDuration=30,this.name=a||"MyTown",this.everClicked=!1,r&&this.load(r),this.rci=new Nt("RCIContainer",this.simulation),this.gameCanvas=new Fi("canvasContainer"),this.gameCanvas.init(this.gameMap,this.tileSet,n),this.inputStatus=new qn(this.gameMap,i.tileWidth),this.dialogOpen=!1,this._openWindow=null,this.mouse=null,this.lastCoord=null,this.simNeededBudget=!1,this.isPaused=!1,this.lastBadMessageTime=null,this.monsterTV=new Hi(this.gameMap,i,n,this.gameCanvas.animationManager);const l="opaque";this.genericDialogClosure=br.bind(this),this.handleEvalRequest=ie("eval",function(){return[this.simulation.evaluation]}.bind(this)),this.evalWindow=new ks(l,"evalWindow"),this.evalWindow.addEventListener(bn,this.genericDialogClosure),this.inputStatus.addEventListener(ga,this.handleEvalRequest.bind(this)),this.handleBudgetRequest=ie("budget",function(){return[{roadMaintenanceBudget:this.simulation.budget.roadMaintenanceBudget,roadRate:Math.floor(this.simulation.budget.roadPercent*100),fireMaintenanceBudget:this.simulation.budget.fireMaintenanceBudget,fireRate:Math.floor(this.simulation.budget.firePercent*100),policeMaintenanceBudget:this.simulation.budget.policeMaintenanceBudget,policeRate:Math.floor(this.simulation.budget.policePercent*100),taxRate:this.simulation.budget.cityTax,totalFunds:this.simulation.budget.totalFunds,taxesCollected:this.simulation.budget.taxFund}]}.bind(this)),this.budgetWindow=new Gn(l,"budget"),this.budgetWindow.addEventListener(wn,this.handleBudgetWindowClosure.bind(this)),this.inputStatus.addEventListener(ua,this.handleBudgetRequest.bind(this)),this.disasterWindow=new U(l,"disasterWindow"),this.disasterWindow.addEventListener(Dn,this.handleDisasterWindowClosure.bind(this)),this.inputStatus.addEventListener(fa,this.handleDisasterRequest.bind(this)),this.debugWindow=new ti(l,"debugWindow"),this.debugWindow.addEventListener(yn,this.handleDebugWindowClosure.bind(this)),this.inputStatus.addEventListener(pa,this.handleDebugRequest.bind(this)),this.handleSettingsRequest=ie("settings",function(){return[{autoBudget:this.simulation.budget.autoBudget,autoBulldoze:Kt.getAutoBulldoze(),speed:this.defaultSpeed,disasters:this.simulation.disasterManager.disastersEnabled}]}.bind(this)),this.settingsWindow=new ct(l,"settingsWindow"),this.settingsWindow.addEventListener(An,this.handleSettingsWindowClosure.bind(this)),this.inputStatus.addEventListener(Ta,this.handleSettingsRequest.bind(this)),this.screenshotWindow=new ee(l,"screenshotWindow"),this.screenshotWindow.addEventListener(Pn,this.handleScreenshotWindowClosure.bind(this)),this.inputStatus.addEventListener(Ea,this.handleScreenshotRequest.bind(this)),this.screenshotLinkWindow=new to(l,"screenshotLinkWindow"),this.screenshotLinkWindow.addEventListener($n,this.genericDialogClosure),this.saveWindow=new Jn(l,"saveWindow"),this.saveWindow.addEventListener(Rn,this.genericDialogClosure),this.touchWindow=new eo(l,"touchWarnWindow"),this.touchWindow.addEventListener(kn,this.genericDialogClosure),this.queryWindow=new Qn(l,"queryWindow"),this.queryWindow.addEventListener(Cn,this.genericDialogClosure),this.inputStatus.addEventListener(re,this.handleQueryRequest.bind(this)),this.inputStatus.addEventListener(_a,this.handleSave.bind(this)),this.simulation.addEventListener(L,this.processFrontEndMessage.bind(this)),this.simulation.addEventListener(xe,this.handleMandatoryBudget.bind(this)),this.inputStatus.addEventListener(Li,this.handleTool.bind(this)),this.inputStatus.addEventListener(In,this.handlePause.bind(this)),this.infoBar=pp("cclass","population","score","funds","date","name");const h={classification:this.simulation.evaluation.cityClass,population:this.simulation.evaluation.cityPop,score:this.simulation.evaluation.cityScore,funds:this.simulation.budget.totalFunds,date:this.simulation.getDate(),name:this.name};this.infoBar(this.simulation,h),this._notificationBar=new te("#notifications",this.gameCanvas),this._reachedTown=this._reachedCity=this._reachedCapital=this._reachedMetropolis=this._reacedMegalopolis=!1,this.revealControls(),this._notificationBar._element.toggle(),this.tick=Nf.bind(this),this.tick(),this.commonAnimate=Vf.bind(this),this.animate=this.commonAnimate.bind(this),this.animate()}d(I,"n"),Te(I,"Game"),I.prototype.save=function(){const t={name:this.name,everClicked:this.everClicked};Kt.save(t),this.simulation.save(t),fe.saveGame(t)},I.prototype.load=function(t){this.name=t.name,this.everClicked=t.everClicked,Kt.load(t),this.simulation.load(t)};const Dr=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame;I.prototype.revealControls=function(){$(".initialHidden").each(function(t){$(this).removeClass("initialHidden")}),this.rci.update({residential:750,commercial:750,industrial:750})};function br(){this.dialogOpen=!1,this._openWindow=null}d(br,"q"),Te(br,"genericDialogClosure"),I.prototype.onDateChange=function(t){},I.prototype.handleDisasterWindowClosure=function(t){if(this.dialogOpen=!1,t!==U.DISASTER_NONE)switch(t){case U.DISASTER_MONSTER:this.simulation.spriteManager.makeMonster();break;case U.DISASTER_FIRE:this.simulation.disasterManager.makeFire();break;case U.DISASTER_FLOOD:this.simulation.disasterManager.makeFlood();break;case U.DISASTER_CRASH:this.simulation.disasterManager.makeCrash();break;case U.DISASTER_MELTDOWN:this.simulation.disasterManager.makeMeltdown();break;case U.DISASTER_TORNADO:this.simulation.spriteManager.makeTornado()}},I.prototype.handleSettingsWindowClosure=function(t){this.dialogOpen=!1;for(let i=0,s=t.length;i<s;i++){const n=t[i];switch(n.action){case ct.AUTOBUDGET:this.simulation.budget.setAutoBudget(n.data);break;case ct.AUTOBULLDOZE:Kt.setAutoBulldoze(n.data);break;case ct.SPEED:this.defaultSpeed=n.data,this.simulation.setSpeed(this.defaultSpeed);break;case ct.DISASTERS_CHANGED:this.simulation.disasterManager.disastersEnabled=n.data;break;default:console.warn("Unexpected action",n)}}},I.prototype.handleDebugWindowClosure=function(t){this.dialogOpen=!1;for(let i=0,s=t.length;i<s;i++){const n=t[i];switch(n.action){case ti.ADD_FUNDS:this.simulation.budget.spend(-1e6);break;default:console.warn("Unexpected action",n)}}},I.prototype.handleScreenshotWindowClosure=function(t){if(this.dialogOpen=!1,t===null)return;let i;t===ee.SCREENSHOT_VISIBLE?i=this.gameCanvas.screenshotVisible():t===ee.SCREENSHOT_ALL&&(i=this.gameCanvas.screenshotMap()),this.dialogOpen=!0,this._openWindow="screenshotLinkWindow",this.screenshotLinkWindow.open(i)},I.prototype.handleBudgetWindowClosure=function(t){this.dialogOpen=!1,t.cancelled||(this.simulation.budget.roadPercent=t.roadPercent/100,this.simulation.budget.firePercent=t.firePercent/100,this.simulation.budget.policePercent=t.policePercent/100,this.simulation.budget.setTax(t.taxPercent-0),this.simNeededBudget?(this.simulation.budget.doBudgetWindow(),this.simNeededBudget=!1):this.simulation.budget.updateFundEffects())};function ie(t,i){return i=i||null,function(){if(this.dialogOpen){console.warn("Request made to open "+t+" window. There is a dialog open!");return}this.dialogOpen=!0,this._openWindow=t+"Window";const s=t+"Window";let n=[];i&&(n=i()),this[s].open.apply(this[s],n)}}d(ie,"u"),Te(ie,"makeWindowOpenHandler"),I.prototype.handleDebugRequest=ie("debug"),I.prototype.handleDisasterRequest=ie("disaster"),I.prototype.handleQueryRequest=ie("query"),I.prototype.handleScreenshotRequest=ie("screenshot"),I.prototype.handleMandatoryBudget=function(){this.simNeededBudget=!0,this.handleBudgetRequest()},I.prototype.handleTool=function(t){const i=t.x,s=t.y,n=this.gameCanvas.canvasCoordinateToTileCoordinate(i,s);if(n===null)return;const o=this.inputStatus.currentTool,a=this.simulation.budget;switch(this.simulation.evaluation,o.doTool(n.x,n.y,this.simulation.blockMaps),o.modifyIfEnoughFunding(a),o.result){case o.TOOLRESULT_NEEDS_BULLDOZE:console.log(X.toolMessages.needsDoze);break;case o.TOOLRESULT_NO_MONEY:console.log(X.toolMessages.noMoney);break}},I.prototype.handleSave=function(){this.save(),this.dialogOpen=!0,this._openWindow="saveWindow",this.saveWindow.open()},I.prototype.handlePause=function(){this.isPaused=!this.isPaused,this.isPaused?this.simulation.setSpeed(y.SPEED_PAUSED):this.simulation.setSpeed(this.defaultSpeed)},I.prototype.handleInput=function(){this.dialogOpen||(this.inputStatus.left?this.gameCanvas.moveWest():this.inputStatus.up?this.gameCanvas.moveNorth():this.inputStatus.right?this.gameCanvas.moveEast():this.inputStatus.down&&this.gameCanvas.moveSouth()),this.inputStatus.escape&&(this.dialogOpen?(this.dialogOpen=!1,this[this._openWindow].close(),this._openWindow=null):this.inputStatus.clearTool())},Te(function(t){window.removeEventListener("touchstart",this.touchListener,!1),this._openWindow="touchWindow",this.dialogOpen=!0,this.touchWindow.open()},"touchListener"),I.prototype.processFrontEndMessage=function(t){const i=t.subject,s=new Date;if(X.goodMessages[i]!==void 0){let n=this.name+" is now a ";switch(i){case Ci:this._reachedCapital||(this._reachedCapital=!0,n+="capital!");break;case Ri:this._reachedCity||(this._reachedCity=!0,n+="city!");break;case $i:this._reachedMegalopolis||(this._reachedMegalopolis=!0,n+="megalopolis!");break;case Mi:this._reachedMetropolis||(this._reachedMetropolis=!0,n+="metropolis!");break;case Pi:this._reachedTown||(this._reachedTown=!0,n+="town!");break}(this.lastBadMessageTime===null||s-this.lastBadMessageTime>yr)&&(this.lastBadMessageTime=null,this._notificationBar.goodNews(t)),n!==this.name+" is now a "&&console.log("Congratulations",n);return}if(t.data&&(t.data.showable?this.monsterTV.show(t.data.x,t.data.y):t.data.trackable&&this.monsterTV.track(t.data.x,t.data.y,t.data.sprite)),X.badMessages[i]!==void 0){this._notificationBar.badNews(t),he.indexOf(t.subject)!==-1&&(this.lastBadMessageTime=s);return}if(X.neutralMessages[i]!==void 0){(this.lastBadMessageTime===null||s-this.lastBadMessageTime>yr)&&(this.lastBadMessageTime=null,this._notificationBar.news(t));return}console.warn("Unexpected message: ",i)},I.prototype.calculateMouseForPaint=function(){let t=null;if(this.inputStatus.mouseX!==-1&&this.inputStatus.toolWidth>0){const i=this.gameCanvas.canvasCoordinateToTileOffset(this.inputStatus.mouseX,this.inputStatus.mouseY);i!==null&&(t={},t.x=i.x,t.y=i.y,t.width=this.inputStatus.toolWidth-0,t.height=this.inputStatus.toolWidth-0,t.colour=this.inputStatus.toolColour||"yellow")}return t},I.prototype.calculateSpritesForPaint=function(t){const i=t.getTileOrigin(),s=this.simulation.spriteManager.getSpritesInView(i.x,i.y,t.canvasWidth,t.canvasHeight);return s.length===0?null:s};var Nf=Te(function(){if(this.handleInput(),this.dialogOpen){window.setTimeout(this.tick,0);return}this.simulation.isPaused()||this.simulation.simTick(),this.mouse=this.calculateMouseForPaint(),window.setTimeout(this.tick,this.tickDuration)},"tick"),Vf=Te(function(){if(this.dialogShowing){Dr(this.animate);return}this.isPaused||this.simulation.spriteManager.moveObjects(this.simulation._constructSimData());let t=this.calculateSpritesForPaint(this.gameCanvas);this.gameCanvas.paint(this.mouse,t,this.isPaused),t=this.calculateSpritesForPaint(this.monsterTV.canvas),this.monsterTV.paint(t,this.isPaused),Dr(this.animate)},"commonAnimate");Te(function(){const t=new Date,i=Math.floor((t-this.animStart)/1e3);i>this.lastElapsed&&this.frameCount>0&&($("#fpsValue").text(Math.floor(this.frameCount/i)),this.lastElapsed=i),this.frameCount++,this.commonAnimate()},"debugAnimate");var Ff=Object.defineProperty,Wi=d((t,i)=>Ff(t,"name",{value:i,configurable:!0}),"t");const io=document.getElementById("tiles"),so=document.getElementById("sprites");function no(){const t=new ln(io,Wi(function(){function i(){Or(t,so)}d(i,"n"),Wi(i,"onSpritesReady"),so.complete?i():so.onload=i},"onLoad"),Wi(function(){console.error("Failed to load tileset")},"onError"))}d(no,"a"),Wi(no,"createTileSet"),io.complete&&no(),io.onload=no;function Or(t,i){const s=kl(120,100),n=fe.canStore&&fe.getSavedGame(),o=new I(n||s,t,null,i,y.LEVEL_EASY,"Microcity");setInterval(function(){fe.canStore&&o.save()},3e3)}d(Or,"g"),Wi(Or,"createGame")})();
//# sourceMappingURL=index.min.js.map
