var Af=Object.defineProperty;var d=(R,f)=>Af(R,"name",{value:f,configurable:!0});(function(){"use strict";(function(){const t={env:{NODE_ENV:"production"}};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,t);return}}catch(i){}globalThis.process={env:t}})();const R=0,f=2,D=3,H=4,Mr=5,$r=20,_e=f,Ee=$r,Fi=21,Ws=Fi,Us=37,Pr=39,Gs=Pr,Ar=40,Lr=43,Hi=44,Ir=47,ie=48,kr=51,Je=52,Ys=56,ro=Ys,nt=64,N=nt,ot=65,mt=66,ti=67,xr=68,Nr=69,Vr=70,Br=71,Fr=72,Hr=73,Wr=74,Ur=75,ei=76,Dt=77,J=78,Te=79,zs=80,we=95,Xs=144,Wi=206,Ot=208,Nt=209,Vt=210,ii=211,Gr=212,Yr=213,zr=214,Xr=215,jr=216,Zr=217,qr=218,Kr=219,lo=220,Z=221,ht=222,_t=Ot,at=224,Bt=225,Ct=226,si=227,Qr=228,Jr=229,tl=230,el=231,il=232,sl=233,nl=234,ol=235,ho=236,it=237,X=238,Ft=at,co=238,Ht=240,ve=244,uo=249,Ui=uo,po=260,js=265,al=405,Zs=409,qs=423,Ks=427,fo=436,Gi=612,Qs=616,rl=620,ni=625,Wt=693,se=698,ll=708,hl=709,go=711,V=716,Js=745,Ut=750,tn=760,cl=761,mo=765,dl=770,en=774,_o=779,Gt=784,Eo=800,ul=811,Rt=816,sn=826,pl=827,nn=828,To=829,wo=830,vo=831,So=832,yo=840,fl=844,oi=860,Yi=867,gl=916,on=924,an=932,ml=940,rn=948,bo=949,Do=950,Oo=951,_l=956,El=1018,zi=1024,Yt=-1;var Tl=Object.defineProperty,Co=d((t,i)=>Tl(t,"name",{value:i,configurable:!0}),"s$m");const wl=16,Ro=Math.sqrt(zi);class Xi{constructor(i,s,n){if(s===void 0||n===void 0)throw s===void 0&&n===void 0?new Error("Tileset constructor called with no callback or errorCallback"):new Error("Tileset constructor called with no "+(s===void 0?"callback":"errorCallback"));this.isValid=!1,i.width,i.height;const o=this.tileWidth=wl,a=document.createElement("canvas");a.width=o,a.height=o;const r=a.getContext("2d"),l=zi;let h=0;const c=this,g=Co(function(){h++,h===l&&(c.isValid=!0,window.setTimeout(s,0))},"imageLoad");for(let _=0;_<l;_++){r.clearRect(0,0,o,o);const v=_%Ro*o,S=Math.floor(_/Ro)*o;r.drawImage(i,v,S,o,o,0,0,o,o),this[_]=new Image,this[_].onload=g,this[_].src=a.toDataURL()}}}d(Xi,"E$i"),Co(Xi,"TileSet");var vl=Object.defineProperty,ai=d((t,i)=>vl(t,"name",{value:i,configurable:!0}),"t$8");function Mo(t,i=Zi){return(i()&t)===0}d(Mo,"d$g"),ai(Mo,"getChance");function $o(t,i=ji){const s=i(t),n=i(t);return Math.min(s,n)}d($o,"i$i"),ai($o,"getERandom");function ji(t,i=Math){return i.floor(i.random()*(t+1))}d(ji,"r$j"),ai(ji,"getRandom");function Zi(t=ji){return t(65535)}d(Zi,"o$g"),ai(Zi,"getRandom16");function Po(t=Zi){const i=t();return i<32768?i:-(2**16)+i}d(Po,"b$9"),ai(Po,"getRandom16Signed");const u={getChance:Mo,getERandom:$o,getRandom:ji,getRandom16:Zi,getRandom16Signed:Po};var Sl=Object.defineProperty,Se=d((t,i)=>Sl(t,"name",{value:i,configurable:!0}),"r$i");class Et{constructor(i){this.name=i}oppositeDirection(){return this.transform(4)}rotateClockwise(){return this.transform(1)}rotateCounterClockwise(){return this.transform(ri.length-1)}toString(){return this.name}transform(i){const s=xo(this)+i;return ri[s%ri.length]}}d(Et,"t$7"),Se(Et,"DirectionValue");const qi=Object.freeze(new Et("NORTH")),Ao=Object.freeze(new Et("NORTHEAST")),Ki=Object.freeze(new Et("EAST")),Lo=Object.freeze(new Et("SOUTHEAST")),Qi=Object.freeze(new Et("SOUTH")),Io=Object.freeze(new Et("SOUTHWEST")),Ji=Object.freeze(new Et("WEST")),ko=Object.freeze(new Et("NORTHWEST")),ri=[qi,Ao,Ki,Lo,Qi,Io,Ji,ko];function xo(t){return ri.indexOf(t)}d(xo,"p$k"),Se(xo,"directionIndex");const No=[qi,Ki,Qi,Ji];function ye(t){No.forEach(i=>t(i))}d(ye,"forEachCardinalDirection"),Se(ye,"forEachCardinalDirection");function ln(){return hn(No)}d(ln,"getRandomCardinalDirection"),Se(ln,"getRandomCardinalDirection");function Vo(){return hn(ri)}d(Vo,"getRandomDirection"),Se(Vo,"getRandomDirection");function hn(t){const i=t.length-1,s=u.getRandom(i);return t[s]}d(hn,"s$l"),Se(hn,"getRandomDirectionFrom");var yl=Object.defineProperty,bl=d((t,i)=>yl(t,"name",{value:i,configurable:!0}),"i$h");function cn(t,i){t||alert(`Assertion failed: ${i}`)}d(cn,"assert"),bl(cn,"assert");var Dl=Object.defineProperty,dn=d((t,i)=>Dl(t,"name",{value:i,configurable:!0}),"o$d");class Tt{constructor(i,s){this.xDelta=i,this.yDelta=s}}d(Tt,"e$c"),dn(Tt,"DirectionDelta");function Bo(t){switch(t){case qi:return new Tt(0,-1);case Ao:return new Tt(1,-1);case Ki:return new Tt(1,0);case Lo:return new Tt(1,1);case Qi:return new Tt(0,1);case Io:return new Tt(-1,1);case Ji:return new Tt(-1,0);case ko:return new Tt(-1,-1);default:throw new Error("Unexpected direction!")}}d(Bo,"w$7"),dn(Bo,"getDeltaFor");class O{constructor(i,s){this.x=i,this.y=s}static move(i,s){const{x:n,y:o}=i,{xDelta:a,yDelta:r}=Bo(s);return new O(n+a,o+r)}static origin(){return new O(0,0)}toString(){return`(${this.x}, ${this.y})`}}d(O,"Position"),dn(O,"Position");var Ol=Object.defineProperty,Cl=d((t,i)=>Ol(t,"name",{value:i,configurable:!0}),"i$g");class li{constructor(i,s,n,o){this.inclusiveStartX=i,this.inclusiveStartY=s,cn(n>0,"bounded region must have a width"),cn(o>0,"bounded region must have a width"),this.exclusiveEndX=i+n,this.exclusiveEndY=s+o}static fromOrigin(i,s){return new li(0,0,i,s)}contains(i){const{x:s,y:n}=i;return this.xInBounds(s)&&this.yInBounds(n)}toString(){const i=new O(this.inclusiveStartX,this.inclusiveStartY),s=new O(this.exclusiveEndX-1,this.exclusiveEndY-1);return`Bounds Rectangle: ${i} - ${s}`}xInBounds(i){return i>=this.inclusiveStartX&&i<this.exclusiveEndX}yInBounds(i){return i>=this.inclusiveStartY&&i<this.exclusiveEndY}}d(li,"Bounds"),Cl(li,"Bounds");const Fo=0,Mt=32768,I=16384,M=8192,m=4096,j=2048,be=1024,Ho=m|M,hi=m|M|I,ts=M|I,Rl=j|I|M,un=Mt|I|M|m|j|be,Wo=1024,es=Wo-1;var Ml=Object.defineProperty,$l=d((t,i)=>Ml(t,"name",{value:i,configurable:!0}),"s$k");class U{constructor(i=R,s=0){this.validateArguments(i,s,"Tile constructor"),this.value=i|s}getValue(){return this.valueFromCombinedValue(this.value)}getFlags(){return this.flagsFromCombinedValue(this.value)}getRawValue(){return this.value}addFlags(i){this.validateFlags(i,"addFlags"),i!==Fo&&(this.value|=i)}setValue(i){if(i<Yt)throw new Error(`setValue called with out-of-range value ${i}`);const s=this.valueFromCombinedValue(i),n=this.flagsToSetFromCombinedValue(i);this.set(s,n)}setFlags(i){this.validateFlags(i,"setFlags");const s=this.value&~un;this.value=s|i}removeFlags(i){this.validateFlags(i,"removeFlags"),i!==Fo&&(this.value&=~i)}setFrom(i){if(!i){console.log("Tile is undefined");return}this.value=i.value}set(i,s){this.validateArguments(i,s,"set"),this.value=i|s}isAnimated(){return this.checkBits(j)}isBulldozable(){return this.checkBits(m)}isConductive(){return this.checkBits(I)}isCombustible(){return this.checkBits(M)}isPowered(){return this.checkBits(Mt)}isZone(){return this.checkBits(be)}toString(){const i=["animated","bulldozable","combustible","conductive","powered","zone"].map(s=>this.getQualityText(s)).join(", ");return`Tile# ${this.getValue()}: ${i}`}getQualityText(i){const s=this.predicateForQuality(i),n=this[s]();return`${i}: ${this.summariseBoolean(n)}`}predicateForQuality(i){return`is${i[0].toUpperCase()}${i.slice(1)}`}summariseBoolean(i){return i?"\u2714":"\u2718"}valueFromCombinedValue(i){return i&es}flagsFromCombinedValue(i){return i&un}flagsToSetFromCombinedValue(i){const s=this.flagsFromCombinedValue(i);return s>0?s:this.getFlags()}checkBits(i){return(this.value&i)>0}validateArguments(i,s,n){this.validateValue(i,n),this.validateFlags(s,n)}validateValue(i,s){if(this.valueIsInvalid(i))throw new Error(`${s} called with out-of-range value ${i}`)}validateFlags(i,s){if(this.flagsAreInvalid(i))throw new Error(`${s} called with out-of-range flags 0x${i.toString(16)}`)}valueIsInvalid(i){return i<Yt||i>=zi}flagsAreInvalid(i){return i!==0&&(i<Wo||(i&~un)!==0)}}d(U,"Tile"),$l(U,"Tile");var Pl=Object.defineProperty,Al=d((t,i)=>Pl(t,"name",{value:i,configurable:!0}),"m$j");function k(t,i,s){if(arguments.length>1&&typeof t=="number"&&(t<1||i<1))throw new Error("GameMap constructor called with invalid width or height "+t+" "+i);const n=120,o=100;arguments.length===0?(t=n,i=o,s=new U().getValue()):arguments.length===1?(typeof t=="number"?s=t:s=t.getValue(),t=n,i=o):arguments.length===2?s=new U().getValue():arguments.length===3&&typeof s=="object"&&(s=s.getValue()),this.width=t,this.height=i,this.bounds=li.fromOrigin(t,i);const a=[];for(let r=0,l=t*i;r<l;r++)a[r]=new U(s);this._data=a,this.cityCentreX=Math.floor(this.width/2),this.cityCentreY=Math.floor(this.height/2),this.pollutionMaxX=this.cityCentreX,this.pollutionMaxY=this.cityCentreY}d(k,"a$m"),Al(k,"GameMap");const De=["cityCentreX","cityCentreY","pollutionMaxX","pollutionMaxY","width","height"];k.prototype.save=function(t){for(let i=0,s=De.length;i<s;i++)t[De[i]]=this[De[i]];t.map=this._data.map(function(i){return{value:i.getRawValue()}})},k.prototype.load=function(t){for(var i=0,s=De.length;i<s;i++)this[De[i]]=t[De[i]];const n=t.map;for(i=0,s=n.length;i<s;i++)this.setTileValue(i%this.width,Math.floor(i/this.width),n[i].value)},k.prototype._calculateIndex=function(t,i){return t+i*this.width},k.prototype.isPositionInBounds=function(t){return this.bounds.contains(t)},k.prototype.testBounds=function(t,i){return this.isPositionInBounds(new O(t,i))},k.prototype.getTile=function(t,i,s){typeof t=="object"&&(i=t.y,t=t.x);const n=this.width,o=this.height;if(t<0||i<0||t>=n||i>=o)return console.warn("getTile called with bad bounds",t,i),new U(Yt);const a=t+i*n,r=this._data[a];return s&&s.setFrom(r),r},k.prototype.getTileValue=function(t,i){if(arguments.length<1)throw new Error("GameMap getTileValue called with too few arguments"+[].toString.apply(arguments));if(typeof t=="object"&&(i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap getTileValue called with invalid bounds "+t+", "+i);const s=this._calculateIndex(t,i);if(this._data[s])return this._data[s].getValue()},k.prototype.getTileFlags=function(t,i){if(arguments.length<1)throw new Error("GameMap getTileFlags called with too few arguments"+[].toString.apply(arguments));if(typeof t=="object"&&(i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap getTileFlags called with invalid bounds "+t+", "+i);const s=this._calculateIndex(t,i);return this._data[s].getFlags()},k.prototype.getTiles=function(t,i,s,n){if(arguments.length<3)throw new Error("GameMap getTiles called with too few arguments"+[].toString.apply(arguments));if(arguments.length===3&&(n=s,s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap getTiles called with invalid bounds "+t+", "+i);const o=[];for(let a=i,r=i+n;a<r;a++){o[a-i]=[];for(let l=t,h=t+s;l<h;l++){const c=this._calculateIndex(l,a);o[a-i].push(this._data[c])}}return o},k.prototype.getTileValuesForPainting=function(t,i,s,n,o){if(o=o||[],arguments.length<3)throw new Error("GameMap getTileValuesForPainting called with too few arguments"+[].toString.apply(arguments));arguments.length===3&&(n=s,s=i,i=t.y,t=t.x);const a=this.width,r=this.height;for(let l=i,h=i+n;l<h;l++)for(let c=t,g=t+s;c<g;c++){if(l<0||c<0||l>=r||c>=a){o[(l-i)*s+(c-t)]=Yt;continue}const _=c+l*a;o[(l-i)*s+(c-t)]=this._data[_].getRawValue()}return o},k.prototype.getTileFromMapOrDefault=function(t,i,s){switch(i){case qi:return t.y>0?this.getTileValue(t.x,t.y-1):s;case Ki:return t.x<this.width-1?this.getTileValue(t.x+1,t.y):s;case Qi:return t.y<this.height-1?this.getTileValue(t.x,t.y+1):s;case Ji:return t.x>0?this.getTileValue(t.x-1,t.y):s;default:return s}},k.prototype.setTile=function(t,i,s,n){if(arguments.length<3)throw new Error("GameMap setTile called with too few arguments"+[].toString.apply(arguments));if(arguments.length===3&&(n=s,s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap setTile called with invalid bounds "+t+", "+i);const o=this._calculateIndex(t,i);this._data[o].set(s,n)},k.prototype.setTo=function(t,i,s){if(arguments.length<2)throw new Error("GameMap setTo called with too few arguments"+[].toString.apply(arguments));if(s===void 0&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap setTo called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n]=s},k.prototype.setTileValue=function(t,i,s){if(arguments.length<2)throw new Error("GameMap setTileValue called with too few arguments"+[].toString.apply(arguments));arguments.length===2&&(s=i,i=t.y,t=t.x),this.testBounds(t,i)||(console.log("GameMap setTileValue called with invalid bounds "+t+", "+i),ReadableStreamDefaultController);const n=this._calculateIndex(t,i);!this._data[n]||this._data[n].setValue(s)},k.prototype.setTileFlags=function(t,i,s){if(arguments.length<2)throw new Error("GameMap setTileFlags called with too few arguments"+[].toString.apply(arguments));if(arguments.length===2&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap setTileFlags called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n].setFlags(s)},k.prototype.addTileFlags=function(t,i,s){if(arguments.length<2)throw new Error("GameMap addTileFlags called with too few arguments"+[].toString.apply(arguments));if(arguments.length===2&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap addTileFlags called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n].addFlags(s)},k.prototype.removeTileFlags=function(t,i,s){if(arguments.length<2)throw new Error("GameMap removeTileFlags called with too few arguments"+[].toString.apply(arguments));if(arguments.length===2&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap removeTileFlags called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n].removeFlags(s)},k.prototype.putZone=function(t,i,s,n){let o,a;if(!this.testBounds(t,i)||!this.testBounds(t-1+n-1,i-1+n-1))throw new Error("GameMap putZone called with invalid bounds "+o+", "+a);let r=s-1-n;const l=t-1,h=i-1;for(a=h;a<h+n;a++)for(o=l;o<l+n;o++)o===t&&a===i?this.setTo(o,a,new U(r,ts|be)):this.setTo(o,a,new U(r,ts)),r+=1};var Ll=Object.defineProperty,B=d((t,i)=>Ll(t,"name",{value:i,configurable:!0}),"u$g");let pn;const Il=-1,kl=18,xl=B(function(t,i){t=t||120,i=i||100,pn=u.getRandom(2)-1;const s=new k(t,i);if(pn<0&&u.getRandom(100)<10)return Vl(s),s;if(pn===1?Uo(s):Nl(s),Il!==0){const n=40+u.getRandom(s.width-80),o=33+u.getRandom(s.height-67),a=new O(n,o);Yl(s,a)}return Bl(s),Yo(s),Go(s),s},"MapGenerator");var Nl=B(function(t){for(let i=0;i<t.width;i++)for(let s=0;s<t.height;s++)t.setTile(i,s,R,0)},"clearMap");B(function(t){for(let i=0;i<t.width;i++)for(let s=0;s<t.height;s++)t.getTileValue(i,s)>Us&&t.setTile(i,s,R,0)},"clearUnnatural");var Uo=B(function(t){const i=kl;let s,n;for(s=0;s<t.width;s++)for(n=0;n<t.height;n++)s<5||s>=t.width-5||n<5||n>=t.height-5?t.setTile(s,n,f,0):t.setTile(s,n,R,0);for(s=0;s<t.width-5;s+=2){let o=u.getERandom(i);Oe(t,new O(s,o)),o=t.height-10-u.getERandom(i),Oe(t,new O(s,o)),Ce(t,new O(s,0)),Ce(t,new O(s,t.height-6))}for(n=0;n<t.height-5;n+=2){let o=u.getERandom(i);Oe(t,new O(o,n)),o=t.width-10-u.getERandom(i),Oe(t,new O(o,n)),Ce(t,new O(0,n)),Ce(t,new O(t.width-6,n))}},"makeNakedIsland"),Vl=B(function(t){Uo(t),Yo(t),Go(t)},"makeIsland"),Bl=B(function(t){let i;for(i=u.getRandom(10);i>0;){const s=u.getRandom(t.width-21)+10,n=u.getRandom(t.height-20)+10;Fl(t,new O(s,n)),i--}},"makeLakes"),Fl=B(function(t,i){let s=u.getRandom(12)+2;for(;s>0;){const n=new O(i,u.getRandom(12)-6,u.getRandom(12)-6);u.getRandom(4)?Ce(t,n):Oe(t,n),s--}},"makeSingleLake");const Hl=B(function(t,i,s){let n;n=u.getRandom(150)+50;let o=new O(i,s);for(;n>0;){const a=Vo();if(o=O.move(o,a),!t.isPositionInBounds(o))return;t.getTileValue(o)===R&&t.setTile(o,Us,Ho),n--}},"treeSplash");var Go=B(function(t){let i;i=u.getRandom(100)+50;for(let s=0;s<i;s++){const n=u.getRandom(t.width-1),o=u.getRandom(t.height-1);Hl(t,n,o)}zo(t),zo(t)},"doTrees");const Wl=[13|m,13|m,17|m,15|m,5|m,f,19|m,17|m,9|m,11|m,f,13|m,7|m,9|m,5|m,f];var Yo=B(function(t){const i=[-1,0,1,0],s=[0,1,0,-1];for(let n=0;n<t.width;n++)for(let o=0;o<t.height;o++)if(t.getTileValue(n,o)===D){let a=0;for(let l=0;l<4;l++){a=a<<1;const h=n+i[l],c=o+s[l];t.testBounds(h,c)&&t.getTileValue(h,c)!==R&&(t.getTileValue(h,c)<Ws||t.getTileValue(h,c)>Gs)&&a++}let r=Wl[a&15];r!==f&&u.getRandom(1)&&r++,t.setTileValue(n,o,r,0)}},"smoothRiver");const fn=B(function(t){return t>=Ws&&t<=Gs},"isTree");var zo=B(function(t){for(let i=0;i<t.width;i++)for(let s=0;s<t.height;s++)fn(t.getTileValue(i,s))&&Gl(t,i,s,!1)},"smoothTrees");const Ul=[0,0,0,34,0,0,36,35,0,32,0,33,30,31,29,37];var Gl=B(function(t,i,s,n){const o=[-1,0,1,0],a=[0,1,0,-1];if(!fn(t.getTileValue(i,s)))return;let r=0;for(let h=0;h<4;h++){r=r<<1;const c=i+o[h],g=s+a[h];t.testBounds(c,g)&&fn(t.getTileValue(c,g))&&r++}let l=Ul[r&15];l?(l!==Us&&i+s&1&&(l=l-8),t.setTile(i,s,l,Ho)):n||t.setTileValue(i,s,l,0)},"smoothTreesAt"),Yl=B(function(t,i){let s=ln();Xo(t,i,s,s),s=s.oppositeDirection();const n=Xo(t,i,s,s);s=ln(),zl(t,i,s,n)},"doRivers"),Xo=B(function(t,i,s,n){let o,a;for(o=100,a=200;t.testBounds(i.x+4,i.y+4);)Oe(t,i),u.getRandom(o)<10?n=s:(u.getRandom(a)>90&&(n=n.rotateClockwise()),u.getRandom(a)>90&&(n=n.rotateCounterClockwise())),i=O.move(i,n);return n},"doBRiver"),zl=B(function(t,i,s,n){let o,a;for(o=100,a=200;t.testBounds(i.x+3,i.y+3);)Ce(t,i),u.getRandom(o)<10?n=s:(u.getRandom(a)>90&&(n=n.rotateClockwise()),u.getRandom(a)>90&&(n=n.rotateCounterClockwise())),i=O.move(i,n);return n},"doSRiver");const jo=B(function(t,i,s,n){if(i===0||!t.testBounds(s,n))return;const o=t.getTileValue(s,n);o!==R&&(o===f&&i!==H||o===H)||t.setTile(s,n,i,0)},"putOnMap");var Oe=B(function(t,i){const s=[[0,0,0,D,D,D,0,0,0],[0,0,D,f,f,f,D,0,0],[0,D,f,f,f,f,f,D,0],[D,f,f,f,f,f,f,f,D],[D,f,f,f,H,f,f,f,D],[D,f,f,f,f,f,f,f,D],[0,D,f,f,f,f,f,D,0],[0,0,D,f,f,f,D,0,0],[0,0,0,D,D,D,0,0,0]];for(let n=0;n<9;n++)for(let o=0;o<9;o++)jo(t,s[o][n],i.x+n,i.y+o)},"plopBRiver"),Ce=B(function(t,i){const s=[[0,0,D,D,0,0],[0,D,f,f,D,0],[D,f,f,f,f,D],[D,f,f,f,f,D],[0,D,f,f,D,0],[0,0,D,D,0,0]];for(let n=0;n<6;n++)for(let o=0;o<6;o++)jo(t,s[o][n],i.x+n,i.y+o)},"plopSRiver");B(function(t){let i,s,n,o;for(i=0;i<t.width;i++)for(s=0;s<t.height;s++)if(n=t.getTileValue(i,s),n>=_e&&n<=Ee){o=new O(i,s);let r=!1;ye(l=>{r||(n=t.getTileFromMap(o,l,_e),(n<_e||n>Ee)&&(t.setTileValue(i,s,D,0),r=!0))})}for(i=0;i<t.width;i++)for(s=0;s<t.height;s++)if(n=t.getTileValue(i,s),n!==H&&n>=_e&&n<=Ee){var a=!0;o=new O(i,s),ye(r=>{!a||(n=t.getTileFromMapOrDefault(o,r,_e),(n<_e||n>Ee)&&(a=!1))}),a&&t.setTileValue(i,s,f,0)}for(i=0;i<t.width;i++)for(s=0;s<t.height;s++)if(n=t.getTileValue(i,s),n>=Ws&&n<=Gs){o=new O(i,s);let r=!1;ye(l=>{r||(n=t.getTileFromMapOrDefault(o,l,TILE_INVALID),(n===f||n===H)&&(t.setTileValue(i,s,D,0),r=!0))})}},"smoothWater");var Xl=Object.defineProperty,Zo=d((t,i)=>Xl(t,"name",{value:i,configurable:!0}),"h$d");const jl=Zo(t=>t,"ID");class G{constructor(i,s,n){this.gameMapWidth=i,this.gameMapHeight=s,this.blockSize=n,this.data=[],this._width=this.convertToBlockCount(this.gameMapWidth),this._height=this.convertToBlockCount(this.gameMapHeight),this.clear()}get width(){return this._width}get height(){return this._height}get(i,s){const n=this.toIndex(i,s);return this.data[n]}set(i,s,n){const o=this.toIndex(i,s);this.data[o]=n}worldGet(i,s){const{x:n,y:o}=this.toBlockCoordinate(i,s);return this.get(n,o)}worldSet(i,s,n){const{x:o,y:a}=this.toBlockCoordinate(i,s);this.set(o,a,n)}clear(){this.forEach((i,s)=>this.set(i,s,0))}copyFrom(i,s=jl){this.hasIncompatibleDimensions(i)&&console.warn("Copying from incompatible blockMap!"),this.forEach((n,o)=>this.set(n,o,s(i.get(n,o))))}forEach(i){const s=this.width,n=this.height;for(let o=0;o<s;o++)for(let a=0;a<n;a++)i(o,a)}convertToBlockCount(i){return Math.floor((i+this.blockSize-1)/this.blockSize)}hasIncompatibleDimensions(i){return i.gameMapHeight!==this.gameMapHeight||i.gameMapWidth!==this.gameMapWidth||i.blockSize!==this.blockSize}toBlockCoordinate(i,s){const n=this.toBlockIndex(i),o=this.toBlockIndex(s);return{x:n,y:o}}toBlockIndex(i){return Math.floor(i/this.blockSize)}toIndex(i,s){return this.width*s+i}}d(G,"BlockMap"),Zo(G,"BlockMap");var Zl=Object.defineProperty,Re=d((t,i)=>Zl(t,"name",{value:i,configurable:!0}),"t$6");const ct=Re(function(t){return function(i){return i instanceof U&&(i=i.getValue()),t.call(null,i)}},"unwrapTile"),ql=ct(function(t){return t>=Mr&&t<=Ir||t>=_t+2&&t<=_t+12||t>=oi&&t<=Yi+2}),qo=ct(function(t){return t>=qs&&t<Gi}),Kl=Re(function(t){return t.isZone()&&qo(t)},"isCommercialZone"),Ql=ct(function(t){return t>=N&&t<=Wi||t>=Z&&t<=co}),Jl=ct(function(t){return t>=ro&&t<N}),th=ct(function(t){return t>=ie&&t<kr}),Ko=ct(function(t){return t>=Gi&&t<Wt}),eh=Re(function(t){return t.isZone()&&Ko(t)},"isIndustrialZone"),ih=ct(function(t){return t>=oi&&t<=Yi}),sh=ct(function(t){return t>=Ft&&t<Ht}),Qo=ct(function(t){return t>=Ht&&t<al}),nh=Re(function(t){return t.isZone()&&Qo(t)},"isResidentialZone"),oh=ct(function(t){return t>=N&&t<_t}),ah=ct(function(t){return t>=N&&t<=Wi+1?(t&15)+64:t}),rh=Re(function(){return new U(Ys+(u.getRandom16()&3),j)},"randomFire"),lh=Re(function(){return new U(Hi+(u.getRandom16()&3),m)},"randomRubble"),T={canBulldoze:ql,isCommercial:qo,isCommercialZone:Kl,isDriveable:Ql,isFire:Jl,isFlood:th,isIndustrial:Ko,isIndustrialZone:eh,isManualExplosion:ih,isRail:sh,isResidential:Qo,isResidentialZone:nh,isRoad:oh,normalizeRoad:ah,randomFire:rh,randomRubble:lh};var hh=Object.defineProperty,is=d((t,i)=>hh(t,"name",{value:i,configurable:!0}),"e$a");const ch=is(function(t,i,s){return t<i?i:t>s?s:t},"clamp"),dh=is(function(t){return{configurable:!1,enumerable:!1,writeable:!1,value:t}},"makeConstantDescriptor"),uh=is(function(t){return(t[0]!=="#"?"#":"")+t},"normaliseDOMid"),ph=is(function(t,i){this._emitEvent(t,i)},"reflectEvent"),p={clamp:ch,makeConstantDescriptor:dh,normaliseDOMid:uh,reflectEvent:ph},Me=1,$t=2,Pt=3,ne=4,$e=5,ci=6,ss=7,di={SPRITE_TRAIN:Me,SPRITE_HELICOPTER:$t,SPRITE_AIRPLANE:Pt,SPRITE_SHIP:ne,SPRITE_MONSTER:$e,SPRITE_TORNADO:ci,SPRITE_EXPLOSION:ss};var fh=Object.defineProperty,Pe=d((t,i)=>fh(t,"name",{value:i,configurable:!0}),"d$d");const gh=Pe(function(t){let i;switch(t){case Ut:case se:case Rt:case Gt:i={zoneSize:4,deltaX:0,deltaY:0};break;case Ut+1:case on:case on+1:case on+2:case se+1:case Rt+1:case Gt+1:i={zoneSize:4,deltaX:-1,deltaY:0};break;case Ut+4:case se+4:case Rt+4:case Gt+4:i={zoneSize:4,deltaX:0,deltaY:-1};break;case Ut+5:case se+5:case Rt+5:case Gt+5:i={zoneSize:4,deltaX:-1,deltaY:-1};break;case V:i={zoneSize:6,deltaX:0,deltaY:0};break;case V+1:i={zoneSize:6,deltaX:-1,deltaY:0};break;case V+2:i={zoneSize:6,deltaX:-2,deltaY:0};break;case V+3:i={zoneSize:6,deltaX:-3,deltaY:0};break;case V+6:i={zoneSize:6,deltaX:0,deltaY:-1};break;case V+7:i={zoneSize:6,deltaX:-1,deltaY:-1};break;case V+8:i={zoneSize:6,deltaX:-2,deltaY:-1};break;case V+9:i={zoneSize:6,deltaX:-3,deltaY:-1};break;case V+12:i={zoneSize:6,deltaX:0,deltaY:-2};break;case V+13:i={zoneSize:6,deltaX:-1,deltaY:-2};break;case V+14:i={zoneSize:6,deltaX:-2,deltaY:-2};break;case V+15:i={zoneSize:6,deltaX:-3,deltaY:-2};break;case V+18:i={zoneSize:6,deltaX:0,deltaY:-3};break;case V+19:i={zoneSize:6,deltaX:-1,deltaY:-3};break;case V+20:i={zoneSize:6,deltaX:-2,deltaY:-3};break;case V+21:i={zoneSize:6,deltaX:-3,deltaY:-3};break;default:i={zoneSize:0,deltaX:0,deltaY:0};break}return i},"checkBigZone"),mh=Pe(function(t){return t>=Ht-1&&t<=Wt-1||t>=tn+1&&t<=en+4||t>=_l&&t<=El?3:t>=Wt&&t<=ll||t>=Js&&t<=tn||t>=_o&&t<=sn?4:0},"checkZoneSize"),_h=Pe(function(t,i,s,n){const o=t.getTileValue(i,s);let a=2,r=n.rateOfGrowthMap.worldGet(i,s);r=p.clamp(r-20,-200,200),n.rateOfGrowthMap.worldSet(i,s,r),o===V?a=5:o>=Wt?a=3:o<Wt&&(a=2);for(let l=-1;l<a;l++)for(let h=-1;h<a;h++){const c=i+l,g=s+h;!t.testBounds(c,g)||t.getTileValue(c,g>=N)&&t.addTileFlags(c,g,m)}},"fireZone"),Eh=Pe(function(t,i,s){let n=t.landValueMap.worldGet(i,s);return n-=t.pollutionDensityMap.worldGet(i,s),n<30?0:n<80?1:n<150?2:3},"getLandPollutionValue"),Th=Pe(function(t,i,s,n){const o=t.rateOfGrowthMap.worldGet(i,s),a=p.clamp(o+n*4,-200,200);t.rateOfGrowthMap.worldSet(i,s,a)},"incRateOfGrowth"),wh=Pe(function(t,i,s,n,o){for(let a=-1;a<2;a++)for(let r=-1;r<2;r++){const l=t.getTileValue(i+r,s+a);if(l>=ie&&l<N)return}t.putZone(i,s,n,3),t.addTileFlags(i,s,m),o&&t.addTileFlags(i,s,Mt)},"putZone"),P={checkBigZone:gh,checkZoneSize:mh,fireZone:_h,getLandPollutionValue:Eh,incRateOfGrowth:Th,putZone:wh};var vh=Object.defineProperty,wt=d((t,i)=>vh(t,"name",{value:i,configurable:!0}),"s$i");const ui=wt(function(t){return t>>4},"pixToWorld"),Sh=wt(function(t){return t<<4},"worldToPix"),yh=wt(function(t,i){return t===i||(t<i?i-t<4?t++:t--:t-i<4?t--:t++,t>8&&(t=1),t<1&&(t=8)),t},"turnTo"),bh=wt(function(t,i,s){const n=ui(i),o=ui(s);return n<0||n>=t.width||o<0||o>=t.height?-1:t.getTileValue(n,o)},"getTileValue"),Dh=[0,3,2,1,3,4,5,7,6,5,7,8,1],Oh=wt(function(t,i,s,n){let o=s-t,a=n-i,r;return o<0?a<0?r=11:r=8:a<0?r=2:r=5,o=Math.abs(o),a=Math.abs(a),o*2<a?r++:a*2<o&&r--,(r<0||r>12)&&(r=0),Dh[r]},"getDir"),Ch=wt(function(t,i,s,n){const o=s-t,a=n-i;return Math.abs(o)+Math.abs(a)},"absoluteDistance"),Rh=wt(function(t){return t===Ot||t===Nt||t===at||t===Bt||t===Te||t===we},"checkWet"),Mh=wt(function(t,i,s,n,o){const a=ui(n),r=ui(o);if(!i.testBounds(a,r))return;const l=i.getTile(a,r),h=l.getValue();if(!(h<Fi)){if(!l.isCombustible()){h>=N&&h<=Wi&&i.setTile(a,r,f,0);return}l.isZone()&&(P.fireZone(i,a,r,s),h>js&&t.makeExplosionAt(n,o)),Rh(h)?i.setTile(a,r,f,0):i.setTile(a,r,oi,m|j)}},"destroyMapTile"),$h=wt(function(t,i,s,n){return Math.abs(t-s)+Math.abs(i-n)},"getDistance"),Ph=wt(function(t,i){return t.frame!==0&&i.frame!==0&&$h(t.x,t.y,i.x,i.y)<30},"checkSpriteCollision"),E={absoluteDistance:Ch,checkSpriteCollision:Ph,destroyMapTile:Mh,getDir:Oh,getTileValue:bh,turnTo:yh,pixToWorld:ui,worldToPix:Sh};var Ah=Object.defineProperty,Lh=d((t,i)=>Ah(t,"name",{value:i,configurable:!0}),"c$f");function x(t,i){this._map=t,this._stack=[],this._spriteManager=i}d(x,"s$h"),Lh(x,"Traffic"),x.prototype.makeTraffic=function(t,i,s,n){this._stack=[];const o=new O(t,i);return this.findPerimeterRoad(o)?this.tryDrive(o,n)?(this.addToTrafficDensityMap(s),x.ROUTE_FOUND):x.NO_ROUTE_FOUND:x.NO_ROAD_FOUND},x.prototype.addToTrafficDensityMap=function(t){const i=t.trafficDensityMap;for(;this._stack.length>0;){const s=this._stack.pop();if(!this._map.testBounds(s.x,s.y))continue;const n=this._map.getTileValue(s.x,s.y);if(n>=N&&n<_t){let o=i.worldGet(s.x,s.y);if(o+=50,o=Math.min(o,240),i.worldSet(s.x,s.y,o),o>=240&&u.getRandom(5)===0){const a=this._spriteManager.getSprite($t);a!==null&&(a.destX=E.worldToPix(s.x),a.destY=E.worldToPix(s.y))}}}};const Ih=[-1,0,1,2,2,2,1,0,-1,-2,-2,-2],kh=[-2,-2,-2,-1,0,1,2,2,2,1,0,-1];x.prototype.findPerimeterRoad=function(t){for(let i=0;i<12;i++){const s=t.x+Ih[i],n=t.y+kh[i];if(this._map.testBounds(s,n)&&T.isDriveable(this._map.getTileValue(s,n)))return t.x=s,t.y=n,!0}return!1};const xh=30;x.prototype.tryDrive=function(t,i){let s,n=new O(t.x,t.y);for(let o=0;o<xh;o++){const a=this.tryGo(n,s);if(a){if(n=O.move(n,a),s=a.oppositeDirection(),o&1&&this._stack.push(new O(n.x,n.y)),this.driveDone(n,i))return!0}else if(this._stack.length>0)this._stack.pop(),o+=3;else return!1}return!1},x.prototype.tryGo=function(t,i){const s=[];let n=0;if(ye(a=>{a!==i&&T.isDriveable(this._map.getTileFromMapOrDefault(t,a,R))&&(s.push(a),n++)}),n===0)return;if(n===1)return s[0];const o=u.getRandom(s.length-1);return s[o]},x.prototype.driveDone=function(t,i){return!!(t.y>0&&i(this._map.getTileValue(t.x,t.y-1))||t.x<this._map.width-1&&i(this._map.getTileValue(t.x+1,t.y))||t.y<this._map.height-1&&i(this._map.getTileValue(t.x,t.y+1))||t.x>0&&i(this._map.getTileValue(t.x-1,t.y)))},Object.defineProperties(x,{ROUTE_FOUND:p.makeConstantDescriptor(1),NO_ROUTE_FOUND:p.makeConstantDescriptor(0),NO_ROAD_FOUND:p.makeConstantDescriptor(-1)});var Nh=Object.defineProperty,pi=d((t,i)=>Nh(t,"name",{value:i,configurable:!0}),"u$d");const Jo=pi(function(t,i,s,n){return n===Ks?0:Math.floor((n-fo)/9)%5+1},"getZonePopulation"),ta=pi(function(t,i,s,n,o,a){const r=(o*5+n)*9+fo;P.putZone(t,i,s,r,a)},"placeCommercial"),Vh=pi(function(t,i,s,n,o,a,r){let l=n.landValueMap.worldGet(i,s);l=l>>5,!(o>l)&&o<5&&(ta(t,i,s,o,a,r),P.incRateOfGrowth(n,i,s,8))},"growZone"),ea=pi(function(t,i,s,n,o,a,r){o>1?ta(t,i,s,o-2,a,r):P.putZone(t,i,s,Ks,r),P.incRateOfGrowth(n,i,s,-8)},"degradeZone"),Bh=pi(function(t,i,s,n){let o;n.census.comZonePop+=1;const a=t.getTileValue(i,s),r=Jo(t,i,s,a);n.census.comPop+=r;const l=t.getTile(i,s).isPowered();let h=x.ROUTE_FOUND;if(r>u.getRandom(5)&&(h=n.trafficManager.makeTraffic(i,s,n.blockMaps,T.isIndustrial),h===x.NO_ROAD_FOUND)){o=P.getLandPollutionValue(n.blockMaps,i,s),ea(t,i,s,n.blockMaps,r,o,l);return}if(u.getChance(7)){const c=h===x.NO_ROAD_FOUND?-3e3:n.blockMaps.cityCentreDistScoreMap.worldGet(i,s);let g=n.valves.comValve+c;if(l||(g=-500),l&&g>-350&&g-26380>u.getRandom16Signed()){o=P.getLandPollutionValue(n.blockMaps,i,s),Vh(t,i,s,n.blockMaps,r,o,l);return}g<350&&g+26380<u.getRandom16Signed()&&(o=P.getLandPollutionValue(n.blockMaps,i,s),ea(t,i,s,n.blockMaps,r,o,l))}},"commercialFound"),ia={registerHandlers:function(t,i){t.addAction(T.isCommercialZone,Bh)},getZonePopulation:Jo};var Fh=Object.defineProperty,Ae=d((t,i)=>Fh(t,"name",{value:i,configurable:!0}),"f$9"),sa=Ae(function(t,i,s,n){return n===Qs?0:Math.floor((n-ni)/9)%4+1},"getZonePopulation"),na=Ae(function(t,i,s,n,o,a){var r=(o*4+n)*9+ni;P.putZone(t,i,s,r,a)},"placeIndustrial"),Hh=Ae(function(t,i,s,n,o,a,r){o<4&&(na(t,i,s,o,a,r),P.incRateOfGrowth(n,i,s,8))},"growZone"),oa=Ae(function(t,i,s,n,o,a,r){o>1?na(t,i,s,o-2,a,r):P.putZone(t,i,s,Qs,r),P.incRateOfGrowth(n,i,s,-8)},"degradeZone"),Wh=[!0,!1,!0,!0,!1,!1,!0,!0],gn=[-1,0,1,0,0,0,0,1],mn=[-1,0,-1,-1,0,0,-1,-1],Uh=Ae(function(t,i,s,n,o){if(!(n<ni)){var a=n-ni>>3;Wh[a]&&o?t.addTileFlags(i+gn[a],s+mn[a],Rl):(t.addTileFlags(i+gn[a],s+mn[a],ts),t.removeTileFlags(i+gn[a],s+mn[a],j))}},"setAnimation"),Gh=Ae(function(t,i,s,n){n.census.indZonePop+=1;var o=t.getTileValue(i,s),a=sa(t,i,s,o);n.census.indPop+=a;var r=t.getTile(i,s).isPowered();Uh(t,i,s,o,r);var l=x.ROUTE_FOUND;if(a>u.getRandom(5)&&(l=n.trafficManager.makeTraffic(i,s,n.blockMaps,T.isResidential),l===x.NO_ROAD_FOUND)){var h=u.getRandom16()&1;oa(t,i,s,n.blockMaps,a,h,r);return}if(u.getChance(7)){var c=n.valves.indValve+(l===x.NO_ROAD_FOUND?-1e3:0);if(r||(c=-500),c>-350&&c-26380>u.getRandom16Signed()){Hh(t,i,s,n.blockMaps,a,u.getRandom16()&1,r);return}c<350&&c+26380<u.getRandom16Signed()&&oa(t,i,s,n.blockMaps,a,u.getRandom16()&1,r)}},"industrialFound"),aa={registerHandlers:function(t,i){t.addAction(T.isIndustrialZone,Gh)},getZonePopulation:sa},Yh=Object.defineProperty,dt=d((t,i)=>Yh(t,"name",{value:i,configurable:!0}),"u$c");const _n=dt(function(t,i,s,n,o,a){const r=(o*4+n)*9+js;P.putZone(t,i,s,r,a)},"placeResidential"),zh=dt(function(t,i,s,n){let o=0;for(let a=i-1;a<=i+1;a++)for(let r=s-1;r<=s+1;r++)a===i&&r===s||(n=t.getTileValue(a,r),n>=Ui&&n<=po&&(o+=1));return o},"getFreeZonePopulation"),ra=dt(function(t,i,s,n){return n instanceof U&&(n=tile.getValue()),n===ve?zh(t,i,s,n):(Math.floor((n-js)/9)%4+1)*8+16},"getZonePopulation"),Xh=dt(function(t,i,s){const n=[0,1,0,-1],o=[-1,0,1,0];if(!t.testBounds(i,s))return-1;let a=t.getTileValue(i,s);if(a<Ht||a>Ht+8)return-1;let r=1;for(let l=0;l<4;l++){const h=i+n[l],c=s+o[l];h<0||h>=t.width||c<0||c>=t.height||(a=t.getTileValue(h,c),a!==R&&a<=Wi&&(r+=1))}return r},"evalLot"),jh=dt(function(t,i,s,n){let o=0,a=0;const r=[0,-1,0,1,-1,1,-1,0,1],l=[0,-1,-1,-1,0,0,1,1,1];for(let h=0;h<9;h++){const c=i+r[h],g=s+l[h],_=Xh(t,c,g);_>a?(a=_,o=h):_===a&&u.getChance(7)&&(o=h)}o>0&&t.testBounds(i+r[o],s+l[o])&&t.setTile(i+r[o],s+l[o],uo+u.getRandom(2)+n*3,hi)},"buildHouse"),Zh=dt(function(t,i,s,n,o,a,r){if(!(n.pollutionDensityMap.worldGet(i,s)>128)){if(t.getTileValue(i,s)===ve){o<8?(jh(t,i,s,a),P.incRateOfGrowth(n,i,s,1)):n.populationDensityMap.worldGet(i,s)>64&&(_n(t,i,s,0,a,r),P.incRateOfGrowth(n,i,s,8));return}o<40&&(_n(t,i,s,Math.floor(o/8)-1,a,r),P.incRateOfGrowth(n,i,s,8))}},"growZone"),qh=[0,3,6,1,4,7,2,5,8],la=dt(function(t,i,s,n,o,a,r){let l,h;if(o===0)return;if(o>16){_n(t,i,s,Math.floor((o-24)/8),a,r),P.incRateOfGrowth(n,i,s,-8);return}if(o===16){for(t.setTile(i,s,ve,hi|be),h=s-1;h<=s+1;h++)for(l=i-1;l<=i+1;l++)l===i&&h===s||t.setTile(i,s,Ui+a+u.getRandom(2),hi);P.incRateOfGrowth(n,i,s,-8);return}let c=0;for(P.incRateOfGrowth(n,i,s,-1),l=i-1;l<=i+1;l++)for(h=s-1;h<=s+1;h++,c++){const g=t.getTileValue(l,h);if(g>=Ui&&g<=po){t.setTile(l,h,qh[c]+Ht,hi);return}}},"degradeZone"),Kh=dt(function(t,i,s,n){if(n===x.NO_ROAD_FOUND)return-3e3;let o=t.landValueMap.worldGet(i,s);return o-=t.pollutionDensityMap.worldGet(i,s),o<0?o=0:o=Math.min(o*32,6e3),o-3e3},"evalResidential"),Qh=dt(function(t,i,s,n){let o;n.census.resZonePop+=1;const a=t.getTileValue(i,s),r=ra(t,i,s,a);n.census.resPop+=r;const l=t.getTile(i,s).isPowered();let h=x.ROUTE_FOUND;if(r>u.getRandom(35)&&(h=n.trafficManager.makeTraffic(i,s,n.blockMaps,T.isCommercial),h===x.NO_ROAD_FOUND)){o=P.getLandPollutionValue(n.blockMaps,i,s),la(t,i,s,n.blockMaps,r,o,l);return}if(a===ve||u.getChance(7)){const c=Kh(n.blockMaps,i,s,h);let g=n.valves.resValve+c;if(l||(g=-500),g>-350&&g-26380>u.getRandom16Signed()){if(r===0&&u.getChance(3)){ha(t,i,s,n,l);return}o=P.getLandPollutionValue(n.blockMaps,i,s),Zh(t,i,s,n.blockMaps,r,o,l);return}g<350&&g+26380<u.getRandom16Signed()&&(o=P.getLandPollutionValue(n.blockMaps,i,s),la(t,i,s,n.blockMaps,r,o,l))}},"residentialFound");function ha(t,i,s,n,o){n.census.needHospital>0&&(P.putZone(t,i,s,Zs,o),n.census.needHospital=0)}d(ha,"I$9"),dt(ha,"makeHospital");const Jh=dt(function(t,i,s,n){n.census.hospitalPop+=1,n.census.needHospital===-1&&u.getRandom(20)===0&&P.putZone(t,i,s,ve,t.getTile(i,s).isPowered())},"hospitalFound"),ca={registerHandlers:function(t,i){t.addAction(T.isResidentialZone,Qh),t.addAction(Zs,Jh),i.addAction(Zs,15,3)},getZonePopulation:ra};var tc=Object.defineProperty,ut=d((t,i)=>tc(t,"name",{value:i,configurable:!0}),"d$c");const zt=0,fi=1,rt=ut(function(t,i,s){for(let n=0,o=t.width;n<o;n++)for(let a=0,r=t.height;a<r;a++){let l=0;n>0&&(l+=t.get(n-1,a)),n<t.width-1&&(l+=t.get(n+1,a)),a>0&&(l+=t.get(n,a-1)),a<t.height-1&&(l+=t.get(n,a+1)),s===zt?(l=t.get(n,a)+Math.floor(l/4),i.set(n,a,Math.floor(l/2))):(l=l+t.get(n,a)>>2,l>255&&(l=255),i.set(n,a,l))}},"smoothMap"),ec=ut(function(t){const i=t.rateOfGrowthMap;for(let s=0,n=i.width;s<n;s++)for(let o=0,a=i.height;o<a;o++){let r=i.get(s,o);r!==0&&(r>0?r--:r++,r=p.clamp(r,-200,200),i.set(s,o,r))}},"neutraliseRateOfGrowthMap"),ic=ut(function(t){const i=t.trafficDensityMap;for(let s=0,n=i.width;s<n;s++)for(let o=0,a=i.height;o<a;o++){let r=i.get(s,o);r!==0&&(r<=24?r=0:r>200?r=r-34:r=r-24,i.set(s,o,r))}},"neutraliseTrafficMap"),sc=ut(function(t){if(t<_t){if(t>=Xs)return 75;if(t>=zs)return 50;if(t<N){if(t>ro)return 90;if(t>=Je)return 255}return 0}return t<=rl?0:t<Wt?50:t<=tn?100:0},"getPollutionValue"),da=ut(function(t,i,s){let n,o;return i>t.cityCentreX?n=i-t.cityCentreX:n=t.cityCentreX-i,s>t.cityCentreY?o=s-t.cityCentreY:o=t.cityCentreY-s,Math.min(n+o,64)},"getCityCentreDistance"),nc=ut(function(t,i,s){const n=s.tempMap1,o=s.tempMap2,a=s.tempMap3;a.clear();const r=s.landValueMap,l=s.terrainDensityMap,h=s.pollutionDensityMap,c=s.crimeRateMap;let g,_,v,S,C=0,A=0;for(g=0,v=r.width;g<v;g++)for(_=0,S=r.height;_<S;_++){let K=0,bt=!1;const oo=g*2,ao=_*2;for(let Q=oo;Q<=oo+1;Q++)for(let Bi=ao;Bi<=ao+1;Bi++){const Hs=t.getTileValue(Q,Bi);if(Hs!==R){if(Hs<Hi){const Pf=a.worldGet(Q,Bi);a.worldSet(Q,Bi,Pf+15);continue}K+=sc(Hs),Hs>=N&&(bt=!0)}}if(K=Math.min(K,255),n.set(g,_,K),bt){let Q=34-Math.floor(da(t,oo,ao)/2);Q=Q<<2,Q+=l.get(g>>1,_>>1),Q-=h.get(g,_),c.get(g,_)>190&&(Q-=20),Q=p.clamp(Q,1,250),r.set(g,_,Q),C+=Q,A++}else r.set(g,_,0)}A>0?i.landValueAverage=Math.floor(C/A):i.landValueAverage=0,rt(n,o,fi),rt(o,n,fi);let ee=0,kt=0,xt=0;for(g=0,v=t.width;g<v;g+=h.blockSize)for(_=0,S=t.height;_<S;_+=h.blockSize){const K=n.worldGet(g,_);h.worldSet(g,_,K),K!==0&&(kt++,xt+=K,(K>ee||K===ee&&u.getChance(3))&&(ee=K,t.pollutionMaxX=g,t.pollutionMaxY=_))}kt?i.pollutionAverage=Math.floor(xt/kt):i.pollutionAverage=0,rt(a,l,zt)},"pollutionTerrainLandValueScan"),oc=ut(function(t,i){const s=i.policeStationMap,n=i.policeStationEffectMap,o=i.crimeRateMap,a=i.landValueMap,r=i.populationDensityMap;rt(s,n,zt),rt(n,s,zt),rt(s,n,zt);let l=0,h=0;for(let v=0,S=o.mapWidth,C=o.blockSize;v<S;v+=C)for(var c=0,g=o.mapHeight,_;c<g;c+=C){let A=a.worldGet(v,c);A>0?(h+=1,A=128-A,A+=r.worldGet(v,c),A=Math.min(A,300),A-=s.worldGet(v,c),A=p.clamp(A,0,250),o.worldSet(v,c,A),l+=A):o.worldSet(v,c,0)}h>0?t.crimeAverage=Math.floor(l/h):t.crimeAverage=0},"crimeScan"),ac=ut(function(t,i){const s=i.cityCentreDistScoreMap;for(let n=0,o=s.width;n<o;n++)for(let a=0,r=s.height;a<r;a++){let l=Math.floor(da(t,n*8,a*8)/2);l=l*4,l=64-l,s.set(n,a,l)}},"fillCityCentreDistScoreMap"),rc=ut(function(t,i,s,n){return n<qs?ca.getZonePopulation(t,i,s,n):n<Gi?ia.getZonePopulation(t,i,s,n)*8:n<Wt?aa.getZonePopulation(t,i,s,n)*8:0},"getPopulationDensity"),lc=ut(function(t,i){const s=i.tempMap1,n=i.tempMap2;i.populationDensityMap;let o=0,a=0,r=0;s.clear();for(let l=0,h=t.width;l<h;l++)for(let c=0,g=t.height;c<g;c++){const _=t.getTile(l,c);if(_.isZone()){const v=_.getValue();let S=rc(t,l,c,v)*8;S=Math.min(S,254),s.worldSet(l,c,S),o+=l,a+=c,r++}}rt(s,n,fi),rt(n,s,fi),rt(s,n,fi),i.populationDensityMap.copyFrom(n,function(l){return l*2}),ac(t,i),r>0?(t.cityCentreX=Math.floor(o/r),t.cityCentreY=Math.floor(a/r)):(t.cityCentreX=Math.floor(t.width/2),t.cityCentreY=Math.floor(t.height/2))},"populationDensityScan"),hc=ut(function(t){const i=t.fireStationMap,s=t.fireStationEffectMap;rt(i,s,zt),rt(s,i,zt),rt(i,s,zt)},"fireAnalysis"),vt={crimeScan:oc,fireAnalysis:hc,neutraliseRateOfGrowthMap:ec,neutraliseTrafficMap:ic,pollutionTerrainLandValueScan:nc,populationDensityScan:lc},cc={debug:!1,gameDebug:!1,queryDebug:!1};var dc=Object.defineProperty,gi=d((t,i)=>dc(t,"name",{value:i,configurable:!0}),"s$g");const st=gi(function(t){const i={},s=gi(function(r,l){r in i||(i[r]=[]);const h=i[r];h.indexOf(l)===-1&&h.push(l)},"addListener"),n=gi(function(r,l){r in i||(i[r]=[]);const h=i[r],c=h.indexOf(l);c!==-1&&h.splice(c,1)},"removeListener"),o=gi(function(r,l){r===void 0&&console.warn("Sending undefined event!"),r in i||(i[r]=[]);const h=i[r];for(let c=0,g=h.length;c<g;c++)h[c](l)},"emitEvent"),a=gi(function(r,l){if(["addEventListener","removeEventListener","_emitEvent"].some(function(h){return r[h]!==void 0}))throw new Error("Cannot decorate "+l+": existing properties would be overwritten!");r.addEventListener=s,r.removeEventListener=n,r._emitEvent=o},"addProps");return typeof t=="object"?a(t,"object"):a(t.prototype,"constructor"),t},"EventEmitter"),En="Autobudget changed",Le="User needs to budget",ua="Budget window requested",Tn="Budget window closed",ns="Blackouts reported",wn="Classification updated",uc="Congratulations showing",pc="Congratulations window closed",os="Date changed",pa="Debug Window Requested",vn="Debug Window Closed",fa="Disaster Requested",Sn="Disaster window closed",mi="Earthquake",ga="Evaluation Requested",fc="Evaluation Updated",yn="Eval window closed",_i="Explosion Reported",Ei="Fire!",as="Fire station needs funding",Ti="Flooding reported",L="Front-end Message",Ie="Total funds has changed",Xt="Total funds has changed",wi="Helicopter crashed",rs="High crime",ls="High pollution",vi="Monster sighted",gc="Nag window closed",hs="Airport needed",cs="More power needed",ds="Fire station needed",us="More commercial zones needed",ps="More industrial zones needed",fs="More railways needed",gs="More residential needed",ms="More roads needed",_s="Police station needed",Es="Seaport needed",Ts="Stadium needed",oe="No money",ke="Not enough power",Si="Nuclear Meltdown",yi="Plane crashed",ws="Police need funding",bn="Population updated",Dn="Query window closed",ae="Query window needed",bi="Now a capital",Di="Now a city",Oi="Now a metropolis",Ci="Now a megalopolis",Ri="Now a town",ma="Now a village",vs="Roads need funding",_a="Save requested",On="Save window closed",Cn="Scoe updated",Rn="Screenshot link closed",Mn="Screenshot window closed",Ea="Screenshot window requested",$n="Settings window closed",Ta="Settings window requested",Mi="Shipwrecked",Ss="Explosion! Bang!",Pn="Explosion! Bang!",wa="Heavy Traffic sound",va="HonkHonk sound",Sa="Monster sound",An="Speed change",ys="Sprite dying",Ln="Sprite move",bs="Tax too high",$i="Tool clicked",xe="Tornado sighted",In="Touch Window closed",Ds="Traffic jams reported",Pi="Train crashed",Ne="Valves updated",kn="Welcome",re=[mi,_i,Ei,Ti,vi,Si,xe],le=[wi,yi,Mi,Pi];var ya=Object.freeze({__proto__:null,AUTOBUDGET_CHANGED:En,BUDGET_NEEDED:Le,BUDGET_REQUESTED:ua,BUDGET_WINDOW_CLOSED:Tn,BLACKOUTS_REPORTED:ns,CLASSIFICATION_UPDATED:wn,CONGRATS_SHOWING:uc,CONGRATS_WINDOW_CLOSED:pc,DATE_UPDATED:os,DEBUG_WINDOW_REQUESTED:pa,DEBUG_WINDOW_CLOSED:vn,DISASTER_REQUESTED:fa,DISASTER_WINDOW_CLOSED:Sn,EARTHQUAKE:mi,EVAL_REQUESTED:ga,EVAL_UPDATED:fc,EVAL_WINDOW_CLOSED:yn,EXPLOSION_REPORTED:_i,FIRE_REPORTED:Ei,FIRE_STATION_NEEDS_FUNDING:as,FLOODING_REPORTED:Ti,FRONT_END_MESSAGE:L,FUNDS_CHANGED:Ie,HEAVY_TRAFFIC:Xt,HELICOPTER_CRASHED:wi,HIGH_CRIME:rs,HIGH_POLLUTION:ls,MONSTER_SIGHTED:vi,NAG_WINDOW_CLOSED:gc,NEED_AIRPORT:hs,NEED_ELECTRICITY:cs,NEED_FIRE_STATION:ds,NEED_MORE_COMMERCIAL:us,NEED_MORE_INDUSTRIAL:ps,NEED_MORE_RAILS:fs,NEED_MORE_RESIDENTIAL:gs,NEED_MORE_ROADS:ms,NEED_POLICE_STATION:_s,NEED_SEAPORT:Es,NEED_STADIUM:Ts,NO_MONEY:oe,NOT_ENOUGH_POWER:ke,NUCLEAR_MELTDOWN:Si,PLANE_CRASHED:yi,POLICE_NEEDS_FUNDING:ws,POPULATION_UPDATED:bn,QUERY_WINDOW_CLOSED:Dn,QUERY_WINDOW_NEEDED:ae,REACHED_CAPITAL:bi,REACHED_CITY:Di,REACHED_METROPOLIS:Oi,REACHED_MEGALOPOLIS:Ci,REACHED_TOWN:Ri,REACHED_VILLAGE:ma,ROAD_NEEDS_FUNDING:vs,SAVE_REQUESTED:_a,SAVE_WINDOW_CLOSED:On,SCORE_UPDATED:Cn,SCREENSHOT_LINK_CLOSED:Rn,SCREENSHOT_WINDOW_CLOSED:Mn,SCREENSHOT_WINDOW_REQUESTED:Ea,SETTINGS_WINDOW_CLOSED:$n,SETTINGS_WINDOW_REQUESTED:Ta,SHIP_CRASHED:Mi,SOUND_EXPLOSIONHIGH:Ss,SOUND_EXPLOSIONLOW:Pn,SOUND_HEAVY_TRAFFIC:wa,SOUND_HONKHONK:va,SOUND_MONSTER:Sa,SPEED_CHANGE:An,SPRITE_DYING:ys,SPRITE_MOVED:Ln,TAX_TOO_HIGH:bs,TOOL_CLICKED:$i,TORNADO_SIGHTED:xe,TOUCH_WINDOW_CLOSED:In,TRAFFIC_JAMS:Ds,TRAIN_CRASHED:Pi,VALVES_UPDATED:Ne,WELCOME:kn,DISASTER_MESSAGES:re,CRASHES:le});const mc=100,_c=100,Ec=1,Tc=2,tt=st(function(){Object.defineProperties(this,{MAX_ROAD_EFFECT:p.makeConstantDescriptor(32),MAX_POLICESTATION_EFFECT:p.makeConstantDescriptor(1e3),MAX_FIRESTATION_EFFECT:p.makeConstantDescriptor(1e3)}),this.roadEffect=this.MAX_ROAD_EFFECT,this.policeEffect=this.MAX_POLICESTATION_EFFECT,this.fireEffect=this.MAX_FIRESTATION_EFFECT,this.totalFunds=0,this.cityTax=7,this.cashFlow=0,this.taxFund=0,this.roadMaintenanceBudget=0,this.fireMaintenanceBudget=0,this.policeMaintenanceBudget=0,this.roadPercent=1,this.firePercent=1,this.policePercent=1,this.roadSpend=0,this.fireSpend=0,this.policeSpend=0,this.awaitingValues=!1,this.autoBudget=!0}),Ve=["autoBudget","totalFunds","policePercent","roadPercent","firePercent","roadSpend","policeSpend","fireSpend","roadMaintenanceBudget","policeMaintenanceBudget","fireMaintenanceBudget","cityTax","roadEffect","policeEffect","fireEffect"];tt.prototype.save=function(t){for(let i=0,s=Ve.length;i<s;i++)t[Ve[i]]=this[Ve[i]]},tt.prototype.load=function(t){for(let i=0,s=Ve.length;i<s;i++)this[Ve[i]]=t[Ve[i]];this._emitEvent(En,this.autoBudget),this._emitEvent(Ie,this.totalFunds)},tt.prototype.setAutoBudget=function(t){this.autoBudget=t,this._emitEvent(En,this.autoBudget)};const wc=[.7,.9,1.2],vc=[1.4,1.2,.8];tt.prototype._calculateBestPercentages=function(){if(this.roadSpend=Math.round(this.roadMaintenanceBudget*this.roadPercent),this.fireSpend=Math.round(this.fireMaintenanceBudget*this.firePercent),this.policeSpend=Math.round(this.policeMaintenanceBudget*this.policePercent),this.roadSpend+this.fireSpend+this.policeSpend===0)return this.roadPercent=1,this.firePercent=1,this.policePercent=1,{road:1,fire:1,police:1};let t=0,i=0,s=0,n=this.totalFunds+this.taxFund;return n>=this.roadSpend?t=this.roadSpend:t=n,n-=t,n>=this.fireSpend?i=this.fireSpend:i=n,n-=i,n>=this.policeSpend?s=this.policeSpend:s=n,n-=s,this.roadMaintenanceBudget>0?this.roadPercent=(t/this.roadMaintenanceBudget).toPrecision(2)-0:this.roadPercent=1,this.fireMaintenanceBudget>0?this.firePercent=(i/this.fireMaintenanceBudget).toPrecision(2)-0:this.firePercent=1,this.policeMaintenanceBudget>0?this.policePercent=(s/this.policeMaintenanceBudget).toPrecision(2)-0:this.policePercent=1,{road:t,police:s,fire:i}},tt.prototype.doBudgetWindow=function(){return this.doBudgetNow(!0)},tt.prototype.doBudgetNow=function(t){const i=this._calculateBestPercentages();if(!this.autoBudget&&!t){this.autoBudget=!1,this.awaitingValues=!0,this._emitEvent(Le);return}const s=i.road,n=i.police,o=i.fire,a=s+n+o;if(this.totalFunds+this.taxFund-a>0&&this.autoBudget||t){this.awaitingValues=!1,this.doBudgetSpend(s,o,n);return}this.setAutoBudget(!1),this.awaitingValues=!0,this._emitEvent(Le),this._emitEvent(oe)},tt.prototype.doBudgetSpend=function(t,i,s){this.roadSpend=t,this.fireSpend=i,this.policeSpend=s;const n=this.roadSpend+this.fireSpend+this.policeSpend;this.spend(-(this.taxFund-n)),this.updateFundEffects()},tt.prototype.updateFundEffects=function(){this.roadSpend=Math.round(this.roadMaintenanceBudget*this.roadPercent),this.fireSpend=Math.round(this.fireMaintenanceBudget*this.firePercent),this.policeSpend=Math.round(this.policeMaintenanceBudget*this.policePercent),this.roadEffect=this.MAX_ROAD_EFFECT,this.policeEffect=this.MAX_POLICESTATION_EFFECT,this.fireEffect=this.MAX_FIRESTATION_EFFECT,this.roadMaintenanceBudget>0&&(this.roadEffect=Math.floor(this.roadEffect*this.roadSpend/this.roadMaintenanceBudget)),this.fireMaintenanceBudget>0&&(this.fireEffect=Math.floor(this.fireEffect*this.fireSpend/this.fireMaintenanceBudget)),this.policeMaintenanceBudget>0&&(this.policeEffect=Math.floor(this.policeEffect*this.policeSpend/this.policeMaintenanceBudget))},tt.prototype.collectTax=function(t,i){this.cashFlow=0,this.policeMaintenanceBudget=i.policeStationPop*mc,this.fireMaintenanceBudget=i.fireStationPop*_c;const s=i.roadTotal*Ec,n=i.railTotal*Tc;this.roadMaintenanceBudget=Math.floor((s+n)*wc[t]),this.taxFund=Math.floor(Math.floor(i.totalPop*i.landValueAverage/120)*this.cityTax*vc[t]),i.totalPop>0?(this.cashFlow=this.taxFund-(this.policeMaintenanceBudget+this.fireMaintenanceBudget+this.roadMaintenanceBudget),this.doBudgetNow(!1)):(this.roadEffect=this.MAX_ROAD_EFFECT,this.policeEffect=this.MAX_POLICESTATION_EFFECT,this.fireEffect=this.MAX_FIRESTATION_EFFECT)},tt.prototype.setTax=function(t){t!==this.cityTax&&(this.cityTax=t)},tt.prototype.setFunds=function(t){t!==this.totalFunds&&(this.totalFunds=Math.max(0,t),this._emitEvent(Ie,this.totalFunds),this.totalFunds===0&&this._emitEvent(oe))},tt.prototype.spend=function(t){this.setFunds(this.totalFunds-t)},tt.prototype.shouldDegradeRoad=function(){return this.roadEffect<Math.floor(15*this.MAX_ROAD_EFFECT/16)};var Sc=Object.defineProperty,Os=d((t,i)=>Sc(t,"name",{value:i,configurable:!0}),"n$h");const he=["res","com","ind","crime","money","pollution"];function ce(){this.clearCensus(),this.changed=!1,this.crimeRamp=0,this.pollutionRamp=0,this.landValueAverage=0,this.pollutionAverage=0,this.crimeAverage=0,this.totalPop=0;const t=Os(function(i){this[i]=[];for(let s=0;s<120;s++)this[i][s]=0},"createArray");for(let i=0;i<he.length;i++){const s=he[i]+"Hist10",n=he[i]+"Hist120";t.call(this,s),t.call(this,n)}}d(ce,"e$8"),Os(ce,"Census");const yc=Os(function(){for(let t=0;t<he.length;t++){const i=he[t]+"Hist10";this[i].pop(),this[i].unshift(0)}},"rotate10Arrays"),bc=Os(function(){for(let t=0;t<he.length;t++){const i=he[t]+"Hist120";this[i].pop(),this[i].unshift(0)}},"rotate120Arrays");ce.prototype.clearCensus=function(){this.poweredZoneCount=0,this.unpoweredZoneCount=0,this.firePop=0,this.roadTotal=0,this.railTotal=0,this.resPop=0,this.comPop=0,this.indPop=0,this.resZonePop=0,this.comZonePop=0,this.indZonePop=0,this.hospitalPop=0,this.churchPop=0,this.policeStationPop=0,this.fireStationPop=0,this.stadiumPop=0,this.coalPowerPop=0,this.nuclearPowerPop=0,this.seaportPop=0,this.airportPop=0};const Be=["resPop","comPop","indPop","crimeRamp","pollutionRamp","landValueAverage","pollutionAverage","crimeAverage","totalPop","resHist10","resHist120","comHist10","comHist120","indHist10","indHist120","crimeHist10","crimeHist120","moneyHist10","moneyHist120","pollutionHist10","pollutionHist120"];ce.prototype.save=function(t){for(let i=0,s=Be.length;i<s;i++)t[Be[i]]=this[Be[i]]},ce.prototype.load=function(t){for(let i=0,s=Be.length;i<s;i++)this[Be[i]]=t[Be[i]]},ce.prototype.take10Census=function(t){yc.call(this),this.resHist10[0]=Math.floor(this.resPop/8),this.comHist10[0]=this.comPop,this.indHist10[0]=this.indPop,this.crimeRamp+=Math.floor((this.crimeAverage-this.crimeRamp)/4),this.crimeHist10[0]=Math.min(this.crimeRamp,255),this.pollutionRamp+=Math.floor((this.pollutionAverage-this.pollutionRamp)/4),this.pollutionHist10[0]=Math.min(this.pollutionRamp,255);const i=Math.floor(t.cashFlow/20)+128;this.moneyHist10[0]=p.clamp(i,0,255),this.resPop>>8,this.hospitalPop<this.resPopScaled?this.needHospital=1:this.hospitalPop>this.resPopScaled?this.needHospital=-1:this.hospitalPop===this.resPopScaled&&(this.needHospital=0),this.changed=!0},ce.prototype.take120Census=function(){bc.call(this);const t=8;this.resHist120[0]=Math.floor(this.resPop/t),this.comHist120[0]=this.comPop,this.indHist120[0]=this.indPop,this.crimeHist120[0]=this.crimeHist10[0],this.pollutionHist120[0]=this.pollutionHist10[0],this.moneyHist120[0]=this.moneyHist10[0],this.changed=!0};var Dc=Object.defineProperty,Oc=d((t,i)=>Dc(t,"name",{value:i,configurable:!0}),"u$a");const pt=st(function(t,i,s){this._map=t,this._spriteManager=i,this._gameLevel=s,this._floodCount=0,this.disastersEnabled=!1}),Cc=[479,239,59];pt.prototype.doDisasters=function(t){if(this._floodCount&&this._floodCount--,!!this.disastersEnabled&&!u.getRandom(Cc[this._gameLevel]))switch(u.getRandom(8)){case 0:case 1:this.setFire();break;case 2:case 3:this.makeFlood();break;case 4:break;case 5:this._spriteManager.makeTornado();break;case 6:break;case 7:case 8:t.pollutionAverage>60&&this._spriteManager.makeMonster();break}},pt.prototype.scenarioDisaster=function(){},pt.prototype.makeMeltdown=function(){for(let t=0;t<this._map.width-1;t++)for(let i=0;i<this._map.height-1;i++)if(this._map.getTileValue(t,i)===Rt){this.doMeltdown(t,i);return}};const Rc=Oc(function(t){const i=t.getValue();return!(i<Ht||i>sn||t.isZone())},"vulnerable");pt.prototype.makeEarthquake=function(){const t=u.getRandom(700)+300;this.doEarthquake(t),this._emitEvent(mi,{x:this._map.cityCenterX,y:this._map.cityCenterY});for(let i=0;i<t;i++){const s=u.getRandom(this._map.width-1),n=u.getRandom(this._map.height-1);!this._map.testBounds(s,n)||Rc(this._map.getTile(s,n))&&((i&3)!==0?this._map.setTo(s,n,T.randomRubble()):this._map.setTo(s,n,T.randomFire()))}},pt.prototype.setFire=function(t,i){t=t||1,i=i||!1;for(let s=0;s<t;s++){const n=u.getRandom(this._map.width-1),o=u.getRandom(this._map.height-1);if(!this._map.testBounds(n,o))continue;let a=this._map.getTile(n,o);if(!a.isZone()&&(a=a.getValue(),a>(i?Ui:Fi)&&a<sn)){this._map.setTo(n,o,T.randomFire()),this._emitEvent(Ei,{showable:!0,x:n,y:o});return}}},pt.prototype.makeCrash=function(){let t=this._spriteManager.getSprite(Pt);if(t!==null){t.explodeSprite();return}const i=u.getRandom(this._map.width-1),s=u.getRandom(this._map.height-1);this._spriteManager.generatePlane(i,s),t=this._spriteManager.getSprite(Pt),t.explodeSprite()},pt.prototype.makeFire=function(){this.setFire(40,!1)};const ba=[0,1,0,-1],Da=[-1,0,1,0];pt.prototype.makeFlood=function(){for(let t=0;t<300;t++){const i=u.getRandom(this._map.width-1),s=u.getRandom(this._map.height-1);if(!this._map.testBounds(i,s))continue;let n=this._map.getTileValue(i,s);if(n>H&&n<=Ee)for(let o=0;o<4;o++){const a=i+ba[o],r=s+Da[o];if(!this._map.testBounds(a,r))continue;const l=this._map.getTile(a,r);if(n=l.getValue(),l===R||l.isBulldozable()&&l.isCombustible){this._map.setTile(a,r,ie,0),this._floodCount=30,this._emitEvent(Ti,{showable:!0,x:a,y:r});return}}}},pt.prototype.doFlood=function(t,i,s){if(this._floodCount>0){for(let n=0;n<4;n++)if(u.getChance(7)){const o=t+ba[n],a=i+Da[n];if(this._map.testBounds(o,a)){const r=this._map.getTile(o,a),l=r.getValue();(r.isCombustible()||l===R||l>=Lr&&l<ie)&&(r.isZone()&&P.fireZone(this._map,o,a,s),this._map.setTile(o,a,ie+u.getRandom(2),0))}}}else u.getChance(15)&&this._map.setTile(t,i,R,0)},pt.prototype.doMeltdown=function(t,i){this._spriteManager.makeExplosion(t-1,i-1),this._spriteManager.makeExplosion(t-1,i+2),this._spriteManager.makeExplosion(t+2,i-1),this._spriteManager.makeExplosion(t+2,i+2);let s,n;for(n=t-1;n<t+3;n++)for(s=i-1;s<i+3;s++)this._map.setTo(n,s,T.randomFire());for(let o=0;o<200;o++){if(n=t-20+u.getRandom(40),s=i-15+u.getRandom(30),!this._map.testBounds(n,s))continue;const a=this._map.getTile(n,s);a.isZone()||(a.isCombustible()||a.getValue()===R)&&this._map.setTile(n,s,Je,0)}this._emitEvent(Si,{showable:!0,x:t,y:i})};var Mc=Object.defineProperty,$c=d((t,i)=>Mc(t,"name",{value:i,configurable:!0}),"d$a");const Oa=$c(function(t,i,s){return function(n,o,a,r){r.census[t]+=1;let l=r.budget[i];n.getTile(o,a).isPowered()||(l=Math.floor(l/2));const h=new O(o,a);r.trafficManager.findPerimeterRoad(h)||(l=Math.floor(l/2));let c=r.blockMaps[s].worldGet(o,a);c+=l,r.blockMaps[s].worldSet(o,a,c)}},"handleService"),Pc=Oa("policeStationPop","policeEffect","policeStationMap"),Ac=Oa("fireStationPop","fireEffect","fireStationMap"),Lc={registerHandlers:function(t,i){t.addAction(en,Pc),t.addAction(mo,Ac)}};var Ic=Object.defineProperty,xn=d((t,i)=>Ic(t,"name",{value:i,configurable:!0}),"P$3"),kc=["CVP_CRIME","CVP_POLLUTION","CVP_HOUSING","CVP_TAXES","CVP_TRAFFIC","CVP_UNEMPLOYMENT","CVP_FIRE"],Fe=kc.length,Nn=4,St=[],w=st(function(t){this.problemVotes=[],this.problemOrder=[],this.evalInit(),this.gameLevel=""+t});w.prototype.cityEvaluation=function(t){var i=t.census;if(i.totalPop>0){for(var s=0;s<Fe;s++)St.push(0);this.getAssessedValue(i),this.getPopulation(i),this.doProblems(t.census,t.budget,t.blockMaps),this.getScore(t),this.doVotes()}else this.evalInit(),this.cityYes=50},w.prototype.evalInit=function(){this.cityYes=0,this.cityPop=0,this.cityPopDelta=0,this.cityAssessedValue=0,this.cityClass=w.CC_VILLAGE,this.cityClassLast=w.CC_VILLAGE,this.cityScore=500,this.cityScoreDelta=0;for(var t=0;t<Fe;t++)this.problemVotes[t]={index:t,voteCount:0};for(t=0;t<Nn;t++)this.problemOrder[t]=Fe};var He=["cityClass","cityScore"];w.prototype.save=function(t){for(var i=0,s=He.length;i<s;i++)t[He[i]]=this[He[i]]},w.prototype.load=function(t){for(var i=0,s=He.length;i<s;i++)this[He[i]]=t[He[i]]},w.prototype.getAssessedValue=function(t){var i;i=t.roadTotal*5,i+=t.railTotal*10,i+=t.policeStationPop*1e3,i+=t.fireStationPop*1e3,i+=t.hospitalPop*400,i+=t.stadiumPop*3e3,i+=t.seaportPop*5e3,i+=t.airportPop*1e4,i+=t.coalPowerPop*3e3,i+=t.nuclearPowerPop*6e3,this.cityAssessedValue=i*1e3},w.prototype.getPopulation=function(t){var i=this.cityPop;return this.cityPop=(t.resPop+(t.comPop+t.indPop)*8)*20,this.cityPopDelta=this.cityPop-i,this.cityPopDelta!==0&&this._emitEvent(bn,this.cityPop),this.cityPop},w.prototype.getCityClass=function(t){return this.cityClass=w.CC_VILLAGE,t>2e3&&(this.cityClass=w.CC_TOWN),t>1e4&&(this.cityClass=w.CC_CITY),t>5e4&&(this.cityClass=w.CC_CAPITAL),t>1e5&&(this.cityClass=w.CC_METROPOLIS),t>5e5&&(this.cityClass=w.CC_MEGALOPOLIS),this.cityClass!==this.cityClassLast&&(this.cityClassLast=this.cityClass,this._emitEvent(wn,this.cityClass)),this.cityClass},w.prototype.voteProblems=function(){for(var t=0;t<Fe;t++)this.problemVotes[t].index=t,this.problemVotes[t].voteCount=0;for(var i=0,s=0,n=0;s<100&&n<600;){var o=u.getRandom(300);St[i]>o&&(this.problemVotes[i].voteCount+=1,s++),i=(i+1)%Fe,n++}};var xc=xn(function(t,i){for(var s=t.trafficDensityMap,n=t.landValueMap,o=0,a=1,r=0;r<n.gameMapWidth;r+=n.blockSize)for(var l=0;l<n.gameMapHeight;l+=n.blockSize)n.worldGet(r,l)>0&&(o+=s.worldGet(r,l),a++);var h=i.trafficAverage=Math.floor(o/a)*2.4;return h},"getTrafficAverage"),Nc=xn(function(t){var i=(t.comPop+t.indPop)*8;if(i===0)return 0;var s=t.resPop/i;return i=Math.round((s-1)*255),Math.min(i,255)},"getUnemployment"),Ca=xn(function(t){return Math.min(t.firePop*5,255)},"getFireSeverity");w.prototype.doProblems=function(t,i,s){St[w.CRIME]=t.crimeAverage,St[w.POLLUTION]=t.pollutionAverage,St[w.HOUSING]=t.landValueAverage*7/10,St[w.TAXES]=i.cityTax*10,St[w.TRAFFIC]=xc(s,t),St[w.UNEMPLOYMENT]=Nc(t),St[w.FIRE]=Ca(t),this.voteProblems(),this.problemVotes.sort(function(n,o){return o.voteCount-n.voteCount}),this.problemOrder=this.problemVotes.map(function(n,o){return o>=Nn||n.voteCount===0?null:n.index})},w.prototype.getScore=function(t){for(var i=t.census,s=t.budget,n=t.valves,o=this.cityScore,a=0,r=0;r<Fe;r++)a+=St[r];a=Math.floor(a/3),a=(250-Math.min(a,250))*4;var l=.85;n.resCap&&(a=Math.round(a*l)),n.comCap&&(a=Math.round(a*l)),n.indCap&&(a=Math.round(a*l)),s.roadEffect<s.MAX_ROAD_EFFECT&&(a-=s.MAX_ROAD_EFFECT-s.roadEffect),s.policeEffect<s.MAX_POLICE_STATION_EFFECT&&(a=Math.round(a*(.9+s.policeEffect/(10*s.MAX_POLICE_STATION_EFFECT)))),s.fireEffect<s.MAX_FIRE_STATION_EFFECT&&(a=Math.round(a*(.9+s.fireEffect/(10*s.MAX_FIRE_STATION_EFFECT)))),n.resValve<-1e3&&(a=Math.round(a*.85)),n.comValve<-1e3&&(a=Math.round(a*.85)),n.indValve<-1e3&&(a=Math.round(a*.85));var h=1;this.cityPop===0||this.cityPopDelta===0||this.cityPopDelta===this.cityPop?h=1:this.cityPopDelta>0?h=this.cityPopDelta/this.cityPop+1:this.cityPopDelta<0&&(h=.95+Math.floor(this.cityPopDelta/(this.cityPop-this.cityPopDelta))),a=Math.round(a*h),a=a-Ca(i)-s.cityTax,h=i.unpoweredZoneCount+i.poweredZoneCount,h>0&&(a=Math.round(a*(i.poweredZoneCount/h))),a=p.clamp(a,0,1e3),this.cityScore=Math.round((this.cityScore+a)/2),this.cityScoreDelta=this.cityScore-o,this.cityScoreDelta!==0&&this._emitEvent(Cn,this.cityScore)},w.prototype.doVotes=function(){this.cityYes=0;for(var t=0;t<100;t++){var i=u.getRandom(1e3);this.cityScore>i&&this.cityYes++}},w.prototype.getProblemNumber=function(t){return t<0||t>=Nn?null:this.problemOrder[t]},Object.defineProperties(w,{CC_VILLAGE:p.makeConstantDescriptor("VILLAGE"),CC_TOWN:p.makeConstantDescriptor("TOWN"),CC_CITY:p.makeConstantDescriptor("CITY"),CC_CAPITAL:p.makeConstantDescriptor("CAPITAL"),CC_METROPOLIS:p.makeConstantDescriptor("METROPOLIS"),CC_MEGALOPOLIS:p.makeConstantDescriptor("MEGALOPOLIS"),CRIME:p.makeConstantDescriptor(0),POLLUTION:p.makeConstantDescriptor(1),HOUSING:p.makeConstantDescriptor(2),TAXES:p.makeConstantDescriptor(3),TRAFFIC:p.makeConstantDescriptor(4),UNEMPLOYMENT:p.makeConstantDescriptor(5),FIRE:p.makeConstantDescriptor(6)});var Vc=Object.defineProperty,Ra=d((t,i)=>Vc(t,"name",{value:i,configurable:!0}),"s$e");const We=new U;function Cs(t){this._map=t,this._actions=[]}d(Cs,"p$c"),Ra(Cs,"MapScanner");const Bc=Ra(function(t){return typeof t=="function"},"isCallable");Cs.prototype.addAction=function(t,i){this._actions.push({criterion:t,action:i})},Cs.prototype.mapScan=function(t,i,s){for(let n=0;n<this._map.height;n++)for(let o=t;o<i;o++){this._map.getTile(o,n,We);const a=We.getValue();if(!(a<ie)){We.isConductive()&&s.powerManager.setTilePower(o,n),We.isZone()&&(s.repairManager.checkTile(o,n,s.cityTime),We.isPowered()?s.census.poweredZoneCount+=1:s.census.unpoweredZoneCount+=1);for(let r=0,l=this._actions.length;r<l;r++){const h=this._actions[r],c=Bc(h.criterion);if(c&&h.criterion.call(null,We)){h.action.call(null,this._map,o,n,s);break}else if(!c&&h.criterion===a){h.action.call(null,this._map,o,n,s);break}}}}};var Fc=Object.defineProperty,Vn=d((t,i)=>Fc(t,"name",{value:i,configurable:!0}),"s$d");const Hc=[-1,0,1,0],Wc=[0,-1,0,1],Uc=Vn(function(t,i,s,n){if(n.census.firePop+=1,(u.getRandom16()&3)!==0)return;for(let r=0;r<4;r++)if(u.getChance(7)){const l=i+Hc[r],h=s+Wc[r];if(t.testBounds(l,h)){const c=t.getTile(i,s);if(!c.isCombustible())continue;c.isZone()&&(P.fireZone(t,i,s,n.blockMaps),c.getValue()>ni&&n.spriteManager.makeExplosionAt(i,s)),t.setTo(T.randomFire())}}let o=10,a=n.blockMaps.fireStationEffectMap.worldGet(i,s);a>100?o=1:a>20?o=2:a>0&&(o=3),u.getRandom(o)===0&&t.setTo(i,s,T.randomRubble())},"fireFound"),Gc=Vn(function(t,i,s,n){u.getChance(4095)&&t.setTile(i,s,R,0)},"radiationFound"),Yc=Vn(function(t,i,s,n){n.disasterManager.doFlood(i,s,n.blockMaps)},"floodFound"),zc={registerHandlers:function(t,i){t.addAction(T.isFire,Uc,!0),t.addAction(Je,Gc,!0),t.addAction(T.isFlood,Yc,!0)}},Xc=700,jc=2e3,jt=st(function(t){this._map=t,this._powerStack=[],this.powerGridMap=new G(this._map.width,this._map.height,1)});jt.prototype.setTilePower=function(t,i){const s=this._map.getTile(t,i),n=s.getValue();if(n===Rt||n===Ut||this.powerGridMap.worldGet(t,i)>0){s.addFlags(Mt);return}s.removeFlags(Mt)},jt.prototype.clearPowerStack=function(){this._powerStackPointer=0,this._powerStack=[]},jt.prototype.testForConductive=function(t,i){const s=O.move(t,i);return!!(this._map.isPositionInBounds(s)&&this._map.getTile(s.x,s.y).isConductive()&&this.powerGridMap.worldGet(s.x,s.y)===0)},jt.prototype.doPowerScan=function(t){this.powerGridMap.clear();const i=t.coalPowerPop*Xc+t.nuclearPowerPop*jc;let s=0;for(;this._powerStack.length>0;){var n=this._powerStack.pop(),o=void 0,a;do{if(s++,s>i){this._emitEvent(ke);return}o&&(n=O.move(n,o)),this.powerGridMap.worldSet(n.x,n.y,1),a=0,ye(r=>{a>=2||this.testForConductive(n,r)&&(a++,o=r)}),a>1&&this._powerStack.push(new O(n.x,n.y))}while(a)}},jt.prototype.coalPowerFound=function(t,i,s,n){n.census.coalPowerPop+=1,this._powerStack.push(new O(i,s));const o=[-1,2,1,2],a=[-1,-1,0,0];for(let r=0;r<4;r++)t.addTileFlags(i+o[r],s+a[r],j)};const Zc=[3e4,2e4,1e4];jt.prototype.nuclearPowerFound=function(t,i,s,n){if(n.disasterManager.disastersEnabled&&u.getRandom(Zc[n.gameLevel])===0){n.disasterManager.doMeltdown(i,s);return}n.census.nuclearPowerPop+=1,this._powerStack.push(new O(i,s));for(let o=0;o<4;o++)t.addTileFlags(i,s,j|I|Mt|M)},jt.prototype.registerHandlers=function(t,i){t.addAction(Ut,this.coalPowerFound.bind(this)),t.addAction(Rt,this.nuclearPowerFound.bind(this)),i.addAction(Ut,7,4),i.addAction(Rt,7,4)};var qc=Object.defineProperty,Ma=d((t,i)=>qc(t,"name",{value:i,configurable:!0}),"p$b");function Ai(t){this._map=t,this._actions=[]}d(Ai,"a$f"),Ma(Ai,"RepairManager");const Kc=Ma(function(t){return typeof t=="function"},"isCallable");Ai.prototype.addAction=function(t,i,s){this._actions.push({criterion:t,period:i,zoneSize:s})},Ai.prototype.repairZone=function(t,i,s){let n=this._map.getTileValue(t,i)-s-2;for(let o=-1;o<s-1;o++)for(let a=-1;a<s-1;a++){n++;const r=this._map.getTile(t+a,i+o);if(r.isZone()||r.isAnimated())continue;const l=r.getValue();(l<Hi||l>=N)&&this._map.setTile(t+a,i+o,n,I|M)}},Ai.prototype.checkTile=function(t,i,s){for(let n=0,o=this._actions.length;n<o;n++){const a=this._actions[n],r=a.period;if((s&r)!==0)continue;const l=this._map.getTile(t,i),h=l.getValue(),c=Kc(a.criterion);c&&a.criterion.call(null,l)?this.repairZone(t,i,a.zoneSize):!c&&a.criterion===h&&this.repairZone(t,i,a.zoneSize)}};var Qc=Object.defineProperty,Rs=d((t,i)=>Qc(t,"name",{value:i,configurable:!0}),"a$e");const $a=Rs(function(t,i,s,n,o,a,r){for(let l=0;l<7;l++){const h=i+n[l],c=s+o[l];t.testBounds(h,c)&&t.getTileValue(h,c)===(a[l]&es)&&t.setTileValue(h,c,r[l])}},"openBridge"),Pa=Rs(function(t,i,s,n,o,a,r){for(let l=0;l<7;l++){const h=i+n[l],c=s+o[l];if(t.testBounds(h,c)){const g=t.getTileValue(h,c);(g===H||(g&15)===(a[l]&15))&&t.setTileValue(h,c,r[l])}}},"closeBridge"),Aa=[0,1,0,0,0,0,1],La=[-2,-2,-1,0,1,2,2],Ia=[rn|m,bo|m,f,we|m,f,Do|m,Oo|m],ka=[ot|m,f,ot|m,ot|m,ot|m,ot|m,f],xa=[-2,2,-2,-1,0,1,2],Na=[-1,-1,0,0,0,0,0],Va=[To|m,vo|m,nn|m,f,Te|m,f,wo|m],Ba=[f,f,nt|m,nt|m,nt|m,nt|m,nt|m],Jc=Rs(function(t,i,s,n,o){if(n===we)return u.getChance(3)&&o.spriteManager.getBoatDistance(i,s)>340&&Pa(t,i,s,Aa,La,Ia,ka),!0;if(n==Te)return u.getChance(3)&&o.spriteManager.getBoatDistance(i,s)>340&&Pa(t,i,s,xa,Na,Va,Ba),!0;if(o.spriteManager.getBoatDistance(i,s)<300||u.getChance(7)){if(n&1)return i<t.width-1&&t.getTileValue(i+1,s)===H?($a(t,i,s,Aa,La,ka,Ia),!0):!1;if(s>0&&t.getTileValue(i,s-1)===H)return $a(t,i,s,xa,Na,Ba,Va),!0}return!1},"doBridge"),td=[N,zs,Xs],ed=Rs(function(t,i,s,n){n.census.roadTotal+=1;let o=t.getTile(i,s);const a=o.getValue();if(n.budget.shouldDegradeRoad()&&u.getChance(511)&&(o=t.getTile(i,s),!o.isConductive()&&n.budget.roadEffect<(u.getRandom16()&31))){o.getValue(),(a&15)<2||(a&15)===15?t.setTile(i,s,f,0):t.setTo(i,s,T.randomRubble());return}if(!o.isCombustible()&&(n.census.roadTotal+=4,Jc(t,i,s,a,n)))return;let r=0;a<zs?r=0:a<Xs?r=1:(n.census.roadTotal+=1,r=2);let l=n.blockMaps.trafficDensityMap.worldGet(i,s)>>6;if(l>1&&(l-=1),l===r)return;const h=(a-N&15)+td[l];let c=o.getFlags()&~j;l>0&&(c|=j),t.setTo(i,s,new U(h,c))},"roadFound"),id={registerHandlers:function(t,i){t.addAction(T.isRoad,ed)}};var sd=Object.defineProperty,Ms=d((t,i)=>sd(t,"name",{value:i,configurable:!0}),"n$f");const nd=Ms(function(t,i,s,n,o){this.type=t,this.map=i,this.spriteManager=s;let a=n,r=o,l=n>>4,h=o>>4;Object.defineProperty(this,"x",{configurable:!1,enumerable:!0,set:function(c){a=c,l=c>>4},get:function(){return a}}),Object.defineProperty(this,"y",{configurable:!1,enumerable:!0,set:function(c){r=c,h=c>>4},get:function(){return r}}),Object.defineProperty(this,"worldX",{configurable:!1,enumerable:!0,set:function(c){l=c,a=c<<4},get:function(){return l}}),Object.defineProperty(this,"worldY",{configurable:!1,enumerable:!0,set:function(c){h=c,r=c<<4},get:function(){return h}}),this.origX=0,this.origY=0,this.destX=0,this.destY=0,this.count=0,this.soundCount=0,this.dir=0,this.newDir=0,this.step=0,this.flag=0,this.turn=0,this.accel=0,this.speed=100},"init"),od=Ms(function(){return["obj",this.type,"-",this.frame-1].join("")},"getFileName"),ad=Ms(function(){const t=this.worldX,i=this.worldY;return t<0||i<0||t>=this.map.width||i>=this.map.height},"spriteNotInBounds"),rd={init:nd,getFileName:od,spriteNotInBounds:ad},de=Ms(function(t){t.prototype=Object.create(rd),st(t)},"BaseSprite");var ld=Object.defineProperty,hd=d((t,i)=>ld(t,"name",{value:i,configurable:!0}),"m$b");function Ue(t,i,s,n){this.init(Pt,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,s>E.worldToPix(t.width-20)?(this.destX=this.x-200,this.frame=7):(this.destX=this.x+200,this.frame=11),this.destY=this.y}d(Ue,"r$e"),hd(Ue,"AirplaneSprite"),de(Ue);const cd=[0,0,6,8,6,0,-6,-8,-6,8,8,8],dd=[0,-8,-6,0,6,8,6,0,-6,0,0,0];Ue.prototype.move=function(t,i,s){let n=this.frame;if(t%5===0)if(n>8)n--,n<9&&(n=3),this.frame=n;else{const o=E.getDir(this.x,this.y,this.destX,this.destY);n=E.turnTo(n,o),this.frame=n}if(E.absoluteDistance(this.x,this.y,this.destX,this.destY)<50&&(this.destX=u.getRandom(E.worldToPix(this.map.width))+8,this.destY=u.getRandom(E.worldToPix(this.map.height))+8),i.enableDisasters){let o=!1;const a=this.spriteManager.getSpriteList();for(let r=0;r<a.length;r++){const l=a[r];l.frame===0||l===this||(l.type===$t||l.type===Pt)&&E.checkSpriteCollision(this,l)&&(l.explodeSprite(),o=!0)}o&&this.explodeSprite()}this.x+=cd[n],this.y+=dd[n],this.spriteNotInBounds()&&(this.frame=0)},Ue.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(yi,{showable:!0,x:this.worldX,y:this.worldY})},Object.defineProperties(Ue,{ID:p.makeConstantDescriptor(3),width:p.makeConstantDescriptor(48),frames:p.makeConstantDescriptor(11)});var ud=Object.defineProperty,Fa=d((t,i)=>ud(t,"name",{value:i,configurable:!0}),"p$a");function Ge(t,i,s,n){this.init(ne,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,s<E.worldToPix(4)?this.frame=3:s>=E.worldToPix(t.width-4)?this.frame=7:n<E.worldToPix(4)?this.frame=5:n>=E.worldToPix(t.height-4)?this.frame=1:this.frame=3,this.newDir=this.frame,this.dir=10,this.count=1}d(Ge,"f$5"),Fa(Ge,"BoatSprite"),de(Ge);const pd=Fa(function(t,i,s){let n=i+4;return n>8&&(n-=8),s!==n?!1:t===_t||t===_t+1||t===Ft||t===Ft+1},"oppositeAndUnderwater"),fd=[0,0,1,1,1,0,-1,-1,-1],gd=[0,-1,-1,0,1,1,1,0,-1],md=[0,0,2,2,2,0,-2,-2,-2],_d=[0,-2,-2,0,2,2,2,0,-2],Ed=[f,H,_t,_t+1,Ft,Ft+1,Te,we],Td=10;Ge.prototype.move=function(t,i,s){let n=f,o,a,r;if(this.soundCount>0&&this.soundCount--,this.soundCount===0&&((u.getRandom16()&3)===1&&this._emitEvent(va),this.soundCount=200),this.count>0&&this.count--,this.count===0){if(this.count=9,this.frame!==this.newDir){this.frame=E.turnTo(this.frame,this.newDir);return}const l=u.getRandom16()&7;let h=l;for(;h<l+8;h++)if(o=(h&7)+1,o!==this.dir&&(a=this.worldX+fd[o],r=this.worldY+gd[o],this.map.testBounds(a,r)&&(n=this.map.getTileValue(a,r),n===H||n===Te||n===we||pd(n,this.dir,o)))){this.newDir=o,this.frame=E.turnTo(this.frame,this.newDir),this.dir=o+4,this.dir>8&&(this.dir-=8);break}h===l+8&&(this.dir=Td,this.newDir=(u.getRandom16()&7)+1)}else o=this.frame,o===this.newDir&&(this.x+=md[o],this.y+=_d[o]);if(this.spriteNotInBounds()){this.frame=0;return}for(let l=0;l<8&&n!==Ed[l];l++)l===7&&(this.explodeSprite(),E.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y))},Ge.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(Mi,{showable:!0,x:this.worldX,y:this.worldY})},Object.defineProperties(Ge,{ID:p.makeConstantDescriptor(4),width:p.makeConstantDescriptor(48),frames:p.makeConstantDescriptor(8)});var wd=Object.defineProperty,vd=d((t,i)=>wd(t,"name",{value:i,configurable:!0}),"f$4");function Ye(t,i,s,n){this.init($t,t,i,s,n),this.width=32,this.height=32,this.xOffset=-16,this.yOffset=-16,this.frame=5,this.count=1500,this.destX=u.getRandom(E.worldToPix(t.width))+8,this.destY=u.getRandom(E.worldToPix(t.height))+8,this.origX=s,this.origY=n}d(Ye,"r$d"),vd(Ye,"CopterSprite"),de(Ye);const Sd=[0,0,3,5,3,0,-3,-5,-3],yd=[0,-5,-3,0,3,5,3,0,-3];Ye.prototype.move=function(t,i,s){if(this.soundCount>0&&this.soundCount--,this.count>0&&this.count--,this.count===0){let o=this.spriteManager.getSprite($e);if(o!==null?(this.destX=o.x,this.destY=o.y):(o=this.spriteManager.getSprite(ci),o!==null?(this.destX=o.x,this.destY=o.y):(this.destX=this.origX,this.destY=this.origY)),E.absoluteDistance(this.x,this.y,this.origX,this.origY)<30){this.frame=0;return}}if(this.soundCount===0){const o=this.worldX,a=this.worldY;o>=0&&o<this.map.width&&a>=0&&a<this.map.height&&s.trafficDensityMap.worldGet(o,a)>170&&(u.getRandom16()&7)===0&&(this._emitEvent(Xt,{x:o,y:a}),this._emitEvent(wa),this.soundCount=200)}let n=this.frame;if((t&3)===0){const o=E.getDir(this.x,this.y,this.destX,this.destY);n=E.turnTo(n,o),this.frame=n}this.x+=Sd[n],this.y+=yd[n]},Ye.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(wi,{x:this.worldX,y:this.worldY})},Object.defineProperties(Ye,{ID:p.makeConstantDescriptor(2),width:p.makeConstantDescriptor(32),frames:p.makeConstantDescriptor(8)});var bd=Object.defineProperty,Dd=d((t,i)=>bd(t,"name",{value:i,configurable:!0}),"h$7");function ze(t,i,s,n){this.init(ss,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,this.frame=1}d(ze,"e$7"),Dd(ze,"ExplosionSprite"),de(ze),ze.prototype.startFire=function(t,i){if(t=this.worldX,i=this.worldY,!!this.map.testBounds(t,i)){var s=this.map.getTile(t,i),n=s.getValue();!s.isCombustible()&&n!==R||s.isZone()||this.map.setTo(t,i,T.randomFire())}},ze.prototype.move=function(t,i,s){if((t&1)===0){if(this.frame===1){var n=this.worldX,o=this.worldY;this._emitEvent(Ss),this._emitEvent(_i,{x:n,y:o})}this.frame++}this.frame>6&&(this.frame=0,this.startFire(this.x,this.y),this.startFire(this.x-16,this.y-16),this.startFire(this.x+16,this.y+16),this.startFire(this.x-16,this.y+16),this.startFire(this.x+16,this.y+16))},Object.defineProperties(ze,{ID:p.makeConstantDescriptor(7),width:p.makeConstantDescriptor(48),frames:p.makeConstantDescriptor(6)});var Od=Object.defineProperty,Cd=d((t,i)=>Od(t,"name",{value:i,configurable:!0}),"g$5");function Li(t,i,s,n){this.init($e,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,s>E.worldToPix(t.width)/2?n>E.worldToPix(t.height)/2?this.frame=10:this.frame=7:n>E.worldToPix(t.height)/2?this.frame=1:this.frame=4,this.flag=0,this.count=1e3,this.destX=E.worldToPix(t.pollutionMaxX),this.destY=E.worldToPix(t.pollutionMaxY),this.origX=this.x,this.origY=this.y,this._seenLand=!1}d(Li,"d$8"),Cd(Li,"MonsterSprite"),de(Li);const Rd=[2,2,-2,-2,0],Md=[-2,2,2,-2,0],$d=[0,1,2,3],Pd=[1,2,3,0],Ad=[2,5,8,11],Ld=[11,2,5,8];Li.prototype.move=function(t,i,s){this.soundCount>0&&this.soundCount--;let n=Math.floor((this.frame-1)/3),o,a;if(n<4){if(o=(this.frame-1)%3,o===2&&(this.step=0),o===0&&(this.step=1),this.step?o++:o--,E.absoluteDistance(this.x,this.y,this.destX,this.destY)<60)if(this.flag===0)this.flag=1,this.destX=this.origX,this.destY=this.origY;else{this.frame=0,this._emitEvent(ys);return}a=E.getDir(this.x,this.y,this.destX,this.destY),a=Math.floor((a-1)/2),a!==n&&u.getChance(10)&&(u.getRandom16()&1?o=$d[n]:o=Pd[n],n=4,this.soundCount||(this._emitEvent(Sa),this.soundCount=50+u.getRandom(100)))}else n=4,a=this.frame,o=a-13&3,u.getRandom16()&3||(u.getRandom16()&1?o=Ad[o]:o=Ld[o],n=Math.floor((o-1)/3),o=(o-1)%3);o=n*3+o+1,o>16&&(o=16),this.frame=o,this.x+=Rd[n],this.y+=Md[n],this.count>0&&this.count--;const r=E.getTileValue(this.map,this.x,this.y);(r===-1||r===f&&this.count<500)&&(this.frame=0),(r===R||r>Ee)&&(this._seenLand=!0);const l=this.spriteManager.getSpriteList();for(let h=0;h<l.length;h++){const c=l[h];c.frame!==0&&(c.type===Pt||c.type===$t||c.type===ne||c.type===Me)&&E.checkSpriteCollision(this,c)&&c.explodeSprite()}this.frame===0&&this._emitEvent(ys),E.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y),this._emitEvent(Ln,{x:this.worldX,y:this.worldY})},Object.defineProperties(Li,{ID:p.makeConstantDescriptor(5),width:p.makeConstantDescriptor(48),frames:p.makeConstantDescriptor(16)});var Id=Object.defineProperty,kd=d((t,i)=>Id(t,"name",{value:i,configurable:!0}),"p$9");function Ii(t,i,s,n){this.init(di.SPRITE_TORNADO,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-40,this.frame=1,this.count=200}d(Ii,"o$a"),kd(Ii,"TornadoSprite"),de(Ii);const xd=[2,3,2,0,-2,-3],Nd=[-2,0,2,3,2,0];Ii.prototype.move=function(t,i,s){let n=this.frame;n===2?this.flag?n=3:n=1:(n===1?this.flag=1:this.flag=0,n=2),this.count>0&&this.count--,this.frame=n;const o=this.spriteManager.getSpriteList();for(let a=0;a<o.length;a++){const r=o[a];r.frame!==0&&(r.type===di.SPRITE_AIRPLANE||r.type===di.SPRITE_HELICOPTER||r.type===di.SPRITE_SHIP||r.type===di.SPRITE_TRAIN)&&E.checkSpriteCollision(this,r)&&r.explodeSprite()}n=u.getRandom(5),this.x+=xd[n],this.y+=Nd[n],this.spriteNotInBounds()&&(this.frame=0),this.count!==0&&u.getRandom(500)===0&&(this.frame=0),this.frame===0&&this._emitEvent(ys),E.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y),this._emitEvent(Ln,{x:this.worldX,y:this.worldY})},Object.defineProperties(Ii,{ID:p.makeConstantDescriptor(6),width:p.makeConstantDescriptor(48),frames:p.makeConstantDescriptor(3)});var Vd=Object.defineProperty,Bd=d((t,i)=>Vd(t,"name",{value:i,configurable:!0}),"c$8");function Xe(t,i,s,n){this.init(Me,t,i,s,n),this.width=32,this.height=32,this.xOffset=-16,this.yOffset=-16,this.frame=1,this.dir=4}d(Xe,"e$6"),Bd(Xe,"TrainSprite"),de(Xe);const Fd=[0,16,0,-16],Hd=[-16,0,16,0],Wd=[0,4,0,-4,0],Ud=[-4,0,4,0,0],Ha=[1,2,1,2,5],Wa=3,Ua=4,Gd=5,Yd=3,$s=4;Xe.prototype.move=function(t,i,s){if((this.frame===Wa||this.frame===Ua)&&(this.frame=Ha[this.dir]),this.x+=Wd[this.dir],this.y+=Ud[this.dir],(t&3)===0){const n=u.getRandom16()&3;for(let o=n;o<n+4;o++){const a=o&3;if(this.dir!==$s&&a===(this.dir+2&3))continue;const r=E.getTileValue(this.map,this.x+Fd[a],this.y+Hd[a]);if(r>=Ft&&r<=co||r===ht||r===Z){this.dir!==a&&this.dir!==$s?this.dir+a===Yd?this.frame=Wa:this.frame=Ua:this.frame=Ha[a],(r===at||r===Bt)&&(this.frame=Gd),this.dir=a;return}}if(this.dir===$s){this.frame=0;return}this.dir=$s}},Xe.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(Pi,{showable:!0,x:this.worldX,y:this.worldY})},Object.defineProperties(Xe,{ID:p.makeConstantDescriptor(1),width:p.makeConstantDescriptor(32),frames:p.makeConstantDescriptor(5)});const Y=st(function(t){this.spriteList=[],this.map=t,this.spriteCycle=0});Y.prototype.getSprite=function(t){const i=this.spriteList.filter(function(s){return s.frame!==0&&s.type===t});return i.length===0?null:i[0]},Y.prototype.getSpriteList=function(){return this.spriteList.slice()},Y.prototype.getSpritesInView=function(t,i,s,n){t=E.worldToPix(t),i=E.worldToPix(i);const o=t+s,a=i+n;return this.spriteList.filter(function(r){const l=r.x+r.xOffset,h=r.y+r.yOffset,c=r.x+r.xOffset+r.width,g=r.y+r.yOffset+r.width,_=l>=t&&l<o,v=c>=t&&c<o,S=h>=i&&h<a,C=g>=i&&g<a;return(_||v)&&(S||C)})},Y.prototype.moveObjects=function(t){const i=t.disasterManager,s=t.blockMaps;this.spriteCycle+=1;const n=this.spriteList.slice();for(let o=0,a=n.length;o<a;o++){const r=n[o];r.frame!==0&&r.move(this.spriteCycle,i,s)}this.pruneDeadSprites()},Y.prototype.makeSprite=function(t,i,s){const n=new Zt[t](this.map,this,i,s);for(let o=0,a=le.length;o<a;o++)n.addEventListener(le[o],p.reflectEvent.bind(this,le[o]));return t==$t&&n.addEventListener(Xt,p.reflectEvent.bind(this,Xt)),this.spriteList.push(n),n},Y.prototype.makeTornado=function(){let t=this.getSprite(ci);if(t!==null){t.count=200,this._emitEvent(xe,{trackable:!0,x:t.worldX,y:t.worldY,sprite:t});return}const i=u.getRandom(E.worldToPix(this.map.width)-800)+400,s=u.getRandom(E.worldToPix(this.map.height)-200)+100;t=this.makeSprite(ci,i,s),this._emitEvent(xe,{trackable:!0,x:t.worldX,y:t.worldY,sprite:t})},Y.prototype.makeExplosion=function(t,i){this.map.testBounds(t,i)&&this.makeExplosionAt(E.worldToPix(t),E.worldToPix(i))},Y.prototype.makeExplosionAt=function(t,i){this.makeSprite(ss,t,i)},Y.prototype.generatePlane=function(t,i){this.getSprite(Pt)===null&&this.makeSprite(Pt,E.worldToPix(t),E.worldToPix(i))},Y.prototype.generateTrain=function(t,i,s){t.totalPop>10&&this.getSprite(Me)===null&&u.getRandom(25)===0&&this.makeSprite(Me,E.worldToPix(i)+8,E.worldToPix(s)+8)},Y.prototype.generateShip=function(){let t,i;if(u.getChance(3)){for(t=4;t<this.map.width-2;t++)if(this.map.getTileValue(t,0)===H){this.makeShipHere(t,0);return}}if(u.getChance(3)){for(i=1;i<this.map.height-2;i++)if(this.map.getTileValue(0,i)===H){this.makeShipHere(0,i);return}}if(u.getChance(3)){for(t=4;t<this.map.width-2;t++)if(this.map.getTileValue(t,this.map.height-1)===H){this.makeShipHere(t,this.map.height-1);return}}if(u.getChance(3)){for(i=1;i<this.map.height-2;i++)if(this.map.getTileValue(this.map.width-1,i)===H){this.makeShipHere(this.map.width-1,i);return}}},Y.prototype.getBoatDistance=function(t,i){let s=99999;const n=E.worldToPix(t)+8,o=E.worldToPix(i)+8;for(let a=0,r=this.spriteList.length;a<r;a++){const l=this.spriteList[a];if(l.type===ne&&l.frame!==0){const h=Math.abs(l.x-n)+Math.abs(l.y-o);s=Math.min(s,h)}}return s},Y.prototype.makeShipHere=function(t,i){this.makeSprite(ne,E.worldToPix(t),E.worldToPix(i))},Y.prototype.generateCopter=function(t,i){this.getSprite($t)===null&&this.makeSprite($t,E.worldToPix(t),E.worldToPix(i))},Y.prototype.makeMonsterAt=function(t,i){const s=this.makeSprite($e,E.worldToPix(t),E.worldToPix(i));this._emitEvent(vi,{trackable:!0,x:t,y:i,sprite:s})},Y.prototype.makeMonster=function(){const t=this.getSprite($e);t!==null&&(t.soundCount=1,t.count=1e3,t.destX=E.worldToPix(this.map.pollutionMaxX),t.destY=E.worldToPix(this.map.pollutionMaxY));let i=0;for(let s=0;s<300;s++){const n=u.getRandom(this.map.width-20)+10,o=u.getRandom(this.map.height-10)+5;if(this.map.getTile(n,o).getValue()===f){this.makeMonsterAt(n,o),i=1;break}}i===0&&this.makeMonsterAt(60,50)},Y.prototype.pruneDeadSprites=function(t){this.spriteList=this.spriteList.filter(function(i){return i.frame!==0})};var Zt={};Zt[Me]=Xe,Zt[ne]=Ge,Zt[$e]=Li,Zt[$t]=Ye,Zt[Pt]=Ue,Zt[ci]=Ii,Zt[ss]=ze;var zd=Object.defineProperty,Ga=d((t,i)=>zd(t,"name",{value:i,configurable:!0}),"d$5");const Xd=Ga(function(t,i,s,n){n.census.stadiumPop+=1,t.getTile(i,s).isPowered()&&(n.cityTime+i+s&31)===0&&(t.putZone(i,s,Eo,4),t.addTileFlags(i,s,Mt),t.setTile(i+1,s,an,j),t.setTile(i+1,s+1,ml,j))},"emptyStadiumFound"),jd=Ga(function(t,i,s,n){n.census.stadiumPop+=1;const o=t.getTile(i,s).isPowered();(n.cityTime+i+s&7)===0&&(t.putZone(i,s,Gt,4),o&&t.addTileFlags(i,s,Mt))},"fullStadiumFound"),Zd={registerHandlers:function(t,i){t.addAction(Gt,Xd),t.addAction(Eo,jd),i.addAction(Gt,15,4)}};var qd=Object.defineProperty,Bn=d((t,i)=>qd(t,"name",{value:i,configurable:!0}),"l$a");const Kd=Bn(function(t,i,s,n){if(n.census.railTotal+=1,n.spriteManager.generateTrain(n.census,i,s),n.budget.shouldDegradeRoad()&&u.getChance(511)){const o=t.getTile(i,s);if(o.isConductive())return;n.budget.roadEffect<(u.getRandom16()&31)&&(o.getValue()<Ft+2?t.setTile(i,s,f,0):t.setTo(i,s,T.randomRubble()))}},"railFound"),Qd=Bn(function(t,i,s,n){if(n.census.airportPop+=1,t.getTile(i,s).isPowered()){if(t.getTileValue(i+1,s-1)===go&&t.setTile(i+1,s-1,So,I|j|M),u.getRandom(5)===0){n.spriteManager.generatePlane(i,s);return}u.getRandom(12)===0&&n.spriteManager.generateCopter(i,s)}else t.setTile(i+1,s-1,go,I|M)},"airportFound"),Jd=Bn(function(t,i,s,n){n.census.seaportPop+=1,t.getTile(i,s).isPowered()&&n.spriteManager.getSprite(ne)===null&&n.spriteManager.generateShip()},"portFound"),tu={registerHandlers:function(t,i){t.addAction(T.isRail,Kd),t.addAction(se,Jd),t.addAction(V,Qd),i.addAction(se,15,4),i.addAction(V,7,6)}},Ps=st(function(){this.resValve=0,this.comValve=0,this.indValve=0,this.resCap=!1,this.comCap=!1,this.indCap=!1}),Ya=2e3,za=1500,Xa=1500,Fn=[200,150,120,100,80,50,30,0,-10,-40,-100,-150,-200,-250,-300,-350,-400,-450,-500,-550,-600],eu=[1.2,1.1,.98];Ps.prototype.save=function(t){t.resValve=this.resValve,t.comValve=this.comValve,t.indValve=this.indValve},Ps.prototype.load=function(t){this.resValve=t.resValve,this.comValve=t.comValve,this.indValve=t.indValve,this._emitEvent(Ne)},Ps.prototype.setValves=function(t,i,s){let n,o;const a=i.resPop/8;i.totalPop=Math.round(a+i.comPop+i.indPop),i.resPop>0?n=(i.comHist10[1]+i.indHist10[1])/a:n=1;const r=a*(n-1),l=a*.02,h=a+r+l;o=i.comHist10[1]+i.indHist10[1],o>0?o=i.resHist10[1]/o:o=1,o=p.clamp(o,0,1.3);const c=(a+i.comPop+i.indPop)/3.7*o;let g=i.indPop*o*eu[t];g=Math.max(g,5);let _;a>0?_=h/a:_=1.3;let v;i.comPop>0?v=c/i.comPop:v=c;let S;i.indPop>0?S=g/i.indPop:S=g,_=Math.min(_,2),v=Math.min(v,2),S=Math.min(S,2);const C=Math.min(s.cityTax+t,20);_=(_-1)*600+Fn[C],v=(v-1)*600+Fn[C],S=(S-1)*600+Fn[C],this.resValve=p.clamp(this.resValve+Math.round(_),-Ya,Ya),this.comValve=p.clamp(this.comValve+Math.round(v),-za,za),this.indValve=p.clamp(this.indValve+Math.round(S),-Xa,Xa),this.resCap&&this.resValve>0&&(this.resValve=0),this.comCap&&this.comValve>0&&(this.comValve=0),this.indCap&&this.indValve>0&&(this.indValve=0),this._emitEvent(Ne)};var iu=Object.defineProperty,su=d((t,i)=>iu(t,"name",{value:i,configurable:!0}),"l$9");const y=st(function(t,i,s,n){this._map=t,this.setLevel(i),this.setSpeed(s),this._phaseCycle=0,this._simCycle=0,this._cityTime=0,this._cityPopLast=0,this._messageLast=ma,this._startingYear=1,this._cityYearLast=-1,this._cityMonthLast=-1,this._lastPowerMessage=null,this.evaluation=new w(this._gameLevel),this._valves=new Ps,this.budget=new tt,this._census=new ce,this._powerManager=new jt(this._map),this.spriteManager=new Y(this._map),this._mapScanner=new Cs(this._map),this._repairManager=new Ai(this._map),this._traffic=new x(this._map,this.spriteManager),this.disasterManager=new pt(this._map,this.spriteManager,this._gameLevel),this.blockMaps={cityCentreDistScoreMap:new G(this._map.width,this._map.height,8),crimeRateMap:new G(this._map.width,this._map.height,2),fireStationMap:new G(this._map.width,this._map.height,8),fireStationEffectMap:new G(this._map.width,this._map.height,8),landValueMap:new G(this._map.width,this._map.height,2),policeStationMap:new G(this._map.width,this._map.height,8),policeStationEffectMap:new G(this._map.width,this._map.height,8),pollutionDensityMap:new G(this._map.width,this._map.height,2),populationDensityMap:new G(this._map.width,this._map.height,2),rateOfGrowthMap:new G(this._map.width,this._map.height,8),terrainDensityMap:new G(this._map.width,this._map.height,4),trafficDensityMap:new G(this._map.width,this._map.height,2),tempMap1:new G(this._map.width,this._map.height,2),tempMap2:new G(this._map.width,this._map.height,2),tempMap3:new G(this._map.width,this._map.height,4)},this._clearCensus(),n?this.load(n):(this.budget.setFunds(1e6),this._census.totalPop=1),this.init()});y.prototype.setLevel=function(t){if(t!==y.LEVEL_EASY&&t!==y.LEVEL_MED&&t!==y.LEVEL_HARD)throw new Error("Invalid level!");this._gameLevel=t},y.prototype.setSpeed=function(t){if(t!==y.SPEED_PAUSED&&t!==y.SPEED_SLOW&&t!==y.SPEED_MED&&t!==y.SPEED_FAST)throw new Error("Invalid speed!");this._speed=t},y.prototype.isPaused=function(){return this._speed===y.SPEED_PAUSED};const je=["_cityTime","_speed","_gameLevel"];y.prototype.save=function(t){for(let i=0,s=je.length;i<s;i++)t[je[i]]=this[je[i]];this._map.save(t),this.evaluation.save(t),this._valves.save(t),this.budget.save(t),this._census.save(t)},y.prototype.load=function(t){for(let i=0,s=je.length;i<s;i++)this[je[i]]=t[je[i]];this._map.load(t),this.evaluation.load(t),this._valves.load(t),this.budget.load(t),this._census.load(t)},y.prototype.simTick=function(){this._simFrame(),this._updateTime()},y.prototype._simFrame=function(){if(this.budget.awaitingValues)return;let t=100;switch(this._speed){case y.SPEED_PAUSED:return;case y.SPEED_SLOW:break;case y.SPEED_MED:t=50;break;case y.SPEED_FAST:t=10;break;default:console.warn("Unexpected speed ("+this._speed+"): defaulting to slow")}if(new Date().getTime()-this._lastTickTime<t)return;const i=this._constructSimData();this._simulate(i),this._lastTickTime=new Date().getTime()},y.prototype._clearCensus=function(){this._census.clearCensus(),this._powerManager.clearPowerStack(),this.blockMaps.fireStationMap.clear(),this.blockMaps.policeStationMap.clear()},y.prototype._constructSimData=function(){return{blockMaps:this.blockMaps,budget:this.budget,census:this._census,cityTime:this._cityTime,disasterManager:this.disasterManager,gameLevel:this._gameLevel,repairManager:this._repairManager,powerManager:this._powerManager,simulator:this,spriteManager:this.spriteManager,trafficManager:this._traffic,valves:this._valves}},y.prototype.init=function(){this._lastTickTime=-1;const t=["CLASSIFICATION_UPDATED","POPULATION_UPDATED","SCORE_UPDATED"].map(function(o){return ya[o]});for(var i=0,s=t.length;i<s;i++)this.evaluation.addEventListener(t[i],p.reflectEvent.bind(this,t[i]));for(this._powerManager.addEventListener(ke,function(o){const a=new Date;(this._lastPowerMessage===null||a-this._lastPowerMessage>1e3*60*2)&&(this._emitEvent(L,{subject:ke}),this._lastPowerMessage=a)}.bind(this)),this.budget.addEventListener(Ie,p.reflectEvent.bind(this,Ie)),this.budget.addEventListener(Le,p.reflectEvent.bind(this,Le)),this.budget.addEventListener(oe,this._wrapMessage.bind(this,oe)),this._valves.addEventListener(Ne,this._onValveChange.bind(this)),i=0,s=re.length;i<s;i++)this.spriteManager.addEventListener(re[i],this._wrapMessage.bind(this,re[i])),this.disasterManager.addEventListener(re[i],this._wrapMessage.bind(this,re[i]));for(i=0,s=le.length;i<s;i++)this.spriteManager.addEventListener(le[i],this._wrapMessage.bind(this,le[i]));this.spriteManager.addEventListener(Xt,this._wrapMessage.bind(this,Xt)),ia.registerHandlers(this._mapScanner,this._repairManager),Lc.registerHandlers(this._mapScanner,this._repairManager),aa.registerHandlers(this._mapScanner,this._repairManager),zc.registerHandlers(this._mapScanner,this._repairManager),this._powerManager.registerHandlers(this._mapScanner,this._repairManager),id.registerHandlers(this._mapScanner,this._repairManager),ca.registerHandlers(this._mapScanner,this._repairManager),Zd.registerHandlers(this._mapScanner,this._repairManager),tu.registerHandlers(this._mapScanner,this._repairManager);const n=this._constructSimData();this._mapScanner.mapScan(0,this._map.width,n),this._powerManager.doPowerScan(this._census),vt.pollutionTerrainLandValueScan(this._map,this._census,this.blockMaps),vt.crimeScan(this._census,this.blockMaps),vt.populationDensityScan(this._map,this.blockMaps),vt.fireAnalysis(this.blockMaps)};const nu=[2,4,5],ou=[2,7,17],au=[1,8,18],ru=[1,9,19],lu=[1,10,20],ja=4,hu=ja*10,cu=48,du=su(function(t){this._phaseCycle&=15;const i=this._speed-1;switch(this._phaseCycle){case 0:++this._simCycle>1023&&(this._simCycle=0),this._cityTime++,(this._simCycle&1)===0&&this._valves.setValves(this._gameLevel,this._census,this.budget),this._clearCensus();break;case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:this._mapScanner.mapScan((this._phaseCycle-1)*this._map.width/8,this._phaseCycle*this._map.width/8,t);break;case 9:this._cityTime%ja===0&&this._census.take10Census(this.budget),this._cityTime%hu===0&&this._census.take120Census(this.budget),this._cityTime%cu===0&&(this.budget.collectTax(this._gameLevel,this._census),this.evaluation.cityEvaluation(t));break;case 10:this._simCycle%5===0&&vt.neutraliseRateOfGrowthMap(t.blockMaps),vt.neutraliseTrafficMap(this.blockMaps),this._sendMessages();break;case 11:this._simCycle%nu[i]===0&&this._powerManager.doPowerScan(this._census);break;case 12:this._simCycle%ou[i]===0&&vt.pollutionTerrainLandValueScan(this._map,this._census,this.blockMaps);break;case 13:this._simCycle%au[i]===0&&vt.crimeScan(this._census,this.blockMaps);break;case 14:this._simCycle%ru[i]===0&&vt.populationDensityScan(this._map,this.blockMaps);break;case 15:this._simCycle%lu[i]===0&&vt.fireAnalysis(this.blockMaps),this.disasterManager.doDisasters(this._census);break}this._phaseCycle=this._phaseCycle+1&15},"simulate");y.prototype._simulate=function(t){this.evaluation.cityEvaluation(t),this._simulate=du,this._simulate(t)},y.prototype._wrapMessage=function(t,i){this._emitEvent(L,{subject:t,data:i})},y.prototype._sendMessages=function(){this._checkGrowth();const t=this._census.resZonePop+this._census.comZonePop+this._census.indZonePop,i=this._census.nuclearPowerPop+this._census.coalPowerPop;switch(this._cityTime&63){case 1:Math.floor(t/4)>=this._census.resZonePop&&this._emitEvent(L,{subject:gs});break;case 5:Math.floor(t/8)>=this._census.comZonePop&&this._emitEvent(L,{subject:us});break;case 10:Math.floor(t/8)>=this._census.indZonePop&&this._emitEvent(L,{subject:ps});break;case 14:t>10&&t*2>this._census.roadTotal&&this._emitEvent(L,{subject:ms});break;case 18:t>50&&t>this._census.railTotal&&this._emitEvent(L,{subject:fs});break;case 22:t>10&&i===0&&this._emitEvent(L,{subject:cs});break;case 26:this._census.resPop>500&&this._census.stadiumPop===0?(this._emitEvent(L,{subject:Ts}),this._valves.resCap=!0):this._valves.resCap=!1;break;case 28:this._census.indPop>70&&this._census.seaportPop===0?(this._emitEvent(L,{subject:Es}),this._valves.indCap=!0):this._valves.indCap=!1;break;case 30:this._census.comPop>100&&this._census.airportPop===0?(this._emitEvent(L,{subject:hs}),this._valves.comCap=!0):this._valves.comCap=!1;break;case 32:var s=this._census.unpoweredZoneCount+this._census.poweredZoneCount;if(s>0&&this._census.poweredZoneCount/s<.7&&i>0){const n=new Date;(this._lastPowerMessage===null||n-this._lastPowerMessage>1e3*60*2)&&(this._emitEvent(L,{subject:ns}),this._lastPowerMessage=n)}break;case 35:this._census.pollutionAverage>60&&this._emitEvent(L,{subject:ls,data:{x:this._map.pollutionMaxX,y:this._map.pollutionMaxY}});break;case 42:this._census.crimeAverage>100&&this._emitEvent(L,{subject:rs});break;case 45:this._census.totalPop>60&&this._census.fireStationPop===0&&this._emitEvent(L,{subject:ds});break;case 48:this._census.totalPop>60&&this._census.policeStationPop===0&&this._emitEvent(L,{subject:_s});break;case 51:this.budget.cityTax>12&&this._emitEvent(L,{subject:bs});break;case 54:this.budget.roadEffect<Math.floor(5*this.budget.MAX_ROAD_EFFECT/8)&&this._census.roadTotal>30&&this._emitEvent(L,{subject:vs});break;case 57:this.budget.fireEffect<Math.floor(7*this.budget.MAX_FIRE_STATION_EFFECT/10)&&this._census.totalPop>20&&this._emitEvent(L,{subject:as});break;case 60:this.budget.policeEffect<Math.floor(7*this.budget.MAX_POLICE_STATION_EFFECT/10)&&this._census.totalPop>20&&this._emitEvent(L,{subject:ws});break;case 63:this._census.trafficAverage>60&&this._emitEvent(L,{subject:Ds});break}},y.prototype._checkGrowth=function(){if((this._cityTime&3)!==0)return;let t="";const i=this.evaluation.getPopulation(this._census);if(i!==this._cityPopLast){const s=this.evaluation.getCityClass(this._cityPopLast),n=this.evaluation.getCityClass(i);if(s!==n)switch(n){case w.CC_VILLAGE:break;case w.CC_TOWN:t=Ri;break;case w.CC_CITY:t=Di;break;case w.CC_CAPITAL:t=bi;break;case w.CC_METROPOLIS:t=Oi;break;case w.CC_MEGALOPOLIS:t=Ci;break}}t!==""&&t!==this._messageLast&&(this._emitEvent(L,{subject:t}),this._messageLast=t),this._cityPopLast=i},y.prototype._onValveChange=function(){this._resLast=this._valves.resValve,this._comLast=this._valves.comValve,this._indLast=this._valves.indValve,this._emitEvent(Ne,{residential:this._valves.resValve,commercial:this._valves.comValve,industrial:this._valves.indValve})},y.prototype.getDate=function(){const t=Math.floor(this._cityTime/48)+this._startingYear;return{month:Math.floor(this._cityTime%48)>>2,year:t}},y.prototype._setYear=function(t){t<this._startingYear&&(t=this._startingYear),t=t-this._startingYear-this._cityTime/48,this._cityTime+=t*48,this._updateTime()},y.prototype._updateTime=function(){const t=Math.floor(this._cityTime/48)+this._startingYear,i=Math.floor(this._cityTime%48)>>2;if(t>=1e6){this.setYear(startingYear);return}(this._cityYearLast!==t||this._cityMonthLast!==i)&&(this._cityYearLast=t,this._cityMonthLast=i,this._emitEvent(os,{month:i,year:t}))},Object.defineProperties(y,{LEVEL_EASY:p.makeConstantDescriptor(0),LEVEL_MED:p.makeConstantDescriptor(1),LEVEL_HARD:p.makeConstantDescriptor(2),SPEED_PAUSED:p.makeConstantDescriptor(0),SPEED_SLOW:p.makeConstantDescriptor(1),SPEED_MED:p.makeConstantDescriptor(2),SPEED_FAST:p.makeConstantDescriptor(3)});var uu=Object.defineProperty,Hn=d((t,i)=>uu(t,"name",{value:i,configurable:!0}),"o$9");const pu=Hn(function(){let t=window.localStorage.getItem(this.KEY);return t!==null&&(t=JSON.parse(t),t.version!==this.CURRENT_VERSION&&this.transitionOldSave(t),t.isSavedGame=!0),t},"getSavedGame"),fu=Hn(function(t){t.version=this.CURRENT_VERSION,t=JSON.stringify(t),window.localStorage.setItem(this.KEY,t)},"saveGame"),gu=Hn(function(t){switch(t.version){case 1:t.everClicked=!1;case 2:t.pollutionMaxX=Math.floor(t.width/2),t.pollutionMaxY=Math.floor(t.height/2),t.cityCentreX=Math.floor(t.width/2),t.cityCentreY=Math.floor(t.height/2);break;default:throw new Error("Unknown save version!")}},"transitionOldSave"),ue={getSavedGame:pu,saveGame:fu,transitionOldSave:gu};Object.defineProperty(ue,"CURRENT_VERSION",p.makeConstantDescriptor(3)),Object.defineProperty(ue,"KEY",p.makeConstantDescriptor("micropolisJSGame")),Object.defineProperty(ue,"canStore",p.makeConstantDescriptor(window.localStorage!==void 0));var mu=Object.defineProperty,Wn=d((t,i)=>mu(t,"name",{value:i,configurable:!0}),"r$c");function pe(t){this._map=t,this._data={}}d(pe,"o$8"),Wn(pe,"WorldEffects");const Za=Wn(function(t,i){return[t,i].join(",")},"toKey"),_u=Wn(function(t){return t=t.split(","),{x:t[0]-0,y:t[1]-0,toString:function(){return"World effect coord: ("+t[0]+", "+t[1]+")"}}},"fromKey");pe.prototype.clear=function(){this._data=[]},pe.prototype.getTile=function(t,i){const s=Za(t,i);let n=this._data[s];return n===void 0&&(n=this._map.getTile(t,i)),n},pe.prototype.getTileValue=function(t,i){return this.getTile(t,i).getValue()},pe.prototype.setTile=function(t,i,s,n){if(n!==void 0&&s instanceof U)throw new Error("Flags supplied with already defined tile");if(!this._map.testBounds(t,i))throw new Error("WorldEffects setTile called with invalid bounds "+t+", "+i);n===void 0&&!(s instanceof U)?s=new U(s):n!==void 0&&(s=new U(s,n));const o=Za(t,i);this._data[o]=s},pe.prototype.apply=function(){const t=Object.keys(this._data);for(let i=0,s=t.length;i<s;i++){const n=_u(t[i]);this._map.setTo(n,this._data[t[i]])}};var Eu=Object.defineProperty,At=d((t,i)=>Eu(t,"name",{value:i,configurable:!0}),"o$7");const Tu=At(function(t,i,s,n){n=n||!1,Object.defineProperty(this,"toolCost",p.makeConstantDescriptor(t)),this.result=null,this.isDraggable=n,this._shouldAutoBulldoze=s,this._map=i,this._worldEffects=new pe(i),this._applicationCost=0},"init"),wu=At(function(){this._applicationCost=0,this._worldEffects.clear()},"clear"),vu=At(function(t){this._applicationCost+=t},"addCost"),Su=At(function(t,i){let s=this._worldEffects.getTile(t,i);s.isBulldozable()&&(s=T.normalizeRoad(s.getValue()),(s>=oi&&s<=Yi||s<nt&&s!==R)&&(this.addCost(1),this._worldEffects.setTile(t,i,R)))},"doAutoBulldoze"),yu=At(function(t){this._worldEffects.apply(),t.spend(this._applicationCost),this.clear()},"apply"),bu=At(function(t){return this.result!==this.TOOLRESULT_OK?(this.clear(),!1):t.totalFunds<this._applicationCost?(this.result=this.TOOLRESULT_NO_MONEY,this.clear(),!1):(yu.call(this,t),this.clear(),!0)},"modifyIfEnoughFunding"),Du=0,Ou=1,Cu=2,Ru=3,As={addCost:vu,autoBulldoze:!0,bulldozerCost:1,clear:wu,doAutoBulldoze:Su,init:Tu,modifyIfEnoughFunding:bu,TOOLRESULT_OK:Du,TOOLRESULT_FAILED:Ou,TOOLRESULT_NO_MONEY:Cu,TOOLRESULT_NEEDS_BULLDOZE:Ru},qt={makeTool:Qa,setAutoBulldoze:function(t){As.autoBulldoze=t},getAutoBulldoze:function(){return As.autoBulldoze},save:qa,load:Ka};function qa(t){t.autoBulldoze=As.autoBulldoze}d(qa,"U"),At(qa,"save");function Ka(t){qt.autoBulldoze=t.autoBulldoze}d(Ka,"S$3"),At(Ka,"load");function Qa(t){return t.prototype=Object.create(As),t}d(Qa,"N$2"),At(Qa,"makeTool");var Mu=Object.defineProperty,Ja=d((t,i)=>Mu(t,"name",{value:i,configurable:!0}),"l$7");const yt=Ja(function(t,i){i=i?p.normaliseDOMid(i):null;const s=Ja(function(n,o){this._opacityLayer=p.normaliseDOMid(n),this._windowID=p.normaliseDOMid(o),t.call(this)},"newConstructor");return s.prototype._toggleDisplay=function(){let n=$(this._opacityLayer);if(n=n.length===0?null:n,n===null)throw new Error("Node "+this._opacityLayer+" not found");let o=$(this._windowID);if(o=o.length===0?null:o,o===null)throw new Error("Node "+this._windowID+" not found");n.toggle(),o.toggle(),i!==null?$(i).focus():$(this._windowID+" input[type=submit]").focus()},st(s)},"ModalWindow");var $u=Object.defineProperty,Ze=d((t,i)=>$u(t,"name",{value:i,configurable:!0}),"s$a"),Un=yt(function(){$(Au).on("click",xu.bind(this)),$(Pu).on("click",ku.bind(this)),$(Lu).on("submit",Nu.bind(this))}),fe=["roadMaintenanceBudget","fireMaintenanceBudget","policeMaintenanceBudget"],ft=["roadRate","fireRate","policeRate"],Pu="#budgetReset",Au="#budgetCancel",Lu="#budgetForm",Gn=Ze(function(t,i,s){var n=t+"Label",o=Math.floor(s*(i/100)),a=[i,"% of $",s," = $",o].join("");$(p.normaliseDOMid(n)).text(a)},"setSpendRangeText"),Iu=Ze(function(t,i){var s=$(p.normaliseDOMid(t))[0],n=s.value-0,o=s.getAttribute("data-source");Gn(t,n,this[o])},"onFundingUpdate"),Yn=Ze(function(t){var i=$("#taxRateLabel")[0],s=$("#taxRate")[0];$(i).text(["Tax rate: ",s.value,"%"].join(""))},"onTaxUpdate"),ku=Ze(function(t){for(var i=0;i<ft.length;i++){var s=this["original"+ft[i]];$(p.normaliseDOMid(ft[i]))[0].value=s,Gn(ft[i],s,this[fe[i]])}$("#taxRate")[0].value=this.originaltaxRate,Yn(),t.preventDefault()},"resetItems");Un.prototype.close=function(t){t=t||{cancelled:!0},this._emitEvent(Tn,t),this._toggleDisplay()};var xu=Ze(function(t){t.preventDefault(),this.close({cancelled:!0})},"cancel"),Nu=Ze(function(t){t.preventDefault();var i=$("#roadRate")[0].value,s=$("#fireRate")[0].value,n=$("#policeRate")[0].value,o=$("#taxRate")[0].value,a={cancelled:!1,roadPercent:i,firePercent:s,policePercent:n,taxPercent:o,e:t,original:t.type};this.close(a)},"submit");Un.prototype.open=function(t){var i,s;for(i=0;i<fe.length;i++){if(t[fe[i]]===void 0)throw new Error("Missing budget data ("+fe[i]+")");this[fe[i]]=t[fe[i]]}for(i=0;i<ft.length;i++){if(t[ft[i]]===void 0)throw new Error("Missing budget data ("+ft[i]+")");s=ft[i],this["original"+s]=t[s],Gn(s,t[ft[i]],this[fe[i]]),s=$(p.normaliseDOMid(s)),s.on("change",Iu.bind(this,ft[i])),s=s[0],s.value=t[ft[i]]}if(t.taxRate===void 0)throw new Error("Missing budget data (taxRate)");this.originalTaxRate=t.taxRate,s=$("#taxRate"),s.on("change",Yn),s=s[0],s.value=t.taxRate,Yn();var n=t.totalFunds;if(n===void 0)throw new Error("Missing budget data (previousFunds)");var o=t.taxesCollected;if(o===void 0)throw new Error("Missing budget data (taxesCollected)");var a=o-this.roadMaintenanceBudget-this.fireMaintenanceBudget-this.policeMaintenanceBudget,r=n+a;$("#taxesCollected").text("$"+o),$("#cashFlow").text((a<0?"-$":"$")+a),$("#previousFunds").text((n<0?"-$":"$")+n),$("#currentFunds").text("$"+r),this._toggleDisplay()};var Vu=Object.defineProperty,tr=d((t,i)=>Vu(t,"name",{value:i,configurable:!0}),"n$b");const qe=yt(function(){$(Bu).on("click",Hu.bind(this)),$(Fu).on("submit",Wu.bind(this))});var Bu="#debugCancel",Fu="#debugForm";qe.prototype.close=function(t){t=t||[],this._emitEvent(vn,t),this._toggleDisplay()};var Hu=tr(function(t){t.preventDefault(),this.close([])},"cancel"),Wu=tr(function(t){t.preventDefault();const i=[];$(".debugAdd:checked").val()==="true"&&i.push({action:qe.ADD_FUNDS,data:{}}),this.close(i)},"submit");qe.prototype.open=function(){this._toggleDisplay()},function(){let t=0;return function(i){Object.defineProperty(qe,i,p.makeConstantDescriptor(t)),t+=1}}()("ADD_FUNDS");var Uu=Object.defineProperty,er=d((t,i)=>Uu(t,"name",{value:i,configurable:!0}),"a$9"),ir="#disasterSelect",Gu="#disasterCancel",Yu="#disasterForm",W=yt(function(){$(Yu).on("submit",Xu.bind(this)),$(Gu).on("click",zu.bind(this))},ir);W.prototype.close=function(t){t=t||W.DISASTER_NONE,this._toggleDisplay(),this._emitEvent(Sn,t)};var zu=er(function(t){t.preventDefault(),this.close()},"cancel"),Xu=er(function(t){t.preventDefault();var i=$(ir)[0].value;this.close(i)},"submit");W.prototype.open=function(){$("#disasterNone").attr("value",W.DISASTER_NONE),$("#disasterMonster").attr("value",W.DISASTER_MONSTER),$("#disasterFire").attr("value",W.DISASTER_FIRE),$("#disasterFlood").attr("value",W.DISASTER_FLOOD),$("#disasterCrash").attr("value",W.DISASTER_CRASH),$("#disasterMeltdown").attr("value",W.DISASTER_MELTDOWN),$("#disasterTornado").attr("value",W.DISASTER_TORNADO),this._toggleDisplay()},Object.defineProperties(W,{DISASTER_NONE:p.makeConstantDescriptor("None"),DISASTER_MONSTER:p.makeConstantDescriptor("Monster"),DISASTER_FIRE:p.makeConstantDescriptor("Fire"),DISASTER_FLOOD:p.makeConstantDescriptor("Flood"),DISASTER_CRASH:p.makeConstantDescriptor("Crash"),DISASTER_MELTDOWN:p.makeConstantDescriptor("Meltdown"),DISASTER_TORNADO:p.makeConstantDescriptor("Tornado")});const ju=["Low","Medium","High","Very High"],Zu=["Slum","Lower Class","Middle Class","High"],qu=["Safe","Light","Moderate","Dangerous"],Ku=["None","Moderate","Heavy","Very Heavy"],Qu=["Declining","Stable","Slow Growth","Fast Growth"],Ju=["Clear","Water","Trees","Rubble","Flood","Radioactive Waste","Fire","Road","Power","Rail","Residential","Commercial","Industrial","Seaport","Airport","Coal Power","Fire Department","Police Department","Stadium","Nuclear Power","Draw Bridge","Radar Dish","Fountain","Industrial","Steelers 38  Bears 3","Draw Bridge","Ur 238"],Ls={};Ls[""+y.LEVEL_EASY]="Easy",Ls[""+y.LEVEL_MED]="Medium",Ls[""+y.LEVEL_HARD]="Hard";const ge={};ge[w.CC_VILLAGE]="VILLAGE",ge[w.CC_TOWN]="TOWN",ge[w.CC_CITY]="CITY",ge[w.CC_CAPITAL]="CAPITAL",ge[w.CC_METROPOLIS]="METROPOLIS",ge[w.CC_MEGALOPOLIS]="MEGALOPOLIS";const Kt={};Kt[w.CRIME]="Crime",Kt[w.POLLUTION]="Pollution",Kt[w.HOUSING]="Housing",Kt[w.TAXES]="Taxes",Kt[w.TRAFFIC]="Traffic",Kt[w.UNEMPLOYMENT]="Unemployment",Kt[w.FIRE]="Fire";const tp=["January","February","March","April","May","June","July","August","September","October","November","December"],ep={noMoney:"Insufficient funds to build that",needsDoze:"Area must be bulldozed first"},q={};q[as]=!0,q[hs]=!0,q[ds]=!0,q[cs]=!0,q[ps]=!0,q[us]=!0,q[gs]=!0,q[fs]=!0,q[ms]=!0,q[_s]=!0,q[Es]=!0,q[Ts]=!0,q[vs]=!0,q[ws]=!0,q[kn]=!0;const F={};F[ns]=!0,F[mi]=!0,F[_i]=!0,F[Ti]=!0,F[Ei]=!0,F[Xt]=!0,F[wi]=!0,F[rs]=!0,F[ls]=!0,F[vi]=!0,F[oe]=!0,F[ke]=!0,F[Si]=!0,F[yi]=!0,F[Mi]=!0,F[bs]=!0,F[xe]=!0,F[Ds]=!0,F[Pi]=!0;const Ke={};Ke[bi]=!0,Ke[Di]=!0,Ke[Ci]=!0,Ke[Oi]=!0,Ke[Ri]=!0;const b={};b[as]="Fire departments need funding",b[hs]="Commerce requires an Airport",b[ds]="Citizens demand a Fire Department",b[cs]="Build a Power Plant",b[ps]="More industrial zones needed",b[us]="More commercial zones needed",b[gs]="More residential zones needed",b[fs]="Inadequate rail system",b[ms]="More roads required",b[_s]="Citizens demand a Police Department",b[Es]="Industry requires a Sea Port",b[Ts]="Residents demand a Stadium",b[vs]="Roads deteriorating, due to lack of funds",b[ws]="Police departments need funding",b[kn]="Welcome to micropolisJS",b[ns]="Brownouts, build another Power Plant",b[mi]="Major earthquake reported !!",b[_i]="Explosion detected ",b[Ti]="Flooding reported !",b[Ei]="Fire reported ",b[Xt]="Heavy traffic reported",b[wi]="A helicopter crashed ",b[rs]="Crime very high",b[ls]="Pollution very high",b[vi]="A Monster has been sighted !",b[oe]="YOUR CITY HAS GONE BROKE",b[ke]="Blackouts reported: insufficient power capacity",b[Si]="A Nuclear Meltdown has occurred !!",b[yi]="A plane has crashed ",b[Mi]="Shipwreck reported ",b[bs]="Citizens upset. The tax rate is too high",b[xe]="Tornado reported !",b[Ds]="Frequent traffic jams reported",b[Pi]="A train crashed ",b[bi]="Population has reached 50,000",b[Di]="Population has reached 10,000",b[Ci]="Population has reached 500,000",b[Oi]="Population has reached 100,000",b[Ri]="Population has reached 2,000";const z={badMessages:F,cityClass:ge,crimeStrings:qu,densityStrings:ju,gameLevel:Ls,goodMessages:Ke,landValueStrings:Zu,messageText:b,months:tp,neutralMessages:q,problems:Kt,pollutionStrings:Ku,rateStrings:Qu,toolMessages:ep,zoneTypes:Ju};var ip=Object.defineProperty,sp=d((t,i)=>ip(t,"name",{value:i,configurable:!0}),"s$7"),Is=yt(function(){$(np).on("submit",op.bind(this))}),np="#evalButtons";Is.prototype.close=function(){this._emitEvent(yn),this._toggleDisplay()};var op=sp(function(t){t.preventDefault(),this.close()},"submit");Is.prototype._populateWindow=function(t){$("#evalYes").text(t.cityYes),$("#evalNo").text(100-t.cityYes);for(var i=0;i<4;i++){var s=t.getProblemNumber(i);if(s!==null){var n=z.problems[s];$("#evalProb"+(i+1)).text(n),$("#evalProb"+(i+1)).show()}else $("#evalProb"+(i+1)).hide()}$("#evalPopulation").text(t.cityPop),$("#evalMigration").text(t.cityPopDelta),$("#evalValue").text(t.cityAssessedValue),$("#evalLevel").text(z.gameLevel[t.gameLevel]),$("#evalClass").text(z.cityClass[t.cityClass]),$("#evalScore").text(t.cityScore),$("#evalScoreDelta").text(t.cityScoreDelta)},Is.prototype.open=function(t){this._populateWindow(t),this._toggleDisplay()};var ap=Object.defineProperty,sr=d((t,i)=>ap(t,"name",{value:i,configurable:!0}),"i$6");function ki(){this.clear()}d(ki,"e$4"),sr(ki,"TileHistory");const nr=sr(function(t,i){return[t,i].join(",")},"toKey");ki.prototype.clear=function(){this.data={}},ki.prototype.getTile=function(t,i){const s=nr(t,i);return this.data[s]},ki.prototype.setTile=function(t,i,s){const n=nr(t,i);this.data[n]=s};var rp=Object.defineProperty,lp=d((t,i)=>rp(t,"name",{value:i,configurable:!0}),"B$1");class ks{constructor(i,s,n){s=s||240,n=n||600,this._map=i,this.animationPeriod=s,this.lastAnimation=new Date(1970,1,1),this.lastBlink=new Date(1970,1,1),this.blinkPeriod=n,this.shouldBlink=!1,this._lastPainted=null,this._currentPainted=null,this._data=[],this.initArray(),this.registerAnimations()}initArray(){for(let i=0;i<zi;i++)this._data[i]=i}inSequence(i,s){const n=[i];let o=this._data[i];for(;n.indexOf(o)===-1;){if(o===s)return!0;n.push(o),o=this._data[o]}return!1}getTiles(i,s,n,o,a,r){r=r||!1;let l=!1;const h=new Date;let c=this.shouldBlink;h-this.lastBlink>this.blinkPeriod&&(c=this.shouldBlink=!this.shouldBlink,this.lastBlink=h),r||h-this.lastAnimation>this.animationPeriod&&(l=!0,this.lastAnimation=h);const g=this._currentPainted===null?new ki:this._currentPainted;for(let S=0;S<a;S++)for(let C=0;C<o;C++){const A=C+s,ee=S+n,kt=S*o+C;if(A<0||A>=this._map.width||ee<0||ee>=this._map.height)continue;const xt=i[kt];if(xt===Yt)continue;if(c&&xt&be&&!(xt&Mt)){i[kt]=pl;continue}if(!(xt&j)){i[kt]=xt&es;continue}const K=xt&es;let bt=Yt;var _;if(this._lastPainted&&(_=this._lastPainted.getTile(C,S)),l?_&&this.inSequence(K,_)?_===Yi?(this._map.setTo(A,ee,T.randomRubble()),bt=this._map.getTileValue(A,ee)):bt=this._data[_]:bt=this._data[K]:_&&this.inSequence(K,_)&&(bt=_),bt===Yt){i[kt]=K;continue}i[kt]=bt,g.setTile(C,S,bt)}const v=this._lastPainted;this._lastPainted=g,v!==null&&v.clear(),this._currentPainted=v}registerSingleAnimation(i){for(let s=1;s<i.length;s++)this._data[i[s-1]]=i[s]}registerAnimations(){this.registerSingleAnimation([56,57,58,59,60,61,62,63,56]),this.registerSingleAnimation([80,128,112,96,80]),this.registerSingleAnimation([81,129,113,97,81]),this.registerSingleAnimation([82,130,114,98,82]),this.registerSingleAnimation([83,131,115,99,83]),this.registerSingleAnimation([84,132,116,100,84]),this.registerSingleAnimation([85,133,117,101,85]),this.registerSingleAnimation([86,134,118,102,86]),this.registerSingleAnimation([87,135,119,103,87]),this.registerSingleAnimation([88,136,120,104,88]),this.registerSingleAnimation([89,137,121,105,89]),this.registerSingleAnimation([90,138,122,106,90]),this.registerSingleAnimation([91,139,123,107,91]),this.registerSingleAnimation([92,140,124,108,92]),this.registerSingleAnimation([93,141,125,109,93]),this.registerSingleAnimation([94,142,126,110,94]),this.registerSingleAnimation([95,143,127,111,95]),this.registerSingleAnimation([144,192,176,160,144]),this.registerSingleAnimation([145,193,177,161,145]),this.registerSingleAnimation([146,194,178,162,146]),this.registerSingleAnimation([147,195,179,163,147]),this.registerSingleAnimation([148,196,180,164,148]),this.registerSingleAnimation([149,197,181,165,149]),this.registerSingleAnimation([150,198,182,166,150]),this.registerSingleAnimation([151,199,183,167,151]),this.registerSingleAnimation([152,200,184,168,152]),this.registerSingleAnimation([153,201,185,169,153]),this.registerSingleAnimation([154,202,186,170,154]),this.registerSingleAnimation([155,203,187,171,155]),this.registerSingleAnimation([156,204,188,172,156]),this.registerSingleAnimation([157,205,189,173,157]),this.registerSingleAnimation([158,206,190,174,158]),this.registerSingleAnimation([159,207,191,175,159]),this.registerSingleAnimation([621,852,853,854,855,856,857,858,859,852]),this.registerSingleAnimation([641,884,885,886,887,884]),this.registerSingleAnimation([644,888,889,890,891,888]),this.registerSingleAnimation([649,892,893,894,895,892]),this.registerSingleAnimation([650,896,897,898,899,896]),this.registerSingleAnimation([676,900,901,902,903,900]),this.registerSingleAnimation([677,904,905,906,907,904]),this.registerSingleAnimation([686,908,909,910,911,908]),this.registerSingleAnimation([689,912,913,914,915,912]),this.registerSingleAnimation([747,916,917,918,919,916]),this.registerSingleAnimation([748,920,921,922,923,920]),this.registerSingleAnimation([751,924,925,926,927,924]),this.registerSingleAnimation([752,928,929,930,931,928]),this.registerSingleAnimation([820,952,953,954,955,952]),this.registerSingleAnimation([832,833,834,835,836,837,838,839,832]),this.registerSingleAnimation([840,841,842,843,840]),this.registerSingleAnimation([844,845,846,847,848,849,850,851,844]),this.registerSingleAnimation([860,861,862,863,864,865,866,867]),this.registerSingleAnimation([932,933,934,935,936,937,938,939,932]),this.registerSingleAnimation([940,941,942,943,944,945,946,947,940])}}d(ks,"P"),lp(ks,"AnimationManager");const hp={draw:function(t,i,s,n,o){const a=o.lineWidth||3,r=o.colour||"yellow",l="outline"in o&&o.outline===!0||!1;let h=-1,c=1;l||(h=1,c=-1);const g=i.x+h*a/2;s=s+c*a;const _=i.y+h*a/2;n=n+c*a;const v=t.getContext("2d");v.lineWidth=a,v.strokeStyle=r,v.strokeRect(g,_,s,n)}};var cp=Object.defineProperty,dp=d((t,i)=>cp(t,"name",{value:i,configurable:!0}),"T$3");const or=d(class{constructor(t,i,s=1.4){if(arguments.length<1)throw new Error("Attempt to construct a GameCanvas with no parameters");if(i===void 0&&(i=t,t=or.DEFAULT_ID),typeof i=="string"){const a=i;if(i=$(p.normaliseDOMid(i)),i=i.length===0?null:i[0],i===null)throw new Error("Node "+a+" not found")}this.zoomRatio=s,this._canvas=document.createElement("canvas"),this._canvas.id=t,this.ctx=this._canvas.getContext("2d");const n=i.getBoundingClientRect();this._canvas.width=n.width,this._canvas.height=n.height,this._canvas.style.margin="0",this._canvas.style.padding="0",this._canvas.style.transform=`scale(${s})`,this._canvas.style.imageRendering="pixelated",this._pendingTileSet=null;const o=document.getElementById(t);if(o!==null)if(o.parentNode===i)i.replaceChild(this._canvas,o);else throw new Error("ID "+t+" already exists in document!");else i.appendChild(this._canvas);this.ready=!1}init(t,i,s,n){if(n=n||new ks(t),arguments.length<3)throw new Error("GameCanvas constructor called with too few arguments "+[].toString.apply(arguments));if(!i.isValid)throw new Error("TileSet not ready!");this._spriteSheet=s,this._tileSet=i;const o=this._tileSet.tileWidth;if(this._map=t,this.animationManager=new ks(t),this._canvas.width<o||this._canvas.height<o)throw new Error("Canvas too small!");this._allowScrolling=!0,this._lastPaintedTiles=null,this._currentPaintedTiles=[],this._lastPaintedWidth=-1,this._lastPaintedHeight=-1,this._lastCanvasWidth=-1,this._lastCanvasHeight=-1,this._lastCanvasData=null,this._calculateDimensions(),this._pendingDimensionChange=!1;const a=function(r){this._pendingDimensionChange=!0}.bind(this);window.addEventListener("resize",a,!1),this.ready=!0,this.centreOn(Math.floor(this._map.width/2),Math.floor(this._map.height/2)),this.paint(null,null)}_calculateDimensions(t){t=t||!1;const i=this.canvasWidth=this._canvas.parentNode.clientWidth,s=this.canvasHeight=this._canvas.parentNode.clientHeight;if(s===this._lastCanvasHeight&&i===this._lastCanvasWidth&&!t)return;this._canvas.width=i,this._canvas.height=s;const n=this._tileSet.tileWidth;this._wholeTilesInViewX=Math.floor(i/n),this._wholeTilesInViewY=Math.floor(s/n),this._totalTilesInViewX=Math.ceil(i/n),this._totalTilesInViewY=Math.ceil(s/n),this._allowScrolling?(this.minX=0,this.maxX=this._map.width-1-Math.ceil(Math.floor(i/n)/2)-Math.floor(Math.floor(i/(n*this.zoomRatio))/2),this.minY=0,this.maxY=this._map.height-1-Math.ceil(Math.floor(s/n)/2)-Math.floor(Math.floor(s/(n*this.zoomRatio))/2)):(this.minX=0,this.minY=0,this.maxX=this._map.width-this._totalTilesInViewX,this.maxY=this._map.height-this._totalTilesInViewY),this._pendingDimensionChange=!0}disallowOffMap(){this._allowScrolling=!1,this._lastPaintedTiles=null,this._calculateDimensions(!0)}moveNorth(){!this.ready||this._originY>this.minY&&this._originY--}moveEast(){!this.ready||this._originX<this.maxX&&this._originX++}moveSouth(){!this.ready||this._originY<this.maxY&&this._originY++}moveWest(){!this.ready||this._originX>this.minX&&this._originX--}moveTo(t,i){if(arguments.length<1)throw new Error("GameCanvas moveTo called with no arguments");if(this.ready){if(t<this.minX||t>this.maxX||i<this.minY||i>this.maxY)throw new Error("Coordinates out of bounds");this._originX=t,this._originY=i}}centreOn(t,i){if(arguments.length<1)throw new Error("GameCanvas centreOn called with no arguments");if(!this.ready)throw new Error("Not ready!");i===void 0&&(i=t.y,t=t.x);let s=Math.floor(t)-Math.ceil(this._wholeTilesInViewX/2),n=Math.floor(i)-Math.ceil(this._wholeTilesInViewY/2);s>this.maxX&&(s=this.maxX),s<this.minX&&(s=this.minX),n>this.maxY&&(n=this.maxY),n<this.minY&&(n=this.minY),this._originX=s,this._originY=n}getTileOrigin(){const t=new Error("Not ready!");if(!this.ready)throw t;return{x:this._originX,y:this._originY}}getMaxTile(){const t=new Error("Not ready!");if(!this.ready)throw t;return{x:this._originX+this._totalTilesInViewX-1,y:this._originY+this._totalTilesInViewY-1}}canvasCoordinateToTileOffset(t,i){if(arguments.length<2)throw new Error("GameCanvas canvasCoordinateToTileOffset called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");return{x:Math.floor(t/this._tileSet.tileWidth/this.zoomRatio),y:Math.floor(i/this._tileSet.tileWidth/this.zoomRatio)}}canvasCoordinateToTileCoordinate(t,i){if(arguments.length<2)throw new Error("GameCanvas canvasCoordinateToTileCoordinate called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");const s=this.canvasWidth*this.zoomRatio,n=this.canvasHeight*this.zoomRatio;if(t>=s||i>=n)return null;const o=this._originX+Math.floor(t/this._tileSet.tileWidth/this.zoomRatio),a=this._originY+Math.floor(i/this._tileSet.tileWidth/this.zoomRatio);return console.log([t,i],[o,a]),{x:o,y:a}}canvasCoordinateToPosition(t,i){if(arguments.length<2)throw new Error("GameCanvas canvasCoordinateToPosition called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");const s=this.canvasWidth*this.zoomRatio,n=this.canvasHeight*this.zoomRatio;return t>=s||i>=n||(t=this._originX+Math.floor(t/this._tileSet.tileWidth/this.zoomRatio),i=this._originY+Math.floor(i/this._tileSet.tileWidth/this.zoomRatio),t<0||t>=this._map.width||i<0||i>=this._map.height)?null:new O(t,i)}positionToCanvasCoordinate(t){if(arguments.length<1)throw new Error("GameCanvas positionToCanvasCoordinate called with too few arguments "+[].toString.apply(arguments));return this.tileToCanvasCoordinate(t)}tileToCanvasCoordinate(t,i){if(arguments.length<1)throw new Error("GameCanvas tileToCanvasCoordinate  called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");if(i===void 0&&(i=t.y,t=t.x),t===void 0||i===void 0||t<this.minX||i<this.minY||t>this.maxX+this._totalTilesInViewX-1||i>this.maxY+this._totalTilesInViewY-1)throw e;return t<this._originX||t>=this._originX+this._totalTilesInViewX||i<this._originY||i>=this._originY+this._totalTilesInViewY?null:{x:(t-this._originX)*this._tileSet.tileWidth*this.zoomRatio,y:(i-this._originY)*this._tileSet.tileWidth*this.zoomRatio}}changeTileSet(t){if(!this.ready)throw new Error("Not ready!");if(!t.isValid)throw new Error("new tileset not loaded");this._pendingTileSet=t}_screenshot(t){if(t)return this._canvas.toDataURL();const i=document.createElement("canvas");i.width=this._map.width*this._tileSet.tileWidth,i.height=this._map.height*this._tileSet.tileWidth;for(let s=0;s<this._map.width;s++)for(let n=0;n<this._map.height;n++)this._paintOne(this.ctx,this._map.getTileValue(s,n),s,n);return i.toDataURL()}screenshotMap(){return this._screenshot(!1)}screenshotVisible(){return this._screenshot(!0)}shoogle(){}_processSprites(t,i){const s=[],n=this._tileSet.tileWidth;for(let o=0,a=i.length;o<a;o++){const r=i[o];try{t.drawImage(this._spriteSheet,(r.frame-1)*48,(r.type-1)*48,r.width,r.width,r.x+r.xOffset-this._originX*16,r.y+r.yOffset-this._originY*16,r.width,r.width)}catch(l){console.warn("Failed to draw sprite "+r.type+" frame "+r.frame+" at "+r.x+", "+r.y);continue}s.push({x:Math.floor((r.x+r.xOffset-this._originX*16)/n),xBound:Math.ceil((r.x+r.xOffset+r.width-this._originX*16)/n),y:Math.floor((r.y+r.yOffset-this._originY*16)/n),yBound:Math.ceil((r.y+r.yOffset+r.height-this._originY*16)/n)})}return s}_processMouse(t){const i={x:0,xBound:0,y:0,yBound:0};if(t.width===0||t.height===0)return;let s=t.x,n=t.y;const o=t.width,a=t.height,r={colour:t.colour,outline:!0};if(o>2&&(s-=1),a>2&&(n-=1),this._originX+s<0&&this._originX+s+o<=0||this._originY+n<0&&this._originY+n+a<=0||this._originX+s>=this._map.width||this._originY+n>=this._map.height)return i.x=i.xBound=s,i.y=i.yBound=n,i;const l={x:s*this._tileSet.tileWidth,y:n*this._tileSet.tileWidth},h=o*this._tileSet.tileWidth,c=a*this._tileSet.tileWidth;return hp.draw(this._canvas,l,h,c,r),i.x=s-1,i.xBound=s+o+2,i.y=n-1,i.yBound=n+o+2,i}_paintVoid(t,i,s){const n=this._tileSet.tileWidth;t.fillStyle="black",t.fillRect(i*n,s*n,n,n)}_paintOne(t,i,s,n){if(i===Yt){this._paintVoid(t,s,n);return}const o=this._tileSet[i];try{t.drawImage(o,s*this._tileSet.tileWidth,n*this._tileSet.tileWidth)}catch(a){const r=this._originX+s,l=this._originY+n;throw new Error("Failed to draw tile "+i+" at "+s+", "+n+" (map "+r+", "+l+" tile "+(this._map.testBounds(r,l)?this._map.getTileValue(r,l):"?? (Out of bounds)")+")")}}_paintTiles(t,i){let s,n,o;const a=this._lastPaintedTiles,r=this._totalTilesInViewX,l=this._totalTilesInViewY;if(a!==null){const c=Math.min(this._lastPaintedWidth,r),g=Math.min(this._lastPaintedHeight,l);for(n=0;n<g;n++)for(s=0;s<c;s++)o=n*c+s,a[o]!==i[o]&&this._paintOne(t,i[o],s,n);if(r>this._lastPaintedWidth)for(n=0;n<l;n++)for(s=this._lastPaintedWidth;s<r;s++)o=n*r+s,this._paintOne(t,i[o],s,n);if(l>this._lastPaintedHeight)for(n=this._lastPaintedHeight;n<l;n++)for(s=0;s<r;s++)o=n*r+s,this._paintOne(t,i[o],s,n)}else for(n=0;n<l;n++)for(s=0;s<r;s++)o=n*r+s,this._paintOne(t,i[o],s,n);this._lastPaintedWidth=r,this._lastPaintedHeight=l;const h=this._lastPaintedTiles;this._lastPaintedTiles=i,this._currentPaintedTiles=h}paint(t,i,s){let n,o,a,r,l,h,c,g;if(!this.ready)return;let _=this._lastPaintedTiles;if(this._pendingDimensionChange||this._pendingTileSet){if(this._calculateDimensions(),this._pendingDimensionChange=!1,this._pendingTileSet!==null&&(this._tileSet=this._pendingTileSet),this._pendingTileSet||this.canvasWidth!==this._lastCanvasWidth||this.canvasHeight!==this._lastCanvasHeight)for(this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight),r=0,o=_!==null?_.length:0;r<o;r++)_[r]=-2;this._pendingTileSet=null}const v=this._totalTilesInViewX,S=this._totalTilesInViewY,C=this._map.getTileValuesForPainting(this._originX,this._originY,v,S,this._currentPaintedTiles);if(this.animationManager.getTiles(C,this._originX,this._originY,v,S,s),this._paintTiles(this.ctx,C),_=this._lastPaintedTiles,this._lastCanvasWidth=this.canvasWidth,this._lastCanvasHeight=this.canvasHeight,!(!t&&!i)){if(t)for(l=this._processMouse(t),r=Math.max(0,l.y),c=Math.min(S,l.yBound);r<c;r++)for(a=Math.max(0,l.x),h=Math.min(v,l.xBound);a<h;a++)g=[r*v+a],_[g]=-2;if(i)for(l=this._processSprites(this.ctx,i),n=0,o=l.length;n<o;n++){const A=l[n];for(r=Math.max(0,A.y),c=Math.min(A.yBound,S);r<c;r++)for(a=Math.max(0,A.x),h=Math.min(A.xBound,v);a<h;a++)g=[r*v+a],this._lastPaintedTiles[g]=-2}}}},"p$5");let xs=or;dp(xs,"GameCanvas"),xs.DEFAULT_ID="microcity-canvas";var up=Object.defineProperty,pp=d((t,i)=>up(t,"name",{value:i,configurable:!0}),"x");const fp=pp(function(t,i,s,n,o,a){const r=p.normaliseDOMid(t),l=p.normaliseDOMid(i),h=p.normaliseDOMid(s),c=p.normaliseDOMid(n),g=p.normaliseDOMid(o),_=p.normaliseDOMid(a);return function(v,S){$(r).text(S.classification),$(l).text(S.population),$(h).text(S.score),$(c).text(S.funds),$(g).text([z.months[S.date.month],S.date.year].join(" ")),$(_).text(S.name),v.addEventListener(wn,function(C){$(r).text(C)}),v.addEventListener(bn,function(C){$(l).text(C)}),v.addEventListener(Cn,function(C){$(h).text(C)}),v.addEventListener(Ie,function(C){$(c).text(C)}),v.addEventListener(os,function(C){$(g).text(`Year ${C.year} ${z.months[C.month]}`)})}},"InfoBar");var gp=Object.defineProperty,Ns=d((t,i)=>gp(t,"name",{value:i,configurable:!0}),"f$1");const mp=[mt,ti,mt,xr,ti,ti,Nr,Hr,mt,Br,mt,Fr,Vr,Ur,Wr,ei],_p=[Ct,si,Ct,Qr,si,si,Jr,sl,Ct,el,Ct,il,tl,ol,nl,ho],Ep=[Vt,ii,Vt,Gr,ii,ii,Yr,Zr,Vt,Xr,Vt,jr,zr,Kr,qr,lo],Tp=Ns(function(t,i){let s=0,n=this._worldEffects.getTile(t,i);if(n=T.normalizeRoad(n),n>=mt&&n<=ei){i>0&&(n=this._worldEffects.getTileValue(t,i-1),n=T.normalizeRoad(n),(n===it||n>=N&&n<=J)&&n!==Dt&&n!==X&&n!==N&&(s|=1)),t<this._map.width-1&&(n=this._worldEffects.getTileValue(t+1,i),n=T.normalizeRoad(n),(n===X||n>=N&&n<=J)&&n!==J&&n!==it&&n!==ot&&(s|=2)),i<this._map.height-1&&(n=this._worldEffects.getTileValue(t,i+1),n=T.normalizeRoad(n),(n===it||n>=N&&n<=J)&&n!==Dt&&n!==X&&n!==N&&(s|=4)),t>0&&(n=this._worldEffects.getTileValue(t-1,i),n=T.normalizeRoad(n),(n===X||n>=N&&n<=J)&&n!==J&&n!==it&&n!==ot&&(s|=8)),this._worldEffects.setTile(t,i,mp[s],m|M);return}if(n>=Ct&&n<=ho){i>0&&(n=this._worldEffects.getTileValue(t,i-1),n=T.normalizeRoad(n),n>=Z&&n<=X&&n!==Z&&n!==it&&n!==at&&(s|=1)),t<this._map.width-1&&(n=this._worldEffects.getTileValue(t+1,i),n=T.normalizeRoad(n),n>=Z&&n<=X&&n!==ht&&n!==X&&n!==Bt&&(s|=2)),i<this._map.height-1&&(n=this._worldEffects.getTileValue(t,i+1),n=T.normalizeRoad(n),n>=Z&&n<=X&&n!==Z&&n!==it&&n!==at&&(s|=4)),t>0&&(n=this._worldEffects.getTileValue(t-1,i),n=T.normalizeRoad(n),n>=Z&&n<=X&&n!==ht&&n!==X&&n!==Bt&&(s|=8)),this._worldEffects.setTile(t,i,_p[s],m|M);return}n>=Vt&&n<=lo&&(i>0&&(n=this._worldEffects.getTile(t,i-1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Nt&&n!==J&&n!==ht&&(s|=1))),t<this._map.width-1&&(n=this._worldEffects.getTile(t+1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Ot&&n!==Dt&&n!==Z&&(s|=2))),i<this._map.height-1&&(n=this._worldEffects.getTile(t,i+1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Nt&&n!==J&&n!==ht&&(s|=4))),t>0&&(n=this._worldEffects.getTile(t-1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Ot&&n!==Dt&&n!==Z&&(s|=8))),this._worldEffects.setTile(t,i,Ep[s],hi))},"fixSingle"),wp=Ns(function(t,i){this.fixSingle(t,i),i>0&&this.fixSingle(t,i-1),t<this._map.width-1&&this.fixSingle(t+1,i),i<this._map.height-1&&this.fixSingle(t,i+1),t>0&&this.fixSingle(t-1,i)},"checkZoneConnections"),vp=Ns(function(t,i,s){t=t-1,i=i-1;let n;for(n=0;n<s;n++)this.fixZone(t+n,i-1);for(n=0;n<s;n++)this.fixZone(t-1,i+n);for(n=0;n<s;n++)this.fixZone(t+n,i+s);for(n=0;n<s;n++)this.fixZone(t+s,i+n)},"checkBorder"),Sp=Ns(function(t){return t.prototype.checkZoneConnections=wp,t.prototype.fixSingle=Tp,t.prototype.checkBorder=vp,t},"Connector");var yp=Object.defineProperty,bp=d((t,i)=>yp(t,"name",{value:i,configurable:!0}),"n$7");const Dp=qt.makeTool,xi=bp(function(t){return Sp(Dp(t))},"ConnectingTool"),et=xi(function(t,i,s,n,o){this.init(t,s,!1),this.centreTile=i,this.size=n,this.animated=o});et.prototype.putBuilding=function(t,i){let s,n,o,a,r=this.centreTile-this.size-1;for(let l=0;l<this.size;l++){n=i+l;for(let h=0;h<this.size;h++)s=t+h,o=r,a=ts,h===1&&(l===1?a|=be:l===2&&this.animated&&(a|=j)),this._worldEffects.setTile(s,n,o,a),r++}},et.prototype.prepareBuildingSite=function(t,i){if(t<0||t+this.size>this._map.width)return this.TOOLRESULT_FAILED;if(i<0||i+this.size>this._map.height)return this.TOOLRESULT_FAILED;let s,n,o;for(let a=0;a<this.size;a++){n=i+a;for(let r=0;r<this.size;r++)if(s=t+r,o=this._worldEffects.getTileValue(s,n),o!==R){if(!this.autoBulldoze)return this.TOOLRESULT_NEEDS_BULLDOZE;if(!T.canBulldoze(o))return this.TOOLRESULT_NEEDS_BULLDOZE;this._worldEffects.setTile(s,n,R),this.addCost(this.bulldozerCost)}}return this.TOOLRESULT_OK},et.prototype.buildBuilding=function(t,i){t--,i--;const s=this.prepareBuildingSite(t,i);return s!==this.TOOLRESULT_OK?s:(this.addCost(this.toolCost),this.putBuilding(t,i),this.checkBorder(t,i),this.TOOLRESULT_OK)},et.prototype.doTool=function(t,i,s){this.result=this.buildBuilding(t,i)};const Vs=st(xi(function(t){this.init(10,t,!0,!0)}));Vs.prototype.putRubble=function(t,i,s){for(let n=t;n<t+s;n++)for(let o=i;o<i+s;o++)if(this._map.testBounds(n,o)){const a=this._worldEffects.getTileValue(n,o);a!=Je&&a!=R&&this._worldEffects.setTile(n,o,oi+u.getRandom(2),j|m)}},Vs.prototype.layDoze=function(t,i){let s=this._worldEffects.getTile(t,i);if(!s.isBulldozable())return this.TOOLRESULT_FAILED;switch(s=s.getValue(),s=T.normalizeRoad(s),s){case nt:case ot:case we:case Te:case nn:case To:case wo:case vo:case rn:case bo:case Do:case Oo:case Ot:case Nt:case at:case Bt:this._worldEffects.setTile(t,i,f);break;default:this._worldEffects.setTile(t,i,R);break}return this.addCost(1),this.TOOLRESULT_OK},Vs.prototype.doTool=function(t,i,s){this._map.testBounds(t,i)||(this.result=this.TOOLRESULT_FAILED);const n=this._worldEffects.getTile(t,i),o=n.getValue();let a=0,r,l;if(n.isZone())a=P.checkZoneSize(o),r=0,l=0;else{const h=P.checkBigZone(o);a=h.zoneSize,r=h.deltaX,l=h.deltaY}if(a>0){this.addCost(this.bulldozerCost);const h=t+r,c=i+l;switch(a){case 3:this._emitEvent(Ss),this.putRubble(h-1,c-1,3);break;case 4:this._emitEvent(Pn),this.putRubble(h-1,c-1,4);break;case 6:this._emitEvent(Ss),this._emitEvent(Pn),this.putRubble(h-1,c-1,6);break}this.result=this.TOOLRESULT_OK}else{let h;o===f||o===D||o===H?(h=this.layDoze(t,i),o!==this._worldEffects.getTileValue(t,i)&&this.addCost(5)):(h=this.layDoze(t,i),this.checkZoneConnections(t,i)),this.result=h}};const Op=qt.makeTool,ar=Op(function(t){this.init(10,t,!0,!0)});ar.prototype.doTool=function(t,i,s){if(this.doAutoBulldoze(t,i),this._worldEffects.getTileValue(t,i)!==R){this.result=this.TOOLRESULT_NEEDS_BULLDOZE;return}const n=u.getRandom(4);let o=M|m,a;n===4?(a=yo,o|=j):a=n+Ar,this._worldEffects.setTile(t,i,a,o),this.addCost(10),this.result=this.TOOLRESULT_OK};const zn=xi(function(t){this.init(20,t,!0,!0)});zn.prototype.layRail=function(t,i){this.doAutoBulldoze(t,i);let s=this._worldEffects.getTileValue(t,i);s=T.normalizeRoad(s);let n=this.toolCost;switch(s){case R:this._worldEffects.setTile(t,i,Ct,m|M);break;case f:case D:case H:if(n=100,t<this._map.width-1&&(s=this._worldEffects.getTileValue(t+1,i),s=T.normalizeRoad(s),s==Z||s==at||s>=Ct&&s<=it)){this._worldEffects.setTile(t,i,at,m);break}if(t>0&&(s=this._worldEffects.getTileValue(t-1,i),s=T.normalizeRoad(s),s==Z||s==at||s>Bt&&s<X)){this._worldEffects.setTile(t,i,at,m);break}if(i<this._map.height-1&&(s=this._worldEffects.getTileValue(t,i+1),s=T.normalizeRoad(s),s==ht||s==X||s>at&&s<it)){this._worldEffects.setTile(t,i,Bt,m);break}if(i>0&&(s=this._worldEffects.getTileValue(t,i-1),s=T.normalizeRoad(s),s==ht||s==X||s>at&&s<it)){this._worldEffects.setTile(t,i,Bt,m);break}return this.TOOLRESULT_FAILED;case Vt:this._worldEffects.setTile(t,i,ht,I|M|m);break;case ii:this._worldEffects.setTile(t,i,Z,I|M|m);break;case mt:this._worldEffects.setTile(t,i,X,M|m);break;case ti:this._worldEffects.setTile(t,i,it,M|m);break;default:return this.TOOLRESULT_FAILED}return this.addCost(n),this.checkZoneConnections(t,i),this.TOOLRESULT_OK},zn.prototype.doTool=function(t,i,s){this.result=this.layRail(t,i)};const Xn=xi(function(t){this.init(10,t,!0,!0)});Xn.prototype.layRoad=function(t,i){this.doAutoBulldoze(t,i);let s=this._worldEffects.getTileValue(t,i),n=this.toolCost;switch(s){case R:this._worldEffects.setTile(t,i,mt,m|M);break;case f:case D:case H:if(n=50,t<this._map.width-1&&(s=this._worldEffects.getTileValue(t+1,i),s=T.normalizeRoad(s),s===X||s===nt||s>=mt&&s<=Dt)){this._worldEffects.setTile(t,i,nt,m);break}if(t>0&&(s=this._worldEffects.getTileValue(t-1,i),s=T.normalizeRoad(s),s===X||s===nt||s>=mt&&s<=ei)){this._worldEffects.setTile(t,i,nt,m);break}if(i<this._map.height-1&&(s=this._worldEffects.getTileValue(t,i+1),s=T.normalizeRoad(s),s===it||s===J||s>=ot&&s<=ei)){this._worldEffects.setTile(t,i,ot,m);break}if(i>0&&(s=this._worldEffects.getTileValue(t,i-1),s=T.normalizeRoad(s),s===it||s===J||s>=ot&&s<=ei)){this._worldEffects.setTile(t,i,ot,m);break}return this.TOOLRESULT_FAILED;case Vt:this._worldEffects.setTile(t,i,J,I|M|m);break;case ii:this._worldEffects.setTile(t,i,Dt,I|M|m);break;case Ct:this._worldEffects.setTile(t,i,it,M|m);break;case si:this._worldEffects.setTile(t,i,X,M|m);break;default:return this.TOOLRESULT_FAILED}return this.addCost(n),this.checkZoneConnections(t,i),this.TOOLRESULT_OK},Xn.prototype.doTool=function(t,i,s){this.result=this.layRoad(t,i)};const Cp=qt.makeTool,Lt=st(Cp(function(t){this.init(0,t,!1,!1)}));Lt.prototype.classifyPopulationDensity=function(t,i,s){let n=s.populationDensityMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryDensity").text(z.densityStrings[n])},Lt.prototype.classifyLandValue=function(t,i,s){const n=s.landValueMap.worldGet(t,i);let o=0;n>=150?o=3:n>=80?o=2:n>=30&&(o=1);const a=z.landValueStrings[o];$("#queryLandValue").text(a)},Lt.prototype.classifyCrime=function(t,i,s){let n=s.crimeRateMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryCrime").text(z.crimeStrings[n])},Lt.prototype.classifyPollution=function(t,i,s){let n=s.pollutionDensityMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryPollution").text(z.pollutionStrings[n])},Lt.prototype.classifyRateOfGrowth=function(t,i,s){let n=s.rateOfGrowthMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryRate").text(z.rateStrings[n])},Lt.prototype.classifyDebug=function(t,i,s){},Lt.prototype.classifyZone=function(t,i){const s=[R,f,Fi,Hi,ie,Je,Ys,N,_t,Ft,Ht,qs,Gi,Wt,hl,Js,cl,dl,_o,ul,nn,So,yo,fl,an,rn,952];let n=this._map.getTileValue(t,i);n>=gl&&n<an&&(n=Js);let o,a;for(o=0,a=s.length-1;o<a&&!(n<s[o+1]);o++);$("#queryZoneType").text(z.zoneTypes[o])},Lt.prototype.doTool=function(t,i,s){let n="Position ("+t+", "+i+")";n+=" TileValue: "+this._map.getTileValue(t,i),cc.queryDebug,this.classifyZone(t,i),this.classifyPopulationDensity(t,i,s),this.classifyLandValue(t,i,s),this.classifyCrime(t,i,s),this.classifyPollution(t,i,s),this.classifyRateOfGrowth(t,i,s),this.classifyDebug(t,i,s),this._emitEvent(ae),this.result=this.TOOLRESULT_OK};const jn=xi(function(t){this.init(5,t,!0,!0)});jn.prototype.layWire=function(t,i){this.doAutoBulldoze(t,i);let s=this.toolCost,n=this._worldEffects.getTileValue(t,i);switch(n=T.normalizeRoad(n),n){case R:this._worldEffects.setTile(t,i,Vt,I|M|m);break;case f:case D:case H:if(s=25,t<this._map.width-1&&(n=this._worldEffects.getTile(t+1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=Dt&&n!=Z&&n!=Ot))){this._worldEffects.setTile(t,i,Nt,I|m);break}if(t>0&&(n=this._worldEffects.getTile(t-1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=Dt&&n!=Z&&n!=Ot))){this._worldEffects.setTile(t,i,Nt,I|m);break}if(i<this._map.height-1&&(n=this._worldEffects.getTile(t,i+1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=J&&n!=ht&&n!=Nt))){this._worldEffects.setTile(t,i,Ot,I|m);break}if(i>0&&(n=this._worldEffects.getTile(t,i-1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=J&&n!=ht&&n!=Nt))){this._worldEffects.setTile(t,i,Ot,I|m);break}return this.TOOLRESULT_FAILED;case mt:this._worldEffects.setTile(t,i,Dt,I|M|m);break;case ti:this._worldEffects.setTile(t,i,J,I|M|m);break;case Ct:this._worldEffects.setTile(t,i,Z,I|M|m);break;case si:this._worldEffects.setTile(t,i,ht,I|M|m);break;default:return this.TOOLRESULT_FAILED}return this.addCost(s),this.checkZoneConnections(t,i),this.TOOLRESULT_OK},jn.prototype.doTool=function(t,i,s){this.result=this.layWire(t,i)};var Rp=Object.defineProperty,Mp=d((t,i)=>Rp(t,"name",{value:i,configurable:!0}),"i$4");function rr(t){const i=st({airport:new et(1e4,V,t,6,!1),bulldozer:new Vs(t),coal:new et(3e3,Ut,t,4,!1),commercial:new et(100,Ks,t,3,!1),fire:new et(500,mo,t,3,!1),industrial:new et(100,Qs,t,3,!1),nuclear:new et(5e3,Rt,t,4,!0),park:new ar(t),police:new et(500,en,t,3,!1),port:new et(3e3,se,t,4,!1),rail:new zn(t),residential:new et(100,ve,t,3,!1),road:new Xn(t),query:new Lt(t),stadium:new et(5e3,Gt,t,4,!1),wire:new jn(t)});return i.query.addEventListener(ae,p.reflectEvent.bind(i,ae)),i}d(rr,"a$3"),Mp(rr,"GameTools");var $p=Object.defineProperty,gt=d((t,i)=>$p(t,"name",{value:i,configurable:!0}),"s$3");const Pp="#"+xs.DEFAULT_ID,Zn=st(function(t,i){this.gameTools=rr(t),this.gameTools.addEventListener(ae,p.reflectEvent.bind(this,ae)),this.canvasID=p.normaliseDOMid(Pp),this._tileWidth=i,this.up=!1,this.down=!1,this.left=!1,this.right=!1,this.escape=!1,this.mouseX=-1,this.mouseY=-1,this._dragging=!1,this._lastdragX=-1,this._lastdragY=-1,this.toolName=null,this.currentTool=null,this.toolWidth=0,this.toolColour="",this.$canvas=$(this.canvasID),$(document).keydown(lr.bind(this)),$(document).keyup(hr.bind(this)),this.getRelativeCoordinates=cr.bind(this),this.$canvas.on("mouseenter",dr.bind(this)),this.$canvas.on("mouseleave",fr.bind(this)),this.mouseDownHandler=ur.bind(this),this.mouseMoveHandler=gr.bind(this),this.mouseUpHandler=pr.bind(this),this.canvasClickHandler=mr.bind(this),$(".toolButton").click(_r.bind(this)),$("#budgetRequest").click(Ap.bind(this)),$("#evalRequest").click(kp.bind(this)),$("#disasterRequest").click(Ip.bind(this)),$("#pauseRequest").click(this.speedChangeHandler.bind(this)),$("#screenshotRequest").click(xp.bind(this)),$("#settingsRequest").click(Np.bind(this)),$("#saveRequest").click(Vp.bind(this)),$("#debugRequest").click(Lp.bind(this))});function lr(t){let i=!1;switch(t.keyCode){case 38:case 87:this.up=!0,i=!0;break;case 40:case 83:this.down=!0,i=!0;break;case 39:case 68:this.right=!0,i=!0;break;case 37:case 65:this.left=!0,i=!0;break;case 27:this.escape=!0,i=!0}i&&t.preventDefault()}d(lr,"g$4"),gt(lr,"keyDownHandler");function hr(t){switch(t.keyCode){case 38:case 87:this.up=!1;break;case 40:case 83:this.down=!1;break;case 39:case 68:this.right=!1;break;case 37:case 65:this.left=!1;break;case 27:this.escape=!1}}d(hr,"E$2"),gt(hr,"keyUpHandler");function cr(t){const i=document.querySelector(this.canvasID).getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top}}d(cr,"D"),gt(cr,"getRelativeCoordinates");function dr(t){this.currentTool!=null&&(this.$canvas.on("mousemove",this.mouseMoveHandler),this.currentTool.isDraggable?this.$canvas.on("mousedown",this.mouseDownHandler):this.$canvas.on("click",this.canvasClickHandler))}d(dr,"_$2"),gt(dr,"mouseEnterHandler");function ur(t){if(t.which!==1||t.shiftKey||t.altKey||t.ctrlKey||t.metaKey)return;const i=this.getRelativeCoordinates(t);this.mouseX=i.x,this.mouseY=i.y,this._dragging=!0,this._emitEvent($i,{x:this.mouseX,y:this.mouseY}),this._lastDragX=Math.floor(this.mouseX/this._tileWidth),this._lastDragY=Math.floor(this.mouseY/this._tileWidth),this.$canvas.on("mouseup",this.mouseUpHandler),t.preventDefault()}d(ur,"p$4"),gt(ur,"mouseDownHandler");function pr(t){this._dragging=!1,this._lastDragX=-1,this._lastDragY=-1,this.$canvas.off("mouseup"),t.preventDefault()}d(pr,"C"),gt(pr,"mouseUpHandler");function fr(t){this.$canvas.off("mousedown"),this.$canvas.off("mousemove"),this.$canvas.off("mouseup"),this._dragging&&(this._dragging=!1,this._lastDragX=-1,this._lastDragY=-1),this.$canvas.off("click"),this.mouseX=-1,this.mouseY=-1}d(fr,"b$1"),gt(fr,"mouseLeaveHandler");function gr(t){const i=this.getRelativeCoordinates(t);if(this.mouseX=i.x,this.mouseY=i.y,this._dragging){const s=Math.floor(this.mouseX/this._tileWidth),n=Math.floor(this.mouseY/this._tileWidth),o=this._lastDragX,a=this._lastDragY;(s!==o||n!==a)&&(this._emitEvent($i,{x:this.mouseX,y:this.mouseY}),this._lastDragX=s,this._lastDragY=n)}}d(gr,"k$1"),gt(gr,"mouseMoveHandler");function mr(t){t.which!==1||t.shiftKey||t.altKey||t.ctrlKey||t.metaKey||this.mouseX===-1||this._mouseY===-1||this._dragging||(this._emitEvent($i,{x:this.mouseX,y:this.mouseY}),t.preventDefault())}d(mr,"H$1"),gt(mr,"canvasClickHandler");function _r(t){$(".selected").each(function(){this.classList.remove("selected"),this.classList.add("unselected")});let i=t.target,s=$(i);i.tagName.toLowerCase()==="img"&&(i=i.parentNode,s=$(i)),s.removeClass("unselected"),s.addClass("selected"),this.toolName=s.attr("data-tool"),this.toolWidth=s.attr("data-size"),this.currentTool=this.gameTools[this.toolName],this.toolColour="",this.toolName!=="query"?(this.$canvas.removeClass("helpPointer"),this.$canvas.addClass("pointer")):(this.$canvas.removeClass("pointer"),this.$canvas.addClass("helpPointer")),t.preventDefault()}d(_r,"R"),gt(_r,"toolButtonHandler"),Zn.prototype.speedChangeHandler=function(t){const i=$("#pauseRequest").text(),s=i==="Pause"?"Play":"Pause";$("#pauseRequest").text(s),this._emitEvent(An,i)},Zn.prototype.clearTool=function(){this.toolName==="query"&&(this.$canvas.removeClass("helpPointer"),this.$canvas.addClass("pointer")),this.currentTool=null,this.toolWidth=0,this.toolColour="",$(".selected").removeClass("selected")};const me=gt(function(t){const i=ya[t];return function(s){this._emitEvent(i)}},"makeHandler");var Ap=me("BUDGET_REQUESTED"),Lp=me("DEBUG_WINDOW_REQUESTED"),Ip=me("DISASTER_REQUESTED"),kp=me("EVAL_REQUESTED"),xp=me("SCREENSHOT_WINDOW_REQUESTED"),Np=me("SETTINGS_WINDOW_REQUESTED"),Vp=me("SAVE_REQUESTED"),Bp=Object.defineProperty,qn=d((t,i)=>Bp(t,"name",{value:i,configurable:!0}),"s$2");const Er=30,Fp=qn(function(t){t&&t.preventDefault(),this._element.is(":visible")&&this._element.toggle()},"close"),Hp=qn(function(t){t.preventDefault(),!(this._x===-1||this._y===-1)&&this._map.centreOn(this._x,this._y)},"handleClick");function Qt(t,i,s){t=p.normaliseDOMid(t),this._map=i,this._element=$(t),this._timeout=null,this._handleClick=Hp.bind(this),this._x=-1,this._y=-1,this._element.click(this._handleClick),this.close=Fp.bind(this),this._element.is(":visible")&&this._element.toggle()}d(Qt,"e$3"),qn(Qt,"Notification"),Qt.prototype._displayLink=function(t,i,s){this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),this._element.text(t),this._x=i,this._y=s,this._element.addClass("pointer"),this._element.is(":visible")||this._element.toggle(),this._timeout=window.setTimeout(function(){this._timeout=null,this.close()}.bind(this),Er*1e3)},Qt.prototype._displayText=function(t,i,s){this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),this._element.removeClass("pointer"),this._element.text(t),this._x=-1,this._y=-1,this._element.is(":visible")||this._element.toggle(),this._timeout=window.setTimeout(function(){this._timeout=null,this.close()}.bind(this),Er*1e3)},Qt.prototype.createMessage=function(t){if(t.hasOwnProperty("data")&&t.data!==void 0&&t.data.hasOwnProperty("x")&&t.data.hasOwnProperty("y")){this._displayLink(z.messageText[t.subject],t.data.x,t.data.y);return}this._displayText(z.messageText[t.subject])},Qt.prototype.badNews=function(t){this._element.removeClass("neutral"),this._element.removeClass("good"),this._element.addClass("bad"),this.createMessage(t)},Qt.prototype.goodNews=function(t){this._element.removeClass("neutral"),this._element.removeClass("bad"),this._element.addClass("good"),this.createMessage(t)},Qt.prototype.news=function(t){this._element.removeClass("good"),this._element.removeClass("bad"),this._element.addClass("neutral"),this.createMessage(t)};var Wp=Object.defineProperty,Up=d((t,i)=>Wp(t,"name",{value:i,configurable:!0}),"t$3");const Kn=yt(function(){this._debugToggled=!1,$(Gp).on("submit",zp.bind(this))});var Gp="#queryForm";const Yp="#queryOK";var zp=Up(function(t){t.preventDefault(),this.close()},"submit");Kn.prototype.close=function(){this._toggleDisplay(),this._emitEvent(Dn)},Kn.prototype.open=function(){this._toggleDisplay(),$(Yp).focus()};var Xp=Object.defineProperty,jp=d((t,i)=>Xp(t,"name",{value:i,configurable:!0}),"o$3");function It(t,i,s){if(arguments.length<2)throw new Error("RCI constructor called with too few arguments "+[].toString.apply(arguments));if(s===void 0&&(s=It.DEFAULT_ID),typeof t=="string"){const a=t;if(t=$(p.normaliseDOMid(t)),t=t.length===0?null:t[0],t===null)throw new Error("Node "+a+" not found")}this._padding=3,this._buckets=10,this._rectSize=5,this._scale=Math.floor(2e3/this._buckets),this._canvas=$("<canvas></canvas>",{id:s})[0];const n=$(p.normaliseDOMid(s)),o=n.length>0?n[0]:null;if(o!==null)if(o.parentNode===t)t.replaceChild(this._canvas,o);else throw new Error("ID "+s+" already exists in document!");else t.appendChild(this._canvas);this._initialisedBounds=!1,i.addEventListener(Ne,this.update.bind(this))}d(It,"a$2"),jp(It,"RCI"),It.prototype._clear=function(t){t.clearRect(0,0,this._canvas.width,this._canvas.height)},It.prototype._drawRect=function(t){const i=this._padding*this._rectSize,s=(this._buckets+this._padding)*this._rectSize,n=7*this._padding*this._rectSize,o=this._padding*this._rectSize;t.fillStyle="rgb(192, 192, 192)",t.fillRect(i,s,n,o)},It.prototype._drawValue=function(t,i,s){i>1&&(s=Math.floor(2e3/1500*s));const n=["rgb(0,255,0)","rgb(0, 0, 139)","rgb(255, 255, 0)"],o=Math.floor(Math.abs(s)/this._scale),a=s>=0?this._buckets+this._padding-o:this._buckets+2*this._padding,r=2*this._padding+i*2*this._padding;t.fillStyle=n[i],t.fillRect(r*this._rectSize,a*this._rectSize,this._padding*this._rectSize,o*this._rectSize)},It.prototype._drawLabel=function(t,i){const s=["R","C","I"],n=2*this._padding+i*2*this._padding+Math.floor(this._padding/2);t.font="normal xx-small sans-serif",t.fillStyle="rgb(0, 0, 0)",t.textBaseline="bottom",t.fillText(s[i],n*this._rectSize,(this._buckets+2*this._padding)*this._rectSize)},It.prototype.update=function(t){if(!this._initialised){const n=this._canvas.parentNode.getBoundingClientRect();this._canvas.width=n.width,this._canvas.height=n.height,this._canvas.style.margin="0",this._canvas.style.padding="0",this._intialised=!0}const i=this._canvas.getContext("2d");this._clear(i),this._drawRect(i);const s=[t.residential,t.commercial,t.industrial];for(let n=0;n<3;n++)this._drawValue(i,n,s[n]),this._drawLabel(i,n)},Object.defineProperty(It,"DEFAULT_ID",p.makeConstantDescriptor("RCICanvas"));var Zp=Object.defineProperty,qp=d((t,i)=>Zp(t,"name",{value:i,configurable:!0}),"i$3");const Kp="#saveForm",Qp="#saveOK",Jp=qp(function(t){t.preventDefault(),this.close()},"submit"),Qn=yt(function(){$(Kp).on("submit",Jp.bind(this))});Qn.prototype.close=function(){this._toggleDisplay(),this._emitEvent(On)},Qn.prototype.open=function(){this._toggleDisplay(),$(Qp).focus()};var tf=Object.defineProperty,Tr=d((t,i)=>tf(t,"name",{value:i,configurable:!0}),"o$2");const ef="#screenshotLinkForm",sf="#screenshotLink";Tr(function(t){t.preventDefault(),this.close()},"cancel");const nf=Tr(function(t){t.preventDefault(),this.close()},"submit"),Jn=yt(function(){$(ef).on("submit",nf.bind(this))});Jn.prototype.close=function(){this._toggleDisplay(),this._emitEvent(Rn)},Jn.prototype.open=function(t){$(sf).attr("href",t),this._toggleDisplay()};var of=Object.defineProperty,wr=d((t,i)=>of(t,"name",{value:i,configurable:!0}),"o$1");const Jt=yt(function(){$(af).on("click",lf.bind(this)),$(rf).on("submit",hf.bind(this))});var af="#screenshotCancel",rf="#screenshotForm";Jt.prototype.close=function(t){t=t||null,this._toggleDisplay(),this._emitEvent(Mn,t)};var lf=wr(function(t){t.preventDefault(),this.close(null)},"cancel"),hf=wr(function(t){t.preventDefault();let i=null;$(".screenshotType:checked").val()==="visible"?i=Jt.SCREENSHOT_VISIBLE:i=Jt.SCREENSHOT_ALL,this.close(i)},"submit");Jt.prototype.open=function(t){this._toggleDisplay()};const vr=function(){let t=1;return function(i){Object.defineProperty(Jt,i,p.makeConstantDescriptor(t)),t+=1}}();vr("SCREENSHOT_VISIBLE"),vr("SCREENSHOT_ALL");var cf=Object.defineProperty,Sr=d((t,i)=>cf(t,"name",{value:i,configurable:!0}),"i$1");const df="#settingsCancel",uf="#settingsForm",pf="#autoBudgetYes",ff="#autoBudgetNo",gf="#autoBulldozeYes",mf="#autoBulldozeNo",_f="#speedSlow",Ef="#speedMed",Tf="#speedFast",wf="#disastersYes",vf="#disastersNo",Sf=Sr(function(t){t.preventDefault(),this.close([])},"cancel"),yf=Sr(function(t){t.preventDefault();const i=[];let s=$(".autoBudgetSetting:checked").val();s==="true"?s=!0:s=!1,i.push({action:lt.AUTOBUDGET,data:s});let n=$(".autoBulldozeSetting:checked").val();n==="true"?n=!0:n=!1,i.push({action:lt.AUTOBULLDOZE,data:n});const o=$(".speedSetting:checked").val()-0;i.push({action:lt.SPEED,data:o});let a=$(".enableDisastersSetting:checked").val();a==="true"?a=!0:a=!1,i.push({action:lt.DISASTERS_CHANGED,data:a}),this.close(i)},"submit"),lt=yt(function(){$(df).on("click",Sf.bind(this)),$(uf).on("submit",yf.bind(this))});lt.prototype.close=function(t){t=t||[],this._emitEvent($n,t),this._toggleDisplay()},lt.prototype.open=function(t){t.autoBudget?$(pf).prop("checked",!0):$(ff).prop("checked",!0),t.autoBulldoze?$(gf).prop("checked",!0):$(mf).prop("checked",!0),t.speed===y.SPEED_SLOW?$(_f).prop("checked",!0):t.speed===y.SPEED_MED?$(Ef).prop("checked",!0):$(Tf).prop("checked",!0),t.disasters?$(wf).prop("checked",!0):$(vf).prop("checked",!0),this._toggleDisplay()};const Bs=function(){let t=0;return function(i){Object.defineProperty(lt,i,p.makeConstantDescriptor(t)),t+=1}}();Bs("AUTOBUDGET"),Bs("AUTOBULLDOZE"),Bs("SPEED"),Bs("DISASTERS_CHANGED");var bf=Object.defineProperty,Df=d((t,i)=>bf(t,"name",{value:i,configurable:!0}),"i");const Of="#touchForm",Cf="#touchOK",Rf=Df(function(t){t.preventDefault(),this.close()},"submit"),to=yt(function(){$(Of).on("submit",Rf.bind(this))});to.prototype.close=function(){this._toggleDisplay(),this._emitEvent(In)},to.prototype.open=function(){this._toggleDisplay(),$(Cf).focus()};var Mf=Object.defineProperty,Qe=d((t,i)=>Mf(t,"name",{value:i,configurable:!0}),"l");let yr=0;function br(){if(yr++,this.handleInput(),this.dialogOpen){window.setTimeout(this.tick,0);return}this.simulation.isPaused()||this.simulation.simTick(),this.mouse=this.calculateMouseForPaint(),window.setTimeout(this.tick,this.tickDuration)}d(br,"H"),Qe(br,"tick");function Dr(){if(this.dialogShowing){Cr(this.animate);return}!this.isPaused&&yr%2===1&&this.simulation.spriteManager.moveObjects(this.simulation._constructSimData());const t=this.calculateSpritesForPaint(this.gameCanvas);this.gameCanvas.paint(this.mouse,t,this.isPaused),Cr(this.animate)}d(Dr,"V"),Qe(Dr,"commonAnimate"),Qe(function(){const t=new Date,i=Math.floor((t-this.animStart)/1e3);i>this.lastElapsed&&this.frameCount>0&&($("#fpsValue").text(Math.floor(this.frameCount/i)),this.lastElapsed=i),this.frameCount++,this.commonAnimate()},"debugAnimate");const Or=20*1e3,Fs={};let Ni;Qe(function(t){window.removeEventListener("touchstart",this.touchListener,!1),this._openWindow="touchWindow",this.dialogOpen=!0,this.touchWindow.open()},"touchListener");const Cr=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame;function te(t,i){return i=i||null,function(){if(this.dialogOpen){console.warn("Request made to open "+t+" window. There is a dialog open!");return}this.dialogOpen=!0,this._openWindow=t+"Window";const s=t+"Window";let n=[];i&&(n=i()),this[s].open.apply(this[s],n)}}d(te,"r$1"),Qe(te,"makeWindowOpenHandler");class eo{constructor({map:i,tileSet:s,snowTileSet:n,spriteSheet:o,difficulty:a=0,name:r="Microcity"}){let l;i.isSavedGame?(this.gameMap=new k(i.width||120,i.height||100),l=i):(this.gameMap=i,l=null),this.tileSet=s,this.snowTileSet=n,this.defaultSpeed=y.SPEED_MED,this.simulation=new y(this.gameMap,a,this.defaultSpeed,l),this.tickDuration=30,this.name=r||"Microcity",this.everClicked=!1,l&&this.load(l),this.rci=new It("RCIContainer",this.simulation),this.gameCanvas=new xs("canvasContainer"),this.gameCanvas.init(this.gameMap,this.tileSet,o),this.inputStatus=new Zn(this.gameMap,s.tileWidth),this.dialogOpen=!1,this._openWindow=null,this.mouse=null,this.lastCoord=null,this.simNeededBudget=!1,this.isPaused=!1,this.lastBadMessageTime=null;const h="opaque";this.handleEvalRequest=te("eval",function(){return[this.simulation.evaluation]}.bind(this)),this.evalWindow=new Is(h,"evalWindow"),this.evalWindow.addEventListener(yn,this.genericDialogClosure),this.inputStatus.addEventListener(ga,this.handleEvalRequest.bind(this)),this.handleBudgetRequest=te("budget",function(){return[{roadMaintenanceBudget:this.simulation.budget.roadMaintenanceBudget,roadRate:Math.floor(this.simulation.budget.roadPercent*100),fireMaintenanceBudget:this.simulation.budget.fireMaintenanceBudget,fireRate:Math.floor(this.simulation.budget.firePercent*100),policeMaintenanceBudget:this.simulation.budget.policeMaintenanceBudget,policeRate:Math.floor(this.simulation.budget.policePercent*100),taxRate:this.simulation.budget.cityTax,totalFunds:this.simulation.budget.totalFunds,taxesCollected:this.simulation.budget.taxFund}]}.bind(this)),this.budgetWindow=new Un(h,"budget"),this.budgetWindow.addEventListener(Tn,this.handleBudgetWindowClosure.bind(this)),this.inputStatus.addEventListener(ua,this.handleBudgetRequest.bind(this)),this.handleDisasterRequest=te("disaster"),this.disasterWindow=new W(h,"disasterWindow"),this.disasterWindow.addEventListener(Sn,this.handleDisasterWindowClosure.bind(this)),this.inputStatus.addEventListener(fa,this.handleDisasterRequest.bind(this)),this.handleDebugRequest=te("debug"),this.debugWindow=new qe(h,"debugWindow"),this.debugWindow.addEventListener(vn,this.handleDebugWindowClosure.bind(this)),this.inputStatus.addEventListener(pa,this.handleDebugRequest.bind(this)),this.handleSettingsRequest=te("settings",function(){return[{autoBudget:this.simulation.budget.autoBudget,autoBulldoze:qt.getAutoBulldoze(),speed:this.defaultSpeed,disasters:this.simulation.disasterManager.disastersEnabled}]}.bind(this)),this.settingsWindow=new lt(h,"settingsWindow"),this.settingsWindow.addEventListener($n,this.handleSettingsWindowClosure.bind(this)),this.inputStatus.addEventListener(Ta,this.handleSettingsRequest.bind(this)),this.handleScreenshotRequest=te("screenshot"),this.screenshotWindow=new Jt(h,"screenshotWindow"),this.screenshotWindow.addEventListener(Mn,this.handleScreenshotWindowClosure.bind(this)),this.inputStatus.addEventListener(Ea,this.handleScreenshotRequest.bind(this)),this.screenshotLinkWindow=new Jn(h,"screenshotLinkWindow"),this.screenshotLinkWindow.addEventListener(Rn,this.genericDialogClosure),this.saveWindow=new Qn(h,"saveWindow"),this.saveWindow.addEventListener(On,this.genericDialogClosure),this.touchWindow=new to(h,"touchWarnWindow"),this.touchWindow.addEventListener(In,this.genericDialogClosure),this.handleQueryRequest=te("query"),this.queryWindow=new Kn(h,"queryWindow"),this.queryWindow.addEventListener(Dn,this.genericDialogClosure),this.inputStatus.addEventListener(ae,this.handleQueryRequest.bind(this)),this.inputStatus.addEventListener(_a,this.handleSave.bind(this)),this.simulation.addEventListener(L,this.processFrontEndMessage.bind(this)),this.simulation.addEventListener(Le,this.handleMandatoryBudget.bind(this)),this.inputStatus.addEventListener($i,this.handleTool.bind(this)),this.inputStatus.addEventListener(An,this.handlePause.bind(this)),this.simulation.addEventListener(os,this.onDateChange.bind(this)),this.infoBar=fp("cclass","population","score","funds","date","name");const c={classification:this.simulation.evaluation.cityClass,population:this.simulation.evaluation.cityPop,score:this.simulation.evaluation.cityScore,funds:this.simulation.budget.totalFunds,date:this.simulation.getDate(),name:this.name};this.infoBar(this.simulation,c),this._notificationBar=new Qt("#notifications",this.gameCanvas),this._reachedTown=this._reachedCity=this._reachedCapital=this._reachedMetropolis=this._reacedMegalopolis=!1,this.revealControls(),this._notificationBar._element.toggle(),this.tick=br.bind(this),this.tick(),this.commonAnimate=Dr.bind(this),this.animate=this.commonAnimate.bind(this),this.animate()}save(){const i={name:this.name,everClicked:this.everClicked};qt.save(i),this.simulation.save(i),ue.saveGame(i)}load(i){this.name=i.name,this.everClicked=i.everClicked,qt.load(i),this.simulation.load(i)}revealControls(){$(".initialHidden").each(function(i){$(this).removeClass("initialHidden")}),this.rci.update({residential:750,commercial:750,industrial:750})}genericDialogClosure(){this.dialogOpen=!1,this._openWindow=null}setTileset(i){if(Fs[i]){this.tileSet=Fs[i],this.gameCanvas.changeTileSet(this.tileSet);return}Ni=Ni||document.createElement("img"),Ni.src=`/images/tiles/${i}.png`,Ni.onload=()=>{this.tileSet=Fs[i]=new Xi(Ni,()=>this.gameCanvas.changeTileSet(this.tileSet),()=>delete Fs[i])}}onDateChange(i){}handleDisasterWindowClosure(i){if(this.dialogOpen=!1,i!==W.DISASTER_NONE)switch(i){case W.DISASTER_MONSTER:this.simulation.spriteManager.makeMonster();break;case W.DISASTER_FIRE:this.simulation.disasterManager.makeFire();break;case W.DISASTER_FLOOD:this.simulation.disasterManager.makeFlood();break;case W.DISASTER_CRASH:this.simulation.disasterManager.makeCrash();break;case W.DISASTER_MELTDOWN:this.simulation.disasterManager.makeMeltdown();break;case W.DISASTER_TORNADO:this.simulation.spriteManager.makeTornado()}}handleSettingsWindowClosure(i){this.dialogOpen=!1;for(let s=0,n=i.length;s<n;s++){const o=i[s];switch(o.action){case lt.AUTOBUDGET:this.simulation.budget.setAutoBudget(o.data);break;case lt.AUTOBULLDOZE:qt.setAutoBulldoze(o.data);break;case lt.SPEED:this.defaultSpeed=o.data,this.simulation.setSpeed(this.defaultSpeed);break;case lt.DISASTERS_CHANGED:this.simulation.disasterManager.disastersEnabled=o.data;break;default:console.warn("Unexpected action",o)}}}handleDebugWindowClosure(i){this.dialogOpen=!1;for(let s=0,n=i.length;s<n;s++){const o=i[s];switch(o.action){case qe.ADD_FUNDS:this.simulation.budget.spend(-1e6);break;default:console.warn("Unexpected action",o)}}}handleScreenshotWindowClosure(i){if(this.dialogOpen=!1,i===null)return;let s;i===Jt.SCREENSHOT_VISIBLE?s=this.gameCanvas.screenshotVisible():i===Jt.SCREENSHOT_ALL&&(s=this.gameCanvas.screenshotMap()),this.dialogOpen=!0,this._openWindow="screenshotLinkWindow",this.screenshotLinkWindow.open(s)}handleBudgetWindowClosure(i){this.dialogOpen=!1,i.cancelled||(this.simulation.budget.roadPercent=i.roadPercent/100,this.simulation.budget.firePercent=i.firePercent/100,this.simulation.budget.policePercent=i.policePercent/100,this.simulation.budget.setTax(i.taxPercent-0),this.simNeededBudget?(this.simulation.budget.doBudgetWindow(),this.simNeededBudget=!1):this.simulation.budget.updateFundEffects())}handleMandatoryBudget(){this.simNeededBudget=!0,this.handleBudgetRequest()}handleTool(i){const s=i.x,n=i.y,o=this.gameCanvas.canvasCoordinateToTileCoordinate(s,n);if(o===null)return;const a=this.inputStatus.currentTool,r=this.simulation.budget;switch(this.simulation.evaluation,a.doTool(o.x,o.y,this.simulation.blockMaps),a.modifyIfEnoughFunding(r),a.result){case a.TOOLRESULT_NEEDS_BULLDOZE:console.log(z.toolMessages.needsDoze);break;case a.TOOLRESULT_NO_MONEY:console.log(z.toolMessages.noMoney);break}}handleSave(){this.save(),this.dialogOpen=!0,this._openWindow="saveWindow",this.saveWindow.open()}handlePause(){this.isPaused=!this.isPaused,this.isPaused?this.simulation.setSpeed(y.SPEED_PAUSED):this.simulation.setSpeed(this.defaultSpeed)}handleInput(){this.dialogOpen||(this.inputStatus.left?this.gameCanvas.moveWest():this.inputStatus.up?this.gameCanvas.moveNorth():this.inputStatus.right?this.gameCanvas.moveEast():this.inputStatus.down&&this.gameCanvas.moveSouth()),this.inputStatus.escape&&(this.dialogOpen?(this.dialogOpen=!1,this[this._openWindow].close(),this._openWindow=null):this.inputStatus.clearTool())}processFrontEndMessage(i){const s=i.subject,n=new Date;if(z.goodMessages[s]!==void 0){let o=this.name+" is now a ";switch(s){case bi:this._reachedCapital||(this._reachedCapital=!0,o+="capital!");break;case Di:this._reachedCity||(this._reachedCity=!0,o+="city!");break;case Ci:this._reachedMegalopolis||(this._reachedMegalopolis=!0,o+="megalopolis!");break;case Oi:this._reachedMetropolis||(this._reachedMetropolis=!0,o+="metropolis!");break;case Ri:this._reachedTown||(this._reachedTown=!0,o+="town!");break}(this.lastBadMessageTime===null||n-this.lastBadMessageTime>Or)&&(this.lastBadMessageTime=null,this._notificationBar.goodNews(i)),o!==this.name+" is now a "&&console.log("Congratulations",o);return}if(this.monsterTV&&i.data&&(i.data.showable?this.monsterTV.show(i.data.x,i.data.y):i.data.trackable&&this.monsterTV.track(i.data.x,i.data.y,i.data.sprite)),z.badMessages[s]!==void 0){this._notificationBar.badNews(i),re.indexOf(i.subject)!==-1&&(this.lastBadMessageTime=n);return}if(z.neutralMessages[s]!==void 0){(this.lastBadMessageTime===null||n-this.lastBadMessageTime>Or)&&(this.lastBadMessageTime=null,this._notificationBar.news(i));return}console.warn("Unexpected message: ",s)}calculateMouseForPaint(){let i=null;if(this.inputStatus.mouseX!==-1&&this.inputStatus.toolWidth>0){const s=this.gameCanvas.canvasCoordinateToTileOffset(this.inputStatus.mouseX,this.inputStatus.mouseY);s!==null&&(i={},i.x=s.x,i.y=s.y,i.width=this.inputStatus.toolWidth-0,i.height=this.inputStatus.toolWidth-0,i.colour=this.inputStatus.toolColour||"yellow")}return i}calculateSpritesForPaint(i){const s=i.getTileOrigin(),n=this.simulation.spriteManager.getSpritesInView(s.x,s.y,i.canvasWidth,i.canvasHeight);return n.length===0?null:n}}d(eo,"v"),Qe(eo,"Game");var $f=Object.defineProperty,Vi=d((t,i)=>$f(t,"name",{value:i,configurable:!0}),"t");const io=document.getElementById("tiles"),so=document.getElementById("sprites");function no(){const t=new Xi(io,Vi(function(){function i(){Rr(t,so)}d(i,"n"),Vi(i,"onSpritesReady"),so.complete?i():so.onload=i},"onLoad"),Vi(function(){console.error("Failed to load tileset")},"onError"))}d(no,"a"),Vi(no,"createTileSet"),io.complete&&no(),io.onload=no;function Rr(t,i){const s=xl(120,100),n=ue.canStore&&ue.getSavedGame(),o=new eo({map:n||s,tileSet:t,spriteSheet:i,difficulty:y.LEVEL_EASY});setInterval(function(){ue.canStore&&o.save()},3e3)}d(Rr,"g"),Vi(Rr,"createGame")})();
//# sourceMappingURL=index.min.js.map
