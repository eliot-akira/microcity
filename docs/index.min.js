var Wf=Object.defineProperty;var u=(R,p)=>Wf(R,"name",{value:p,configurable:!0});(function(){"use strict";(function(){const t={env:{NODE_ENV:"production"}};try{if(process){process.env=Object.assign({},process.env),Object.assign(process.env,t);return}}catch(i){}globalThis.process={env:t}})();const R=0,p=2,O=3,G=4,Vr=5,Br=20,Re=p,Pe=Br,ji=21,Zs=ji,qs=37,Fr=39,Ks=Fr,Hr=40,Wr=43,Zi=44,Ur=47,le=48,Gr=51,ai=52,Qs=56,_o=Qs,ut=64,F=ut,dt=65,yt=66,ri=67,Yr=68,zr=69,Xr=70,jr=71,Zr=72,qr=73,Kr=74,Qr=75,li=76,At=77,ot=78,$e=79,Js=80,Ae=95,tn=144,qi=206,Lt=208,Yt=209,zt=210,hi=211,Jr=212,tl=213,el=214,il=215,sl=216,nl=217,ol=218,al=219,Eo=220,Q=221,gt=222,bt=Lt,pt=224,Xt=225,It=226,ci=227,rl=228,ll=229,hl=230,cl=231,ul=232,dl=233,pl=234,fl=235,To=236,lt=237,q=238,jt=pt,wo=238,Zt=240,Le=244,vo=249,Ki=vo,So=260,en=265,ml=405,sn=409,nn=423,on=427,yo=436,Qi=612,an=616,gl=620,ui=625,qt=693,he=698,_l=708,El=709,bo=711,H=716,rn=745,Kt=750,ln=760,Tl=761,Oo=765,wl=770,hn=774,Do=779,Qt=784,Co=800,vl=811,kt=816,cn=826,Sl=827,un=828,Mo=829,Ro=830,Po=831,$o=832,Ao=840,yl=844,di=860,Ji=867,bl=916,dn=924,pn=932,Ol=940,fn=948,Lo=949,Io=950,ko=951,Dl=956,Cl=1018,ts=1024,Jt=-1;var Ml=Object.defineProperty,xo=u((t,i)=>Ml(t,"name",{value:i,configurable:!0}),"s$l");const Rl=16,No=Math.sqrt(ts);class es{constructor(i,s,n){if(s===void 0||n===void 0)throw s===void 0&&n===void 0?new Error("Tileset constructor called with no callback or errorCallback"):new Error("Tileset constructor called with no "+(s===void 0?"callback":"errorCallback"));this.isValid=!1,i.width,i.height;const o=this.tileWidth=Rl,a=document.createElement("canvas");a.width=o,a.height=o;const r=a.getContext("2d"),l=ts;let h=0;const c=this,f=xo(function(){h++,h===l&&(c.isValid=!0,window.setTimeout(s,0))},"imageLoad");for(let _=0;_<l;_++){r.clearRect(0,0,o,o);const S=_%No*o,w=Math.floor(_/No)*o;r.drawImage(i,S,w,o,o,0,0,o,o),this[_]=new Image,this[_].onload=f,this[_].src=a.toDataURL()}}}u(es,"E$g"),xo(es,"TileSet");var Pl=Object.defineProperty,xt=u((t,i)=>Pl(t,"name",{value:i,configurable:!0}),"t$7");const $l=xt(function(t,i,s){return t<i?i:t>s?s:t},"clamp"),Al=xt(function(t){return{configurable:!1,enumerable:!1,writeable:!1,value:t}},"makeConstantDescriptor"),Ll=xt(function(t){return(t[0]!=="#"?"#":"")+t},"normaliseDOMid"),Il=xt(function(t,i){this._emitEvent(t,i)},"reflectEvent");function x(t,i=Y){return(i()&t)===0}u(x,"getChance"),xt(x,"getChance");function pi(t,i=g){const s=i(t),n=i(t);return Math.min(s,n)}u(pi,"getERandom"),xt(pi,"getERandom");function g(t,i=Math){return i.floor(i.random()*(t+1))}u(g,"getRandom"),xt(g,"getRandom");function Y(t=g){return t(65535)}u(Y,"getRandom16"),xt(Y,"getRandom16");function ce(t=Y){const i=t();return i<32768?i:-(2**16)+i}u(ce,"getRandom16Signed"),xt(ce,"getRandom16Signed");const d={clamp:$l,makeConstantDescriptor:Al,normaliseDOMid:Ll,reflectEvent:Il};var kl=Object.defineProperty,Ie=u((t,i)=>kl(t,"name",{value:i,configurable:!0}),"r$l");class Ot{constructor(i){this.name=i}oppositeDirection(){return this.transform(4)}rotateClockwise(){return this.transform(1)}rotateCounterClockwise(){return this.transform(fi.length-1)}toString(){return this.name}transform(i){const s=Wo(this)+i;return fi[s%fi.length]}}u(Ot,"t$6"),Ie(Ot,"DirectionValue");const is=Object.freeze(new Ot("NORTH")),Vo=Object.freeze(new Ot("NORTHEAST")),ss=Object.freeze(new Ot("EAST")),Bo=Object.freeze(new Ot("SOUTHEAST")),ns=Object.freeze(new Ot("SOUTH")),Fo=Object.freeze(new Ot("SOUTHWEST")),os=Object.freeze(new Ot("WEST")),Ho=Object.freeze(new Ot("NORTHWEST")),fi=[is,Vo,ss,Bo,ns,Fo,os,Ho];function Wo(t){return fi.indexOf(t)}u(Wo,"p$i"),Ie(Wo,"directionIndex");const Uo=[is,ss,ns,os];function ke(t){Uo.forEach(i=>t(i))}u(ke,"forEachCardinalDirection"),Ie(ke,"forEachCardinalDirection");function mn(){return gn(Uo)}u(mn,"getRandomCardinalDirection"),Ie(mn,"getRandomCardinalDirection");function Go(){return gn(fi)}u(Go,"getRandomDirection"),Ie(Go,"getRandomDirection");function gn(t){const i=t.length-1,s=g(i);return t[s]}u(gn,"s$k"),Ie(gn,"getRandomDirectionFrom");var xl=Object.defineProperty,Nl=u((t,i)=>xl(t,"name",{value:i,configurable:!0}),"i$g");function _n(t,i){t||alert(`Assertion failed: ${i}`)}u(_n,"assert"),Nl(_n,"assert");var Vl=Object.defineProperty,En=u((t,i)=>Vl(t,"name",{value:i,configurable:!0}),"o$e");class Dt{constructor(i,s){this.xDelta=i,this.yDelta=s}}u(Dt,"e$c"),En(Dt,"DirectionDelta");function Yo(t){switch(t){case is:return new Dt(0,-1);case Vo:return new Dt(1,-1);case ss:return new Dt(1,0);case Bo:return new Dt(1,1);case ns:return new Dt(0,1);case Fo:return new Dt(-1,1);case os:return new Dt(-1,0);case Ho:return new Dt(-1,-1);default:throw new Error("Unexpected direction!")}}u(Yo,"w$8"),En(Yo,"getDeltaFor");class D{constructor(i,s){this.x=i,this.y=s}static move(i,s){const{x:n,y:o}=i,{xDelta:a,yDelta:r}=Yo(s);return new D(n+a,o+r)}static origin(){return new D(0,0)}toString(){return`(${this.x}, ${this.y})`}}u(D,"Position"),En(D,"Position");var Bl=Object.defineProperty,Fl=u((t,i)=>Bl(t,"name",{value:i,configurable:!0}),"i$f");class mi{constructor(i,s,n,o){this.inclusiveStartX=i,this.inclusiveStartY=s,_n(n>0,"bounded region must have a width"),_n(o>0,"bounded region must have a width"),this.exclusiveEndX=i+n,this.exclusiveEndY=s+o}static fromOrigin(i,s){return new mi(0,0,i,s)}contains(i){const{x:s,y:n}=i;return this.xInBounds(s)&&this.yInBounds(n)}toString(){const i=new D(this.inclusiveStartX,this.inclusiveStartY),s=new D(this.exclusiveEndX-1,this.exclusiveEndY-1);return`Bounds Rectangle: ${i} - ${s}`}xInBounds(i){return i>=this.inclusiveStartX&&i<this.exclusiveEndX}yInBounds(i){return i>=this.inclusiveStartY&&i<this.exclusiveEndY}}u(mi,"Bounds"),Fl(mi,"Bounds");const zo=0,Nt=32768,k=16384,P=8192,m=4096,K=2048,xe=1024,Xo=m|P,gi=m|P|k,as=P|k,Hl=K|k|P,Tn=Nt|k|P|m|K|xe,jo=1024,rs=jo-1;var Wl=Object.defineProperty,Ul=u((t,i)=>Wl(t,"name",{value:i,configurable:!0}),"s$j");class X{constructor(i=R,s=0){this.validateArguments(i,s,"Tile constructor"),this.value=i|s}getValue(){return this.valueFromCombinedValue(this.value)}getFlags(){return this.flagsFromCombinedValue(this.value)}getRawValue(){return this.value}addFlags(i){this.validateFlags(i,"addFlags"),i!==zo&&(this.value|=i)}setValue(i){if(i<Jt)throw new Error(`setValue called with out-of-range value ${i}`);const s=this.valueFromCombinedValue(i),n=this.flagsToSetFromCombinedValue(i);this.set(s,n)}setFlags(i){this.validateFlags(i,"setFlags");const s=this.value&~Tn;this.value=s|i}removeFlags(i){this.validateFlags(i,"removeFlags"),i!==zo&&(this.value&=~i)}setFrom(i){if(!i){console.log("Tile is undefined");return}this.value=i.value}set(i,s){this.validateArguments(i,s,"set"),this.value=i|s}isAnimated(){return this.checkBits(K)}isBulldozable(){return this.checkBits(m)}isConductive(){return this.checkBits(k)}isCombustible(){return this.checkBits(P)}isPowered(){return this.checkBits(Nt)}isZone(){return this.checkBits(xe)}toString(){const i=["animated","bulldozable","combustible","conductive","powered","zone"].map(s=>this.getQualityText(s)).join(", ");return`Tile# ${this.getValue()}: ${i}`}getQualityText(i){const s=this.predicateForQuality(i),n=this[s]();return`${i}: ${this.summariseBoolean(n)}`}predicateForQuality(i){return`is${i[0].toUpperCase()}${i.slice(1)}`}summariseBoolean(i){return i?"\u2714":"\u2718"}valueFromCombinedValue(i){return i&rs}flagsFromCombinedValue(i){return i&Tn}flagsToSetFromCombinedValue(i){const s=this.flagsFromCombinedValue(i);return s>0?s:this.getFlags()}checkBits(i){return(this.value&i)>0}validateArguments(i,s,n){this.validateValue(i,n),this.validateFlags(s,n)}validateValue(i,s){if(this.valueIsInvalid(i))throw new Error(`${s} called with out-of-range value ${i}`)}validateFlags(i,s){if(this.flagsAreInvalid(i))throw new Error(`${s} called with out-of-range flags 0x${i.toString(16)}`)}valueIsInvalid(i){return i<Jt||i>=ts}flagsAreInvalid(i){return i!==0&&(i<jo||(i&~Tn)!==0)}}u(X,"Tile"),Ul(X,"Tile");var Gl=Object.defineProperty,Yl=u((t,i)=>Gl(t,"name",{value:i,configurable:!0}),"m$j");function N(t,i,s){if(arguments.length>1&&typeof t=="number"&&(t<1||i<1))throw new Error("GameMap constructor called with invalid width or height "+t+" "+i);const n=120,o=100;arguments.length===0?(t=n,i=o,s=new X().getValue()):arguments.length===1?(typeof t=="number"?s=t:s=t.getValue(),t=n,i=o):arguments.length===2?s=new X().getValue():arguments.length===3&&typeof s=="object"&&(s=s.getValue()),this.width=t,this.height=i,this.bounds=mi.fromOrigin(t,i);const a=[];for(let r=0,l=t*i;r<l;r++)a[r]=new X(s);this._data=a,this.cityCentreX=Math.floor(this.width/2),this.cityCentreY=Math.floor(this.height/2),this.pollutionMaxX=this.cityCentreX,this.pollutionMaxY=this.cityCentreY}u(N,"a$h"),Yl(N,"GameMap");const ue=["cityCentreX","cityCentreY","pollutionMaxX","pollutionMaxY","width","height"];N.prototype.save=function(t){for(let i=0,s=ue.length;i<s;i++)t[ue[i]]=this[ue[i]];t.map=this._data.map(function(i){return{value:i.getRawValue()}})},N.prototype.load=function(t){for(var i=0,s=ue.length;i<s;i++)this[ue[i]]=t[ue[i]]||this[ue[i]];const n=t.map;for(i=0,s=n.length;i<s;i++)this.setTileValue(i%this.width,Math.floor(i/this.width),n[i].value)},N.prototype._calculateIndex=function(t,i){return t+i*this.width},N.prototype.isPositionInBounds=function(t){return this.bounds.contains(t)},N.prototype.testBounds=function(t,i){return this.isPositionInBounds(new D(t,i))},N.prototype.getTile=function(t,i,s){typeof t=="object"&&(i=t.y,t=t.x);const n=this.width,o=this.height;if(t<0||i<0||t>=n||i>=o)return console.warn("getTile called with bad bounds",t,i),new X(Jt);const a=t+i*n,r=this._data[a];return s&&s.setFrom(r),r},N.prototype.getTileValue=function(t,i){if(arguments.length<1)throw new Error("GameMap getTileValue called with too few arguments"+[].toString.apply(arguments));if(typeof t=="object"&&(i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap getTileValue called with invalid bounds "+t+", "+i);const s=this._calculateIndex(t,i);if(this._data[s])return this._data[s].getValue()},N.prototype.getTileFlags=function(t,i){if(arguments.length<1)throw new Error("GameMap getTileFlags called with too few arguments"+[].toString.apply(arguments));if(typeof t=="object"&&(i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap getTileFlags called with invalid bounds "+t+", "+i);const s=this._calculateIndex(t,i);return this._data[s].getFlags()},N.prototype.getTiles=function(t,i,s,n){if(arguments.length<3)throw new Error("GameMap getTiles called with too few arguments"+[].toString.apply(arguments));if(arguments.length===3&&(n=s,s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap getTiles called with invalid bounds "+t+", "+i);const o=[];for(let a=i,r=i+n;a<r;a++){o[a-i]=[];for(let l=t,h=t+s;l<h;l++){const c=this._calculateIndex(l,a);o[a-i].push(this._data[c])}}return o},N.prototype.getTileValuesForPainting=function(t,i,s,n,o){if(o=o||[],arguments.length<3)throw new Error("GameMap getTileValuesForPainting called with too few arguments"+[].toString.apply(arguments));arguments.length===3&&(n=s,s=i,i=t.y,t=t.x);const a=this.width,r=this.height;for(let l=i,h=i+n;l<h;l++)for(let c=t,f=t+s;c<f;c++){if(l<0||c<0||l>=r||c>=a){o[(l-i)*s+(c-t)]=Jt;continue}const _=c+l*a;this._data[_]||console.log(_,a,r,this._data),o[(l-i)*s+(c-t)]=this._data[_].getRawValue()}return o},N.prototype.getTileFromMapOrDefault=function(t,i,s){switch(i){case is:return t.y>0?this.getTileValue(t.x,t.y-1):s;case ss:return t.x<this.width-1?this.getTileValue(t.x+1,t.y):s;case ns:return t.y<this.height-1?this.getTileValue(t.x,t.y+1):s;case os:return t.x>0?this.getTileValue(t.x-1,t.y):s;default:return s}},N.prototype.setTile=function(t,i,s,n){if(arguments.length<3)throw new Error("GameMap setTile called with too few arguments"+[].toString.apply(arguments));if(arguments.length===3&&(n=s,s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap setTile called with invalid bounds "+t+", "+i);const o=this._calculateIndex(t,i);this._data[o].set(s,n)},N.prototype.setTo=function(t,i,s){if(arguments.length<2)throw new Error("GameMap setTo called with too few arguments"+[].toString.apply(arguments));if(s===void 0&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap setTo called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n]=s},N.prototype.setTileValue=function(t,i,s){if(arguments.length<2)throw new Error("GameMap setTileValue called with too few arguments"+[].toString.apply(arguments));arguments.length===2&&(s=i,i=t.y,t=t.x),this.testBounds(t,i)||(console.log("GameMap setTileValue called with invalid bounds "+t+", "+i),ReadableStreamDefaultController);const n=this._calculateIndex(t,i);!this._data[n]||this._data[n].setValue(s)},N.prototype.setTileFlags=function(t,i,s){if(arguments.length<2)throw new Error("GameMap setTileFlags called with too few arguments"+[].toString.apply(arguments));if(arguments.length===2&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap setTileFlags called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n].setFlags(s)},N.prototype.addTileFlags=function(t,i,s){if(arguments.length<2)throw new Error("GameMap addTileFlags called with too few arguments"+[].toString.apply(arguments));if(arguments.length===2&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap addTileFlags called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n].addFlags(s)},N.prototype.removeTileFlags=function(t,i,s){if(arguments.length<2)throw new Error("GameMap removeTileFlags called with too few arguments"+[].toString.apply(arguments));if(arguments.length===2&&(s=i,i=t.y,t=t.x),!this.testBounds(t,i))throw new Error("GameMap removeTileFlags called with invalid bounds "+t+", "+i);const n=this._calculateIndex(t,i);this._data[n].removeFlags(s)},N.prototype.putZone=function(t,i,s,n){let o,a;if(!this.testBounds(t,i)||!this.testBounds(t-1+n-1,i-1+n-1))throw new Error("GameMap putZone called with invalid bounds "+o+", "+a);let r=s-1-n;const l=t-1,h=i-1;for(a=h;a<h+n;a++)for(o=l;o<l+n;o++)o===t&&a===i?this.setTo(o,a,new X(r,as|xe)):this.setTo(o,a,new X(r,as)),r+=1};var zl=Object.defineProperty,W=u((t,i)=>zl(t,"name",{value:i,configurable:!0}),"u$f");let wn;const Xl=-1,jl=18,Zl=W(function(t){for(let i=0;i<t.width;i++)for(let s=0;s<t.height;s++)t.setTile(i,s,R,0)},"clearMap");W(function(t){for(let i=0;i<t.width;i++)for(let s=0;s<t.height;s++)t.getTileValue(i,s)>qs&&t.setTile(i,s,R,0)},"clearUnnatural");var Zo=W(function(t){const i=jl;let s,n;for(s=0;s<t.width;s++)for(n=0;n<t.height;n++)s<5||s>=t.width-5||n<5||n>=t.height-5?t.setTile(s,n,p,0):t.setTile(s,n,R,0);for(s=0;s<t.width-5;s+=2){let o=pi(i);Ne(t,new D(s,o)),o=t.height-10-pi(i),Ne(t,new D(s,o)),Ve(t,new D(s,0)),Ve(t,new D(s,t.height-6))}for(n=0;n<t.height-5;n+=2){let o=pi(i);Ne(t,new D(o,n)),o=t.width-10-pi(i),Ne(t,new D(o,n)),Ve(t,new D(0,n)),Ve(t,new D(t.width-6,n))}},"makeNakedIsland"),ql=W(function(t){Zo(t),Ko(t),qo(t)},"makeIsland"),Kl=W(function(t){let i;for(i=g(10);i>0;){const s=g(t.width-21)+10,n=g(t.height-20)+10;Ql(t,new D(s,n)),i--}},"makeLakes"),Ql=W(function(t,i){let s=g(12)+2;for(;s>0;){const n=new D(i,g(12)-6,g(12)-6);g(4)?Ve(t,n):Ne(t,n),s--}},"makeSingleLake");const Jl=W(function(t,i,s){let n;n=g(150)+50;let o=new D(i,s);for(;n>0;){const a=Go();if(o=D.move(o,a),!t.isPositionInBounds(o))return;t.getTileValue(o)===R&&t.setTile(o,qs,Xo),n--}},"treeSplash");var qo=W(function(t){let i;i=g(100)+50;for(let s=0;s<i;s++){const n=g(t.width-1),o=g(t.height-1);Jl(t,n,o)}Qo(t),Qo(t)},"doTrees");const th=[13|m,13|m,17|m,15|m,5|m,p,19|m,17|m,9|m,11|m,p,13|m,7|m,9|m,5|m,p];var Ko=W(function(t){const i=[-1,0,1,0],s=[0,1,0,-1];for(let n=0;n<t.width;n++)for(let o=0;o<t.height;o++)if(t.getTileValue(n,o)===O){let a=0;for(let l=0;l<4;l++){a=a<<1;const h=n+i[l],c=o+s[l];t.testBounds(h,c)&&t.getTileValue(h,c)!==R&&(t.getTileValue(h,c)<Zs||t.getTileValue(h,c)>Ks)&&a++}let r=th[a&15];r!==p&&g(1)&&r++,t.setTileValue(n,o,r,0)}},"smoothRiver");const vn=W(function(t){return t>=Zs&&t<=Ks},"isTree");var Qo=W(function(t){for(let i=0;i<t.width;i++)for(let s=0;s<t.height;s++)vn(t.getTileValue(i,s))&&ih(t,i,s,!1)},"smoothTrees");const eh=[0,0,0,34,0,0,36,35,0,32,0,33,30,31,29,37];var ih=W(function(t,i,s,n){const o=[-1,0,1,0],a=[0,1,0,-1];if(!vn(t.getTileValue(i,s)))return;let r=0;for(let h=0;h<4;h++){r=r<<1;const c=i+o[h],f=s+a[h];t.testBounds(c,f)&&vn(t.getTileValue(c,f))&&r++}let l=eh[r&15];l?(l!==qs&&i+s&1&&(l=l-8),t.setTile(i,s,l,Xo)):n||t.setTileValue(i,s,l,0)},"smoothTreesAt"),sh=W(function(t,i){let s=mn();Jo(t,i,s,s),s=s.oppositeDirection();const n=Jo(t,i,s,s);s=mn(),nh(t,i,s,n)},"doRivers"),Jo=W(function(t,i,s,n){let o,a;for(o=100,a=200;t.testBounds(i.x+4,i.y+4);)Ne(t,i),g(o)<10?n=s:(g(a)>90&&(n=n.rotateClockwise()),g(a)>90&&(n=n.rotateCounterClockwise())),i=D.move(i,n);return n},"doBRiver"),nh=W(function(t,i,s,n){let o,a;for(o=100,a=200;t.testBounds(i.x+3,i.y+3);)Ve(t,i),g(o)<10?n=s:(g(a)>90&&(n=n.rotateClockwise()),g(a)>90&&(n=n.rotateCounterClockwise())),i=D.move(i,n);return n},"doSRiver");const ta=W(function(t,i,s,n){if(i===0||!t.testBounds(s,n))return;const o=t.getTileValue(s,n);o!==R&&(o===p&&i!==G||o===G)||t.setTile(s,n,i,0)},"putOnMap");var Ne=W(function(t,i){const s=[[0,0,0,O,O,O,0,0,0],[0,0,O,p,p,p,O,0,0],[0,O,p,p,p,p,p,O,0],[O,p,p,p,p,p,p,p,O],[O,p,p,p,G,p,p,p,O],[O,p,p,p,p,p,p,p,O],[0,O,p,p,p,p,p,O,0],[0,0,O,p,p,p,O,0,0],[0,0,0,O,O,O,0,0,0]];for(let n=0;n<9;n++)for(let o=0;o<9;o++)ta(t,s[o][n],i.x+n,i.y+o)},"plopBRiver"),Ve=W(function(t,i){const s=[[0,0,O,O,0,0],[0,O,p,p,O,0],[O,p,p,p,p,O],[O,p,p,p,p,O],[0,O,p,p,O,0],[0,0,O,O,0,0]];for(let n=0;n<6;n++)for(let o=0;o<6;o++)ta(t,s[o][n],i.x+n,i.y+o)},"plopSRiver");W(function(t){let i,s,n,o;for(i=0;i<t.width;i++)for(s=0;s<t.height;s++)if(n=t.getTileValue(i,s),n>=Re&&n<=Pe){o=new D(i,s);let r=!1;ke(l=>{r||(n=t.getTileFromMap(o,l,Re),(n<Re||n>Pe)&&(t.setTileValue(i,s,O,0),r=!0))})}for(i=0;i<t.width;i++)for(s=0;s<t.height;s++)if(n=t.getTileValue(i,s),n!==G&&n>=Re&&n<=Pe){var a=!0;o=new D(i,s),ke(r=>{!a||(n=t.getTileFromMapOrDefault(o,r,Re),(n<Re||n>Pe)&&(a=!1))}),a&&t.setTileValue(i,s,p,0)}for(i=0;i<t.width;i++)for(s=0;s<t.height;s++)if(n=t.getTileValue(i,s),n>=Zs&&n<=Ks){o=new D(i,s);let r=!1;ke(l=>{r||(n=t.getTileFromMapOrDefault(o,l,TILE_INVALID),(n===p||n===G)&&(t.setTileValue(i,s,O,0),r=!0))})}},"smoothWater");const Sn=W(function(t,i){t=t||120,i=i||100,wn=g(2)-1;const s=new N(t,i);if(wn<0&&g(100)<10)return ql(s),s;if(wn===1?Zo(s):Zl(s),Xl!==0){const n=40+g(s.width-80),o=33+g(s.height-67),a=new D(n,o);sh(s,a)}return Kl(s),Ko(s),qo(s),s},"MapGenerator");var oh=Object.defineProperty,ea=u((t,i)=>oh(t,"name",{value:i,configurable:!0}),"h$d");const ah=ea(t=>t,"ID");class j{constructor(i,s,n){this.gameMapWidth=i,this.gameMapHeight=s,this.blockSize=n,this.data=[],this._width=this.convertToBlockCount(this.gameMapWidth),this._height=this.convertToBlockCount(this.gameMapHeight),this.clear()}get width(){return this._width}get height(){return this._height}get(i,s){const n=this.toIndex(i,s);return this.data[n]}set(i,s,n){const o=this.toIndex(i,s);this.data[o]=n}worldGet(i,s){const{x:n,y:o}=this.toBlockCoordinate(i,s);return this.get(n,o)}worldSet(i,s,n){const{x:o,y:a}=this.toBlockCoordinate(i,s);this.set(o,a,n)}clear(){this.forEach((i,s)=>this.set(i,s,0))}copyFrom(i,s=ah){this.hasIncompatibleDimensions(i)&&console.warn("Copying from incompatible blockMap!"),this.forEach((n,o)=>this.set(n,o,s(i.get(n,o))))}forEach(i){const s=this.width,n=this.height;for(let o=0;o<s;o++)for(let a=0;a<n;a++)i(o,a)}convertToBlockCount(i){return Math.floor((i+this.blockSize-1)/this.blockSize)}hasIncompatibleDimensions(i){return i.gameMapHeight!==this.gameMapHeight||i.gameMapWidth!==this.gameMapWidth||i.blockSize!==this.blockSize}toBlockCoordinate(i,s){const n=this.toBlockIndex(i),o=this.toBlockIndex(s);return{x:n,y:o}}toBlockIndex(i){return Math.floor(i/this.blockSize)}toIndex(i,s){return this.width*s+i}}u(j,"BlockMap"),ea(j,"BlockMap");var rh=Object.defineProperty,Be=u((t,i)=>rh(t,"name",{value:i,configurable:!0}),"t$5");const _t=Be(function(t){return function(i){return i instanceof X&&(i=i.getValue()),t.call(null,i)}},"unwrapTile"),lh=_t(function(t){return t>=Vr&&t<=Ur||t>=bt+2&&t<=bt+12||t>=di&&t<=Ji+2}),ia=_t(function(t){return t>=nn&&t<Qi}),hh=Be(function(t){return t.isZone()&&ia(t)},"isCommercialZone"),ch=_t(function(t){return t>=F&&t<=qi||t>=Q&&t<=wo}),uh=_t(function(t){return t>=_o&&t<F}),dh=_t(function(t){return t>=le&&t<Gr}),sa=_t(function(t){return t>=Qi&&t<qt}),ph=Be(function(t){return t.isZone()&&sa(t)},"isIndustrialZone"),fh=_t(function(t){return t>=di&&t<=Ji}),mh=_t(function(t){return t>=jt&&t<Zt}),na=_t(function(t){return t>=Zt&&t<ml}),gh=Be(function(t){return t.isZone()&&na(t)},"isResidentialZone"),_h=_t(function(t){return t>=F&&t<bt}),Eh=_t(function(t){return t>=F&&t<=qi+1?(t&15)+64:t}),Th=Be(function(){return new X(Qs+(Y()&3),K)},"randomFire"),wh=Be(function(){return new X(Zi+(Y()&3),m)},"randomRubble"),T={canBulldoze:lh,isCommercial:ia,isCommercialZone:hh,isDriveable:ch,isFire:uh,isFlood:dh,isIndustrial:sa,isIndustrialZone:ph,isManualExplosion:fh,isRail:mh,isResidential:na,isResidentialZone:gh,isRoad:_h,normalizeRoad:Eh,randomFire:Th,randomRubble:wh},Fe=1,Vt=2,Bt=3,de=4,He=5,_i=6,ls=7,Ei={SPRITE_TRAIN:Fe,SPRITE_HELICOPTER:Vt,SPRITE_AIRPLANE:Bt,SPRITE_SHIP:de,SPRITE_MONSTER:He,SPRITE_TORNADO:_i,SPRITE_EXPLOSION:ls};var vh=Object.defineProperty,We=u((t,i)=>vh(t,"name",{value:i,configurable:!0}),"d$c");const Sh=We(function(t){let i;switch(t){case Kt:case he:case kt:case Qt:i={zoneSize:4,deltaX:0,deltaY:0};break;case Kt+1:case dn:case dn+1:case dn+2:case he+1:case kt+1:case Qt+1:i={zoneSize:4,deltaX:-1,deltaY:0};break;case Kt+4:case he+4:case kt+4:case Qt+4:i={zoneSize:4,deltaX:0,deltaY:-1};break;case Kt+5:case he+5:case kt+5:case Qt+5:i={zoneSize:4,deltaX:-1,deltaY:-1};break;case H:i={zoneSize:6,deltaX:0,deltaY:0};break;case H+1:i={zoneSize:6,deltaX:-1,deltaY:0};break;case H+2:i={zoneSize:6,deltaX:-2,deltaY:0};break;case H+3:i={zoneSize:6,deltaX:-3,deltaY:0};break;case H+6:i={zoneSize:6,deltaX:0,deltaY:-1};break;case H+7:i={zoneSize:6,deltaX:-1,deltaY:-1};break;case H+8:i={zoneSize:6,deltaX:-2,deltaY:-1};break;case H+9:i={zoneSize:6,deltaX:-3,deltaY:-1};break;case H+12:i={zoneSize:6,deltaX:0,deltaY:-2};break;case H+13:i={zoneSize:6,deltaX:-1,deltaY:-2};break;case H+14:i={zoneSize:6,deltaX:-2,deltaY:-2};break;case H+15:i={zoneSize:6,deltaX:-3,deltaY:-2};break;case H+18:i={zoneSize:6,deltaX:0,deltaY:-3};break;case H+19:i={zoneSize:6,deltaX:-1,deltaY:-3};break;case H+20:i={zoneSize:6,deltaX:-2,deltaY:-3};break;case H+21:i={zoneSize:6,deltaX:-3,deltaY:-3};break;default:i={zoneSize:0,deltaX:0,deltaY:0};break}return i},"checkBigZone"),yh=We(function(t){return t>=Zt-1&&t<=qt-1||t>=ln+1&&t<=hn+4||t>=Dl&&t<=Cl?3:t>=qt&&t<=_l||t>=rn&&t<=ln||t>=Do&&t<=cn?4:0},"checkZoneSize"),bh=We(function(t,i,s,n){const o=t.getTileValue(i,s);let a=2,r=n.rateOfGrowthMap.worldGet(i,s);r=d.clamp(r-20,-200,200),n.rateOfGrowthMap.worldSet(i,s,r),o===H?a=5:o>=qt?a=3:o<qt&&(a=2);for(let l=-1;l<a;l++)for(let h=-1;h<a;h++){const c=i+l,f=s+h;!t.testBounds(c,f)||t.getTileValue(c,f>=F)&&t.addTileFlags(c,f,m)}},"fireZone"),Oh=We(function(t,i,s){let n=t.landValueMap.worldGet(i,s);return n-=t.pollutionDensityMap.worldGet(i,s),n<30?0:n<80?1:n<150?2:3},"getLandPollutionValue"),Dh=We(function(t,i,s,n){const o=t.rateOfGrowthMap.worldGet(i,s),a=d.clamp(o+n*4,-200,200);t.rateOfGrowthMap.worldSet(i,s,a)},"incRateOfGrowth"),Ch=We(function(t,i,s,n,o){for(let a=-1;a<2;a++)for(let r=-1;r<2;r++){const l=t.getTileValue(i+r,s+a);if(l>=le&&l<F)return}t.putZone(i,s,n,3),t.addTileFlags(i,s,m),o&&t.addTileFlags(i,s,Nt)},"putZone"),A={checkBigZone:Sh,checkZoneSize:yh,fireZone:bh,getLandPollutionValue:Oh,incRateOfGrowth:Dh,putZone:Ch};var Mh=Object.defineProperty,Ct=u((t,i)=>Mh(t,"name",{value:i,configurable:!0}),"s$i");const Ti=Ct(function(t){return t>>4},"pixToWorld"),Rh=Ct(function(t){return t<<4},"worldToPix"),Ph=Ct(function(t,i){return t===i||(t<i?i-t<4?t++:t--:t-i<4?t--:t++,t>8&&(t=1),t<1&&(t=8)),t},"turnTo"),$h=Ct(function(t,i,s){const n=Ti(i),o=Ti(s);return n<0||n>=t.width||o<0||o>=t.height?-1:t.getTileValue(n,o)},"getTileValue"),Ah=[0,3,2,1,3,4,5,7,6,5,7,8,1],Lh=Ct(function(t,i,s,n){let o=s-t,a=n-i,r;return o<0?a<0?r=11:r=8:a<0?r=2:r=5,o=Math.abs(o),a=Math.abs(a),o*2<a?r++:a*2<o&&r--,(r<0||r>12)&&(r=0),Ah[r]},"getDir"),Ih=Ct(function(t,i,s,n){const o=s-t,a=n-i;return Math.abs(o)+Math.abs(a)},"absoluteDistance"),kh=Ct(function(t){return t===Lt||t===Yt||t===pt||t===Xt||t===$e||t===Ae},"checkWet"),xh=Ct(function(t,i,s,n,o){const a=Ti(n),r=Ti(o);if(!i.testBounds(a,r))return;const l=i.getTile(a,r),h=l.getValue();if(!(h<ji)){if(!l.isCombustible()){h>=F&&h<=qi&&i.setTile(a,r,p,0);return}l.isZone()&&(A.fireZone(i,a,r,s),h>en&&t.makeExplosionAt(n,o)),kh(h)?i.setTile(a,r,p,0):i.setTile(a,r,di,m|K)}},"destroyMapTile"),Nh=Ct(function(t,i,s,n){return Math.abs(t-s)+Math.abs(i-n)},"getDistance"),Vh=Ct(function(t,i){return t.frame!==0&&i.frame!==0&&Nh(t.x,t.y,i.x,i.y)<30},"checkSpriteCollision"),E={absoluteDistance:Ih,checkSpriteCollision:Vh,destroyMapTile:xh,getDir:Lh,getTileValue:$h,turnTo:Ph,pixToWorld:Ti,worldToPix:Rh};var Bh=Object.defineProperty,Fh=u((t,i)=>Bh(t,"name",{value:i,configurable:!0}),"c$e");function V(t,i){this._map=t,this._stack=[],this._spriteManager=i}u(V,"s$h"),Fh(V,"Traffic"),V.prototype.makeTraffic=function(t,i,s,n){this._stack=[];const o=new D(t,i);return this.findPerimeterRoad(o)?this.tryDrive(o,n)?(this.addToTrafficDensityMap(s),V.ROUTE_FOUND):V.NO_ROUTE_FOUND:V.NO_ROAD_FOUND},V.prototype.addToTrafficDensityMap=function(t){const i=t.trafficDensityMap;for(;this._stack.length>0;){const s=this._stack.pop();if(!this._map.testBounds(s.x,s.y))continue;const n=this._map.getTileValue(s.x,s.y);if(n>=F&&n<bt){let o=i.worldGet(s.x,s.y);if(o+=50,o=Math.min(o,240),i.worldSet(s.x,s.y,o),o>=240&&g(5)===0){const a=this._spriteManager.getSprite(Vt);a!==null&&(a.destX=E.worldToPix(s.x),a.destY=E.worldToPix(s.y))}}}};const Hh=[-1,0,1,2,2,2,1,0,-1,-2,-2,-2],Wh=[-2,-2,-2,-1,0,1,2,2,2,1,0,-1];V.prototype.findPerimeterRoad=function(t){for(let i=0;i<12;i++){const s=t.x+Hh[i],n=t.y+Wh[i];if(this._map.testBounds(s,n)&&T.isDriveable(this._map.getTileValue(s,n)))return t.x=s,t.y=n,!0}return!1};const Uh=30;V.prototype.tryDrive=function(t,i){let s,n=new D(t.x,t.y);for(let o=0;o<Uh;o++){const a=this.tryGo(n,s);if(a){if(n=D.move(n,a),s=a.oppositeDirection(),o&1&&this._stack.push(new D(n.x,n.y)),this.driveDone(n,i))return!0}else if(this._stack.length>0)this._stack.pop(),o+=3;else return!1}return!1},V.prototype.tryGo=function(t,i){const s=[];let n=0;if(ke(a=>{a!==i&&T.isDriveable(this._map.getTileFromMapOrDefault(t,a,R))&&(s.push(a),n++)}),n===0)return;if(n===1)return s[0];const o=g(s.length-1);return s[o]},V.prototype.driveDone=function(t,i){return!!(t.y>0&&i(this._map.getTileValue(t.x,t.y-1))||t.x<this._map.width-1&&i(this._map.getTileValue(t.x+1,t.y))||t.y<this._map.height-1&&i(this._map.getTileValue(t.x,t.y+1))||t.x>0&&i(this._map.getTileValue(t.x-1,t.y)))},Object.defineProperties(V,{ROUTE_FOUND:d.makeConstantDescriptor(1),NO_ROUTE_FOUND:d.makeConstantDescriptor(0),NO_ROAD_FOUND:d.makeConstantDescriptor(-1)});var Gh=Object.defineProperty,wi=u((t,i)=>Gh(t,"name",{value:i,configurable:!0}),"u$d");const oa=wi(function(t,i,s,n){return n===on?0:Math.floor((n-yo)/9)%5+1},"getZonePopulation"),aa=wi(function(t,i,s,n,o,a){const r=(o*5+n)*9+yo;A.putZone(t,i,s,r,a)},"placeCommercial"),Yh=wi(function(t,i,s,n,o,a,r){let l=n.landValueMap.worldGet(i,s);l=l>>5,!(o>l)&&o<5&&(aa(t,i,s,o,a,r),A.incRateOfGrowth(n,i,s,8))},"growZone"),ra=wi(function(t,i,s,n,o,a,r){o>1?aa(t,i,s,o-2,a,r):A.putZone(t,i,s,on,r),A.incRateOfGrowth(n,i,s,-8)},"degradeZone"),zh=wi(function(t,i,s,n){let o;n.census.comZonePop+=1;const a=t.getTileValue(i,s),r=oa(t,i,s,a);n.census.comPop+=r;const l=t.getTile(i,s).isPowered();let h=V.ROUTE_FOUND;if(r>g(5)&&(h=n.trafficManager.makeTraffic(i,s,n.blockMaps,T.isIndustrial),h===V.NO_ROAD_FOUND)){o=A.getLandPollutionValue(n.blockMaps,i,s),ra(t,i,s,n.blockMaps,r,o,l);return}if(x(7)){const c=h===V.NO_ROAD_FOUND?-3e3:n.blockMaps.cityCentreDistScoreMap.worldGet(i,s);let f=n.valves.comValve+c;if(l||(f=-500),l&&f>-350&&f-26380>ce()){o=A.getLandPollutionValue(n.blockMaps,i,s),Yh(t,i,s,n.blockMaps,r,o,l);return}f<350&&f+26380<ce()&&(o=A.getLandPollutionValue(n.blockMaps,i,s),ra(t,i,s,n.blockMaps,r,o,l))}},"commercialFound"),la={registerHandlers:function(t,i){t.addAction(T.isCommercialZone,zh)},getZonePopulation:oa};var Xh=Object.defineProperty,Ue=u((t,i)=>Xh(t,"name",{value:i,configurable:!0}),"f$c"),ha=Ue(function(t,i,s,n){return n===an?0:Math.floor((n-ui)/9)%4+1},"getZonePopulation"),ca=Ue(function(t,i,s,n,o,a){var r=(o*4+n)*9+ui;A.putZone(t,i,s,r,a)},"placeIndustrial"),jh=Ue(function(t,i,s,n,o,a,r){o<4&&(ca(t,i,s,o,a,r),A.incRateOfGrowth(n,i,s,8))},"growZone"),ua=Ue(function(t,i,s,n,o,a,r){o>1?ca(t,i,s,o-2,a,r):A.putZone(t,i,s,an,r),A.incRateOfGrowth(n,i,s,-8)},"degradeZone"),Zh=[!0,!1,!0,!0,!1,!1,!0,!0],yn=[-1,0,1,0,0,0,0,1],bn=[-1,0,-1,-1,0,0,-1,-1],qh=Ue(function(t,i,s,n,o){if(!(n<ui)){var a=n-ui>>3;Zh[a]&&o?t.addTileFlags(i+yn[a],s+bn[a],Hl):(t.addTileFlags(i+yn[a],s+bn[a],as),t.removeTileFlags(i+yn[a],s+bn[a],K))}},"setAnimation"),Kh=Ue(function(t,i,s,n){n.census.indZonePop+=1;var o=t.getTileValue(i,s),a=ha(t,i,s,o);n.census.indPop+=a;var r=t.getTile(i,s).isPowered();qh(t,i,s,o,r);var l=V.ROUTE_FOUND;if(a>g(5)&&(l=n.trafficManager.makeTraffic(i,s,n.blockMaps,T.isResidential),l===V.NO_ROAD_FOUND)){var h=Y()&1;ua(t,i,s,n.blockMaps,a,h,r);return}if(x(7)){var c=n.valves.indValve+(l===V.NO_ROAD_FOUND?-1e3:0);if(r||(c=-500),c>-350&&c-26380>ce()){jh(t,i,s,n.blockMaps,a,Y()&1,r);return}c<350&&c+26380<ce()&&ua(t,i,s,n.blockMaps,a,Y()&1,r)}},"industrialFound"),da={registerHandlers:function(t,i){t.addAction(T.isIndustrialZone,Kh)},getZonePopulation:ha},Qh=Object.defineProperty,Et=u((t,i)=>Qh(t,"name",{value:i,configurable:!0}),"u$c");const On=Et(function(t,i,s,n,o,a){const r=(o*4+n)*9+en;A.putZone(t,i,s,r,a)},"placeResidential"),Jh=Et(function(t,i,s,n){let o=0;for(let a=i-1;a<=i+1;a++)for(let r=s-1;r<=s+1;r++)a===i&&r===s||(n=t.getTileValue(a,r),n>=Ki&&n<=So&&(o+=1));return o},"getFreeZonePopulation"),pa=Et(function(t,i,s,n){return n instanceof X&&(n=tile.getValue()),n===Le?Jh(t,i,s,n):(Math.floor((n-en)/9)%4+1)*8+16},"getZonePopulation"),tc=Et(function(t,i,s){const n=[0,1,0,-1],o=[-1,0,1,0];if(!t.testBounds(i,s))return-1;let a=t.getTileValue(i,s);if(a<Zt||a>Zt+8)return-1;let r=1;for(let l=0;l<4;l++){const h=i+n[l],c=s+o[l];h<0||h>=t.width||c<0||c>=t.height||(a=t.getTileValue(h,c),a!==R&&a<=qi&&(r+=1))}return r},"evalLot"),ec=Et(function(t,i,s,n){let o=0,a=0;const r=[0,-1,0,1,-1,1,-1,0,1],l=[0,-1,-1,-1,0,0,1,1,1];for(let h=0;h<9;h++){const c=i+r[h],f=s+l[h],_=tc(t,c,f);_>a?(a=_,o=h):_===a&&x(7)&&(o=h)}o>0&&t.testBounds(i+r[o],s+l[o])&&t.setTile(i+r[o],s+l[o],vo+g(2)+n*3,gi)},"buildHouse"),ic=Et(function(t,i,s,n,o,a,r){if(!(n.pollutionDensityMap.worldGet(i,s)>128)){if(t.getTileValue(i,s)===Le){o<8?(ec(t,i,s,a),A.incRateOfGrowth(n,i,s,1)):n.populationDensityMap.worldGet(i,s)>64&&(On(t,i,s,0,a,r),A.incRateOfGrowth(n,i,s,8));return}o<40&&(On(t,i,s,Math.floor(o/8)-1,a,r),A.incRateOfGrowth(n,i,s,8))}},"growZone"),sc=[0,3,6,1,4,7,2,5,8],fa=Et(function(t,i,s,n,o,a,r){let l,h;if(o===0)return;if(o>16){On(t,i,s,Math.floor((o-24)/8),a,r),A.incRateOfGrowth(n,i,s,-8);return}if(o===16){for(t.setTile(i,s,Le,gi|xe),h=s-1;h<=s+1;h++)for(l=i-1;l<=i+1;l++)l===i&&h===s||t.setTile(i,s,Ki+a+g(2),gi);A.incRateOfGrowth(n,i,s,-8);return}let c=0;for(A.incRateOfGrowth(n,i,s,-1),l=i-1;l<=i+1;l++)for(h=s-1;h<=s+1;h++,c++){const f=t.getTileValue(l,h);if(f>=Ki&&f<=So){t.setTile(l,h,sc[c]+Zt,gi);return}}},"degradeZone"),nc=Et(function(t,i,s,n){if(n===V.NO_ROAD_FOUND)return-3e3;let o=t.landValueMap.worldGet(i,s);return o-=t.pollutionDensityMap.worldGet(i,s),o<0?o=0:o=Math.min(o*32,6e3),o-3e3},"evalResidential"),oc=Et(function(t,i,s,n){let o;n.census.resZonePop+=1;const a=t.getTileValue(i,s),r=pa(t,i,s,a);n.census.resPop+=r;const l=t.getTile(i,s).isPowered();let h=V.ROUTE_FOUND;if(r>g(35)&&(h=n.trafficManager.makeTraffic(i,s,n.blockMaps,T.isCommercial),h===V.NO_ROAD_FOUND)){o=A.getLandPollutionValue(n.blockMaps,i,s),fa(t,i,s,n.blockMaps,r,o,l);return}if(a===Le||x(7)){const c=nc(n.blockMaps,i,s,h);let f=n.valves.resValve+c;if(l||(f=-500),f>-350&&f-26380>ce()){if(r===0&&x(3)){ma(t,i,s,n,l);return}o=A.getLandPollutionValue(n.blockMaps,i,s),ic(t,i,s,n.blockMaps,r,o,l);return}f<350&&f+26380<ce()&&(o=A.getLandPollutionValue(n.blockMaps,i,s),fa(t,i,s,n.blockMaps,r,o,l))}},"residentialFound");function ma(t,i,s,n,o){n.census.needHospital>0&&(A.putZone(t,i,s,sn,o),n.census.needHospital=0)}u(ma,"U$3"),Et(ma,"makeHospital");const ac=Et(function(t,i,s,n){n.census.hospitalPop+=1,n.census.needHospital===-1&&g(20)===0&&A.putZone(t,i,s,Le,t.getTile(i,s).isPowered())},"hospitalFound"),ga={registerHandlers:function(t,i){t.addAction(T.isResidentialZone,oc),t.addAction(sn,ac),i.addAction(sn,15,3)},getZonePopulation:pa};var rc=Object.defineProperty,Tt=u((t,i)=>rc(t,"name",{value:i,configurable:!0}),"d$b");const te=0,vi=1,ft=Tt(function(t,i,s){for(let n=0,o=t.width;n<o;n++)for(let a=0,r=t.height;a<r;a++){let l=0;n>0&&(l+=t.get(n-1,a)),n<t.width-1&&(l+=t.get(n+1,a)),a>0&&(l+=t.get(n,a-1)),a<t.height-1&&(l+=t.get(n,a+1)),s===te?(l=t.get(n,a)+Math.floor(l/4),i.set(n,a,Math.floor(l/2))):(l=l+t.get(n,a)>>2,l>255&&(l=255),i.set(n,a,l))}},"smoothMap"),lc=Tt(function(t){const i=t.rateOfGrowthMap;for(let s=0,n=i.width;s<n;s++)for(let o=0,a=i.height;o<a;o++){let r=i.get(s,o);r!==0&&(r>0?r--:r++,r=d.clamp(r,-200,200),i.set(s,o,r))}},"neutraliseRateOfGrowthMap"),hc=Tt(function(t){const i=t.trafficDensityMap;for(let s=0,n=i.width;s<n;s++)for(let o=0,a=i.height;o<a;o++){let r=i.get(s,o);r!==0&&(r<=24?r=0:r>200?r=r-34:r=r-24,i.set(s,o,r))}},"neutraliseTrafficMap"),cc=Tt(function(t){if(t<bt){if(t>=tn)return 75;if(t>=Js)return 50;if(t<F){if(t>_o)return 90;if(t>=ai)return 255}return 0}return t<=gl?0:t<qt?50:t<=ln?100:0},"getPollutionValue"),_a=Tt(function(t,i,s){let n,o;return i>t.cityCentreX?n=i-t.cityCentreX:n=t.cityCentreX-i,s>t.cityCentreY?o=s-t.cityCentreY:o=t.cityCentreY-s,Math.min(n+o,64)},"getCityCentreDistance"),uc=Tt(function(t,i,s){const n=s.tempMap1,o=s.tempMap2,a=s.tempMap3;a.clear();const r=s.landValueMap,l=s.terrainDensityMap,h=s.pollutionDensityMap,c=s.crimeRateMap;let f,_,S,w,C=0,M=0;for(f=0,S=r.width;f<S;f++)for(_=0,w=r.height;_<w;_++){let I=0,B=!1;const mo=f*2,go=_*2;for(let nt=mo;nt<=mo+1;nt++)for(let Xi=go;Xi<=go+1;Xi++){const js=t.getTileValue(nt,Xi);if(js!==R){if(js<Zi){const Hf=a.worldGet(nt,Xi);a.worldSet(nt,Xi,Hf+15);continue}I+=cc(js),js>=F&&(B=!0)}}if(I=Math.min(I,255),n.set(f,_,I),B){let nt=34-Math.floor(_a(t,mo,go)/2);nt=nt<<2,nt+=l.get(f>>1,_>>1),nt-=h.get(f,_),c.get(f,_)>190&&(nt-=20),nt=d.clamp(nt,1,250),r.set(f,_,nt),C+=nt,M++}else r.set(f,_,0)}M>0?i.landValueAverage=Math.floor(C/M):i.landValueAverage=0,ft(n,o,vi),ft(o,n,vi);let it=0,ct=0,st=0;for(f=0,S=t.width;f<S;f+=h.blockSize)for(_=0,w=t.height;_<w;_+=h.blockSize){const I=n.worldGet(f,_);h.worldSet(f,_,I),I!==0&&(ct++,st+=I,(I>it||I===it&&x(3))&&(it=I,t.pollutionMaxX=f,t.pollutionMaxY=_))}ct?i.pollutionAverage=Math.floor(st/ct):i.pollutionAverage=0,ft(a,l,te)},"pollutionTerrainLandValueScan"),dc=Tt(function(t,i){const s=i.policeStationMap,n=i.policeStationEffectMap,o=i.crimeRateMap,a=i.landValueMap,r=i.populationDensityMap;ft(s,n,te),ft(n,s,te),ft(s,n,te);let l=0,h=0;for(let S=0,w=o.mapWidth,C=o.blockSize;S<w;S+=C)for(var c=0,f=o.mapHeight,_;c<f;c+=C){let M=a.worldGet(S,c);M>0?(h+=1,M=128-M,M+=r.worldGet(S,c),M=Math.min(M,300),M-=s.worldGet(S,c),M=d.clamp(M,0,250),o.worldSet(S,c,M),l+=M):o.worldSet(S,c,0)}h>0?t.crimeAverage=Math.floor(l/h):t.crimeAverage=0},"crimeScan"),pc=Tt(function(t,i){const s=i.cityCentreDistScoreMap;for(let n=0,o=s.width;n<o;n++)for(let a=0,r=s.height;a<r;a++){let l=Math.floor(_a(t,n*8,a*8)/2);l=l*4,l=64-l,s.set(n,a,l)}},"fillCityCentreDistScoreMap"),fc=Tt(function(t,i,s,n){return n<nn?ga.getZonePopulation(t,i,s,n):n<Qi?la.getZonePopulation(t,i,s,n)*8:n<qt?da.getZonePopulation(t,i,s,n)*8:0},"getPopulationDensity"),mc=Tt(function(t,i){const s=i.tempMap1,n=i.tempMap2;i.populationDensityMap;let o=0,a=0,r=0;s.clear();for(let l=0,h=t.width;l<h;l++)for(let c=0,f=t.height;c<f;c++){const _=t.getTile(l,c);if(_.isZone()){const S=_.getValue();let w=fc(t,l,c,S)*8;w=Math.min(w,254),s.worldSet(l,c,w),o+=l,a+=c,r++}}ft(s,n,vi),ft(n,s,vi),ft(s,n,vi),i.populationDensityMap.copyFrom(n,function(l){return l*2}),pc(t,i),r>0?(t.cityCentreX=Math.floor(o/r),t.cityCentreY=Math.floor(a/r)):(t.cityCentreX=Math.floor(t.width/2),t.cityCentreY=Math.floor(t.height/2))},"populationDensityScan"),gc=Tt(function(t){const i=t.fireStationMap,s=t.fireStationEffectMap;ft(i,s,te),ft(s,i,te),ft(i,s,te)},"fireAnalysis"),Mt={crimeScan:dc,fireAnalysis:gc,neutraliseRateOfGrowthMap:lc,neutraliseTrafficMap:hc,pollutionTerrainLandValueScan:uc,populationDensityScan:mc},_c={debug:!1,gameDebug:!1,queryDebug:!1};var Ec=Object.defineProperty,Si=u((t,i)=>Ec(t,"name",{value:i,configurable:!0}),"s$g");const ht=Si(function(t){const i={},s=Si(function(r,l){r in i||(i[r]=[]);const h=i[r];h.indexOf(l)===-1&&h.push(l)},"addListener"),n=Si(function(r,l){r in i||(i[r]=[]);const h=i[r],c=h.indexOf(l);c!==-1&&h.splice(c,1)},"removeListener"),o=Si(function(r,l){r===void 0&&console.warn("Sending undefined event!"),r in i||(i[r]=[]);const h=i[r];for(let c=0,f=h.length;c<f;c++)h[c](l)},"emitEvent"),a=Si(function(r,l){if(["addEventListener","removeEventListener","_emitEvent"].some(function(h){return r[h]!==void 0}))throw new Error("Cannot decorate "+l+": existing properties would be overwritten!");r.addEventListener=s,r.removeEventListener=n,r._emitEvent=o},"addProps");return typeof t=="object"?a(t,"object"):a(t.prototype,"constructor"),t},"EventEmitter"),Dn="Autobudget changed",Ge="User needs to budget",Ea="Budget window requested",Cn="Budget window closed",hs="Blackouts reported",Mn="Classification updated",Tc="Congratulations showing",wc="Congratulations window closed",cs="Date changed",Ta="Debug Window Requested",Rn="Debug Window Closed",wa="Disaster Requested",Pn="Disaster window closed",yi="Earthquake",va="Evaluation Requested",vc="Evaluation Updated",$n="Eval window closed",bi="Explosion Reported",Oi="Fire!",us="Fire station needs funding",Di="Flooding reported",L="Front-end Message",Ye="Total funds has changed",ee="Total funds has changed",Ci="Helicopter crashed",ds="High crime",ps="High pollution",Mi="Monster sighted",Sc="Nag window closed",fs="Airport needed",ms="More power needed",gs="Fire station needed",_s="More commercial zones needed",Es="More industrial zones needed",Ts="More railways needed",ws="More residential needed",vs="More roads needed",Ss="Police station needed",ys="Seaport needed",bs="Stadium needed",pe="No money",ze="Not enough power",Ri="Nuclear Meltdown",Pi="Plane crashed",Os="Police need funding",An="Population updated",Ln="Query window closed",fe="Query window needed",$i="Now a capital",Ai="Now a city",Li="Now a metropolis",Ii="Now a megalopolis",ki="Now a town",Sa="Now a village",Ds="Roads need funding",ya="Save requested",In="Save window closed",kn="Scoe updated",xn="Screenshot link closed",Nn="Screenshot window closed",ba="Screenshot window requested",Vn="Settings window closed",Oa="Settings window requested",xi="Shipwrecked",Cs="Explosion! Bang!",Bn="Explosion! Bang!",Da="Heavy Traffic sound",Ca="HonkHonk sound",Ma="Monster sound",Fn="Speed change",Ms="Sprite dying",Hn="Sprite move",Rs="Tax too high",Ni="Tool clicked",Xe="Tornado sighted",Wn="Touch Window closed",Ps="Traffic jams reported",Vi="Train crashed",je="Valves updated",Un="Welcome",me=[yi,bi,Oi,Di,Mi,Ri,Xe],ge=[Ci,Pi,xi,Vi];var Ra=Object.freeze({__proto__:null,AUTOBUDGET_CHANGED:Dn,BUDGET_NEEDED:Ge,BUDGET_REQUESTED:Ea,BUDGET_WINDOW_CLOSED:Cn,BLACKOUTS_REPORTED:hs,CLASSIFICATION_UPDATED:Mn,CONGRATS_SHOWING:Tc,CONGRATS_WINDOW_CLOSED:wc,DATE_UPDATED:cs,DEBUG_WINDOW_REQUESTED:Ta,DEBUG_WINDOW_CLOSED:Rn,DISASTER_REQUESTED:wa,DISASTER_WINDOW_CLOSED:Pn,EARTHQUAKE:yi,EVAL_REQUESTED:va,EVAL_UPDATED:vc,EVAL_WINDOW_CLOSED:$n,EXPLOSION_REPORTED:bi,FIRE_REPORTED:Oi,FIRE_STATION_NEEDS_FUNDING:us,FLOODING_REPORTED:Di,FRONT_END_MESSAGE:L,FUNDS_CHANGED:Ye,HEAVY_TRAFFIC:ee,HELICOPTER_CRASHED:Ci,HIGH_CRIME:ds,HIGH_POLLUTION:ps,MONSTER_SIGHTED:Mi,NAG_WINDOW_CLOSED:Sc,NEED_AIRPORT:fs,NEED_ELECTRICITY:ms,NEED_FIRE_STATION:gs,NEED_MORE_COMMERCIAL:_s,NEED_MORE_INDUSTRIAL:Es,NEED_MORE_RAILS:Ts,NEED_MORE_RESIDENTIAL:ws,NEED_MORE_ROADS:vs,NEED_POLICE_STATION:Ss,NEED_SEAPORT:ys,NEED_STADIUM:bs,NO_MONEY:pe,NOT_ENOUGH_POWER:ze,NUCLEAR_MELTDOWN:Ri,PLANE_CRASHED:Pi,POLICE_NEEDS_FUNDING:Os,POPULATION_UPDATED:An,QUERY_WINDOW_CLOSED:Ln,QUERY_WINDOW_NEEDED:fe,REACHED_CAPITAL:$i,REACHED_CITY:Ai,REACHED_METROPOLIS:Li,REACHED_MEGALOPOLIS:Ii,REACHED_TOWN:ki,REACHED_VILLAGE:Sa,ROAD_NEEDS_FUNDING:Ds,SAVE_REQUESTED:ya,SAVE_WINDOW_CLOSED:In,SCORE_UPDATED:kn,SCREENSHOT_LINK_CLOSED:xn,SCREENSHOT_WINDOW_CLOSED:Nn,SCREENSHOT_WINDOW_REQUESTED:ba,SETTINGS_WINDOW_CLOSED:Vn,SETTINGS_WINDOW_REQUESTED:Oa,SHIP_CRASHED:xi,SOUND_EXPLOSIONHIGH:Cs,SOUND_EXPLOSIONLOW:Bn,SOUND_HEAVY_TRAFFIC:Da,SOUND_HONKHONK:Ca,SOUND_MONSTER:Ma,SPEED_CHANGE:Fn,SPRITE_DYING:Ms,SPRITE_MOVED:Hn,TAX_TOO_HIGH:Rs,TOOL_CLICKED:Ni,TORNADO_SIGHTED:Xe,TOUCH_WINDOW_CLOSED:Wn,TRAFFIC_JAMS:Ps,TRAIN_CRASHED:Vi,VALVES_UPDATED:je,WELCOME:Un,DISASTER_MESSAGES:me,CRASHES:ge});const yc=100,bc=100,Oc=1,Dc=2,at=ht(function(){Object.defineProperties(this,{MAX_ROAD_EFFECT:d.makeConstantDescriptor(32),MAX_POLICESTATION_EFFECT:d.makeConstantDescriptor(1e3),MAX_FIRESTATION_EFFECT:d.makeConstantDescriptor(1e3)}),this.roadEffect=this.MAX_ROAD_EFFECT,this.policeEffect=this.MAX_POLICESTATION_EFFECT,this.fireEffect=this.MAX_FIRESTATION_EFFECT,this.totalFunds=0,this.cityTax=7,this.cashFlow=0,this.taxFund=0,this.roadMaintenanceBudget=0,this.fireMaintenanceBudget=0,this.policeMaintenanceBudget=0,this.roadPercent=1,this.firePercent=1,this.policePercent=1,this.roadSpend=0,this.fireSpend=0,this.policeSpend=0,this.awaitingValues=!1,this.autoBudget=!0}),_e=["autoBudget","totalFunds","policePercent","roadPercent","firePercent","roadSpend","policeSpend","fireSpend","roadMaintenanceBudget","policeMaintenanceBudget","fireMaintenanceBudget","cityTax","roadEffect","policeEffect","fireEffect"];at.prototype.save=function(t){for(let i=0,s=_e.length;i<s;i++)t[_e[i]]=this[_e[i]]},at.prototype.load=function(t){for(let i=0,s=_e.length;i<s;i++)this[_e[i]]=t[_e[i]]||this[_e[i]];this._emitEvent(Dn,this.autoBudget),this._emitEvent(Ye,this.totalFunds)},at.prototype.setAutoBudget=function(t){this.autoBudget=t,this._emitEvent(Dn,this.autoBudget)};const Cc=[.7,.9,1.2],Mc=[1.4,1.2,.8];at.prototype._calculateBestPercentages=function(){if(this.roadSpend=Math.round(this.roadMaintenanceBudget*this.roadPercent),this.fireSpend=Math.round(this.fireMaintenanceBudget*this.firePercent),this.policeSpend=Math.round(this.policeMaintenanceBudget*this.policePercent),this.roadSpend+this.fireSpend+this.policeSpend===0)return this.roadPercent=1,this.firePercent=1,this.policePercent=1,{road:1,fire:1,police:1};let t=0,i=0,s=0,n=this.totalFunds+this.taxFund;return n>=this.roadSpend?t=this.roadSpend:t=n,n-=t,n>=this.fireSpend?i=this.fireSpend:i=n,n-=i,n>=this.policeSpend?s=this.policeSpend:s=n,n-=s,this.roadMaintenanceBudget>0?this.roadPercent=(t/this.roadMaintenanceBudget).toPrecision(2)-0:this.roadPercent=1,this.fireMaintenanceBudget>0?this.firePercent=(i/this.fireMaintenanceBudget).toPrecision(2)-0:this.firePercent=1,this.policeMaintenanceBudget>0?this.policePercent=(s/this.policeMaintenanceBudget).toPrecision(2)-0:this.policePercent=1,{road:t,police:s,fire:i}},at.prototype.doBudgetWindow=function(){return this.doBudgetNow(!0)},at.prototype.doBudgetNow=function(t){const i=this._calculateBestPercentages();if(!this.autoBudget&&!t){this.autoBudget=!1,this.awaitingValues=!0,this._emitEvent(Ge);return}const s=i.road,n=i.police,o=i.fire,a=s+n+o;if(this.totalFunds+this.taxFund-a>0&&this.autoBudget||t){this.awaitingValues=!1,this.doBudgetSpend(s,o,n);return}this.setAutoBudget(!1),this.awaitingValues=!0,this._emitEvent(Ge),this._emitEvent(pe)},at.prototype.doBudgetSpend=function(t,i,s){this.roadSpend=t,this.fireSpend=i,this.policeSpend=s;const n=this.roadSpend+this.fireSpend+this.policeSpend;this.spend(-(this.taxFund-n)),this.updateFundEffects()},at.prototype.updateFundEffects=function(){this.roadSpend=Math.round(this.roadMaintenanceBudget*this.roadPercent),this.fireSpend=Math.round(this.fireMaintenanceBudget*this.firePercent),this.policeSpend=Math.round(this.policeMaintenanceBudget*this.policePercent),this.roadEffect=this.MAX_ROAD_EFFECT,this.policeEffect=this.MAX_POLICESTATION_EFFECT,this.fireEffect=this.MAX_FIRESTATION_EFFECT,this.roadMaintenanceBudget>0&&(this.roadEffect=Math.floor(this.roadEffect*this.roadSpend/this.roadMaintenanceBudget)),this.fireMaintenanceBudget>0&&(this.fireEffect=Math.floor(this.fireEffect*this.fireSpend/this.fireMaintenanceBudget)),this.policeMaintenanceBudget>0&&(this.policeEffect=Math.floor(this.policeEffect*this.policeSpend/this.policeMaintenanceBudget))},at.prototype.collectTax=function(t,i){this.cashFlow=0,this.policeMaintenanceBudget=i.policeStationPop*yc,this.fireMaintenanceBudget=i.fireStationPop*bc;const s=i.roadTotal*Oc,n=i.railTotal*Dc;this.roadMaintenanceBudget=Math.floor((s+n)*Cc[t]),this.taxFund=Math.floor(Math.floor(i.totalPop*i.landValueAverage/120)*this.cityTax*Mc[t]),i.totalPop>0?(this.cashFlow=this.taxFund-(this.policeMaintenanceBudget+this.fireMaintenanceBudget+this.roadMaintenanceBudget),this.doBudgetNow(!1)):(this.roadEffect=this.MAX_ROAD_EFFECT,this.policeEffect=this.MAX_POLICESTATION_EFFECT,this.fireEffect=this.MAX_FIRESTATION_EFFECT)},at.prototype.setTax=function(t){t!==this.cityTax&&(this.cityTax=t)},at.prototype.setFunds=function(t){t!==this.totalFunds&&(this.totalFunds=Math.max(0,t),this._emitEvent(Ye,this.totalFunds),this.totalFunds===0&&this._emitEvent(pe))},at.prototype.spend=function(t){this.setFunds(this.totalFunds-t)},at.prototype.shouldDegradeRoad=function(){return this.roadEffect<Math.floor(15*this.MAX_ROAD_EFFECT/16)};var Rc=Object.defineProperty,$s=u((t,i)=>Rc(t,"name",{value:i,configurable:!0}),"n$e");const Ee=["res","com","ind","crime","money","pollution"];function Te(){this.clearCensus(),this.changed=!1,this.crimeRamp=0,this.pollutionRamp=0,this.landValueAverage=0,this.pollutionAverage=0,this.crimeAverage=0,this.totalPop=0;const t=$s(function(i){this[i]=[];for(let s=0;s<120;s++)this[i][s]=0},"createArray");for(let i=0;i<Ee.length;i++){const s=Ee[i]+"Hist10",n=Ee[i]+"Hist120";t.call(this,s),t.call(this,n)}}u(Te,"h$b"),$s(Te,"Census");const Pc=$s(function(){for(let t=0;t<Ee.length;t++){const i=Ee[t]+"Hist10";this[i].pop(),this[i].unshift(0)}},"rotate10Arrays"),$c=$s(function(){for(let t=0;t<Ee.length;t++){const i=Ee[t]+"Hist120";this[i].pop(),this[i].unshift(0)}},"rotate120Arrays");Te.prototype.clearCensus=function(){this.poweredZoneCount=0,this.unpoweredZoneCount=0,this.firePop=0,this.roadTotal=0,this.railTotal=0,this.resPop=0,this.comPop=0,this.indPop=0,this.resZonePop=0,this.comZonePop=0,this.indZonePop=0,this.hospitalPop=0,this.churchPop=0,this.policeStationPop=0,this.fireStationPop=0,this.stadiumPop=0,this.coalPowerPop=0,this.nuclearPowerPop=0,this.seaportPop=0,this.airportPop=0};const we=["resPop","comPop","indPop","crimeRamp","pollutionRamp","landValueAverage","pollutionAverage","crimeAverage","totalPop","resHist10","resHist120","comHist10","comHist120","indHist10","indHist120","crimeHist10","crimeHist120","moneyHist10","moneyHist120","pollutionHist10","pollutionHist120"];Te.prototype.save=function(t){for(let i=0,s=we.length;i<s;i++)t[we[i]]=this[we[i]]},Te.prototype.load=function(t){for(let i=0,s=we.length;i<s;i++)this[we[i]]=t[we[i]]||this[we[i]]},Te.prototype.take10Census=function(t){Pc.call(this),this.resHist10[0]=Math.floor(this.resPop/8),this.comHist10[0]=this.comPop,this.indHist10[0]=this.indPop,this.crimeRamp+=Math.floor((this.crimeAverage-this.crimeRamp)/4),this.crimeHist10[0]=Math.min(this.crimeRamp,255),this.pollutionRamp+=Math.floor((this.pollutionAverage-this.pollutionRamp)/4),this.pollutionHist10[0]=Math.min(this.pollutionRamp,255);const i=Math.floor(t.cashFlow/20)+128;this.moneyHist10[0]=d.clamp(i,0,255),this.resPop>>8,this.hospitalPop<this.resPopScaled?this.needHospital=1:this.hospitalPop>this.resPopScaled?this.needHospital=-1:this.hospitalPop===this.resPopScaled&&(this.needHospital=0),this.changed=!0},Te.prototype.take120Census=function(){$c.call(this);const t=8;this.resHist120[0]=Math.floor(this.resPop/t),this.comHist120[0]=this.comPop,this.indHist120[0]=this.indPop,this.crimeHist120[0]=this.crimeHist10[0],this.pollutionHist120[0]=this.pollutionHist10[0],this.moneyHist120[0]=this.moneyHist10[0],this.changed=!0};var Ac=Object.defineProperty,Lc=u((t,i)=>Ac(t,"name",{value:i,configurable:!0}),"u$a");const wt=ht(function(t,i,s){this._map=t,this._spriteManager=i,this._gameLevel=s,this._floodCount=0,this.disastersEnabled=!1}),Ic=[479,239,59];wt.prototype.doDisasters=function(t){if(this._floodCount&&this._floodCount--,!!this.disastersEnabled&&!g(Ic[this._gameLevel]))switch(g(8)){case 0:case 1:this.setFire();break;case 2:case 3:this.makeFlood();break;case 4:break;case 5:this._spriteManager.makeTornado();break;case 6:break;case 7:case 8:t.pollutionAverage>60&&this._spriteManager.makeMonster();break}},wt.prototype.scenarioDisaster=function(){},wt.prototype.makeMeltdown=function(){for(let t=0;t<this._map.width-1;t++)for(let i=0;i<this._map.height-1;i++)if(this._map.getTileValue(t,i)===kt){this.doMeltdown(t,i);return}};const kc=Lc(function(t){const i=t.getValue();return!(i<Zt||i>cn||t.isZone())},"vulnerable");wt.prototype.makeEarthquake=function(){const t=g(700)+300;this.doEarthquake(t),this._emitEvent(yi,{x:this._map.cityCenterX,y:this._map.cityCenterY});for(let i=0;i<t;i++){const s=g(this._map.width-1),n=g(this._map.height-1);!this._map.testBounds(s,n)||kc(this._map.getTile(s,n))&&((i&3)!==0?this._map.setTo(s,n,T.randomRubble()):this._map.setTo(s,n,T.randomFire()))}},wt.prototype.setFire=function(t,i){t=t||1,i=i||!1;for(let s=0;s<t;s++){const n=g(this._map.width-1),o=g(this._map.height-1);if(!this._map.testBounds(n,o))continue;let a=this._map.getTile(n,o);if(!a.isZone()&&(a=a.getValue(),a>(i?Ki:ji)&&a<cn)){this._map.setTo(n,o,T.randomFire()),this._emitEvent(Oi,{showable:!0,x:n,y:o});return}}},wt.prototype.makeCrash=function(){let t=this._spriteManager.getSprite(Bt);if(t!==null){t.explodeSprite();return}const i=g(this._map.width-1),s=g(this._map.height-1);this._spriteManager.generatePlane(i,s),t=this._spriteManager.getSprite(Bt),t.explodeSprite()},wt.prototype.makeFire=function(){this.setFire(40,!1)};const Pa=[0,1,0,-1],$a=[-1,0,1,0];wt.prototype.makeFlood=function(){for(let t=0;t<300;t++){const i=g(this._map.width-1),s=g(this._map.height-1);if(!this._map.testBounds(i,s))continue;let n=this._map.getTileValue(i,s);if(n>G&&n<=Pe)for(let o=0;o<4;o++){const a=i+Pa[o],r=s+$a[o];if(!this._map.testBounds(a,r))continue;const l=this._map.getTile(a,r);if(n=l.getValue(),l===R||l.isBulldozable()&&l.isCombustible){this._map.setTile(a,r,le,0),this._floodCount=30,this._emitEvent(Di,{showable:!0,x:a,y:r});return}}}},wt.prototype.doFlood=function(t,i,s){if(this._floodCount>0){for(let n=0;n<4;n++)if(x(7)){const o=t+Pa[n],a=i+$a[n];if(this._map.testBounds(o,a)){const r=this._map.getTile(o,a),l=r.getValue();(r.isCombustible()||l===R||l>=Wr&&l<le)&&(r.isZone()&&A.fireZone(this._map,o,a,s),this._map.setTile(o,a,le+g(2),0))}}}else x(15)&&this._map.setTile(t,i,R,0)},wt.prototype.doMeltdown=function(t,i){this._spriteManager.makeExplosion(t-1,i-1),this._spriteManager.makeExplosion(t-1,i+2),this._spriteManager.makeExplosion(t+2,i-1),this._spriteManager.makeExplosion(t+2,i+2);let s,n;for(n=t-1;n<t+3;n++)for(s=i-1;s<i+3;s++)this._map.setTo(n,s,T.randomFire());for(let o=0;o<200;o++){if(n=t-20+g(40),s=i-15+g(30),!this._map.testBounds(n,s))continue;const a=this._map.getTile(n,s);a.isZone()||(a.isCombustible()||a.getValue()===R)&&this._map.setTile(n,s,ai,0)}this._emitEvent(Ri,{showable:!0,x:t,y:i})};var xc=Object.defineProperty,Nc=u((t,i)=>xc(t,"name",{value:i,configurable:!0}),"d$9");const Aa=Nc(function(t,i,s){return function(n,o,a,r){r.census[t]+=1;let l=r.budget[i];n.getTile(o,a).isPowered()||(l=Math.floor(l/2));const h=new D(o,a);r.trafficManager.findPerimeterRoad(h)||(l=Math.floor(l/2));let c=r.blockMaps[s].worldGet(o,a);c+=l,r.blockMaps[s].worldSet(o,a,c)}},"handleService"),Vc=Aa("policeStationPop","policeEffect","policeStationMap"),Bc=Aa("fireStationPop","fireEffect","fireStationMap"),Fc={registerHandlers:function(t,i){t.addAction(hn,Vc),t.addAction(Oo,Bc)}};var Hc=Object.defineProperty,Gn=u((t,i)=>Hc(t,"name",{value:i,configurable:!0}),"P$4"),Wc=["CVP_CRIME","CVP_POLLUTION","CVP_HOUSING","CVP_TAXES","CVP_TRAFFIC","CVP_UNEMPLOYMENT","CVP_FIRE"],Ze=Wc.length,Yn=4,Rt=[],v=ht(function(t){this.problemVotes=[],this.problemOrder=[],this.evalInit(),this.gameLevel=""+t});v.prototype.cityEvaluation=function(t){var i=t.census;if(i.totalPop>0){for(var s=0;s<Ze;s++)Rt.push(0);this.getAssessedValue(i),this.getPopulation(i),this.doProblems(t.census,t.budget,t.blockMaps),this.getScore(t),this.doVotes()}else this.evalInit(),this.cityYes=50},v.prototype.evalInit=function(){this.cityYes=0,this.cityPop=0,this.cityPopDelta=0,this.cityAssessedValue=0,this.cityClass=v.CC_VILLAGE,this.cityClassLast=v.CC_VILLAGE,this.cityScore=500,this.cityScoreDelta=0;for(var t=0;t<Ze;t++)this.problemVotes[t]={index:t,voteCount:0};for(t=0;t<Yn;t++)this.problemOrder[t]=Ze};var qe=["cityClass","cityScore"];v.prototype.save=function(t){for(var i=0,s=qe.length;i<s;i++)t[qe[i]]=this[qe[i]]},v.prototype.load=function(t){for(var i=0,s=qe.length;i<s;i++)this[qe[i]]=t[qe[i]]},v.prototype.getAssessedValue=function(t){var i;i=t.roadTotal*5,i+=t.railTotal*10,i+=t.policeStationPop*1e3,i+=t.fireStationPop*1e3,i+=t.hospitalPop*400,i+=t.stadiumPop*3e3,i+=t.seaportPop*5e3,i+=t.airportPop*1e4,i+=t.coalPowerPop*3e3,i+=t.nuclearPowerPop*6e3,this.cityAssessedValue=i*1e3},v.prototype.getPopulation=function(t){var i=this.cityPop;return this.cityPop=(t.resPop+(t.comPop+t.indPop)*8)*20,this.cityPopDelta=this.cityPop-i,this.cityPopDelta!==0&&this._emitEvent(An,this.cityPop),this.cityPop},v.prototype.getCityClass=function(t){return this.cityClass=v.CC_VILLAGE,t>2e3&&(this.cityClass=v.CC_TOWN),t>1e4&&(this.cityClass=v.CC_CITY),t>5e4&&(this.cityClass=v.CC_CAPITAL),t>1e5&&(this.cityClass=v.CC_METROPOLIS),t>5e5&&(this.cityClass=v.CC_MEGALOPOLIS),this.cityClass!==this.cityClassLast&&(this.cityClassLast=this.cityClass,this._emitEvent(Mn,this.cityClass)),this.cityClass},v.prototype.voteProblems=function(){for(var t=0;t<Ze;t++)this.problemVotes[t].index=t,this.problemVotes[t].voteCount=0;for(var i=0,s=0,n=0;s<100&&n<600;){var o=g(300);Rt[i]>o&&(this.problemVotes[i].voteCount+=1,s++),i=(i+1)%Ze,n++}};var Uc=Gn(function(t,i){for(var s=t.trafficDensityMap,n=t.landValueMap,o=0,a=1,r=0;r<n.gameMapWidth;r+=n.blockSize)for(var l=0;l<n.gameMapHeight;l+=n.blockSize)n.worldGet(r,l)>0&&(o+=s.worldGet(r,l),a++);var h=i.trafficAverage=Math.floor(o/a)*2.4;return h},"getTrafficAverage"),Gc=Gn(function(t){var i=(t.comPop+t.indPop)*8;if(i===0)return 0;var s=t.resPop/i;return i=Math.round((s-1)*255),Math.min(i,255)},"getUnemployment"),La=Gn(function(t){return Math.min(t.firePop*5,255)},"getFireSeverity");v.prototype.doProblems=function(t,i,s){Rt[v.CRIME]=t.crimeAverage,Rt[v.POLLUTION]=t.pollutionAverage,Rt[v.HOUSING]=t.landValueAverage*7/10,Rt[v.TAXES]=i.cityTax*10,Rt[v.TRAFFIC]=Uc(s,t),Rt[v.UNEMPLOYMENT]=Gc(t),Rt[v.FIRE]=La(t),this.voteProblems(),this.problemVotes.sort(function(n,o){return o.voteCount-n.voteCount}),this.problemOrder=this.problemVotes.map(function(n,o){return o>=Yn||n.voteCount===0?null:n.index})},v.prototype.getScore=function(t){for(var i=t.census,s=t.budget,n=t.valves,o=this.cityScore,a=0,r=0;r<Ze;r++)a+=Rt[r];a=Math.floor(a/3),a=(250-Math.min(a,250))*4;var l=.85;n.resCap&&(a=Math.round(a*l)),n.comCap&&(a=Math.round(a*l)),n.indCap&&(a=Math.round(a*l)),s.roadEffect<s.MAX_ROAD_EFFECT&&(a-=s.MAX_ROAD_EFFECT-s.roadEffect),s.policeEffect<s.MAX_POLICE_STATION_EFFECT&&(a=Math.round(a*(.9+s.policeEffect/(10*s.MAX_POLICE_STATION_EFFECT)))),s.fireEffect<s.MAX_FIRE_STATION_EFFECT&&(a=Math.round(a*(.9+s.fireEffect/(10*s.MAX_FIRE_STATION_EFFECT)))),n.resValve<-1e3&&(a=Math.round(a*.85)),n.comValve<-1e3&&(a=Math.round(a*.85)),n.indValve<-1e3&&(a=Math.round(a*.85));var h=1;this.cityPop===0||this.cityPopDelta===0||this.cityPopDelta===this.cityPop?h=1:this.cityPopDelta>0?h=this.cityPopDelta/this.cityPop+1:this.cityPopDelta<0&&(h=.95+Math.floor(this.cityPopDelta/(this.cityPop-this.cityPopDelta))),a=Math.round(a*h),a=a-La(i)-s.cityTax,h=i.unpoweredZoneCount+i.poweredZoneCount,h>0&&(a=Math.round(a*(i.poweredZoneCount/h))),a=d.clamp(a,0,1e3),this.cityScore=Math.round((this.cityScore+a)/2),this.cityScoreDelta=this.cityScore-o,this.cityScoreDelta!==0&&this._emitEvent(kn,this.cityScore)},v.prototype.doVotes=function(){this.cityYes=0;for(var t=0;t<100;t++){var i=g(1e3);this.cityScore>i&&this.cityYes++}},v.prototype.getProblemNumber=function(t){return t<0||t>=Yn?null:this.problemOrder[t]},Object.defineProperties(v,{CC_VILLAGE:d.makeConstantDescriptor("VILLAGE"),CC_TOWN:d.makeConstantDescriptor("TOWN"),CC_CITY:d.makeConstantDescriptor("CITY"),CC_CAPITAL:d.makeConstantDescriptor("CAPITAL"),CC_METROPOLIS:d.makeConstantDescriptor("METROPOLIS"),CC_MEGALOPOLIS:d.makeConstantDescriptor("MEGALOPOLIS"),CRIME:d.makeConstantDescriptor(0),POLLUTION:d.makeConstantDescriptor(1),HOUSING:d.makeConstantDescriptor(2),TAXES:d.makeConstantDescriptor(3),TRAFFIC:d.makeConstantDescriptor(4),UNEMPLOYMENT:d.makeConstantDescriptor(5),FIRE:d.makeConstantDescriptor(6)});var Yc=Object.defineProperty,Ia=u((t,i)=>Yc(t,"name",{value:i,configurable:!0}),"s$e");const Ke=new X;function As(t){this._map=t,this._actions=[]}u(As,"p$b"),Ia(As,"MapScanner");const zc=Ia(function(t){return typeof t=="function"},"isCallable");As.prototype.addAction=function(t,i){this._actions.push({criterion:t,action:i})},As.prototype.mapScan=function(t,i,s){for(let n=0;n<this._map.height;n++)for(let o=t;o<i;o++){this._map.getTile(o,n,Ke);const a=Ke.getValue();if(!(a<le)){Ke.isConductive()&&s.powerManager.setTilePower(o,n),Ke.isZone()&&(s.repairManager.checkTile(o,n,s.cityTime),Ke.isPowered()?s.census.poweredZoneCount+=1:s.census.unpoweredZoneCount+=1);for(let r=0,l=this._actions.length;r<l;r++){const h=this._actions[r],c=zc(h.criterion);if(c&&h.criterion.call(null,Ke)){h.action.call(null,this._map,o,n,s);break}else if(!c&&h.criterion===a){h.action.call(null,this._map,o,n,s);break}}}}};var Xc=Object.defineProperty,zn=u((t,i)=>Xc(t,"name",{value:i,configurable:!0}),"s$d");const jc=[-1,0,1,0],Zc=[0,-1,0,1],qc=zn(function(t,i,s,n){if(n.census.firePop+=1,(Y()&3)!==0)return;for(let r=0;r<4;r++)if(x(7)){const l=i+jc[r],h=s+Zc[r];if(t.testBounds(l,h)){const c=t.getTile(i,s);if(!c.isCombustible())continue;c.isZone()&&(A.fireZone(t,i,s,n.blockMaps),c.getValue()>ui&&n.spriteManager.makeExplosionAt(i,s)),t.setTo(T.randomFire())}}let o=10;const a=n.blockMaps.fireStationEffectMap.worldGet(i,s);a>100?o=1:a>20?o=2:a>0&&(o=3),g(o)===0&&t.setTo(i,s,T.randomRubble())},"fireFound"),Kc=zn(function(t,i,s,n){x(4095)&&t.setTile(i,s,R,0)},"radiationFound"),Qc=zn(function(t,i,s,n){n.disasterManager.doFlood(i,s,n.blockMaps)},"floodFound"),Jc={registerHandlers:function(t,i){t.addAction(T.isFire,qc,!0),t.addAction(ai,Kc,!0),t.addAction(T.isFlood,Qc,!0)}},tu=700,eu=2e3,ie=ht(function(t){this._map=t,this._powerStack=[],this.powerGridMap=new j(this._map.width,this._map.height,1)});ie.prototype.setTilePower=function(t,i){const s=this._map.getTile(t,i),n=s.getValue();if(n===kt||n===Kt||this.powerGridMap.worldGet(t,i)>0){s.addFlags(Nt);return}s.removeFlags(Nt)},ie.prototype.clearPowerStack=function(){this._powerStackPointer=0,this._powerStack=[]},ie.prototype.testForConductive=function(t,i){const s=D.move(t,i);return!!(this._map.isPositionInBounds(s)&&this._map.getTile(s.x,s.y).isConductive()&&this.powerGridMap.worldGet(s.x,s.y)===0)},ie.prototype.doPowerScan=function(t){this.powerGridMap.clear();const i=t.coalPowerPop*tu+t.nuclearPowerPop*eu;let s=0;for(;this._powerStack.length>0;){var n=this._powerStack.pop(),o=void 0,a;do{if(s++,s>i){this._emitEvent(ze);return}o&&(n=D.move(n,o)),this.powerGridMap.worldSet(n.x,n.y,1),a=0,ke(r=>{a>=2||this.testForConductive(n,r)&&(a++,o=r)}),a>1&&this._powerStack.push(new D(n.x,n.y))}while(a)}},ie.prototype.coalPowerFound=function(t,i,s,n){n.census.coalPowerPop+=1,this._powerStack.push(new D(i,s));const o=[-1,2,1,2],a=[-1,-1,0,0];for(let r=0;r<4;r++)t.addTileFlags(i+o[r],s+a[r],K)};const iu=[3e4,2e4,1e4];ie.prototype.nuclearPowerFound=function(t,i,s,n){if(n.disasterManager.disastersEnabled&&g(iu[n.gameLevel])===0){n.disasterManager.doMeltdown(i,s);return}n.census.nuclearPowerPop+=1,this._powerStack.push(new D(i,s));for(let o=0;o<4;o++)t.addTileFlags(i,s,K|k|Nt|P)},ie.prototype.registerHandlers=function(t,i){t.addAction(Kt,this.coalPowerFound.bind(this)),t.addAction(kt,this.nuclearPowerFound.bind(this)),i.addAction(Kt,7,4),i.addAction(kt,7,4)};var su=Object.defineProperty,ka=u((t,i)=>su(t,"name",{value:i,configurable:!0}),"p$a");function Bi(t){this._map=t,this._actions=[]}u(Bi,"a$b"),ka(Bi,"RepairManager");const nu=ka(function(t){return typeof t=="function"},"isCallable");Bi.prototype.addAction=function(t,i,s){this._actions.push({criterion:t,period:i,zoneSize:s})},Bi.prototype.repairZone=function(t,i,s){let n=this._map.getTileValue(t,i)-s-2;for(let o=-1;o<s-1;o++)for(let a=-1;a<s-1;a++){n++;const r=this._map.getTile(t+a,i+o);if(r.isZone()||r.isAnimated())continue;const l=r.getValue();(l<Zi||l>=F)&&this._map.setTile(t+a,i+o,n,k|P)}},Bi.prototype.checkTile=function(t,i,s){for(let n=0,o=this._actions.length;n<o;n++){const a=this._actions[n],r=a.period;if((s&r)!==0)continue;const l=this._map.getTile(t,i),h=l.getValue(),c=nu(a.criterion);c&&a.criterion.call(null,l)?this.repairZone(t,i,a.zoneSize):!c&&a.criterion===h&&this.repairZone(t,i,a.zoneSize)}};var ou=Object.defineProperty,Ls=u((t,i)=>ou(t,"name",{value:i,configurable:!0}),"B$5");const xa=Ls(function(t,i,s,n,o,a,r){for(let l=0;l<7;l++){const h=i+n[l],c=s+o[l];t.testBounds(h,c)&&t.getTileValue(h,c)===(a[l]&rs)&&t.setTileValue(h,c,r[l])}},"openBridge"),Na=Ls(function(t,i,s,n,o,a,r){for(let l=0;l<7;l++){const h=i+n[l],c=s+o[l];if(t.testBounds(h,c)){const f=t.getTileValue(h,c);(f===G||(f&15)===(a[l]&15))&&t.setTileValue(h,c,r[l])}}},"closeBridge"),Va=[0,1,0,0,0,0,1],Ba=[-2,-2,-1,0,1,2,2],Fa=[fn|m,Lo|m,p,Ae|m,p,Io|m,ko|m],Ha=[dt|m,p,dt|m,dt|m,dt|m,dt|m,p],Wa=[-2,2,-2,-1,0,1,2],Ua=[-1,-1,0,0,0,0,0],Ga=[Mo|m,Po|m,un|m,p,$e|m,p,Ro|m],Ya=[p,p,ut|m,ut|m,ut|m,ut|m,ut|m],au=Ls(function(t,i,s,n,o){if(n===Ae)return x(3)&&o.spriteManager.getBoatDistance(i,s)>340&&Na(t,i,s,Va,Ba,Fa,Ha),!0;if(n==$e)return x(3)&&o.spriteManager.getBoatDistance(i,s)>340&&Na(t,i,s,Wa,Ua,Ga,Ya),!0;if(o.spriteManager.getBoatDistance(i,s)<300||x(7)){if(n&1)return i<t.width-1&&t.getTileValue(i+1,s)===G?(xa(t,i,s,Va,Ba,Ha,Fa),!0):!1;if(s>0&&t.getTileValue(i,s-1)===G)return xa(t,i,s,Wa,Ua,Ya,Ga),!0}return!1},"doBridge"),ru=[F,Js,tn],lu=Ls(function(t,i,s,n){n.census.roadTotal+=1;let o=t.getTile(i,s);const a=o.getValue();if(n.budget.shouldDegradeRoad()&&x(511)&&(o=t.getTile(i,s),!o.isConductive()&&n.budget.roadEffect<(Y()&31))){o.getValue(),(a&15)<2||(a&15)===15?t.setTile(i,s,p,0):t.setTo(i,s,T.randomRubble());return}if(!o.isCombustible()&&(n.census.roadTotal+=4,au(t,i,s,a,n)))return;let r=0;a<Js?r=0:a<tn?r=1:(n.census.roadTotal+=1,r=2);let l=n.blockMaps.trafficDensityMap.worldGet(i,s)>>6;if(l>1&&(l-=1),l===r)return;const h=(a-F&15)+ru[l];let c=o.getFlags()&~K;l>0&&(c|=K),t.setTo(i,s,new X(h,c))},"roadFound"),hu={registerHandlers:function(t,i){t.addAction(T.isRoad,lu)}};var cu=Object.defineProperty,Is=u((t,i)=>cu(t,"name",{value:i,configurable:!0}),"n$c");const uu=Is(function(t,i,s,n,o){this.type=t,this.map=i,this.spriteManager=s;let a=n,r=o,l=n>>4,h=o>>4;Object.defineProperty(this,"x",{configurable:!1,enumerable:!0,set:function(c){a=c,l=c>>4},get:function(){return a}}),Object.defineProperty(this,"y",{configurable:!1,enumerable:!0,set:function(c){r=c,h=c>>4},get:function(){return r}}),Object.defineProperty(this,"worldX",{configurable:!1,enumerable:!0,set:function(c){l=c,a=c<<4},get:function(){return l}}),Object.defineProperty(this,"worldY",{configurable:!1,enumerable:!0,set:function(c){h=c,r=c<<4},get:function(){return h}}),this.origX=0,this.origY=0,this.destX=0,this.destY=0,this.count=0,this.soundCount=0,this.dir=0,this.newDir=0,this.step=0,this.flag=0,this.turn=0,this.accel=0,this.speed=100},"init"),du=Is(function(){return["obj",this.type,"-",this.frame-1].join("")},"getFileName"),pu=Is(function(){const t=this.worldX,i=this.worldY;return t<0||i<0||t>=this.map.width||i>=this.map.height},"spriteNotInBounds"),fu={init:uu,getFileName:du,spriteNotInBounds:pu},ve=Is(function(t){t.prototype=Object.create(fu),ht(t)},"BaseSprite");var mu=Object.defineProperty,gu=u((t,i)=>mu(t,"name",{value:i,configurable:!0}),"m$d");function Qe(t,i,s,n){this.init(Bt,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,s>E.worldToPix(t.width-20)?(this.destX=this.x-200,this.frame=7):(this.destX=this.x+200,this.frame=11),this.destY=this.y}u(Qe,"r$h"),gu(Qe,"AirplaneSprite"),ve(Qe);const _u=[0,0,6,8,6,0,-6,-8,-6,8,8,8],Eu=[0,-8,-6,0,6,8,6,0,-6,0,0,0];Qe.prototype.move=function(t,i,s){let n=this.frame;if(t%5===0)if(n>8)n--,n<9&&(n=3),this.frame=n;else{const o=E.getDir(this.x,this.y,this.destX,this.destY);n=E.turnTo(n,o),this.frame=n}if(E.absoluteDistance(this.x,this.y,this.destX,this.destY)<50&&(this.destX=g(E.worldToPix(this.map.width))+8,this.destY=g(E.worldToPix(this.map.height))+8),i.enableDisasters){let o=!1;const a=this.spriteManager.getSpriteList();for(let r=0;r<a.length;r++){const l=a[r];l.frame===0||l===this||(l.type===Vt||l.type===Bt)&&E.checkSpriteCollision(this,l)&&(l.explodeSprite(),o=!0)}o&&this.explodeSprite()}this.x+=_u[n],this.y+=Eu[n],this.spriteNotInBounds()&&(this.frame=0)},Qe.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(Pi,{showable:!0,x:this.worldX,y:this.worldY})},Object.defineProperties(Qe,{ID:d.makeConstantDescriptor(3),width:d.makeConstantDescriptor(48),frames:d.makeConstantDescriptor(11)});var Tu=Object.defineProperty,za=u((t,i)=>Tu(t,"name",{value:i,configurable:!0}),"l$d");function Je(t,i,s,n){this.init(de,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,s<E.worldToPix(4)?this.frame=3:s>=E.worldToPix(t.width-4)?this.frame=7:n<E.worldToPix(4)?this.frame=5:n>=E.worldToPix(t.height-4)?this.frame=1:this.frame=3,this.newDir=this.frame,this.dir=10,this.count=1}u(Je,"f$8"),za(Je,"BoatSprite"),ve(Je);const wu=za(function(t,i,s){let n=i+4;return n>8&&(n-=8),s!==n?!1:t===bt||t===bt+1||t===jt||t===jt+1},"oppositeAndUnderwater"),vu=[0,0,1,1,1,0,-1,-1,-1],Su=[0,-1,-1,0,1,1,1,0,-1],yu=[0,0,2,2,2,0,-2,-2,-2],bu=[0,-2,-2,0,2,2,2,0,-2],Ou=[p,G,bt,bt+1,jt,jt+1,$e,Ae],Du=10;Je.prototype.move=function(t,i,s){let n=p,o,a,r;if(this.soundCount>0&&this.soundCount--,this.soundCount===0&&((Y()&3)===1&&this._emitEvent(Ca),this.soundCount=200),this.count>0&&this.count--,this.count===0){if(this.count=9,this.frame!==this.newDir){this.frame=E.turnTo(this.frame,this.newDir);return}const l=Y()&7;let h=l;for(;h<l+8;h++)if(o=(h&7)+1,o!==this.dir&&(a=this.worldX+vu[o],r=this.worldY+Su[o],this.map.testBounds(a,r)&&(n=this.map.getTileValue(a,r),n===G||n===$e||n===Ae||wu(n,this.dir,o)))){this.newDir=o,this.frame=E.turnTo(this.frame,this.newDir),this.dir=o+4,this.dir>8&&(this.dir-=8);break}h===l+8&&(this.dir=Du,this.newDir=(Y()&7)+1)}else o=this.frame,o===this.newDir&&(this.x+=yu[o],this.y+=bu[o]);if(this.spriteNotInBounds()){this.frame=0;return}for(let l=0;l<8&&n!==Ou[l];l++)l===7&&(this.explodeSprite(),E.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y))},Je.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(xi,{showable:!0,x:this.worldX,y:this.worldY})},Object.defineProperties(Je,{ID:d.makeConstantDescriptor(4),width:d.makeConstantDescriptor(48),frames:d.makeConstantDescriptor(8)});var Cu=Object.defineProperty,Mu=u((t,i)=>Cu(t,"name",{value:i,configurable:!0}),"f$7");function ti(t,i,s,n){this.init(Vt,t,i,s,n),this.width=32,this.height=32,this.xOffset=-16,this.yOffset=-16,this.frame=5,this.count=1500,this.destX=g(E.worldToPix(t.width))+8,this.destY=g(E.worldToPix(t.height))+8,this.origX=s,this.origY=n}u(ti,"h$6"),Mu(ti,"CopterSprite"),ve(ti);const Ru=[0,0,3,5,3,0,-3,-5,-3],Pu=[0,-5,-3,0,3,5,3,0,-3];ti.prototype.move=function(t,i,s){if(this.soundCount>0&&this.soundCount--,this.count>0&&this.count--,this.count===0){let o=this.spriteManager.getSprite(He);if(o!==null?(this.destX=o.x,this.destY=o.y):(o=this.spriteManager.getSprite(_i),o!==null?(this.destX=o.x,this.destY=o.y):(this.destX=this.origX,this.destY=this.origY)),E.absoluteDistance(this.x,this.y,this.origX,this.origY)<30){this.frame=0;return}}if(this.soundCount===0){const o=this.worldX,a=this.worldY;o>=0&&o<this.map.width&&a>=0&&a<this.map.height&&s.trafficDensityMap.worldGet(o,a)>170&&(Y()&7)===0&&(this._emitEvent(ee,{x:o,y:a}),this._emitEvent(Da),this.soundCount=200)}let n=this.frame;if((t&3)===0){const o=E.getDir(this.x,this.y,this.destX,this.destY);n=E.turnTo(n,o),this.frame=n}this.x+=Ru[n],this.y+=Pu[n]},ti.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(Ci,{x:this.worldX,y:this.worldY})},Object.defineProperties(ti,{ID:d.makeConstantDescriptor(2),width:d.makeConstantDescriptor(32),frames:d.makeConstantDescriptor(8)});var $u=Object.defineProperty,Au=u((t,i)=>$u(t,"name",{value:i,configurable:!0}),"h$5");function ei(t,i,s,n){this.init(ls,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,this.frame=1}u(ei,"e$8"),Au(ei,"ExplosionSprite"),ve(ei),ei.prototype.startFire=function(t,i){if(t=this.worldX,i=this.worldY,!!this.map.testBounds(t,i)){var s=this.map.getTile(t,i),n=s.getValue();!s.isCombustible()&&n!==R||s.isZone()||this.map.setTo(t,i,T.randomFire())}},ei.prototype.move=function(t,i,s){if((t&1)===0){if(this.frame===1){var n=this.worldX,o=this.worldY;this._emitEvent(Cs),this._emitEvent(bi,{x:n,y:o})}this.frame++}this.frame>6&&(this.frame=0,this.startFire(this.x,this.y),this.startFire(this.x-16,this.y-16),this.startFire(this.x+16,this.y+16),this.startFire(this.x-16,this.y+16),this.startFire(this.x+16,this.y+16))},Object.defineProperties(ei,{ID:d.makeConstantDescriptor(7),width:d.makeConstantDescriptor(48),frames:d.makeConstantDescriptor(6)});var Lu=Object.defineProperty,Iu=u((t,i)=>Lu(t,"name",{value:i,configurable:!0}),"g$5");function Fi(t,i,s,n){this.init(He,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,s>E.worldToPix(t.width)/2?n>E.worldToPix(t.height)/2?this.frame=10:this.frame=7:n>E.worldToPix(t.height)/2?this.frame=1:this.frame=4,this.flag=0,this.count=1e3,this.destX=E.worldToPix(t.pollutionMaxX),this.destY=E.worldToPix(t.pollutionMaxY),this.origX=this.x,this.origY=this.y,this._seenLand=!1}u(Fi,"m$a"),Iu(Fi,"MonsterSprite"),ve(Fi);const ku=[2,2,-2,-2,0],xu=[-2,2,2,-2,0],Nu=[0,1,2,3],Vu=[1,2,3,0],Bu=[2,5,8,11],Fu=[11,2,5,8];Fi.prototype.move=function(t,i,s){this.soundCount>0&&this.soundCount--;let n=Math.floor((this.frame-1)/3),o,a;if(n<4){if(o=(this.frame-1)%3,o===2&&(this.step=0),o===0&&(this.step=1),this.step?o++:o--,E.absoluteDistance(this.x,this.y,this.destX,this.destY)<60)if(this.flag===0)this.flag=1,this.destX=this.origX,this.destY=this.origY;else{this.frame=0,this._emitEvent(Ms);return}a=E.getDir(this.x,this.y,this.destX,this.destY),a=Math.floor((a-1)/2),a!==n&&x(10)&&(Y()&1?o=Nu[n]:o=Vu[n],n=4,this.soundCount||(this._emitEvent(Ma),this.soundCount=50+g(100)))}else n=4,a=this.frame,o=a-13&3,Y()&3||(Y()&1?o=Bu[o]:o=Fu[o],n=Math.floor((o-1)/3),o=(o-1)%3);o=n*3+o+1,o>16&&(o=16),this.frame=o,this.x+=ku[n],this.y+=xu[n],this.count>0&&this.count--;const r=E.getTileValue(this.map,this.x,this.y);(r===-1||r===p&&this.count<500)&&(this.frame=0),(r===R||r>Pe)&&(this._seenLand=!0);const l=this.spriteManager.getSpriteList();for(let h=0;h<l.length;h++){const c=l[h];c.frame!==0&&(c.type===Bt||c.type===Vt||c.type===de||c.type===Fe)&&E.checkSpriteCollision(this,c)&&c.explodeSprite()}this.frame===0&&this._emitEvent(Ms),E.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y),this._emitEvent(Hn,{x:this.worldX,y:this.worldY})},Object.defineProperties(Fi,{ID:d.makeConstantDescriptor(5),width:d.makeConstantDescriptor(48),frames:d.makeConstantDescriptor(16)});var Hu=Object.defineProperty,Wu=u((t,i)=>Hu(t,"name",{value:i,configurable:!0}),"p$9");function Hi(t,i,s,n){this.init(Ei.SPRITE_TORNADO,t,i,s,n),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-40,this.frame=1,this.count=200}u(Hi,"o$c"),Wu(Hi,"TornadoSprite"),ve(Hi);const Uu=[2,3,2,0,-2,-3],Gu=[-2,0,2,3,2,0];Hi.prototype.move=function(t,i,s){let n=this.frame;n===2?this.flag?n=3:n=1:(n===1?this.flag=1:this.flag=0,n=2),this.count>0&&this.count--,this.frame=n;const o=this.spriteManager.getSpriteList();for(let a=0;a<o.length;a++){const r=o[a];r.frame!==0&&(r.type===Ei.SPRITE_AIRPLANE||r.type===Ei.SPRITE_HELICOPTER||r.type===Ei.SPRITE_SHIP||r.type===Ei.SPRITE_TRAIN)&&E.checkSpriteCollision(this,r)&&r.explodeSprite()}n=g(5),this.x+=Uu[n],this.y+=Gu[n],this.spriteNotInBounds()&&(this.frame=0),this.count!==0&&g(500)===0&&(this.frame=0),this.frame===0&&this._emitEvent(Ms),E.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y),this._emitEvent(Hn,{x:this.worldX,y:this.worldY})},Object.defineProperties(Hi,{ID:d.makeConstantDescriptor(6),width:d.makeConstantDescriptor(48),frames:d.makeConstantDescriptor(3)});var Yu=Object.defineProperty,zu=u((t,i)=>Yu(t,"name",{value:i,configurable:!0}),"c$9");function ii(t,i,s,n){this.init(Fe,t,i,s,n),this.width=32,this.height=32,this.xOffset=-16,this.yOffset=-16,this.frame=1,this.dir=4}u(ii,"r$g"),zu(ii,"TrainSprite"),ve(ii);const Xu=[0,16,0,-16],ju=[-16,0,16,0],Zu=[0,4,0,-4,0],qu=[-4,0,4,0,0],Xa=[1,2,1,2,5],ja=3,Za=4,Ku=5,Qu=3,ks=4;ii.prototype.move=function(t,i,s){if((this.frame===ja||this.frame===Za)&&(this.frame=Xa[this.dir]),this.x+=Zu[this.dir],this.y+=qu[this.dir],(t&3)===0){const n=Y()&3;for(let o=n;o<n+4;o++){const a=o&3;if(this.dir!==ks&&a===(this.dir+2&3))continue;const r=E.getTileValue(this.map,this.x+Xu[a],this.y+ju[a]);if(r>=jt&&r<=wo||r===gt||r===Q){this.dir!==a&&this.dir!==ks?this.dir+a===Qu?this.frame=ja:this.frame=Za:this.frame=Xa[a],(r===pt||r===Xt)&&(this.frame=Ku),this.dir=a;return}}if(this.dir===ks){this.frame=0;return}this.dir=ks}},ii.prototype.explodeSprite=function(){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),this._emitEvent(Vi,{showable:!0,x:this.worldX,y:this.worldY})},Object.defineProperties(ii,{ID:d.makeConstantDescriptor(1),width:d.makeConstantDescriptor(32),frames:d.makeConstantDescriptor(5)});const Z=ht(function(t){this.spriteList=[],this.map=t,this.spriteCycle=0});Z.prototype.getSprite=function(t){const i=this.spriteList.filter(function(s){return s.frame!==0&&s.type===t});return i.length===0?null:i[0]},Z.prototype.getSpriteList=function(){return this.spriteList.slice()},Z.prototype.getSpritesInView=function(t,i,s,n){t=E.worldToPix(t),i=E.worldToPix(i);const o=t+s,a=i+n;return this.spriteList.filter(function(r){const l=r.x+r.xOffset,h=r.y+r.yOffset,c=r.x+r.xOffset+r.width,f=r.y+r.yOffset+r.width,_=l>=t&&l<o,S=c>=t&&c<o,w=h>=i&&h<a,C=f>=i&&f<a;return(_||S)&&(w||C)})},Z.prototype.moveObjects=function(t){const i=t.disasterManager,s=t.blockMaps;this.spriteCycle+=1;const n=this.spriteList.slice();for(let o=0,a=n.length;o<a;o++){const r=n[o];r.frame!==0&&r.move(this.spriteCycle,i,s)}this.pruneDeadSprites()},Z.prototype.makeSprite=function(t,i,s){const n=new se[t](this.map,this,i,s);for(let o=0,a=ge.length;o<a;o++)n.addEventListener(ge[o],d.reflectEvent.bind(this,ge[o]));return t==Vt&&n.addEventListener(ee,d.reflectEvent.bind(this,ee)),this.spriteList.push(n),n},Z.prototype.makeTornado=function(){let t=this.getSprite(_i);if(t!==null){t.count=200,this._emitEvent(Xe,{trackable:!0,x:t.worldX,y:t.worldY,sprite:t});return}const i=g(E.worldToPix(this.map.width)-800)+400,s=g(E.worldToPix(this.map.height)-200)+100;t=this.makeSprite(_i,i,s),this._emitEvent(Xe,{trackable:!0,x:t.worldX,y:t.worldY,sprite:t})},Z.prototype.makeExplosion=function(t,i){this.map.testBounds(t,i)&&this.makeExplosionAt(E.worldToPix(t),E.worldToPix(i))},Z.prototype.makeExplosionAt=function(t,i){this.makeSprite(ls,t,i)},Z.prototype.generatePlane=function(t,i){this.getSprite(Bt)===null&&this.makeSprite(Bt,E.worldToPix(t),E.worldToPix(i))},Z.prototype.generateTrain=function(t,i,s){t.totalPop>10&&this.getSprite(Fe)===null&&g(25)===0&&this.makeSprite(Fe,E.worldToPix(i)+8,E.worldToPix(s)+8)},Z.prototype.generateShip=function(){let t,i;if(x(3)){for(t=4;t<this.map.width-2;t++)if(this.map.getTileValue(t,0)===G){this.makeShipHere(t,0);return}}if(x(3)){for(i=1;i<this.map.height-2;i++)if(this.map.getTileValue(0,i)===G){this.makeShipHere(0,i);return}}if(x(3)){for(t=4;t<this.map.width-2;t++)if(this.map.getTileValue(t,this.map.height-1)===G){this.makeShipHere(t,this.map.height-1);return}}if(x(3)){for(i=1;i<this.map.height-2;i++)if(this.map.getTileValue(this.map.width-1,i)===G){this.makeShipHere(this.map.width-1,i);return}}},Z.prototype.getBoatDistance=function(t,i){let s=99999;const n=E.worldToPix(t)+8,o=E.worldToPix(i)+8;for(let a=0,r=this.spriteList.length;a<r;a++){const l=this.spriteList[a];if(l.type===de&&l.frame!==0){const h=Math.abs(l.x-n)+Math.abs(l.y-o);s=Math.min(s,h)}}return s},Z.prototype.makeShipHere=function(t,i){this.makeSprite(de,E.worldToPix(t),E.worldToPix(i))},Z.prototype.generateCopter=function(t,i){this.getSprite(Vt)===null&&this.makeSprite(Vt,E.worldToPix(t),E.worldToPix(i))},Z.prototype.makeMonsterAt=function(t,i){const s=this.makeSprite(He,E.worldToPix(t),E.worldToPix(i));this._emitEvent(Mi,{trackable:!0,x:t,y:i,sprite:s})},Z.prototype.makeMonster=function(){const t=this.getSprite(He);t!==null&&(t.soundCount=1,t.count=1e3,t.destX=E.worldToPix(this.map.pollutionMaxX),t.destY=E.worldToPix(this.map.pollutionMaxY));let i=0;for(let s=0;s<300;s++){const n=g(this.map.width-20)+10,o=g(this.map.height-10)+5;if(this.map.getTile(n,o).getValue()===p){this.makeMonsterAt(n,o),i=1;break}}i===0&&this.makeMonsterAt(60,50)},Z.prototype.pruneDeadSprites=function(t){this.spriteList=this.spriteList.filter(function(i){return i.frame!==0})};var se={};se[Fe]=ii,se[de]=Je,se[He]=Fi,se[Vt]=ti,se[Bt]=Qe,se[_i]=Hi,se[ls]=ei;var Ju=Object.defineProperty,qa=u((t,i)=>Ju(t,"name",{value:i,configurable:!0}),"d$6");const td=qa(function(t,i,s,n){n.census.stadiumPop+=1,t.getTile(i,s).isPowered()&&(n.cityTime+i+s&31)===0&&(t.putZone(i,s,Co,4),t.addTileFlags(i,s,Nt),t.setTile(i+1,s,pn,K),t.setTile(i+1,s+1,Ol,K))},"emptyStadiumFound"),ed=qa(function(t,i,s,n){n.census.stadiumPop+=1;const o=t.getTile(i,s).isPowered();(n.cityTime+i+s&7)===0&&(t.putZone(i,s,Qt,4),o&&t.addTileFlags(i,s,Nt))},"fullStadiumFound"),id={registerHandlers:function(t,i){t.addAction(Qt,td),t.addAction(Co,ed),i.addAction(Qt,15,4)}};var sd=Object.defineProperty,Xn=u((t,i)=>sd(t,"name",{value:i,configurable:!0}),"l$a");const nd=Xn(function(t,i,s,n){if(n.census.railTotal+=1,n.spriteManager.generateTrain(n.census,i,s),n.budget.shouldDegradeRoad()&&x(511)){const o=t.getTile(i,s);if(o.isConductive())return;n.budget.roadEffect<(Y()&31)&&(o.getValue()<jt+2?t.setTile(i,s,p,0):t.setTo(i,s,T.randomRubble()))}},"railFound"),od=Xn(function(t,i,s,n){if(n.census.airportPop+=1,t.getTile(i,s).isPowered()){if(t.getTileValue(i+1,s-1)===bo&&t.setTile(i+1,s-1,$o,k|K|P),g(5)===0){n.spriteManager.generatePlane(i,s);return}g(12)===0&&n.spriteManager.generateCopter(i,s)}else t.setTile(i+1,s-1,bo,k|P)},"airportFound"),ad=Xn(function(t,i,s,n){n.census.seaportPop+=1,t.getTile(i,s).isPowered()&&n.spriteManager.getSprite(de)===null&&n.spriteManager.generateShip()},"portFound"),rd={registerHandlers:function(t,i){t.addAction(T.isRail,nd),t.addAction(he,ad),t.addAction(H,od),i.addAction(he,15,4),i.addAction(H,7,6)}},xs=ht(function(){this.resValve=0,this.comValve=0,this.indValve=0,this.resCap=!1,this.comCap=!1,this.indCap=!1}),Ka=2e3,Qa=1500,Ja=1500,jn=[200,150,120,100,80,50,30,0,-10,-40,-100,-150,-200,-250,-300,-350,-400,-450,-500,-550,-600],ld=[1.2,1.1,.98];xs.prototype.save=function(t){t.resValve=this.resValve,t.comValve=this.comValve,t.indValve=this.indValve},xs.prototype.load=function(t){this.resValve=t.resValve,this.comValve=t.comValve,this.indValve=t.indValve,this._emitEvent(je)},xs.prototype.setValves=function(t,i,s){let n,o;const a=i.resPop/8;i.totalPop=Math.round(a+i.comPop+i.indPop),i.resPop>0?n=(i.comHist10[1]+i.indHist10[1])/a:n=1;const r=a*(n-1),l=a*.02,h=a+r+l;o=i.comHist10[1]+i.indHist10[1],o>0?o=i.resHist10[1]/o:o=1,o=d.clamp(o,0,1.3);const c=(a+i.comPop+i.indPop)/3.7*o;let f=i.indPop*o*ld[t];f=Math.max(f,5);let _;a>0?_=h/a:_=1.3;let S;i.comPop>0?S=c/i.comPop:S=c;let w;i.indPop>0?w=f/i.indPop:w=f,_=Math.min(_,2),S=Math.min(S,2),w=Math.min(w,2);const C=Math.min(s.cityTax+t,20);_=(_-1)*600+jn[C],S=(S-1)*600+jn[C],w=(w-1)*600+jn[C],this.resValve=d.clamp(this.resValve+Math.round(_),-Ka,Ka),this.comValve=d.clamp(this.comValve+Math.round(S),-Qa,Qa),this.indValve=d.clamp(this.indValve+Math.round(w),-Ja,Ja),this.resCap&&this.resValve>0&&(this.resValve=0),this.comCap&&this.comValve>0&&(this.comValve=0),this.indCap&&this.indValve>0&&(this.indValve=0),this._emitEvent(je)};var hd=Object.defineProperty,cd=u((t,i)=>hd(t,"name",{value:i,configurable:!0}),"u$8");const y=ht(function(t,i,s,n){this.reset(t,i,s),la.registerHandlers(this._mapScanner,this._repairManager),Fc.registerHandlers(this._mapScanner,this._repairManager),da.registerHandlers(this._mapScanner,this._repairManager),Jc.registerHandlers(this._mapScanner,this._repairManager),hu.registerHandlers(this._mapScanner,this._repairManager),ga.registerHandlers(this._mapScanner,this._repairManager),id.registerHandlers(this._mapScanner,this._repairManager),rd.registerHandlers(this._mapScanner,this._repairManager),n&&this.load(n),this.init()});y.prototype.reset=function(t,i=y.LEVEL_EASY,s=y.SPEED_MED){this._map=t,this.setLevel(i),this.setSpeed(s),this._phaseCycle=0,this._simCycle=0,this._cityTime=0,this._cityPopLast=0,this._messageLast=Sa,this._startingYear=1,this._lastTickTime=-1,this._cityYearLast=-1,this._cityMonthLast=-1,this._lastPowerMessage=null,this.evaluation=new v(this._gameLevel),this._valves=new xs,this.budget=new at,this._census=new Te,this._powerManager=new ie(this._map),this.spriteManager=new Z(this._map),this._mapScanner=new As(this._map),this._repairManager=new Bi(this._map),this._traffic=new V(this._map,this.spriteManager),this.disasterManager=new wt(this._map,this.spriteManager,this._gameLevel),this.blockMaps={cityCentreDistScoreMap:new j(this._map.width,this._map.height,8),crimeRateMap:new j(this._map.width,this._map.height,2),fireStationMap:new j(this._map.width,this._map.height,8),fireStationEffectMap:new j(this._map.width,this._map.height,8),landValueMap:new j(this._map.width,this._map.height,2),policeStationMap:new j(this._map.width,this._map.height,8),policeStationEffectMap:new j(this._map.width,this._map.height,8),pollutionDensityMap:new j(this._map.width,this._map.height,2),populationDensityMap:new j(this._map.width,this._map.height,2),rateOfGrowthMap:new j(this._map.width,this._map.height,8),terrainDensityMap:new j(this._map.width,this._map.height,4),trafficDensityMap:new j(this._map.width,this._map.height,2),tempMap1:new j(this._map.width,this._map.height,2),tempMap2:new j(this._map.width,this._map.height,2),tempMap3:new j(this._map.width,this._map.height,4)},this.budget.setFunds(999999999),this._census.totalPop=1,this._clearCensus();const n=["CLASSIFICATION_UPDATED","POPULATION_UPDATED","SCORE_UPDATED"].map(function(r){return Ra[r]});for(var o=0,a=n.length;o<a;o++)this.evaluation.addEventListener(n[o],d.reflectEvent.bind(this,n[o]));for(this._powerManager.addEventListener(ze,function(r){const l=new Date;(this._lastPowerMessage===null||l-this._lastPowerMessage>1e3*60*2)&&(this._emitEvent(L,{subject:ze}),this._lastPowerMessage=l)}.bind(this)),this.budget.addEventListener(Ye,d.reflectEvent.bind(this,Ye)),this.budget.addEventListener(Ge,d.reflectEvent.bind(this,Ge)),this.budget.addEventListener(pe,this._wrapMessage.bind(this,pe)),this._valves.addEventListener(je,this._onValveChange.bind(this)),o=0,a=me.length;o<a;o++)this.spriteManager.addEventListener(me[o],this._wrapMessage.bind(this,me[o])),this.disasterManager.addEventListener(me[o],this._wrapMessage.bind(this,me[o]));for(o=0,a=ge.length;o<a;o++)this.spriteManager.addEventListener(ge[o],this._wrapMessage.bind(this,ge[o]));this.spriteManager.addEventListener(ee,this._wrapMessage.bind(this,ee)),this._powerManager.registerHandlers(this._mapScanner,this._repairManager)},y.prototype.setLevel=function(t){if(t!==y.LEVEL_EASY&&t!==y.LEVEL_MED&&t!==y.LEVEL_HARD)throw new Error("Invalid level!");this._gameLevel=t},y.prototype.setSpeed=function(t){if(t!==y.SPEED_PAUSED&&t!==y.SPEED_SLOW&&t!==y.SPEED_MED&&t!==y.SPEED_FAST)throw new Error("Invalid speed!");this._speed=t},y.prototype.isPaused=function(){return this._speed===y.SPEED_PAUSED};const Se=["_cityTime","_speed","_gameLevel"];y.prototype.save=function(t){for(let i=0,s=Se.length;i<s;i++)t[Se[i]]=this[Se[i]];this._map.save(t),this.evaluation.save(t),this._valves.save(t),this.budget.save(t),this._census.save(t)},y.prototype.load=function(t){for(let i=0,s=Se.length;i<s;i++)this[Se[i]]=t[Se[i]]||this[Se[i]];this._map.load(t),this.evaluation.load(t),this._valves.load(t),this.budget.load(t),this._census.load(t)},y.prototype.simTick=function(){this._simFrame(),this._updateTime()},y.prototype._simFrame=function(){if(this.budget.awaitingValues)return;let t=100;switch(this._speed){case y.SPEED_PAUSED:return;case y.SPEED_SLOW:break;case y.SPEED_MED:t=50;break;case y.SPEED_FAST:t=10;break;default:console.warn("Unexpected speed ("+this._speed+"): defaulting to slow")}if(new Date().getTime()-this._lastTickTime<t)return;const i=this._constructSimData();this._simulate(i),this._lastTickTime=new Date().getTime()},y.prototype._clearCensus=function(){this._census.clearCensus(),this._powerManager.clearPowerStack(),this.blockMaps.fireStationMap.clear(),this.blockMaps.policeStationMap.clear()},y.prototype._constructSimData=function(){return{blockMaps:this.blockMaps,budget:this.budget,census:this._census,cityTime:this._cityTime,disasterManager:this.disasterManager,gameLevel:this._gameLevel,repairManager:this._repairManager,powerManager:this._powerManager,simulator:this,spriteManager:this.spriteManager,trafficManager:this._traffic,valves:this._valves}},y.prototype.init=function(){const t=this._constructSimData();this._mapScanner.mapScan(0,this._map.width,t),this._powerManager.doPowerScan(this._census),Mt.pollutionTerrainLandValueScan(this._map,this._census,this.blockMaps),Mt.crimeScan(this._census,this.blockMaps),Mt.populationDensityScan(this._map,this.blockMaps),Mt.fireAnalysis(this.blockMaps)};const ud=[2,4,5],dd=[2,7,17],pd=[1,8,18],fd=[1,9,19],md=[1,10,20],tr=4,gd=tr*10,_d=48,Ed=cd(function(t){this._phaseCycle&=15;const i=this._speed-1;switch(this._phaseCycle){case 0:++this._simCycle>1023&&(this._simCycle=0),this._cityTime++,(this._simCycle&1)===0&&this._valves.setValves(this._gameLevel,this._census,this.budget),this._clearCensus();break;case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:this._mapScanner.mapScan((this._phaseCycle-1)*this._map.width/8,this._phaseCycle*this._map.width/8,t);break;case 9:this._cityTime%tr===0&&this._census.take10Census(this.budget),this._cityTime%gd===0&&this._census.take120Census(this.budget),this._cityTime%_d===0&&(this.budget.collectTax(this._gameLevel,this._census),this.evaluation.cityEvaluation(t));break;case 10:this._simCycle%5===0&&Mt.neutraliseRateOfGrowthMap(t.blockMaps),Mt.neutraliseTrafficMap(this.blockMaps),this._sendMessages();break;case 11:this._simCycle%ud[i]===0&&this._powerManager.doPowerScan(this._census);break;case 12:this._simCycle%dd[i]===0&&Mt.pollutionTerrainLandValueScan(this._map,this._census,this.blockMaps);break;case 13:this._simCycle%pd[i]===0&&Mt.crimeScan(this._census,this.blockMaps);break;case 14:this._simCycle%fd[i]===0&&Mt.populationDensityScan(this._map,this.blockMaps);break;case 15:this._simCycle%md[i]===0&&Mt.fireAnalysis(this.blockMaps),this.disasterManager.doDisasters(this._census);break}this._phaseCycle=this._phaseCycle+1&15},"simulate");y.prototype._simulate=function(t){this.evaluation.cityEvaluation(t),this._simulate=Ed,this._simulate(t)},y.prototype._wrapMessage=function(t,i){this._emitEvent(L,{subject:t,data:i})},y.prototype._sendMessages=function(){this._checkGrowth();const t=this._census.resZonePop+this._census.comZonePop+this._census.indZonePop,i=this._census.nuclearPowerPop+this._census.coalPowerPop;switch(this._cityTime&63){case 1:Math.floor(t/4)>=this._census.resZonePop&&this._emitEvent(L,{subject:ws});break;case 5:Math.floor(t/8)>=this._census.comZonePop&&this._emitEvent(L,{subject:_s});break;case 10:Math.floor(t/8)>=this._census.indZonePop&&this._emitEvent(L,{subject:Es});break;case 14:t>10&&t*2>this._census.roadTotal&&this._emitEvent(L,{subject:vs});break;case 18:t>50&&t>this._census.railTotal&&this._emitEvent(L,{subject:Ts});break;case 22:t>10&&i===0&&this._emitEvent(L,{subject:ms});break;case 26:this._census.resPop>500&&this._census.stadiumPop===0?(this._emitEvent(L,{subject:bs}),this._valves.resCap=!0):this._valves.resCap=!1;break;case 28:this._census.indPop>70&&this._census.seaportPop===0?(this._emitEvent(L,{subject:ys}),this._valves.indCap=!0):this._valves.indCap=!1;break;case 30:this._census.comPop>100&&this._census.airportPop===0?(this._emitEvent(L,{subject:fs}),this._valves.comCap=!0):this._valves.comCap=!1;break;case 32:var s=this._census.unpoweredZoneCount+this._census.poweredZoneCount;if(s>0&&this._census.poweredZoneCount/s<.7&&i>0){const n=new Date;(this._lastPowerMessage===null||n-this._lastPowerMessage>1e3*60*2)&&(this._emitEvent(L,{subject:hs}),this._lastPowerMessage=n)}break;case 35:this._census.pollutionAverage>60&&this._emitEvent(L,{subject:ps,data:{x:this._map.pollutionMaxX,y:this._map.pollutionMaxY}});break;case 42:this._census.crimeAverage>100&&this._emitEvent(L,{subject:ds});break;case 45:this._census.totalPop>60&&this._census.fireStationPop===0&&this._emitEvent(L,{subject:gs});break;case 48:this._census.totalPop>60&&this._census.policeStationPop===0&&this._emitEvent(L,{subject:Ss});break;case 51:this.budget.cityTax>12&&this._emitEvent(L,{subject:Rs});break;case 54:this.budget.roadEffect<Math.floor(5*this.budget.MAX_ROAD_EFFECT/8)&&this._census.roadTotal>30&&this._emitEvent(L,{subject:Ds});break;case 57:this.budget.fireEffect<Math.floor(7*this.budget.MAX_FIRE_STATION_EFFECT/10)&&this._census.totalPop>20&&this._emitEvent(L,{subject:us});break;case 60:this.budget.policeEffect<Math.floor(7*this.budget.MAX_POLICE_STATION_EFFECT/10)&&this._census.totalPop>20&&this._emitEvent(L,{subject:Os});break;case 63:this._census.trafficAverage>60&&this._emitEvent(L,{subject:Ps});break}},y.prototype._checkGrowth=function(){if((this._cityTime&3)!==0)return;let t="";const i=this.evaluation.getPopulation(this._census);if(i!==this._cityPopLast){const s=this.evaluation.getCityClass(this._cityPopLast),n=this.evaluation.getCityClass(i);if(s!==n)switch(n){case v.CC_VILLAGE:break;case v.CC_TOWN:t=ki;break;case v.CC_CITY:t=Ai;break;case v.CC_CAPITAL:t=$i;break;case v.CC_METROPOLIS:t=Li;break;case v.CC_MEGALOPOLIS:t=Ii;break}}t!==""&&t!==this._messageLast&&(this._emitEvent(L,{subject:t}),this._messageLast=t),this._cityPopLast=i},y.prototype._onValveChange=function(){this._resLast=this._valves.resValve,this._comLast=this._valves.comValve,this._indLast=this._valves.indValve,this._emitEvent(je,{residential:this._valves.resValve,commercial:this._valves.comValve,industrial:this._valves.indValve})},y.prototype.getDate=function(){const t=Math.floor(this._cityTime/48)+this._startingYear;return{month:Math.floor(this._cityTime%48)>>2,year:t}},y.prototype._setYear=function(t){t<this._startingYear&&(t=this._startingYear),t=t-this._startingYear-this._cityTime/48,this._cityTime+=t*48,this._updateTime()},y.prototype._updateTime=function(){const t=Math.floor(this._cityTime/48)+this._startingYear,i=Math.floor(this._cityTime%48)>>2;if(t>=1e6){this.setYear(startingYear);return}(this._cityYearLast!==t||this._cityMonthLast!==i)&&(this._cityYearLast=t,this._cityMonthLast=i,this._emitEvent(cs,{month:i,year:t}))},Object.defineProperties(y,{LEVEL_EASY:d.makeConstantDescriptor(0),LEVEL_MED:d.makeConstantDescriptor(1),LEVEL_HARD:d.makeConstantDescriptor(2),SPEED_PAUSED:d.makeConstantDescriptor(0),SPEED_SLOW:d.makeConstantDescriptor(1),SPEED_MED:d.makeConstantDescriptor(2),SPEED_FAST:d.makeConstantDescriptor(3)});var Td=Object.defineProperty,Ns=u((t,i)=>Td(t,"name",{value:i,configurable:!0}),"o$b");const wd=Ns(function(){let t=window.localStorage.getItem(this.KEY);return t!==null&&(t=JSON.parse(t),t.version!==this.CURRENT_VERSION&&this.transitionOldSave(t),t.isSavedGame=!0),t},"getSavedGame"),vd=Ns(function(t){t.version=this.CURRENT_VERSION,t=JSON.stringify(t),window.localStorage.setItem(this.KEY,t)},"saveGame"),Sd=Ns(function(){window.localStorage.removeItem(this.KEY)},"clear"),yd=Ns(function(t){switch(t.version){case 1:t.everClicked=!1;case 2:t.pollutionMaxX=Math.floor(t.width/2),t.pollutionMaxY=Math.floor(t.height/2),t.cityCentreX=Math.floor(t.width/2),t.cityCentreY=Math.floor(t.height/2);break;default:throw new Error("Unknown save version!")}},"transitionOldSave"),Ft={getSavedGame:wd,saveGame:vd,clear:Sd,transitionOldSave:yd};Object.defineProperty(Ft,"CURRENT_VERSION",d.makeConstantDescriptor(3)),Object.defineProperty(Ft,"KEY",d.makeConstantDescriptor("micropolisJSGame")),Object.defineProperty(Ft,"canStore",d.makeConstantDescriptor(window.localStorage!==void 0));var bd=Object.defineProperty,er=u((t,i)=>bd(t,"name",{value:i,configurable:!0}),"l$8");const Pt=er(function(t,i){i=i?d.normaliseDOMid(i):null;const s=er(function(n,o){this._opacityLayer=d.normaliseDOMid(n),this._windowID=d.normaliseDOMid(o),t.call(this)},"newConstructor");return s.prototype._toggleDisplay=function(){let n=$(this._opacityLayer);if(n=n.length===0?null:n,n===null)throw new Error("Node "+this._opacityLayer+" not found");let o=$(this._windowID);if(o=o.length===0?null:o,o===null)throw new Error("Node "+this._windowID+" not found");n.toggle(),o.toggle(),i!==null?$(i).focus():$(this._windowID+" input[type=submit]").focus()},ht(s)},"ModalWindow");var Od=Object.defineProperty,si=u((t,i)=>Od(t,"name",{value:i,configurable:!0}),"c$7");const ye=["roadMaintenanceBudget","fireMaintenanceBudget","policeMaintenanceBudget"],vt=["roadRate","fireRate","policeRate"],Dd="#budgetReset",Cd="#budgetCancel",Md="#budgetForm",Zn=si(function(t,i,s){const n=t+"Label",o=Math.floor(s*(i/100)),a=[i,"% of $",s," = $",o].join("");$(d.normaliseDOMid(n)).text(a)},"setSpendRangeText"),Rd=si(function(t,i){const s=$(d.normaliseDOMid(t))[0],n=s.value-0,o=s.getAttribute("data-source");Zn(t,n,this[o])},"onFundingUpdate"),qn=si(function(t){const i=$("#taxRateLabel")[0],s=$("#taxRate")[0];$(i).text(["Tax rate: ",s.value,"%"].join(""))},"onTaxUpdate"),Pd=si(function(t){for(let i=0;i<vt.length;i++){const s=this["original"+vt[i]];$(d.normaliseDOMid(vt[i]))[0].value=s,Zn(vt[i],s,this[ye[i]])}$("#taxRate")[0].value=this.originaltaxRate,qn(),t.preventDefault()},"resetItems"),$d=si(function(t){t.preventDefault(),this.close({cancelled:!0})},"cancel"),Ad=si(function(t){t.preventDefault();const i=$("#roadRate")[0].value,s=$("#fireRate")[0].value,n=$("#policeRate")[0].value,o=$("#taxRate")[0].value,a={cancelled:!1,roadPercent:i,firePercent:s,policePercent:n,taxPercent:o,e:t,original:t.type};this.close(a)},"submit"),Kn=Pt(function(){$(Cd).on("click",$d.bind(this)),$(Dd).on("click",Pd.bind(this)),$(Md).on("submit",Ad.bind(this))});Kn.prototype.close=function(t){t=t||{cancelled:!0},this._emitEvent(Cn,t),this._toggleDisplay()},Kn.prototype.open=function(t){let i,s;for(i=0;i<ye.length;i++){if(t[ye[i]]===void 0)throw new Error("Missing budget data ("+ye[i]+")");this[ye[i]]=t[ye[i]]}for(i=0;i<vt.length;i++){if(t[vt[i]]===void 0)throw new Error("Missing budget data ("+vt[i]+")");s=vt[i],this["original"+s]=t[s],Zn(s,t[vt[i]],this[ye[i]]),s=$(d.normaliseDOMid(s)),s.on("change",Rd.bind(this,vt[i])),s=s[0],s.value=t[vt[i]]}if(t.taxRate===void 0)throw new Error("Missing budget data (taxRate)");this.originalTaxRate=t.taxRate,s=$("#taxRate"),s.on("change",qn),s=s[0],s.value=t.taxRate,qn();const n=t.totalFunds;if(n===void 0)throw new Error("Missing budget data (previousFunds)");const o=t.taxesCollected;if(o===void 0)throw new Error("Missing budget data (taxesCollected)");const a=o-this.roadMaintenanceBudget-this.fireMaintenanceBudget-this.policeMaintenanceBudget,r=n+a;$("#taxesCollected").text("$"+o),$("#cashFlow").text((a<0?"-$":"$")+a),$("#previousFunds").text((n<0?"-$":"$")+n),$("#currentFunds").text("$"+r),this._toggleDisplay()};var Ld=Object.defineProperty,ir=u((t,i)=>Ld(t,"name",{value:i,configurable:!0}),"n$a");const ni=Pt(function(){$(Id).on("click",xd.bind(this)),$(kd).on("submit",Nd.bind(this))});var Id="#debugCancel",kd="#debugForm";ni.prototype.close=function(t){t=t||[],this._emitEvent(Rn,t),this._toggleDisplay()};var xd=ir(function(t){t.preventDefault(),this.close([])},"cancel"),Nd=ir(function(t){t.preventDefault();const i=[];$(".debugAdd:checked").val()==="true"&&i.push({action:ni.ADD_FUNDS,data:{}}),this.close(i)},"submit");ni.prototype.open=function(){this._toggleDisplay()},function(){let t=0;return function(i){Object.defineProperty(ni,i,d.makeConstantDescriptor(t)),t+=1}}()("ADD_FUNDS");var Vd=Object.defineProperty,sr=u((t,i)=>Vd(t,"name",{value:i,configurable:!0}),"a$8"),nr="#disasterSelect",Bd="#disasterCancel",Fd="#disasterForm",z=Pt(function(){$(Fd).on("submit",Wd.bind(this)),$(Bd).on("click",Hd.bind(this))},nr);z.prototype.close=function(t){t=t||z.DISASTER_NONE,this._toggleDisplay(),this._emitEvent(Pn,t)};var Hd=sr(function(t){t.preventDefault(),this.close()},"cancel"),Wd=sr(function(t){t.preventDefault();var i=$(nr)[0].value;this.close(i)},"submit");z.prototype.open=function(){$("#disasterNone").attr("value",z.DISASTER_NONE),$("#disasterMonster").attr("value",z.DISASTER_MONSTER),$("#disasterFire").attr("value",z.DISASTER_FIRE),$("#disasterFlood").attr("value",z.DISASTER_FLOOD),$("#disasterCrash").attr("value",z.DISASTER_CRASH),$("#disasterMeltdown").attr("value",z.DISASTER_MELTDOWN),$("#disasterTornado").attr("value",z.DISASTER_TORNADO),this._toggleDisplay()},Object.defineProperties(z,{DISASTER_NONE:d.makeConstantDescriptor("None"),DISASTER_MONSTER:d.makeConstantDescriptor("Monster"),DISASTER_FIRE:d.makeConstantDescriptor("Fire"),DISASTER_FLOOD:d.makeConstantDescriptor("Flood"),DISASTER_CRASH:d.makeConstantDescriptor("Crash"),DISASTER_MELTDOWN:d.makeConstantDescriptor("Meltdown"),DISASTER_TORNADO:d.makeConstantDescriptor("Tornado")});const Ud=["Low","Medium","High","Very High"],Gd=["Slum","Lower Class","Middle Class","High"],Yd=["Safe","Light","Moderate","Dangerous"],zd=["None","Moderate","Heavy","Very Heavy"],Xd=["Declining","Stable","Slow Growth","Fast Growth"],jd=["Clear","Water","Trees","Rubble","Flood","Radioactive Waste","Fire","Road","Power","Rail","Residential","Commercial","Industrial","Seaport","Airport","Coal Power","Fire Department","Police Department","Stadium","Nuclear Power","Draw Bridge","Radar Dish","Fountain","Industrial","Steelers 38  Bears 3","Draw Bridge","Ur 238"],Vs={};Vs[""+y.LEVEL_EASY]="Easy",Vs[""+y.LEVEL_MED]="Medium",Vs[""+y.LEVEL_HARD]="Hard";const be={};be[v.CC_VILLAGE]="VILLAGE",be[v.CC_TOWN]="TOWN",be[v.CC_CITY]="CITY",be[v.CC_CAPITAL]="CAPITAL",be[v.CC_METROPOLIS]="METROPOLIS",be[v.CC_MEGALOPOLIS]="MEGALOPOLIS";const ne={};ne[v.CRIME]="Crime",ne[v.POLLUTION]="Pollution",ne[v.HOUSING]="Housing",ne[v.TAXES]="Taxes",ne[v.TRAFFIC]="Traffic",ne[v.UNEMPLOYMENT]="Unemployment",ne[v.FIRE]="Fire";const Zd=["January","February","March","April","May","June","July","August","September","October","November","December"],qd={noMoney:"Insufficient funds to build that",needsDoze:"Area must be bulldozed first"},J={};J[us]=!0,J[fs]=!0,J[gs]=!0,J[ms]=!0,J[Es]=!0,J[_s]=!0,J[ws]=!0,J[Ts]=!0,J[vs]=!0,J[Ss]=!0,J[ys]=!0,J[bs]=!0,J[Ds]=!0,J[Os]=!0,J[Un]=!0;const U={};U[hs]=!0,U[yi]=!0,U[bi]=!0,U[Di]=!0,U[Oi]=!0,U[ee]=!0,U[Ci]=!0,U[ds]=!0,U[ps]=!0,U[Mi]=!0,U[pe]=!0,U[ze]=!0,U[Ri]=!0,U[Pi]=!0,U[xi]=!0,U[Rs]=!0,U[Xe]=!0,U[Ps]=!0,U[Vi]=!0;const oi={};oi[$i]=!0,oi[Ai]=!0,oi[Ii]=!0,oi[Li]=!0,oi[ki]=!0;const b={};b[us]="Fire departments need funding",b[fs]="Commerce requires an Airport",b[gs]="Citizens demand a Fire Department",b[ms]="Build a Power Plant",b[Es]="More industrial zones needed",b[_s]="More commercial zones needed",b[ws]="More residential zones needed",b[Ts]="Inadequate rail system",b[vs]="More roads required",b[Ss]="Citizens demand a Police Department",b[ys]="Industry requires a Sea Port",b[bs]="Residents demand a Stadium",b[Ds]="Roads deteriorating, due to lack of funds",b[Os]="Police departments need funding",b[Un]="Welcome to micropolisJS",b[hs]="Brownouts, build another Power Plant",b[yi]="Major earthquake reported !!",b[bi]="Explosion detected ",b[Di]="Flooding reported !",b[Oi]="Fire reported ",b[ee]="Heavy traffic reported",b[Ci]="A helicopter crashed ",b[ds]="Crime very high",b[ps]="Pollution very high",b[Mi]="A Monster has been sighted !",b[pe]="YOUR CITY HAS GONE BROKE",b[ze]="Blackouts reported: insufficient power capacity",b[Ri]="A Nuclear Meltdown has occurred !!",b[Pi]="A plane has crashed ",b[xi]="Shipwreck reported ",b[Rs]="Citizens upset. The tax rate is too high",b[Xe]="Tornado reported !",b[Ps]="Frequent traffic jams reported",b[Vi]="A train crashed ",b[$i]="Population has reached 50,000",b[Ai]="Population has reached 10,000",b[Ii]="Population has reached 500,000",b[Li]="Population has reached 100,000",b[ki]="Population has reached 2,000";const tt={badMessages:U,cityClass:be,crimeStrings:Yd,densityStrings:Ud,gameLevel:Vs,goodMessages:oi,landValueStrings:Gd,messageText:b,months:Zd,neutralMessages:J,problems:ne,pollutionStrings:zd,rateStrings:Xd,toolMessages:qd,zoneTypes:jd};var Kd=Object.defineProperty,Qd=u((t,i)=>Kd(t,"name",{value:i,configurable:!0}),"i$8");const Jd="#evalButtons",tp=Qd(function(t){t.preventDefault(),this.close()},"submit"),Bs=Pt(function(){$(Jd).on("submit",tp.bind(this))});Bs.prototype.close=function(){this._emitEvent($n),this._toggleDisplay()},Bs.prototype._populateWindow=function(t){$("#evalYes").text(t.cityYes),$("#evalNo").text(100-t.cityYes);for(let i=0;i<4;i++){const s=t.getProblemNumber(i);if(s!==null){const n=tt.problems[s];$("#evalProb"+(i+1)).text(n),$("#evalProb"+(i+1)).show()}else $("#evalProb"+(i+1)).hide()}$("#evalPopulation").text(t.cityPop),$("#evalMigration").text(t.cityPopDelta),$("#evalValue").text(t.cityAssessedValue),$("#evalLevel").text(tt.gameLevel[t.gameLevel]),$("#evalClass").text(tt.cityClass[t.cityClass]),$("#evalScore").text(t.cityScore),$("#evalScoreDelta").text(t.cityScoreDelta)},Bs.prototype.open=function(t){this._populateWindow(t),this._toggleDisplay()};var ep=Object.defineProperty,or=u((t,i)=>ep(t,"name",{value:i,configurable:!0}),"i$7");function Wi(){this.clear()}u(Wi,"e$5"),or(Wi,"TileHistory");const ar=or(function(t,i){return[t,i].join(",")},"toKey");Wi.prototype.clear=function(){this.data={}},Wi.prototype.getTile=function(t,i){const s=ar(t,i);return this.data[s]},Wi.prototype.setTile=function(t,i,s){const n=ar(t,i);this.data[n]=s};var ip=Object.defineProperty,sp=u((t,i)=>ip(t,"name",{value:i,configurable:!0}),"B$3");class Qn{constructor(i,s,n){s=s||220,n=n||600,this._map=i,this.animationPeriod=s,this.lastAnimation=new Date(1970,1,1),this.lastBlink=new Date(1970,1,1),this.blinkPeriod=n,this.shouldBlink=!1,this._lastPainted=null,this._currentPainted=null,this._data=[],this.initArray(),this.registerAnimations()}initArray(){for(let i=0;i<ts;i++)this._data[i]=i}inSequence(i,s){const n=[i];let o=this._data[i];for(;n.indexOf(o)===-1;){if(o===s)return!0;n.push(o),o=this._data[o]}return!1}getTiles(i,s,n,o,a,r){r=r||!1;let l=!1;const h=new Date;let c=this.shouldBlink;h-this.lastBlink>this.blinkPeriod&&(c=this.shouldBlink=!this.shouldBlink,this.lastBlink=h),r||h-this.lastAnimation>this.animationPeriod&&(l=!0,this.lastAnimation=h);const f=this._currentPainted===null?new Wi:this._currentPainted;for(let w=0;w<a;w++)for(let C=0;C<o;C++){const M=C+s,it=w+n,ct=w*o+C;if(M<0||M>=this._map.width||it<0||it>=this._map.height)continue;const st=i[ct];if(st===Jt)continue;if(c&&st&xe&&!(st&Nt)){i[ct]=Sl;continue}if(!(st&K)){i[ct]=st&rs;continue}const I=st&rs;let B=Jt;var _;if(this._lastPainted&&(_=this._lastPainted.getTile(C,w)),l?_&&this.inSequence(I,_)?_===Ji?(this._map.setTo(M,it,T.randomRubble()),B=this._map.getTileValue(M,it)):B=this._data[_]:B=this._data[I]:_&&this.inSequence(I,_)&&(B=_),B===Jt){i[ct]=I;continue}i[ct]=B,f.setTile(C,w,B)}const S=this._lastPainted;this._lastPainted=f,S!==null&&S.clear(),this._currentPainted=S}registerSingleAnimation(i){for(let s=1;s<i.length;s++)this._data[i[s-1]]=i[s]}registerAnimations(){this.registerSingleAnimation([56,57,58,59,60,61,62,63,56]),this.registerSingleAnimation([80,128,112,96,80]),this.registerSingleAnimation([81,129,113,97,81]),this.registerSingleAnimation([82,130,114,98,82]),this.registerSingleAnimation([83,131,115,99,83]),this.registerSingleAnimation([84,132,116,100,84]),this.registerSingleAnimation([85,133,117,101,85]),this.registerSingleAnimation([86,134,118,102,86]),this.registerSingleAnimation([87,135,119,103,87]),this.registerSingleAnimation([88,136,120,104,88]),this.registerSingleAnimation([89,137,121,105,89]),this.registerSingleAnimation([90,138,122,106,90]),this.registerSingleAnimation([91,139,123,107,91]),this.registerSingleAnimation([92,140,124,108,92]),this.registerSingleAnimation([93,141,125,109,93]),this.registerSingleAnimation([94,142,126,110,94]),this.registerSingleAnimation([95,143,127,111,95]),this.registerSingleAnimation([144,192,176,160,144]),this.registerSingleAnimation([145,193,177,161,145]),this.registerSingleAnimation([146,194,178,162,146]),this.registerSingleAnimation([147,195,179,163,147]),this.registerSingleAnimation([148,196,180,164,148]),this.registerSingleAnimation([149,197,181,165,149]),this.registerSingleAnimation([150,198,182,166,150]),this.registerSingleAnimation([151,199,183,167,151]),this.registerSingleAnimation([152,200,184,168,152]),this.registerSingleAnimation([153,201,185,169,153]),this.registerSingleAnimation([154,202,186,170,154]),this.registerSingleAnimation([155,203,187,171,155]),this.registerSingleAnimation([156,204,188,172,156]),this.registerSingleAnimation([157,205,189,173,157]),this.registerSingleAnimation([158,206,190,174,158]),this.registerSingleAnimation([159,207,191,175,159]),this.registerSingleAnimation([621,852,853,854,855,856,857,858,859,852]),this.registerSingleAnimation([641,884,885,886,887,884]),this.registerSingleAnimation([644,888,889,890,891,888]),this.registerSingleAnimation([649,892,893,894,895,892]),this.registerSingleAnimation([650,896,897,898,899,896]),this.registerSingleAnimation([676,900,901,902,903,900]),this.registerSingleAnimation([677,904,905,906,907,904]),this.registerSingleAnimation([686,908,909,910,911,908]),this.registerSingleAnimation([689,912,913,914,915,912]),this.registerSingleAnimation([747,916,917,918,919,916]),this.registerSingleAnimation([748,920,921,922,923,920]),this.registerSingleAnimation([751,924,925,926,927,924]),this.registerSingleAnimation([752,928,929,930,931,928]),this.registerSingleAnimation([820,952,953,954,955,952]),this.registerSingleAnimation([832,833,834,835,836,837,838,839,832]),this.registerSingleAnimation([840,841,842,843,840]),this.registerSingleAnimation([844,845,846,847,848,849,850,851,844]),this.registerSingleAnimation([860,861,862,863,864,865,866,867]),this.registerSingleAnimation([932,933,934,935,936,937,938,939,932]),this.registerSingleAnimation([940,941,942,943,944,945,946,947,940])}}u(Qn,"P"),sp(Qn,"AnimationManager");const np={draw:function(t,i,s,n,o){const a=o.lineWidth||3,r=o.colour||"yellow",l="outline"in o&&o.outline===!0||!1;let h=-1,c=1;l||(h=1,c=-1);const f=i.x+h*a/2;s=s+c*a;const _=i.y+h*a/2;n=n+c*a;const S=t.getContext("2d");S.lineWidth=a,S.strokeStyle=r,S.strokeRect(f,_,s,n)}};var op=Object.defineProperty,ap=u((t,i)=>op(t,"name",{value:i,configurable:!0}),"T$3");const rr=u(class{constructor(t,i,s=1.4){if(arguments.length<1)throw new Error("Attempt to construct a GameCanvas with no parameters");if(i===void 0&&(i=t,t=rr.DEFAULT_ID),typeof i=="string"){const a=i;if(i=$(d.normaliseDOMid(i)),i=i.length===0?null:i[0],i===null)throw new Error("Node "+a+" not found")}this.parentNode=i,this.zoomRatio=s,this._canvas=document.createElement("canvas"),this._canvas.id=t,this.ctx=this._canvas.getContext("2d");const n=i.getBoundingClientRect();this._canvas.width=n.width,this._canvas.height=n.height,this._canvas.style.margin="0",this._canvas.style.padding="0",this._canvas.style.transform=`scale(${s})`,this._canvas.style.imageRendering="pixelated",this._pendingTileSet=null;const o=document.getElementById(t);if(o!==null)if(o.parentNode===i)i.replaceChild(this._canvas,o);else throw new Error("ID "+t+" already exists in document!");else i.appendChild(this._canvas);this.ready=!1}init(t,i,s,n){if(arguments.length<3)throw new Error("GameCanvas constructor called with too few arguments "+[].toString.apply(arguments));if(!i.isValid)throw new Error("TileSet not ready!");this._spriteSheet=s,this._tileSet=i;const o=this._tileSet.tileWidth;if(this._map=t,this.animationManager=n||new Qn(t),this._canvas.width<o||this._canvas.height<o)throw new Error("Canvas too small!");this._allowScrolling=!0,this.reset();const a=function(r){this._pendingDimensionChange=!0}.bind(this);window.addEventListener("resize",a,!1)}reset(t){t&&(this._map=t),this._lastPaintedTiles=null,this._currentPaintedTiles=[],this._lastPaintedWidth=-1,this._lastPaintedHeight=-1,this._lastCanvasWidth=-1,this._lastCanvasHeight=-1,this._lastCanvasData=null,this._calculateDimensions(),this._pendingDimensionChange=!1,this.ready=!0,this.centreOn(Math.floor(this._map.width/2),Math.floor(this._map.height/2)),this.paint(null,null)}setZoom(t){this.zoomRatio=t,this._canvas.style.transform=`scale(${t})`,this.reset()}zoomIn(){let t=this.zoomRatio;t>=1.7||(t+=.2,this.setZoom(t))}zoomOut(){let t=this.zoomRatio;t<=1.1||(t-=.2,this.setZoom(t))}_calculateDimensions(t){t=t||!1;const i=this.canvasWidth=this._canvas.parentNode.clientWidth,s=this.canvasHeight=this._canvas.parentNode.clientHeight;if(s===this._lastCanvasHeight&&i===this._lastCanvasWidth&&!t)return;this._canvas.width=i,this._canvas.height=s;const n=this._tileSet.tileWidth;this._wholeTilesInViewX=Math.floor(i/n),this._wholeTilesInViewY=Math.floor(s/n),this._totalTilesInViewX=Math.ceil(i/n),this._totalTilesInViewY=Math.ceil(s/n),this._allowScrolling?(this.minX=0,this.maxX=this._map.width-1-Math.ceil(Math.floor(i/n)/2)-Math.floor(Math.floor(i/(n*this.zoomRatio))/2),this.minY=0,this.maxY=this._map.height-1-Math.ceil(Math.floor(s/n)/2)-Math.floor(Math.floor(s/(n*this.zoomRatio))/2)):(this.minX=0,this.minY=0,this.maxX=this._map.width-this._totalTilesInViewX,this.maxY=this._map.height-this._totalTilesInViewY),this._pendingDimensionChange=!0}disallowOffMap(){this._allowScrolling=!1,this._lastPaintedTiles=null,this._calculateDimensions(!0)}moveNorth(){!this.ready||this._originY>this.minY&&this._originY--}moveEast(){!this.ready||this._originX<this.maxX&&this._originX++}moveSouth(){!this.ready||this._originY<this.maxY&&this._originY++}moveWest(){!this.ready||this._originX>this.minX&&this._originX--}moveTo(t,i){if(arguments.length<1)throw new Error("GameCanvas moveTo called with no arguments");if(this.ready){if(t<this.minX||t>this.maxX||i<this.minY||i>this.maxY)throw new Error("Coordinates out of bounds");this._originX=t,this._originY=i}}centreOn(t,i){if(arguments.length<1)throw new Error("GameCanvas centreOn called with no arguments");if(!this.ready)throw new Error("Not ready!");i===void 0&&(i=t.y,t=t.x);let s=Math.floor(t)-Math.ceil(this._wholeTilesInViewX/2),n=Math.floor(i)-Math.ceil(this._wholeTilesInViewY/2);s>this.maxX&&(s=this.maxX),s<this.minX&&(s=this.minX),n>this.maxY&&(n=this.maxY),n<this.minY&&(n=this.minY),this._originX=s,this._originY=n}getTileOrigin(){const t=new Error("Not ready!");if(!this.ready)throw t;return{x:this._originX,y:this._originY}}getMaxTile(){const t=new Error("Not ready!");if(!this.ready)throw t;return{x:this._originX+this._totalTilesInViewX-1,y:this._originY+this._totalTilesInViewY-1}}canvasCoordinateToTileOffset(t,i){if(arguments.length<2)throw new Error("GameCanvas canvasCoordinateToTileOffset called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");return{x:Math.floor(t/this._tileSet.tileWidth/this.zoomRatio),y:Math.floor(i/this._tileSet.tileWidth/this.zoomRatio)}}canvasCoordinateToTileCoordinate(t,i){if(arguments.length<2)throw new Error("GameCanvas canvasCoordinateToTileCoordinate called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");const s=this.canvasWidth*this.zoomRatio,n=this.canvasHeight*this.zoomRatio;if(t>=s||i>=n)return null;const o=this._originX+Math.floor(t/this._tileSet.tileWidth/this.zoomRatio),a=this._originY+Math.floor(i/this._tileSet.tileWidth/this.zoomRatio);return{x:o,y:a}}canvasCoordinateToPosition(t,i){if(arguments.length<2)throw new Error("GameCanvas canvasCoordinateToPosition called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");const s=this.canvasWidth*this.zoomRatio,n=this.canvasHeight*this.zoomRatio;return t>=s||i>=n||(t=this._originX+Math.floor(t/this._tileSet.tileWidth/this.zoomRatio),i=this._originY+Math.floor(i/this._tileSet.tileWidth/this.zoomRatio),t<0||t>=this._map.width||i<0||i>=this._map.height)?null:new D(t,i)}positionToCanvasCoordinate(t){if(arguments.length<1)throw new Error("GameCanvas positionToCanvasCoordinate called with too few arguments "+[].toString.apply(arguments));return this.tileToCanvasCoordinate(t)}tileToCanvasCoordinate(t,i){if(arguments.length<1)throw new Error("GameCanvas tileToCanvasCoordinate  called with too few arguments "+[].toString.apply(arguments));if(!this.ready)throw new Error("Not ready!");if(i===void 0&&(i=t.y,t=t.x),t===void 0||i===void 0||t<this.minX||i<this.minY||t>this.maxX+this._totalTilesInViewX-1||i>this.maxY+this._totalTilesInViewY-1)throw e;return t<this._originX||t>=this._originX+this._totalTilesInViewX||i<this._originY||i>=this._originY+this._totalTilesInViewY?null:{x:(t-this._originX)*this._tileSet.tileWidth*this.zoomRatio,y:(i-this._originY)*this._tileSet.tileWidth*this.zoomRatio}}changeTileSet(t){if(!this.ready)throw new Error("Not ready!");if(!t.isValid)throw new Error("new tileset not loaded");this._pendingTileSet=t}_screenshot(t){if(t)return this._canvas.toDataURL();const i=document.createElement("canvas");i.width=this._map.width*this._tileSet.tileWidth,i.height=this._map.height*this._tileSet.tileWidth;for(let s=0;s<this._map.width;s++)for(let n=0;n<this._map.height;n++)this._paintOne(this.ctx,this._map.getTileValue(s,n),s,n);return i.toDataURL()}screenshotMap(){return this._screenshot(!1)}screenshotVisible(){return this._screenshot(!0)}shoogle(){}_processSprites(t,i){const s=[],n=this._tileSet.tileWidth;for(let o=0,a=i.length;o<a;o++){const r=i[o];try{t.drawImage(this._spriteSheet,(r.frame-1)*48,(r.type-1)*48,r.width,r.width,r.x+r.xOffset-this._originX*16,r.y+r.yOffset-this._originY*16,r.width,r.width)}catch(l){console.warn("Failed to draw sprite "+r.type+" frame "+r.frame+" at "+r.x+", "+r.y);continue}s.push({x:Math.floor((r.x+r.xOffset-this._originX*16)/n),xBound:Math.ceil((r.x+r.xOffset+r.width-this._originX*16)/n),y:Math.floor((r.y+r.yOffset-this._originY*16)/n),yBound:Math.ceil((r.y+r.yOffset+r.height-this._originY*16)/n)})}return s}_processMouse(t){const i={x:0,xBound:0,y:0,yBound:0};if(t.width===0||t.height===0)return;let s=t.x,n=t.y;const o=t.width,a=t.height,r={colour:t.colour,outline:!0};if(o>2&&(s-=1),a>2&&(n-=1),this._originX+s<0&&this._originX+s+o<=0||this._originY+n<0&&this._originY+n+a<=0||this._originX+s>=this._map.width||this._originY+n>=this._map.height)return i.x=i.xBound=s,i.y=i.yBound=n,i;const l={x:s*this._tileSet.tileWidth,y:n*this._tileSet.tileWidth},h=o*this._tileSet.tileWidth,c=a*this._tileSet.tileWidth;return np.draw(this._canvas,l,h,c,r),i.x=s-1,i.xBound=s+o+2,i.y=n-1,i.yBound=n+o+2,i}_paintVoid(t,i,s){const n=this._tileSet.tileWidth;t.fillStyle="black",t.fillRect(i*n,s*n,n,n)}_paintOne(t,i,s,n){if(i===Jt){this._paintVoid(t,s,n);return}const o=this._tileSet[i];try{t.drawImage(o,s*this._tileSet.tileWidth,n*this._tileSet.tileWidth)}catch(a){const r=this._originX+s,l=this._originY+n;throw new Error("Failed to draw tile "+i+" at "+s+", "+n+" (map "+r+", "+l+" tile "+(this._map.testBounds(r,l)?this._map.getTileValue(r,l):"?? (Out of bounds)")+")")}}_paintTiles(t,i){let s,n,o;const a=this._lastPaintedTiles,r=this._totalTilesInViewX,l=this._totalTilesInViewY;if(a!==null){const c=Math.min(this._lastPaintedWidth,r),f=Math.min(this._lastPaintedHeight,l);for(n=0;n<f;n++)for(s=0;s<c;s++)o=n*c+s,a[o]!==i[o]&&this._paintOne(t,i[o],s,n);if(r>this._lastPaintedWidth)for(n=0;n<l;n++)for(s=this._lastPaintedWidth;s<r;s++)o=n*r+s,this._paintOne(t,i[o],s,n);if(l>this._lastPaintedHeight)for(n=this._lastPaintedHeight;n<l;n++)for(s=0;s<r;s++)o=n*r+s,this._paintOne(t,i[o],s,n)}else for(n=0;n<l;n++)for(s=0;s<r;s++)o=n*r+s,this._paintOne(t,i[o],s,n);this._lastPaintedWidth=r,this._lastPaintedHeight=l;const h=this._lastPaintedTiles;this._lastPaintedTiles=i,this._currentPaintedTiles=h}paint(t,i,s){let n,o,a,r,l,h,c,f;if(!this.ready)return;let _=this._lastPaintedTiles;if(this._pendingDimensionChange||this._pendingTileSet){if(this._calculateDimensions(),this._pendingDimensionChange=!1,this._pendingTileSet!==null&&(this._tileSet=this._pendingTileSet),this._pendingTileSet||this.canvasWidth!==this._lastCanvasWidth||this.canvasHeight!==this._lastCanvasHeight)for(this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight),r=0,o=_!==null?_.length:0;r<o;r++)_[r]=-2;this._pendingTileSet=null}const S=this._totalTilesInViewX,w=this._totalTilesInViewY,C=this._map.getTileValuesForPainting(this._originX,this._originY,S,w,this._currentPaintedTiles);if(this.animationManager.getTiles(C,this._originX,this._originY,S,w,s),this._paintTiles(this.ctx,C),_=this._lastPaintedTiles,this._lastCanvasWidth=this.canvasWidth,this._lastCanvasHeight=this.canvasHeight,!(!t&&!i)){if(t)for(l=this._processMouse(t),r=Math.max(0,l.y),c=Math.min(w,l.yBound);r<c;r++)for(a=Math.max(0,l.x),h=Math.min(S,l.xBound);a<h;a++)f=[r*S+a],_[f]=-2;if(i)for(l=this._processSprites(this.ctx,i),n=0,o=l.length;n<o;n++){const M=l[n];for(r=Math.max(0,M.y),c=Math.min(M.yBound,w);r<c;r++)for(a=Math.max(0,M.x),h=Math.min(M.xBound,S);a<h;a++)f=[r*S+a],this._lastPaintedTiles[f]=-2}}}},"p$5");let Fs=rr;ap(Fs,"GameCanvas"),Fs.DEFAULT_ID="microcity-canvas";var rp=Object.defineProperty,lp=u((t,i)=>rp(t,"name",{value:i,configurable:!0}),"l$5");const hp=lp(function(t,i,s,n,o,a){const r=d.normaliseDOMid(t),l=d.normaliseDOMid(i),h=d.normaliseDOMid(s),c=d.normaliseDOMid(n),f=d.normaliseDOMid(o),_=d.normaliseDOMid(a),S=$(r),w=$(l),C=$(h),M=$(c),it=$(f),ct=$(_);return function(st,I){S.text(I.classification),w.text(I.population),C.text(I.score),M.text(I.funds),it.text([tt.months[I.date.month],I.date.year].join(" ")),ct.text(I.name),st.addEventListener(Mn,function(B){S.text(B)}),st.addEventListener(An,function(B){w.text(B)}),st.addEventListener(kn,function(B){C.text(B)}),st.addEventListener(Ye,function(B){M.text(B)}),st.addEventListener(cs,function(B){it.text(`Year ${B.year} ${tt.months[B.month]}`)})}},"InfoBar");var cp=Object.defineProperty,Jn=u((t,i)=>cp(t,"name",{value:i,configurable:!0}),"r$a");function Oe(t){this._map=t,this._data={}}u(Oe,"o$7"),Jn(Oe,"WorldEffects");const lr=Jn(function(t,i){return[t,i].join(",")},"toKey"),up=Jn(function(t){return t=t.split(","),{x:t[0]-0,y:t[1]-0,toString:function(){return"World effect coord: ("+t[0]+", "+t[1]+")"}}},"fromKey");Oe.prototype.clear=function(){this._data=[]},Oe.prototype.getTile=function(t,i){const s=lr(t,i);let n=this._data[s];return n===void 0&&(n=this._map.getTile(t,i)),n},Oe.prototype.getTileValue=function(t,i){return this.getTile(t,i).getValue()},Oe.prototype.setTile=function(t,i,s,n){if(n!==void 0&&s instanceof X)throw new Error("Flags supplied with already defined tile");if(!this._map.testBounds(t,i))throw new Error("WorldEffects setTile called with invalid bounds "+t+", "+i);n===void 0&&!(s instanceof X)?s=new X(s):n!==void 0&&(s=new X(s,n));const o=lr(t,i);this._data[o]=s},Oe.prototype.apply=function(){const t=Object.keys(this._data);for(let i=0,s=t.length;i<s;i++){const n=up(t[i]);this._map.setTo(n,this._data[t[i]])}};var dp=Object.defineProperty,Ht=u((t,i)=>dp(t,"name",{value:i,configurable:!0}),"o$6");const pp=Ht(function(t,i,s,n){n=n||!1,Object.defineProperty(this,"toolCost",d.makeConstantDescriptor(t)),this.result=null,this.isDraggable=n,this._shouldAutoBulldoze=s,this._map=i,this._worldEffects=new Oe(i),this._applicationCost=0},"init"),fp=Ht(function(){this._applicationCost=0,this._worldEffects.clear()},"clear"),mp=Ht(function(t){this._applicationCost+=t},"addCost"),gp=Ht(function(t,i){let s=this._worldEffects.getTile(t,i);s.isBulldozable()&&(s=T.normalizeRoad(s.getValue()),(s>=di&&s<=Ji||s<ut&&s!==R)&&(this.addCost(1),this._worldEffects.setTile(t,i,R)))},"doAutoBulldoze"),_p=Ht(function(t){this._worldEffects.apply(),t.spend(this._applicationCost),this.clear()},"apply"),Ep=Ht(function(t){return this.result!==this.TOOLRESULT_OK?(this.clear(),!1):t.totalFunds<this._applicationCost?(this.result=this.TOOLRESULT_NO_MONEY,this.clear(),!1):(_p.call(this,t),this.clear(),!0)},"modifyIfEnoughFunding"),Tp=0,wp=1,vp=2,Sp=3,Hs={addCost:mp,autoBulldoze:!0,bulldozerCost:1,clear:fp,doAutoBulldoze:gp,init:pp,modifyIfEnoughFunding:Ep,TOOLRESULT_OK:Tp,TOOLRESULT_FAILED:wp,TOOLRESULT_NO_MONEY:vp,TOOLRESULT_NEEDS_BULLDOZE:Sp},Wt={makeTool:ur,setAutoBulldoze:function(t){Hs.autoBulldoze=t},getAutoBulldoze:function(){return Hs.autoBulldoze},save:hr,load:cr};function hr(t){t.autoBulldoze=Hs.autoBulldoze}u(hr,"U"),Ht(hr,"save");function cr(t){Wt.autoBulldoze=t.autoBulldoze}u(cr,"S$3"),Ht(cr,"load");function ur(t){return t.prototype=Object.create(Hs),t}u(ur,"N$2"),Ht(ur,"makeTool");var yp=Object.defineProperty,Ws=u((t,i)=>yp(t,"name",{value:i,configurable:!0}),"f$3");const bp=[yt,ri,yt,Yr,ri,ri,zr,qr,yt,jr,yt,Zr,Xr,Qr,Kr,li],Op=[It,ci,It,rl,ci,ci,ll,dl,It,cl,It,ul,hl,fl,pl,To],Dp=[zt,hi,zt,Jr,hi,hi,tl,nl,zt,il,zt,sl,el,al,ol,Eo],Cp=Ws(function(t,i){let s=0,n=this._worldEffects.getTile(t,i);if(n=T.normalizeRoad(n),n>=yt&&n<=li){i>0&&(n=this._worldEffects.getTileValue(t,i-1),n=T.normalizeRoad(n),(n===lt||n>=F&&n<=ot)&&n!==At&&n!==q&&n!==F&&(s|=1)),t<this._map.width-1&&(n=this._worldEffects.getTileValue(t+1,i),n=T.normalizeRoad(n),(n===q||n>=F&&n<=ot)&&n!==ot&&n!==lt&&n!==dt&&(s|=2)),i<this._map.height-1&&(n=this._worldEffects.getTileValue(t,i+1),n=T.normalizeRoad(n),(n===lt||n>=F&&n<=ot)&&n!==At&&n!==q&&n!==F&&(s|=4)),t>0&&(n=this._worldEffects.getTileValue(t-1,i),n=T.normalizeRoad(n),(n===q||n>=F&&n<=ot)&&n!==ot&&n!==lt&&n!==dt&&(s|=8)),this._worldEffects.setTile(t,i,bp[s],m|P);return}if(n>=It&&n<=To){i>0&&(n=this._worldEffects.getTileValue(t,i-1),n=T.normalizeRoad(n),n>=Q&&n<=q&&n!==Q&&n!==lt&&n!==pt&&(s|=1)),t<this._map.width-1&&(n=this._worldEffects.getTileValue(t+1,i),n=T.normalizeRoad(n),n>=Q&&n<=q&&n!==gt&&n!==q&&n!==Xt&&(s|=2)),i<this._map.height-1&&(n=this._worldEffects.getTileValue(t,i+1),n=T.normalizeRoad(n),n>=Q&&n<=q&&n!==Q&&n!==lt&&n!==pt&&(s|=4)),t>0&&(n=this._worldEffects.getTileValue(t-1,i),n=T.normalizeRoad(n),n>=Q&&n<=q&&n!==gt&&n!==q&&n!==Xt&&(s|=8)),this._worldEffects.setTile(t,i,Op[s],m|P);return}n>=zt&&n<=Eo&&(i>0&&(n=this._worldEffects.getTile(t,i-1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Yt&&n!==ot&&n!==gt&&(s|=1))),t<this._map.width-1&&(n=this._worldEffects.getTile(t+1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Lt&&n!==At&&n!==Q&&(s|=2))),i<this._map.height-1&&(n=this._worldEffects.getTile(t,i+1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Yt&&n!==ot&&n!==gt&&(s|=4))),t>0&&(n=this._worldEffects.getTile(t-1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!==Lt&&n!==At&&n!==Q&&(s|=8))),this._worldEffects.setTile(t,i,Dp[s],gi))},"fixSingle"),Mp=Ws(function(t,i){this.fixSingle(t,i),i>0&&this.fixSingle(t,i-1),t<this._map.width-1&&this.fixSingle(t+1,i),i<this._map.height-1&&this.fixSingle(t,i+1),t>0&&this.fixSingle(t-1,i)},"checkZoneConnections"),Rp=Ws(function(t,i,s){t=t-1,i=i-1;let n;for(n=0;n<s;n++)this.fixZone(t+n,i-1);for(n=0;n<s;n++)this.fixZone(t-1,i+n);for(n=0;n<s;n++)this.fixZone(t+n,i+s);for(n=0;n<s;n++)this.fixZone(t+s,i+n)},"checkBorder"),Pp=Ws(function(t){return t.prototype.checkZoneConnections=Mp,t.prototype.fixSingle=Cp,t.prototype.checkBorder=Rp,t},"Connector");var $p=Object.defineProperty,Ap=u((t,i)=>$p(t,"name",{value:i,configurable:!0}),"n$7");const Lp=Wt.makeTool,Ui=Ap(function(t){return Pp(Lp(t))},"ConnectingTool"),rt=Ui(function(t,i,s,n,o){this.init(t,s,!1),this.centreTile=i,this.size=n,this.animated=o});rt.prototype.putBuilding=function(t,i){let s,n,o,a,r=this.centreTile-this.size-1;for(let l=0;l<this.size;l++){n=i+l;for(let h=0;h<this.size;h++)s=t+h,o=r,a=as,h===1&&(l===1?a|=xe:l===2&&this.animated&&(a|=K)),this._worldEffects.setTile(s,n,o,a),r++}},rt.prototype.prepareBuildingSite=function(t,i){if(t<0||t+this.size>this._map.width)return this.TOOLRESULT_FAILED;if(i<0||i+this.size>this._map.height)return this.TOOLRESULT_FAILED;let s,n,o;for(let a=0;a<this.size;a++){n=i+a;for(let r=0;r<this.size;r++)if(s=t+r,o=this._worldEffects.getTileValue(s,n),o!==R){if(!this.autoBulldoze)return this.TOOLRESULT_NEEDS_BULLDOZE;if(!T.canBulldoze(o))return this.TOOLRESULT_NEEDS_BULLDOZE;this._worldEffects.setTile(s,n,R),this.addCost(this.bulldozerCost)}}return this.TOOLRESULT_OK},rt.prototype.buildBuilding=function(t,i){t--,i--;const s=this.prepareBuildingSite(t,i);return s!==this.TOOLRESULT_OK?s:(this.addCost(this.toolCost),this.putBuilding(t,i),this.checkBorder(t,i),this.TOOLRESULT_OK)},rt.prototype.doTool=function(t,i,s){this.result=this.buildBuilding(t,i)};const Gi=ht(Ui(function(t){this.init(10,t,!0,!0)}));Gi.prototype.putRubble=function(t,i,s){for(let n=t;n<t+s;n++)for(let o=i;o<i+s;o++)if(this._map.testBounds(n,o)){const a=this._worldEffects.getTileValue(n,o);a!=ai&&a!=R&&this._worldEffects.setTile(n,o,di+g(2),K|m)}},Gi.prototype.layDoze=function(t,i){let s=this._worldEffects.getTile(t,i);if(!s.isBulldozable())return this.TOOLRESULT_FAILED;switch(s=s.getValue(),s=T.normalizeRoad(s),s){case ut:case dt:case Ae:case $e:case un:case Mo:case Ro:case Po:case fn:case Lo:case Io:case ko:case Lt:case Yt:case pt:case Xt:this._worldEffects.setTile(t,i,p);break;default:this._worldEffects.setTile(t,i,R);break}return this.addCost(1),this.TOOLRESULT_OK},Gi.prototype.doTool=function(t,i,s){this._map.testBounds(t,i)||(this.result=this.TOOLRESULT_FAILED);const n=this._worldEffects.getTile(t,i),o=n.getValue();let a=0,r,l;if(n.isZone())a=A.checkZoneSize(o),r=0,l=0;else{const h=A.checkBigZone(o);a=h.zoneSize,r=h.deltaX,l=h.deltaY}if(a>0){this.addCost(this.bulldozerCost);const h=t+r,c=i+l;switch(a){case 3:this._emitEvent(Cs),this.putRubble(h-1,c-1,3);break;case 4:this._emitEvent(Bn),this.putRubble(h-1,c-1,4);break;case 6:this._emitEvent(Cs),this._emitEvent(Bn),this.putRubble(h-1,c-1,6);break}this.result=this.TOOLRESULT_OK}else{let h;o===p||o===O||o===G?(h=this.layDoze(t,i),o!==this._worldEffects.getTileValue(t,i)&&this.addCost(5)):(h=this.layDoze(t,i),this.checkZoneConnections(t,i)),this.result=h}};const Ip=Wt.makeTool,to=Ip(function(t){this.init(10,t,!0,!0)});to.prototype.doTool=function(t,i,s){if(this.doAutoBulldoze(t,i),this._worldEffects.getTileValue(t,i)!==R){this.result=this.TOOLRESULT_NEEDS_BULLDOZE;return}const n=g(4);let o=P|m,a;n===4?(a=Ao,o|=K):a=n+Hr,this._worldEffects.setTile(t,i,a,o),this.addCost(10),this.result=this.TOOLRESULT_OK};const Us=Ui(function(t){this.init(20,t,!0,!0)});Us.prototype.layRail=function(t,i){this.doAutoBulldoze(t,i);let s=this._worldEffects.getTileValue(t,i);s=T.normalizeRoad(s);let n=this.toolCost;switch(s){case R:this._worldEffects.setTile(t,i,It,m|P);break;case p:case O:case G:if(n=100,t<this._map.width-1&&(s=this._worldEffects.getTileValue(t+1,i),s=T.normalizeRoad(s),s==Q||s==pt||s>=It&&s<=lt)){this._worldEffects.setTile(t,i,pt,m);break}if(t>0&&(s=this._worldEffects.getTileValue(t-1,i),s=T.normalizeRoad(s),s==Q||s==pt||s>Xt&&s<q)){this._worldEffects.setTile(t,i,pt,m);break}if(i<this._map.height-1&&(s=this._worldEffects.getTileValue(t,i+1),s=T.normalizeRoad(s),s==gt||s==q||s>pt&&s<lt)){this._worldEffects.setTile(t,i,Xt,m);break}if(i>0&&(s=this._worldEffects.getTileValue(t,i-1),s=T.normalizeRoad(s),s==gt||s==q||s>pt&&s<lt)){this._worldEffects.setTile(t,i,Xt,m);break}return this.TOOLRESULT_FAILED;case zt:this._worldEffects.setTile(t,i,gt,k|P|m);break;case hi:this._worldEffects.setTile(t,i,Q,k|P|m);break;case yt:this._worldEffects.setTile(t,i,q,P|m);break;case ri:this._worldEffects.setTile(t,i,lt,P|m);break;default:return this.TOOLRESULT_FAILED}return this.addCost(n),this.checkZoneConnections(t,i),this.TOOLRESULT_OK},Us.prototype.doTool=function(t,i,s){this.result=this.layRail(t,i)};const Gs=Ui(function(t){this.init(10,t,!0,!0)});Gs.prototype.layRoad=function(t,i){this.doAutoBulldoze(t,i);let s=this._worldEffects.getTileValue(t,i),n=this.toolCost;switch(s){case R:this._worldEffects.setTile(t,i,yt,m|P);break;case p:case O:case G:if(n=50,t<this._map.width-1&&(s=this._worldEffects.getTileValue(t+1,i),s=T.normalizeRoad(s),s===q||s===ut||s>=yt&&s<=At)){this._worldEffects.setTile(t,i,ut,m);break}if(t>0&&(s=this._worldEffects.getTileValue(t-1,i),s=T.normalizeRoad(s),s===q||s===ut||s>=yt&&s<=li)){this._worldEffects.setTile(t,i,ut,m);break}if(i<this._map.height-1&&(s=this._worldEffects.getTileValue(t,i+1),s=T.normalizeRoad(s),s===lt||s===ot||s>=dt&&s<=li)){this._worldEffects.setTile(t,i,dt,m);break}if(i>0&&(s=this._worldEffects.getTileValue(t,i-1),s=T.normalizeRoad(s),s===lt||s===ot||s>=dt&&s<=li)){this._worldEffects.setTile(t,i,dt,m);break}return this.TOOLRESULT_FAILED;case zt:this._worldEffects.setTile(t,i,ot,k|P|m);break;case hi:this._worldEffects.setTile(t,i,At,k|P|m);break;case It:this._worldEffects.setTile(t,i,lt,P|m);break;case ci:this._worldEffects.setTile(t,i,q,P|m);break;default:return this.TOOLRESULT_FAILED}return this.addCost(n),this.checkZoneConnections(t,i),this.TOOLRESULT_OK},Gs.prototype.doTool=function(t,i,s){this.result=this.layRoad(t,i)};const kp=Wt.makeTool,$t=ht(kp(function(t){this.init(0,t,!1,!1)}));$t.prototype.classifyPopulationDensity=function(t,i,s){let n=s.populationDensityMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryDensity").text(tt.densityStrings[n])},$t.prototype.classifyLandValue=function(t,i,s){const n=s.landValueMap.worldGet(t,i);let o=0;n>=150?o=3:n>=80?o=2:n>=30&&(o=1);const a=tt.landValueStrings[o];$("#queryLandValue").text(a)},$t.prototype.classifyCrime=function(t,i,s){let n=s.crimeRateMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryCrime").text(tt.crimeStrings[n])},$t.prototype.classifyPollution=function(t,i,s){let n=s.pollutionDensityMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryPollution").text(tt.pollutionStrings[n])},$t.prototype.classifyRateOfGrowth=function(t,i,s){let n=s.rateOfGrowthMap.worldGet(t,i);n=n>>6,n=n&3,$("#queryRate").text(tt.rateStrings[n])},$t.prototype.classifyDebug=function(t,i,s){},$t.prototype.classifyZone=function(t,i){const s=[R,p,ji,Zi,le,ai,Qs,F,bt,jt,Zt,nn,Qi,qt,El,rn,Tl,wl,Do,vl,un,$o,Ao,yl,pn,fn,952];let n=this._map.getTileValue(t,i);n>=bl&&n<pn&&(n=rn);let o,a;for(o=0,a=s.length-1;o<a&&!(n<s[o+1]);o++);$("#queryZoneType").text(tt.zoneTypes[o])},$t.prototype.doTool=function(t,i,s){let n="Position ("+t+", "+i+")";n+=" TileValue: "+this._map.getTileValue(t,i),_c.queryDebug,this.classifyZone(t,i),this.classifyPopulationDensity(t,i,s),this.classifyLandValue(t,i,s),this.classifyCrime(t,i,s),this.classifyPollution(t,i,s),this.classifyRateOfGrowth(t,i,s),this.classifyDebug(t,i,s),this._emitEvent(fe),this.result=this.TOOLRESULT_OK};const Ys=Ui(function(t){this.init(5,t,!0,!0)});Ys.prototype.layWire=function(t,i){this.doAutoBulldoze(t,i);let s=this.toolCost,n=this._worldEffects.getTileValue(t,i);switch(n=T.normalizeRoad(n),n){case R:this._worldEffects.setTile(t,i,zt,k|P|m);break;case p:case O:case G:if(s=25,t<this._map.width-1&&(n=this._worldEffects.getTile(t+1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=At&&n!=Q&&n!=Lt))){this._worldEffects.setTile(t,i,Yt,k|m);break}if(t>0&&(n=this._worldEffects.getTile(t-1,i),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=At&&n!=Q&&n!=Lt))){this._worldEffects.setTile(t,i,Yt,k|m);break}if(i<this._map.height-1&&(n=this._worldEffects.getTile(t,i+1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=ot&&n!=gt&&n!=Yt))){this._worldEffects.setTile(t,i,Lt,k|m);break}if(i>0&&(n=this._worldEffects.getTile(t,i-1),n.isConductive()&&(n=n.getValue(),n=T.normalizeRoad(n),n!=ot&&n!=gt&&n!=Yt))){this._worldEffects.setTile(t,i,Lt,k|m);break}return this.TOOLRESULT_FAILED;case yt:this._worldEffects.setTile(t,i,At,k|P|m);break;case ri:this._worldEffects.setTile(t,i,ot,k|P|m);break;case It:this._worldEffects.setTile(t,i,Q,k|P|m);break;case ci:this._worldEffects.setTile(t,i,gt,k|P|m);break;default:return this.TOOLRESULT_FAILED}return this.addCost(s),this.checkZoneConnections(t,i),this.TOOLRESULT_OK},Ys.prototype.doTool=function(t,i,s){this.result=this.layWire(t,i)};var xp=Object.defineProperty,Np=u((t,i)=>xp(t,"name",{value:i,configurable:!0}),"i$4");function dr(t){const i=ht({airport:new rt(1e4,H,t,6,!1),bulldozer:new Gi(t),coal:new rt(3e3,Kt,t,4,!1),commercial:new rt(100,on,t,3,!1),fire:new rt(500,Oo,t,3,!1),industrial:new rt(100,an,t,3,!1),nuclear:new rt(5e3,kt,t,4,!0),park:new to(t),police:new rt(500,hn,t,3,!1),port:new rt(3e3,he,t,4,!1),rail:new Us(t),residential:new rt(100,Le,t,3,!1),road:new Gs(t),query:new $t(t),stadium:new rt(5e3,Qt,t,4,!1),wire:new Ys(t)});return i.query.addEventListener(fe,d.reflectEvent.bind(i,fe)),i}u(dr,"a$3"),Np(dr,"GameTools");var Vp=Object.defineProperty,St=u((t,i)=>Vp(t,"name",{value:i,configurable:!0}),"s$4");const Bp="#"+Fs.DEFAULT_ID,eo=ht(function(t,i){this.gameTools=dr(t),this.gameTools.addEventListener(fe,d.reflectEvent.bind(this,fe)),this.canvasID=d.normaliseDOMid(Bp),this._tileWidth=i,this.up=!1,this.down=!1,this.left=!1,this.right=!1,this.escape=!1,this.mouseX=-1,this.mouseY=-1,this._dragging=!1,this._lastdragX=-1,this._lastdragY=-1,this.toolName=null,this.currentTool=null,this.toolWidth=0,this.toolColour="",this.$canvas=$(this.canvasID),$(document).keydown(pr.bind(this)),$(document).keyup(fr.bind(this)),this.getRelativeCoordinates=mr.bind(this),this.$canvas.on("mouseenter",gr.bind(this)),this.$canvas.on("mouseleave",Tr.bind(this)),this.mouseDownHandler=_r.bind(this),this.mouseMoveHandler=wr.bind(this),this.mouseUpHandler=Er.bind(this),this.canvasClickHandler=vr.bind(this),$(".toolButton").click(Sr.bind(this)),$("#budgetRequest").click(Fp.bind(this)),$("#evalRequest").click(Up.bind(this)),$("#disasterRequest").click(Wp.bind(this)),$("#pauseRequest").click(this.speedChangeHandler.bind(this)),$("#screenshotRequest").click(Gp.bind(this)),$("#settingsRequest").click(Yp.bind(this)),$("#saveRequest").click(zp.bind(this)),$("#debugRequest").click(Hp.bind(this))});function pr(t){let i=!1;switch(t.keyCode){case 38:case 87:this.up=!0,i=!0;break;case 40:case 83:this.down=!0,i=!0;break;case 39:case 68:this.right=!0,i=!0;break;case 37:case 65:this.left=!0,i=!0;break;case 27:this.escape=!0,i=!0}i&&t.preventDefault()}u(pr,"g$3"),St(pr,"keyDownHandler");function fr(t){switch(t.keyCode){case 38:case 87:this.up=!1;break;case 40:case 83:this.down=!1;break;case 39:case 68:this.right=!1;break;case 37:case 65:this.left=!1;break;case 27:this.escape=!1}}u(fr,"E$1"),St(fr,"keyUpHandler");function mr(t){const i=document.querySelector(this.canvasID).getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top}}u(mr,"D"),St(mr,"getRelativeCoordinates");function gr(t){this.currentTool!=null&&(this.$canvas.on("mousemove",this.mouseMoveHandler),this.currentTool.isDraggable?this.$canvas.on("mousedown",this.mouseDownHandler):this.$canvas.on("click",this.canvasClickHandler))}u(gr,"_$1"),St(gr,"mouseEnterHandler");function _r(t){if(t.which!==1||t.shiftKey||t.altKey||t.ctrlKey||t.metaKey)return;const i=this.getRelativeCoordinates(t);this.mouseX=i.x,this.mouseY=i.y,this._dragging=!0,this._emitEvent(Ni,{x:this.mouseX,y:this.mouseY}),this._lastDragX=Math.floor(this.mouseX/this._tileWidth),this._lastDragY=Math.floor(this.mouseY/this._tileWidth),this.$canvas.on("mouseup",this.mouseUpHandler),t.preventDefault()}u(_r,"p$3"),St(_r,"mouseDownHandler");function Er(t){this._dragging=!1,this._lastDragX=-1,this._lastDragY=-1,this.$canvas.off("mouseup"),t.preventDefault()}u(Er,"C"),St(Er,"mouseUpHandler");function Tr(t){this.$canvas.off("mousedown"),this.$canvas.off("mousemove"),this.$canvas.off("mouseup"),this._dragging&&(this._dragging=!1,this._lastDragX=-1,this._lastDragY=-1),this.$canvas.off("click"),this.mouseX=-1,this.mouseY=-1}u(Tr,"b"),St(Tr,"mouseLeaveHandler");function wr(t){const i=this.getRelativeCoordinates(t);if(this.mouseX=i.x,this.mouseY=i.y,this._dragging){const s=Math.floor(this.mouseX/this._tileWidth),n=Math.floor(this.mouseY/this._tileWidth),o=this._lastDragX,a=this._lastDragY;(s!==o||n!==a)&&(this._emitEvent(Ni,{x:this.mouseX,y:this.mouseY}),this._lastDragX=s,this._lastDragY=n)}}u(wr,"k$1"),St(wr,"mouseMoveHandler");function vr(t){t.which!==1||t.shiftKey||t.altKey||t.ctrlKey||t.metaKey||this.mouseX===-1||this._mouseY===-1||this._dragging||(this._emitEvent(Ni,{x:this.mouseX,y:this.mouseY}),t.preventDefault())}u(vr,"H"),St(vr,"canvasClickHandler");function Sr(t){$(".selected").each(function(){this.classList.remove("selected"),this.classList.add("unselected")});let i=t.target,s=$(i);i.tagName.toLowerCase()==="img"&&(i=i.parentNode,s=$(i)),s.removeClass("unselected"),s.addClass("selected"),this.toolName=s.attr("data-tool"),this.toolWidth=s.attr("data-size"),this.currentTool=this.gameTools[this.toolName],this.toolColour="",this.toolName!=="query"?(this.$canvas.removeClass("helpPointer"),this.$canvas.addClass("pointer")):(this.$canvas.removeClass("pointer"),this.$canvas.addClass("helpPointer")),t.preventDefault()}u(Sr,"R"),St(Sr,"toolButtonHandler"),eo.prototype.speedChangeHandler=function(t){const i=$("#pauseRequest").text(),s=i==="Pause"?"Play":"Pause";$("#pauseRequest").text(s),this._emitEvent(Fn,i)},eo.prototype.clearTool=function(){this.toolName==="query"&&(this.$canvas.removeClass("helpPointer"),this.$canvas.addClass("pointer")),this.currentTool=null,this.toolWidth=0,this.toolColour="",$(".selected").removeClass("selected")};const De=St(function(t){const i=Ra[t];return function(s){this._emitEvent(i)}},"makeHandler");var Fp=De("BUDGET_REQUESTED"),Hp=De("DEBUG_WINDOW_REQUESTED"),Wp=De("DISASTER_REQUESTED"),Up=De("EVAL_REQUESTED"),Gp=De("SCREENSHOT_WINDOW_REQUESTED"),Yp=De("SETTINGS_WINDOW_REQUESTED"),zp=De("SAVE_REQUESTED"),Xp=Object.defineProperty,io=u((t,i)=>Xp(t,"name",{value:i,configurable:!0}),"s$3");const yr=30,jp=io(function(t){t&&t.preventDefault(),this._element.is(":visible")&&this._element.toggle()},"close"),Zp=io(function(t){t.preventDefault(),!(this._x===-1||this._y===-1)&&this._map.centreOn(this._x,this._y)},"handleClick");function oe(t,i,s){t=d.normaliseDOMid(t),this._map=i,this._element=$(t),this._timeout=null,this._handleClick=Zp.bind(this),this._x=-1,this._y=-1,this._element.click(this._handleClick),this.close=jp.bind(this),this._element.is(":visible")&&this._element.toggle()}u(oe,"e$4"),io(oe,"Notification"),oe.prototype._displayLink=function(t,i,s){this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),this._element.text(t),this._x=i,this._y=s,this._element.addClass("pointer"),this._element.is(":visible")||this._element.toggle(),this._timeout=window.setTimeout(function(){this._timeout=null,this.close()}.bind(this),yr*1e3)},oe.prototype._displayText=function(t,i,s){this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),this._element.removeClass("pointer"),this._element.text(t),this._x=-1,this._y=-1,this._element.is(":visible")||this._element.toggle(),this._timeout=window.setTimeout(function(){this._timeout=null,this.close()}.bind(this),yr*1e3)},oe.prototype.createMessage=function(t){if(t.hasOwnProperty("data")&&t.data!==void 0&&t.data.hasOwnProperty("x")&&t.data.hasOwnProperty("y")){this._displayLink(tt.messageText[t.subject],t.data.x,t.data.y);return}this._displayText(tt.messageText[t.subject])},oe.prototype.badNews=function(t){this._element.removeClass("neutral"),this._element.removeClass("good"),this._element.addClass("bad"),this.createMessage(t)},oe.prototype.goodNews=function(t){this._element.removeClass("neutral"),this._element.removeClass("bad"),this._element.addClass("good"),this.createMessage(t)},oe.prototype.news=function(t){this._element.removeClass("good"),this._element.removeClass("bad"),this._element.addClass("neutral"),this.createMessage(t)};var qp=Object.defineProperty,Kp=u((t,i)=>qp(t,"name",{value:i,configurable:!0}),"e$3");const Qp="#queryForm",Jp="#queryOK",tf=Kp(function(t){t.preventDefault(),this.close()},"submit"),so=Pt(function(){this._debugToggled=!1,$(Qp).on("submit",tf.bind(this)),this.$queryOK=$(Jp)});so.prototype.close=function(){this._toggleDisplay(),this._emitEvent(Ln)},so.prototype.open=function(){this._toggleDisplay(),this.$queryOK.focus()};var ef=Object.defineProperty,sf=u((t,i)=>ef(t,"name",{value:i,configurable:!0}),"o$4");function Ut(t,i,s){if(arguments.length<2)throw new Error("RCI constructor called with too few arguments "+[].toString.apply(arguments));if(s===void 0&&(s=Ut.DEFAULT_ID),typeof t=="string"){const a=t;if(t=$(d.normaliseDOMid(t)),t=t.length===0?null:t[0],t===null)throw new Error("Node "+a+" not found")}this._padding=3,this._buckets=10,this._rectSize=5,this._scale=Math.floor(2e3/this._buckets),this._canvas=$("<canvas></canvas>",{id:s})[0];const n=$(d.normaliseDOMid(s)),o=n.length>0?n[0]:null;if(o!==null)if(o.parentNode===t)t.replaceChild(this._canvas,o);else throw new Error("ID "+s+" already exists in document!");else t.appendChild(this._canvas);this._initialisedBounds=!1,i.addEventListener(je,this.update.bind(this))}u(Ut,"a$2"),sf(Ut,"RCI"),Ut.prototype._clear=function(t){t.clearRect(0,0,this._canvas.width,this._canvas.height)},Ut.prototype._drawRect=function(t){const i=this._padding*this._rectSize,s=(this._buckets+this._padding)*this._rectSize,n=7*this._padding*this._rectSize,o=this._padding*this._rectSize;t.fillStyle="rgb(192, 192, 192)",t.fillRect(i,s,n,o)},Ut.prototype._drawValue=function(t,i,s){i>1&&(s=Math.floor(2e3/1500*s));const n=["rgb(0,255,0)","rgb(0, 0, 139)","rgb(255, 255, 0)"],o=Math.floor(Math.abs(s)/this._scale),a=s>=0?this._buckets+this._padding-o:this._buckets+2*this._padding,r=2*this._padding+i*2*this._padding;t.fillStyle=n[i],t.fillRect(r*this._rectSize,a*this._rectSize,this._padding*this._rectSize,o*this._rectSize)},Ut.prototype._drawLabel=function(t,i){const s=["R","C","I"],n=2*this._padding+i*2*this._padding+Math.floor(this._padding/2);t.font="normal xx-small sans-serif",t.fillStyle="rgb(0, 0, 0)",t.textBaseline="bottom",t.fillText(s[i],n*this._rectSize,(this._buckets+2*this._padding)*this._rectSize)},Ut.prototype.update=function(t){if(!this._initialised){const n=this._canvas.parentNode.getBoundingClientRect();this._canvas.width=n.width,this._canvas.height=n.height,this._canvas.style.margin="0",this._canvas.style.padding="0",this._intialised=!0}const i=this._canvas.getContext("2d");this._clear(i),this._drawRect(i);const s=[t.residential,t.commercial,t.industrial];for(let n=0;n<3;n++)this._drawValue(i,n,s[n]),this._drawLabel(i,n)},Object.defineProperty(Ut,"DEFAULT_ID",d.makeConstantDescriptor("RCICanvas"));var nf=Object.defineProperty,of=u((t,i)=>nf(t,"name",{value:i,configurable:!0}),"i$3");const af="#saveForm",rf="#saveOK",lf=of(function(t){t.preventDefault(),this.close()},"submit"),no=Pt(function(){$(af).on("submit",lf.bind(this))});no.prototype.close=function(){this._toggleDisplay(),this._emitEvent(In)},no.prototype.open=function(){this._toggleDisplay(),$(rf).focus()};var hf=Object.defineProperty,br=u((t,i)=>hf(t,"name",{value:i,configurable:!0}),"o$3");const cf="#screenshotLinkForm",uf="#screenshotLink";br(function(t){t.preventDefault(),this.close()},"cancel");const df=br(function(t){t.preventDefault(),this.close()},"submit"),oo=Pt(function(){$(cf).on("submit",df.bind(this))});oo.prototype.close=function(){this._toggleDisplay(),this._emitEvent(xn)},oo.prototype.open=function(t){$(uf).attr("href",t),this._toggleDisplay()};var pf=Object.defineProperty,Or=u((t,i)=>pf(t,"name",{value:i,configurable:!0}),"o$2");const ae=Pt(function(){$(ff).on("click",gf.bind(this)),$(mf).on("submit",_f.bind(this))});var ff="#screenshotCancel",mf="#screenshotForm";ae.prototype.close=function(t){t=t||null,this._toggleDisplay(),this._emitEvent(Nn,t)};var gf=Or(function(t){t.preventDefault(),this.close(null)},"cancel"),_f=Or(function(t){t.preventDefault();let i=null;$(".screenshotType:checked").val()==="visible"?i=ae.SCREENSHOT_VISIBLE:i=ae.SCREENSHOT_ALL,this.close(i)},"submit");ae.prototype.open=function(t){this._toggleDisplay()};const Dr=function(){let t=1;return function(i){Object.defineProperty(ae,i,d.makeConstantDescriptor(t)),t+=1}}();Dr("SCREENSHOT_VISIBLE"),Dr("SCREENSHOT_ALL");var Ef=Object.defineProperty,Cr=u((t,i)=>Ef(t,"name",{value:i,configurable:!0}),"i$1");const Tf="#settingsCancel",wf="#settingsForm",vf="#autoBudgetYes",Sf="#autoBudgetNo",yf="#autoBulldozeYes",bf="#autoBulldozeNo",Of="#speedSlow",Df="#speedMed",Cf="#speedFast",Mf="#disastersYes",Rf="#disastersNo",Pf=Cr(function(t){t.preventDefault(),this.close([])},"cancel"),$f=Cr(function(t){t.preventDefault();const i=[];let s=$(".autoBudgetSetting:checked").val();s==="true"?s=!0:s=!1,i.push({action:mt.AUTOBUDGET,data:s});let n=$(".autoBulldozeSetting:checked").val();n==="true"?n=!0:n=!1,i.push({action:mt.AUTOBULLDOZE,data:n});const o=$(".speedSetting:checked").val()-0;i.push({action:mt.SPEED,data:o});let a=$(".enableDisastersSetting:checked").val();a==="true"?a=!0:a=!1,i.push({action:mt.DISASTERS_CHANGED,data:a}),this.close(i)},"submit"),mt=Pt(function(){$(Tf).on("click",Pf.bind(this)),$(wf).on("submit",$f.bind(this))});mt.prototype.close=function(t){t=t||[],this._emitEvent(Vn,t),this._toggleDisplay()},mt.prototype.open=function(t){t.autoBudget?$(vf).prop("checked",!0):$(Sf).prop("checked",!0),t.autoBulldoze?$(yf).prop("checked",!0):$(bf).prop("checked",!0),t.speed===y.SPEED_SLOW?$(Of).prop("checked",!0):t.speed===y.SPEED_MED?$(Df).prop("checked",!0):$(Cf).prop("checked",!0),t.disasters?$(Mf).prop("checked",!0):$(Rf).prop("checked",!0),this._toggleDisplay()};const zs=function(){let t=0;return function(i){Object.defineProperty(mt,i,d.makeConstantDescriptor(t)),t+=1}}();zs("AUTOBUDGET"),zs("AUTOBULLDOZE"),zs("SPEED"),zs("DISASTERS_CHANGED");var Af=Object.defineProperty,Lf=u((t,i)=>Af(t,"name",{value:i,configurable:!0}),"i");const If="#touchForm",kf="#touchOK",xf=Lf(function(t){t.preventDefault(),this.close()},"submit"),ao=Pt(function(){$(If).on("submit",xf.bind(this))});ao.prototype.close=function(){this._toggleDisplay(),this._emitEvent(Wn)},ao.prototype.open=function(){this._toggleDisplay(),$(kf).focus()};var Nf=Object.defineProperty,Gt=u((t,i)=>Nf(t,"name",{value:i,configurable:!0}),"o");const et={audioContext:null,audioContextReady:!1,samples:{}};function ro(){et.audioContext||(et.audioContext=new AudioContext),et.audioContext.state==="playing"?(et.audioContextReady=!0,ho()):Mr()}u(ro,"init"),Gt(ro,"init");function Mr(){function t(){document.body.removeEventListener("click",t),et.audioContext.resume().then(function(){et.audioContextReady=!0,ho()}).catch(function(){})}u(t,"e"),Gt(t,"onClick"),document.body.addEventListener("click",t)}u(Mr,"d"),Gt(Mr,"resumeAudioContextOnUserGesture");const lo=["rumble","thumb_piano_dry_3_03_07","toy_glock_1_3_5","toy_glock_6_4_5","whaledrum_1_b_05","whaledrum_8_b_19"];function ho(){function t(){const i=Math.random();i>.9||(i>.8?Ce("heavytraffic",1,6):i>.7?Ce("honkhonk-low",1,6):i>.6?Ce("siren",.7,6):i>.5&&Ce("computer",.7,4)),setTimeout(t,3e3+Math.random()*12e3)}u(t,"e"),Gt(t,"tick"),setTimeout(t,6e3)}u(ho,"s"),Gt(ho,"startMusic");function Rr(){const t=lo[Math.floor(lo.length*Math.random())];Ce(t)}u(Rr,"makeRandomSound"),Gt(Rr,"makeRandomSound");async function Pr(t){let i=et.samples[name];if(!i){const s=await(await fetch(t)).arrayBuffer();i=et.samples[name]=await et.audioContext.decodeAudioData(s)}return i}u(Pr,"r$1"),Gt(Pr,"loadSound");function $r(t,i=1,s=50){const n=new AudioBufferSourceNode(et.audioContext,{buffer:t,playbackRate:i}),o=new GainNode(et.audioContext);o.gain.setValueAtTime(s/100,et.audioContext.currentTime),n.connect(o).connect(et.audioContext.destination),n.start(0)}u($r,"f$1"),Gt($r,"playAudioBuffer");async function Ce(t,i,s){typeof t=="number"&&(t=lo[t]);try{et.audioContextReady||await et.resumeAudioContext(),$r(await Pr(`sounds/${t}.mp3`),i,s)}catch(n){}}u(Ce,"makeSound"),Gt(Ce,"makeSound");var Vf=Object.freeze({__proto__:null,state:et,init:ro,makeRandomSound:Rr,makeSound:Ce}),Bf=Object.defineProperty,Me=u((t,i)=>Bf(t,"name",{value:i,configurable:!0}),"l$1");let Ar=0;function Lr(){if(Ar++,this.handleInput(),this.dialogOpen){window.setTimeout(this.tick,0);return}this.simulation.isPaused()||this.simulation.simTick(),this.mouse=this.calculateMouseForPaint(),window.setTimeout(this.tick,this.tickDuration)}u(Lr,"ot"),Me(Lr,"tick");function Ir(){if(this.dialogShowing){xr(this.animate);return}!this.isPaused&&Ar%2===1&&this.simulation.spriteManager.moveObjects(this.simulation._constructSimData());const t=this.calculateSpritesForPaint(this.gameCanvas);this.gameCanvas.paint(this.mouse,t,this.isPaused),xr(this.animate)}u(Ir,"dt"),Me(Ir,"commonAnimate"),Me(function(){const t=new Date,i=Math.floor((t-this.animStart)/1e3);i>this.lastElapsed&&this.frameCount>0&&($("#fpsValue").text(Math.floor(this.frameCount/i)),this.lastElapsed=i),this.frameCount++,this.commonAnimate()},"debugAnimate");const kr=20*1e3,Xs={};let Yi;Me(function(t){window.removeEventListener("touchstart",this.touchListener,!1),this._openWindow="touchWindow",this.dialogOpen=!0,this.touchWindow.open()},"touchListener");const xr=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame;function re(t,i){return i=i||null,function(){if(console.log("Open request",this),this.dialogOpen){console.warn("Request made to open "+t+" window. There is a dialog open!"),this._openWindow&&console.log("Currently open",this._openWindow);return}this.dialogOpen=!0,this._openWindow=t+"Window";const s=t+"Window";let n=[];i&&(n=i()),this[s].open.apply(this[s],n)}}u(re,"c"),Me(re,"makeWindowOpenHandler");class co{constructor({map:i,tileSet:s,snowTileSet:n,spriteSheet:o,difficulty:a=0,name:r="Microcity"}){let l;i.isSavedGame?(this.gameMap=new N(i.width,i.height),l=i):(this.gameMap=i,l=null),this.tileSet=s,this.spriteSheet=o,this.defaultSpeed=y.SPEED_MED,this.difficulty=a,this.simulation=new y(this.gameMap,this.difficulty,this.defaultSpeed,l),this.tickDuration=30,this.name=r||"Microcity",this.everClicked=!1,l&&this.loadInitial(l),this.rci=new Ut("RCIContainer",this.simulation),this.gameCanvas=new Fs("canvasContainer"),this.gameCanvas.init(this.gameMap,this.tileSet,this.spriteSheet),this.inputStatus=new eo(this.gameMap,s.tileWidth),this.gameAudio=Vf,ro(),this.dialogOpen=!1,this._openWindow=null,this.mouse=null,this.lastCoord=null,this.simNeededBudget=!1,this.isPaused=!1,this.lastBadMessageTime=null;const h="opaque",c=Me(()=>{this.dialogOpen=!1,this._openWindow=null},"genericDialogClosure");this.handleEvalRequest=re("eval",function(){return[this.simulation.evaluation]}.bind(this)),this.evalWindow=new Bs(h,"evalWindow"),this.evalWindow.addEventListener($n,c),this.inputStatus.addEventListener(va,this.handleEvalRequest.bind(this)),this.handleBudgetRequest=re("budget",function(){return[{roadMaintenanceBudget:this.simulation.budget.roadMaintenanceBudget,roadRate:Math.floor(this.simulation.budget.roadPercent*100),fireMaintenanceBudget:this.simulation.budget.fireMaintenanceBudget,fireRate:Math.floor(this.simulation.budget.firePercent*100),policeMaintenanceBudget:this.simulation.budget.policeMaintenanceBudget,policeRate:Math.floor(this.simulation.budget.policePercent*100),taxRate:this.simulation.budget.cityTax,totalFunds:this.simulation.budget.totalFunds,taxesCollected:this.simulation.budget.taxFund}]}.bind(this)),this.budgetWindow=new Kn(h,"budget"),this.budgetWindow.addEventListener(Cn,this.handleBudgetWindowClosure.bind(this)),this.inputStatus.addEventListener(Ea,this.handleBudgetRequest.bind(this)),this.handleDisasterRequest=re("disaster"),this.disasterWindow=new z(h,"disasterWindow"),this.disasterWindow.addEventListener(Pn,this.handleDisasterWindowClosure.bind(this)),this.inputStatus.addEventListener(wa,this.handleDisasterRequest.bind(this)),this.handleDebugRequest=re("debug"),this.debugWindow=new ni(h,"debugWindow"),this.debugWindow.addEventListener(Rn,this.handleDebugWindowClosure.bind(this)),this.inputStatus.addEventListener(Ta,this.handleDebugRequest.bind(this)),this.handleSettingsRequest=re("settings",function(){return[{autoBudget:this.simulation.budget.autoBudget,autoBulldoze:Wt.getAutoBulldoze(),speed:this.defaultSpeed,disasters:this.simulation.disasterManager.disastersEnabled}]}.bind(this)),this.settingsWindow=new mt(h,"settingsWindow"),this.settingsWindow.addEventListener(Vn,this.handleSettingsWindowClosure.bind(this)),this.inputStatus.addEventListener(Oa,this.handleSettingsRequest.bind(this)),this.handleScreenshotRequest=re("screenshot"),this.screenshotWindow=new ae(h,"screenshotWindow"),this.screenshotWindow.addEventListener(Nn,this.handleScreenshotWindowClosure.bind(this)),this.inputStatus.addEventListener(ba,this.handleScreenshotRequest.bind(this)),this.screenshotLinkWindow=new oo(h,"screenshotLinkWindow"),this.screenshotLinkWindow.addEventListener(xn,c),this.saveWindow=new no(h,"saveWindow"),this.saveWindow.addEventListener(In,c),this.touchWindow=new ao(h,"touchWarnWindow"),this.touchWindow.addEventListener(Wn,c),this.handleQueryRequest=re("query"),this.queryWindow=new so(h,"queryWindow"),this.queryWindow.addEventListener(Ln,c),this.inputStatus.addEventListener(fe,this.handleQueryRequest.bind(this)),this.inputStatus.addEventListener(ya,this.handleSave.bind(this)),this.simulation.addEventListener(L,this.processFrontEndMessage.bind(this)),this.simulation.addEventListener(Ge,this.handleMandatoryBudget.bind(this)),this.inputStatus.addEventListener(Ni,this.handleTool.bind(this)),this.inputStatus.addEventListener(Fn,this.handlePause.bind(this)),this.simulation.addEventListener(cs,this.onDateChange.bind(this)),this.infoBar=hp("cclass","population","score","funds","date","name"),this.resetInfoBar(),this._notificationBar=new oe("#notifications",this.gameCanvas),this._reachedTown=this._reachedCity=this._reachedCapital=this._reachedMetropolis=this._reacedMegalopolis=!1,this._notificationBar._element.toggle();const f=$("#tilesetSelect");f.length&&(f==null||f.on("change",w=>{const C=w.target.value;this.setTileset(C)}),f.val()!=="classic"&&f.val("classic")),$("#exportButton").on("click",()=>{const w={name:this.name,everClicked:this.everClicked};Wt.save(w),this.simulation.save(w),Ft.saveGame(w),console.log("Save",w);const C=document.createElement("a");C.download="microcity.json",C.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(w)),C.click()});const _=$("#importButton"),S=$("#importFileInput");_.on("click",w=>{S.click()}),S.on("change",({target:{files:w}})=>{const C=new FileReader;C.onload=({target:{result:M}})=>{try{const it=JSON.parse(M),ct=Sn(it.width,it.height);this.reload(ct,it)}catch(it){}},C.onerror=M=>console.error(M),C.readAsText(w[0])}),$("#newGameButton").on("click",()=>{const w=Sn(120,100),C={name:"Microcity",everClicked:!1,map:w};this.reload(w,C)}),$("#zoomInButton").on("click",()=>{this.gameCanvas.zoomIn()}),$("#zoomOutButton").on("click",()=>{this.gameCanvas.zoomOut()}),this.tick=Lr.bind(this),this.tick(),this.commonAnimate=Ir.bind(this),this.animate=this.commonAnimate.bind(this),this.animate()}save(){const i={name:this.name,everClicked:this.everClicked};Wt.save(i),this.simulation.save(i),Ft.saveGame(i)}loadInitial(i){this.name=i.name,this.everClicked=i.everClicked,Wt.load(i),this.simulation.load(i),Ft.saveGame(i)}reload(i,s){this.gameMap=i,this.simulation.reset(i),this.loadInitial(s),this.simulation.init(),this.gameCanvas.reset(i),this.resetInfoBar()}resetInfoBar(){this.infoBar(this.simulation,{classification:this.simulation.evaluation.cityClass,population:this.simulation.evaluation.cityPop,score:this.simulation.evaluation.cityScore,funds:this.simulation.budget.totalFunds,date:this.simulation.getDate(),name:this.name})}revealControls(){$(".initialHidden").each(function(i){$(this).removeClass("initialHidden")}),this.rci.update({residential:750,commercial:750,industrial:750})}setTileset(i){if(Xs[i]){this.tileSet=Xs[i],this.gameCanvas.changeTileSet(this.tileSet);return}Yi=Yi||document.createElement("img"),Yi.src=`/images/tiles/${i}.png`,Yi.onload=()=>{this.tileSet=Xs[i]=new es(Yi,()=>this.gameCanvas.changeTileSet(this.tileSet),()=>delete Xs[i])}}onDateChange(i){}handleDisasterWindowClosure(i){if(this.dialogOpen=!1,i!==z.DISASTER_NONE)switch(i){case z.DISASTER_MONSTER:this.simulation.spriteManager.makeMonster();break;case z.DISASTER_FIRE:this.simulation.disasterManager.makeFire();break;case z.DISASTER_FLOOD:this.simulation.disasterManager.makeFlood();break;case z.DISASTER_CRASH:this.simulation.disasterManager.makeCrash();break;case z.DISASTER_MELTDOWN:this.simulation.disasterManager.makeMeltdown();break;case z.DISASTER_TORNADO:this.simulation.spriteManager.makeTornado()}}handleSettingsWindowClosure(i){this.dialogOpen=!1;for(let s=0,n=i.length;s<n;s++){const o=i[s];switch(o.action){case mt.AUTOBUDGET:this.simulation.budget.setAutoBudget(o.data);break;case mt.AUTOBULLDOZE:Wt.setAutoBulldoze(o.data);break;case mt.SPEED:this.defaultSpeed=o.data,this.simulation.setSpeed(this.defaultSpeed);break;case mt.DISASTERS_CHANGED:this.simulation.disasterManager.disastersEnabled=o.data;break;default:console.warn("Unexpected action",o)}}}handleDebugWindowClosure(i){this.dialogOpen=!1;for(let s=0,n=i.length;s<n;s++){const o=i[s];switch(o.action){case ni.ADD_FUNDS:this.simulation.budget.spend(-1e6);break;default:console.warn("Unexpected action",o)}}}handleScreenshotWindowClosure(i){if(this.dialogOpen=!1,i===null)return;let s;i===ae.SCREENSHOT_VISIBLE?s=this.gameCanvas.screenshotVisible():i===ae.SCREENSHOT_ALL&&(s=this.gameCanvas.screenshotMap()),this.dialogOpen=!0,this._openWindow="screenshotLinkWindow",this.screenshotLinkWindow.open(s)}handleBudgetWindowClosure(i){this.dialogOpen=!1,i.cancelled||(this.simulation.budget.roadPercent=i.roadPercent/100,this.simulation.budget.firePercent=i.firePercent/100,this.simulation.budget.policePercent=i.policePercent/100,this.simulation.budget.setTax(i.taxPercent-0),this.simNeededBudget?(this.simulation.budget.doBudgetWindow(),this.simNeededBudget=!1):this.simulation.budget.updateFundEffects())}handleMandatoryBudget(){this.simNeededBudget=!0,this.handleBudgetRequest()}handleTool(i){const s=i.x,n=i.y,o=this.gameCanvas.canvasCoordinateToTileCoordinate(s,n);if(o===null)return;const a=this.inputStatus.currentTool,r=this.simulation.budget;switch(this.simulation.evaluation,a.doTool(o.x,o.y,this.simulation.blockMaps),a.modifyIfEnoughFunding(r),a.result){case a.TOOLRESULT_NEEDS_BULLDOZE:break;case a.TOOLRESULT_NO_MONEY:break;default:a instanceof $t||(a instanceof Gi?this.gameAudio.makeSound("rumble",.4):a instanceof Gs||a instanceof Us||a instanceof Ys||a instanceof to?this.gameAudio.makeSound("thumb_piano_dry_3_03_07",.4):a.result===a.TOOLRESULT_FAILED||a.result===a.TOOLRESULT_OK&&this.gameAudio.makeSound(["whaledrum_1_b_05","whaledrum_8_b_19"][Math.floor(Math.random()*2)]))}}handleSave(){this.save(),this.dialogOpen=!0,this._openWindow="saveWindow",this.saveWindow.open()}handlePause(){this.isPaused=!this.isPaused,this.isPaused?this.simulation.setSpeed(y.SPEED_PAUSED):this.simulation.setSpeed(this.defaultSpeed)}handleInput(){this.dialogOpen||(this.inputStatus.left?this.gameCanvas.moveWest():this.inputStatus.up?this.gameCanvas.moveNorth():this.inputStatus.right?this.gameCanvas.moveEast():this.inputStatus.down&&this.gameCanvas.moveSouth()),this.inputStatus.escape&&(this.dialogOpen?(this.dialogOpen=!1,this[this._openWindow].close(),this._openWindow=null):this.inputStatus.clearTool())}processFrontEndMessage(i){const s=i.subject,n=new Date;if(tt.goodMessages[s]!==void 0){let o=this.name+" is now a ";switch(s){case $i:this._reachedCapital||(this._reachedCapital=!0,o+="capital!");break;case Ai:this._reachedCity||(this._reachedCity=!0,o+="city!");break;case Ii:this._reachedMegalopolis||(this._reachedMegalopolis=!0,o+="megalopolis!");break;case Li:this._reachedMetropolis||(this._reachedMetropolis=!0,o+="metropolis!");break;case ki:this._reachedTown||(this._reachedTown=!0,o+="town!");break}(this.lastBadMessageTime===null||n-this.lastBadMessageTime>kr)&&(this.lastBadMessageTime=null,this._notificationBar.goodNews(i)),o!==this.name+" is now a "&&console.log("Congratulations",o);return}if(this.monsterTV&&i.data&&(i.data.showable?this.monsterTV.show(i.data.x,i.data.y):i.data.trackable&&this.monsterTV.track(i.data.x,i.data.y,i.data.sprite)),tt.badMessages[s]!==void 0){this._notificationBar.badNews(i),me.indexOf(i.subject)!==-1&&(this.lastBadMessageTime=n);return}if(tt.neutralMessages[s]!==void 0){(this.lastBadMessageTime===null||n-this.lastBadMessageTime>kr)&&(this.lastBadMessageTime=null,this._notificationBar.news(i));return}console.warn("Unexpected message: ",s)}calculateMouseForPaint(){let i=null;if(this.inputStatus.mouseX!==-1&&this.inputStatus.toolWidth>0){const s=this.gameCanvas.canvasCoordinateToTileOffset(this.inputStatus.mouseX,this.inputStatus.mouseY);s!==null&&(i={},i.x=s.x,i.y=s.y,i.width=this.inputStatus.toolWidth-0,i.height=this.inputStatus.toolWidth-0,i.colour=this.inputStatus.toolColour||"yellow")}return i}calculateSpritesForPaint(i){const s=i.getTileOrigin(),n=this.simulation.spriteManager.getSpritesInView(s.x,s.y,i.canvasWidth,i.canvasHeight);return n.length===0?null:n}}u(co,"y"),Me(co,"Game");var Ff=Object.defineProperty,zi=u((t,i)=>Ff(t,"name",{value:i,configurable:!0}),"e$1");const uo=document.getElementById("tiles"),po=document.getElementById("sprites");function fo(){const t=new es(uo,zi(function(){function i(){Nr(t,po)}u(i,"n"),zi(i,"onSpritesReady"),po.complete?i():po.onload=i},"onLoad"),zi(function(){console.error("Failed to load tileset")},"onError"))}u(fo,"l"),zi(fo,"createTileSet"),uo.complete&&fo(),uo.onload=fo;function Nr(t,i){let s=Sn(120,100),n;Ft.canStore&&(n=Ft.getSavedGame())&&(s=n);const o=new co({map:s,tileSet:t,spriteSheet:i,difficulty:y.LEVEL_EASY});setInterval(function(){Ft.canStore&&o.save()},3e3)}u(Nr,"g"),zi(Nr,"createGame")})();
//# sourceMappingURL=index.min.js.map
